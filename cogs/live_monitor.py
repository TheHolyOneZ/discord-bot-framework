"""Zoryx Discord Bot Framework â€“ Live Monitor Dashboard

Copyright (c) 2025â€“2026 TheHolyOneZ
GitHub: https://github.com/TheHolyOneZ
Discord: theholyonez (ID: 1284210833869639680)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

CREDITS & IDENTITY PROTECTION NOTICE

The Zoryx Discord Bot Framework, its name, branding, and identity
â€”including but not limited to the followingâ€”

â€¢ â€œZoryxâ€
â€¢ â€œZoryx Frameworkâ€
â€¢ â€œZoryx Discord Bot Frameworkâ€
â€¢ â€œTheHolyOneZâ€
â€¢ The Credits tab (layout, wording, structure, and crown artwork)

are NOT covered by the MIT license of the remaining framework.

The Credits tab MUST:
â€¢ Remain clearly visible at all times
â€¢ Remain unaltered in wording, layout, and design
â€¢ NOT be hidden, removed, renamed, duplicated, or repositioned
â€¢ NOT be visually minimized or obscured in any way

Any modification, removal, concealment, or misrepresentation of the
Credits tab or protected names is strictly prohibited unless explicit,
direct permission is granted by TheHolyOneZ.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

CUSTOMIZATION & MODIFICATION POLICY

You ARE allowed to:
â€¢ Customize styling, layout, or functionality of the dashboard
  outside of the protected Credits section
â€¢ Extend the framework by adding new features or integrations
â€¢ Create additional tabs for your own work or contributions

If you add a new tab, you MUST:
â€¢ Clearly label it as your own work
â€¢ Accurately describe what you modified or added (roughly)
â€¢ Use wording such as:
  â€œTab created by <YourName>. Added custom functionality on top of the existing Zoryx system.â€

You MUST NOT:
â€¢ Claim authorship of code, systems, or backend logic you did not create
â€¢ Present yourself as the original creator of the framework
â€¢ Imply ownership over backend systems you did not meaningfully modify
â€¢ Alter backend logic in a way that introduces security risks
â€¢ Attempt to remove, obscure, or disassociate the framework from
  its original author to damage reputation or mislead others

Any attempt to misrepresent authorship, remove attribution, or
maliciously modify the framework to reflect poorly on the original
author is considered a violation of this license and intent.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Tutorial & Showcase:
https://www.youtube.com/watch?v=ir3AsxZOshw&t=497s

Note:
The interface design has evolved significantly since the video was recorded.
The current dashboard is more refined, though core logic remains unchanged.

Additional Information:
During development, temporary comments or notes may exist in the code.
These do not affect functionality and may be safely ignored.

License Reminder:
By using or modifying this framework, you agree to comply with this notice
and the LICENSE file located in the main project directory.
"""


from discord.ext import commands, tasks
import discord
from discord import app_commands
import aiohttp
import asyncio
import secrets
import json
import logging
from datetime import datetime, timedelta
from typing import Optional, Dict, Any, List
from pathlib import Path
import psutil
import time
import inspect
import shutil
import platform
import sys
import ast
import re
logger = logging.getLogger('discord')


class LiveMonitor(commands.Cog):
    def __init__(self, bot):
        self.bot = bot
        self.config_file = Path("./data/live_monitor_config.json")
        self.config_file.parent.mkdir(parents=True, exist_ok=True)

        
        self.local_assets_dir = Path("./assets")
        self.local_assets_dir.mkdir(parents=True, exist_ok=True)
        
        self.config = self._load_config()
        self.is_enabled = False
        self.verbose_logging = self.config.get("verbose_logging", False)
        self.last_send_success = None
        self.send_failures = 0
        
        self._process = None
        self._start_time = datetime.now()
        self._command_usage = {}
        self._event_log = []
        self._max_event_log = 1000
        self._hook_execution_log = []
        self._max_hook_execution_log = 1000
        self._fileops_response = None


        self._fileops_lock = asyncio.Lock()


        self._dashboard_plugins = []
        self._plugins_discovered = False

        logger.info("Live Monitor: Advanced system initialized")
    
    @commands.Cog.listener()
    async def on_command(self, ctx):
        cmd_name = ctx.command.qualified_name if ctx.command else "unknown"
        if cmd_name not in self._command_usage:
            self._command_usage[cmd_name] = {
                "count": 0,
                "last_used": None,
                "errors": 0,
                "avg_time": 0,
                "total_time": 0
            }
        
        self._command_usage[cmd_name]["count"] += 1
        self._command_usage[cmd_name]["last_used"] = datetime.now().isoformat()
        
        self._log_event("command_executed", {
            "command": cmd_name,
            "user": str(ctx.author),
            "guild": ctx.guild.name if ctx.guild else "DM",
            "channel": ctx.channel.name if hasattr(ctx.channel, 'name') else "DM"
        })
    
    @commands.Cog.listener()
    async def on_command_error(self, ctx, error):
        cmd_name = ctx.command.qualified_name if ctx.command else "unknown"
        if cmd_name in self._command_usage:
            self._command_usage[cmd_name]["errors"] += 1
        
        self._log_event("command_error", {
            "command": cmd_name,
            "error": str(error),
            "user": str(ctx.author),
            "guild": ctx.guild.name if ctx.guild else "DM"
        })
    
    @commands.Cog.listener()
    async def on_guild_join(self, guild):
        self._log_event("guild_join", {
            "guild": guild.name,
            "guild_id": guild.id,
            "member_count": guild.member_count
        })
    
    @commands.Cog.listener()
    async def on_guild_remove(self, guild):
        self._log_event("guild_remove", {
            "guild": guild.name,
            "guild_id": guild.id
        })
    
    @commands.Cog.listener()
    async def on_message(self, message):
        if message.author.bot:
            return
        
        if len(self._event_log) == 0 or self._event_log[-1].get("type") != "message_activity":
            self._log_event("message_activity", {
                "count": 1,
                "last_author": str(message.author),
                "last_guild": message.guild.name if message.guild else "DM"
            })
        else:
            last_event = self._event_log[-1]
            last_event["details"]["count"] = last_event["details"].get("count", 0) + 1
            last_event["details"]["last_author"] = str(message.author)
            last_event["details"]["last_guild"] = message.guild.name if message.guild else "DM"
            last_event["timestamp"] = datetime.now().isoformat()
    
    def _load_config(self) -> Dict[str, Any]:
        if self.config_file.exists():
            try:
                with open(self.config_file, 'r') as f:
                    return json.load(f)
            except:
                pass

        return {
            "enabled": False,
            "secret_token": None,
            "website_url": None,
            "update_interval": 5,
            "verbose_logging": False,
            "setup_token": None,
        }

    def _get_default_prefix(self) -> str:
        """Best-effort fetch of the global/default prefix from config.json.
        Falls back to '!' if anything goes wrong.
        """
        try:
            config_path = Path("./config.json")
            if config_path.exists():
                with open(config_path, "r", encoding="utf-8") as f:
                    cfg = json.load(f)
                prefix = cfg.get("prefix")
                if isinstance(prefix, str) and prefix:
                    return prefix
        except Exception as e:
            logger.error(f"Live Monitor: Failed to read default prefix from config.json: {e}")
        return "!"
    
    def _save_config(self):
        try:
            with open(self.config_file, 'w') as f:
                json.dump(self.config, f, indent=4)
        except Exception as e:
            logger.error(f"Live Monitor: Failed to save config: {e}")
    



    
    def _discover_dashboard_plugins(self) -> List[Dict[str, Any]]:
        """
        Scan the extensions folder for dashboard-compatible plugins.
        
        A plugin is recognized if it has:
        - DASHBOARD_COMPATIBLE = True
        - DASHBOARD_PLUGIN = {...} configuration dict
        
        Returns:
            List of plugin configurations with extracted HTML/CSS/JS
        """
        plugins = []
        extensions_dir = Path("./extensions")
        
        if not extensions_dir.exists():
            logger.info("Dashboard Plugin System: extensions/ folder not found")
            return plugins
        

        for py_file in extensions_dir.rglob("*.py"):
            try:
                plugin = self._extract_plugin_from_file(py_file)
                if plugin:
                    plugins.append(plugin)
                    logger.info(f"Dashboard Plugin System: Discovered plugin '{plugin['id']}' from {py_file}")
            except Exception as e:
                logger.error(f"Dashboard Plugin System: Error scanning {py_file}: {e}")
        

        plugins.sort(key=lambda p: p.get('position', 99))
        
        logger.info(f"Dashboard Plugin System: Found {len(plugins)} compatible plugin(s)")
        return plugins
    
    def _extract_plugin_from_file(self, file_path: Path) -> Optional[Dict[str, Any]]:
        """
        Extract plugin configuration from a Python file.
        
        Uses AST parsing for safety - doesn't execute the file.
        """
        try:
            content = file_path.read_text(encoding='utf-8')
        except Exception as e:
            logger.error(f"Could not read {file_path}: {e}")
            return None
        

        if 'DASHBOARD_COMPATIBLE' not in content:
            return None
        

        try:
            tree = ast.parse(content)
        except SyntaxError as e:
            logger.error(f"Syntax error in {file_path}: {e}")
            return None
        

        assignments = {}
        for node in ast.walk(tree):
            if isinstance(node, ast.Assign):
                for target in node.targets:
                    if isinstance(target, ast.Name):
                        try:
                            if isinstance(node.value, ast.Constant):
                                assignments[target.id] = node.value.value
                            elif isinstance(node.value, ast.Dict):
                                assignments[target.id] = self._ast_dict_to_python(node.value)
                            elif isinstance(node.value, ast.NameConstant):
                                assignments[target.id] = node.value.value
                        except Exception:
                            pass
        

        if assignments.get('DASHBOARD_COMPATIBLE') is not True:
            return None
        

        plugin_config = assignments.get('DASHBOARD_PLUGIN')
        if not plugin_config or not isinstance(plugin_config, dict):
            logger.warning(f"DASHBOARD_COMPATIBLE=True but no valid DASHBOARD_PLUGIN in {file_path}")
            return None
        

        if 'id' not in plugin_config or 'name' not in plugin_config:
            logger.warning(f"Plugin in {file_path} missing required 'id' or 'name' field")
            return None
        

        plugin_config['_html'] = self._extract_multiline_string(content, 'DASHBOARD_HTML')
        plugin_config['_css'] = self._extract_multiline_string(content, 'DASHBOARD_CSS')
        plugin_config['_js'] = self._extract_multiline_string(content, 'DASHBOARD_JS')
        plugin_config['_source_file'] = str(file_path)
        

        if 'permissions' not in plugin_config:
            plugin_config['permissions'] = {}
        if 'view' not in plugin_config['permissions']:
            plugin_config['permissions']['view'] = f"view_{plugin_config['id']}"
        if 'actions' not in plugin_config['permissions']:
            plugin_config['permissions']['actions'] = []
        
        return plugin_config
    
    def _ast_dict_to_python(self, node: ast.Dict) -> dict:
        """Convert an AST Dict node to a Python dictionary."""
        result = {}
        for key, value in zip(node.keys, node.values):
            if isinstance(key, ast.Constant):
                k = key.value
            elif isinstance(key, ast.Str):
                k = key.s
            else:
                continue
            
            if isinstance(value, ast.Constant):
                result[k] = value.value
            elif isinstance(value, ast.Str):
                result[k] = value.s
            elif isinstance(value, ast.Num):
                result[k] = value.n
            elif isinstance(value, ast.NameConstant):
                result[k] = value.value
            elif isinstance(value, ast.List):
                result[k] = self._ast_list_to_python(value)
            elif isinstance(value, ast.Dict):
                result[k] = self._ast_dict_to_python(value)
        
        return result
    
    def _ast_list_to_python(self, node: ast.List) -> list:
        """Convert an AST List node to a Python list."""
        result = []
        for item in node.elts:
            if isinstance(item, ast.Constant):
                result.append(item.value)
            elif isinstance(item, ast.Str):
                result.append(item.s)
            elif isinstance(item, ast.Num):
                result.append(item.n)
            elif isinstance(item, ast.Dict):
                result.append(self._ast_dict_to_python(item))
            elif isinstance(item, ast.List):
                result.append(self._ast_list_to_python(item))
        return result
    
    def _extract_multiline_string(self, content: str, var_name: str) -> str:
        
        patterns = [
            rf'{var_name}\s*=\s*"""(.*?)"""',
            rf"{var_name}\s*=\s*'''(.*?)'''",
            rf'{var_name}\s*=\s*"([^"]*)"',
            rf"{var_name}\s*=\s*'([^']*)'",
        ]
        
        for pattern in patterns:
            match = re.search(pattern, content, re.DOTALL)
            if match:
                return match.group(1)
        
        return ""
    
    def _get_all_plugin_permissions(self, plugins: List[Dict]) -> Dict[str, List[Dict]]:
        """Extract all permissions from discovered plugins."""
        view_perms = []
        action_perms = []
        
        for plugin in plugins:
            perms = plugin.get('permissions', {})
            
            view_key = perms.get('view')
            if view_key:
                view_perms.append({
                    'key': view_key,
                    'label': f"{plugin['name']} (Plugin)",
                    'plugin_id': plugin['id']
                })
            
            for action in perms.get('actions', []):
                action_perms.append({
                    'key': action['key'],
                    'label': f"{action.get('label', action['key'])} (Plugin: {plugin['name']})",
                    'description': action.get('description', ''),
                    'dangerous': action.get('dangerous', False),
                    'plugin_id': plugin['id']
                })
        
        return {'view': view_perms, 'actions': action_perms}
    
    def _generate_plugin_sidebar_html(self, plugins: List[Dict]) -> str:
        """Generate the HTML for the Plugins section in the sidebar."""
        if not plugins:
            return ""
        
        items_html = ""
        for plugin in plugins:
            icon = plugin.get('icon', 'ğŸ“¦')
            name = plugin['name']
            plugin_id = plugin['id']
            view_perm = plugin.get('permissions', {}).get('view', f'view_{plugin_id}')
            
            if name.startswith(icon):
                name = name[len(icon):].strip()
            
            items_html += '''
                    <button class="lm-sidebar-item lm-plugin-item" data-tab="''' + plugin_id + '''" data-view-perm="''' + view_perm + '''">
                        ''' + icon + ''' ''' + name + '''
                    </button>'''
        
        return '''
                    <div class="lm-plugin-section" id="lm-plugin-section">
                        <div class="lm-sidebar-group-label lm-plugin-group-toggle" onclick="togglePluginDropdown()">
                            <span class="plugin-dropdown-arrow">â–¶</span> Plugins
                            <span class="plugin-count-badge" id="lm-plugin-visible-count">''' + str(len(plugins)) + '''</span>
                        </div>
                        <div class="lm-plugin-dropdown" id="lm-plugin-dropdown" style="display: none;">
                            ''' + items_html + '''
                        </div>
                    </div>'''
    
    def _generate_plugin_tabs_html(self, plugins: List[Dict]) -> str:
        """Generate the HTML tab content for each plugin."""
        if not plugins:
            return ""
        
        tabs_html = ""
        for plugin in plugins:
            plugin_id = plugin['id']
            plugin_name = plugin['name']
            css = plugin.get('_css', '')
            html = plugin.get('_html', '')
            js = plugin.get('_js', '')
            

            tab_content = '''
            <!-- Plugin Tab: ''' + plugin_name + ''' -->
            <div id="tab-''' + plugin_id + '''" class="tab-content">
                <style>
                    /* Plugin CSS: ''' + plugin_id + ''' */
                    ''' + css + '''
                </style>
                ''' + html + '''
                <script>
                    /* Plugin JS: ''' + plugin_id + ''' */
                    ''' + js + '''
                </script>
            </div>
            '''
            tabs_html += tab_content
        
        return tabs_html
    
    def _generate_plugin_permission_js(self, plugins: List[Dict]) -> str:
        """Generate JavaScript to add plugin permissions to VIEW_PERM_DEFS and CONTROL_PERM_DEFS."""
        if not plugins:
            return ""
        
        all_perms = self._get_all_plugin_permissions(plugins)
        
        view_additions = json.dumps(all_perms['view'])
        action_additions = json.dumps(all_perms['actions'])
        
        return f'''
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Dashboard Plugin System - Permission Injection
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            (function() {{
                const pluginViewPerms = {view_additions};
                const pluginActionPerms = {action_additions};
                
                if (typeof VIEW_PERM_DEFS !== 'undefined') {{
                    pluginViewPerms.forEach(p => VIEW_PERM_DEFS.push({{ key: p.key, label: p.label }}));
                }}
                
                if (typeof CONTROL_PERM_DEFS !== 'undefined') {{
                    pluginActionPerms.forEach(p => CONTROL_PERM_DEFS.push({{ key: p.key, label: p.label }}));
                }}
                
                console.log('[Dashboard Plugins] Registered ' + pluginViewPerms.length + ' view permissions');
                console.log('[Dashboard Plugins] Registered ' + pluginActionPerms.length + ' action permissions');
            }})();
        '''
    
    def _generate_plugin_tab_mapping_js(self, plugins: List[Dict]) -> str:
        """Generate JavaScript to add plugin tabs to the permission mappin"""
        if not plugins:
            return ""
        
        mappings = []
        for plugin in plugins:
            plugin_id = plugin['id']
            view_perm = plugin.get('permissions', {}).get('view', f'view_{plugin_id}')
            mappings.append(f"'{plugin_id}': '{view_perm}'")
        
        return f'''
            // Plugin tab permission mappings
            const PLUGIN_TAB_PERMS = {{
                {', '.join(mappings)}
            }};
            
            // Extend tab permission checking for plugins
            const _origIsTabAllowed = typeof isTabAllowedByPerms === 'function' ? isTabAllowedByPerms : null;
            window.isTabAllowedByPermsWithPlugins = function(tabName) {{
                if (PLUGIN_TAB_PERMS[tabName]) {{
                    return typeof LM_PERMS !== 'undefined' && !!LM_PERMS[PLUGIN_TAB_PERMS[tabName]];
                }}
                return _origIsTabAllowed ? _origIsTabAllowed(tabName) : true;
            }};
        '''
    
    def _generate_plugin_dropdown_js(self) -> str:
        """Generate JavaScript for the plugin dropdown toggle."""
        return '''
            function togglePluginDropdown() {
                const dropdown = document.getElementById('lm-plugin-dropdown');
                const arrow = document.querySelector('#lm-plugin-section .plugin-dropdown-arrow');
                
                if (dropdown.style.display === 'none') {
                    dropdown.style.display = 'block';
                    if (arrow) arrow.textContent = 'â–¼';
                } else {
                    dropdown.style.display = 'none';
                    if (arrow) arrow.textContent = 'â–¶';
                }
            }
            
            function toggleDrawerPluginDropdown() {
                const dropdown = document.getElementById('lm-drawer-plugin-dropdown');
                const arrow = document.querySelector('#lm-drawer-plugin-section .plugin-dropdown-arrow');
                
                if (dropdown.style.display === 'none') {
                    dropdown.style.display = 'block';
                    if (arrow) arrow.textContent = 'â–¼';
                } else {
                    dropdown.style.display = 'none';
                    if (arrow) arrow.textContent = 'â–¶';
                }
            }
        '''
    
    def _generate_plugin_dropdown_css(self) -> str:
        """Generate CSS for the plugin dropdown."""
        return '''
            /* Dashboard Plugin System - Sidebar Styles */
            .lm-plugin-group-toggle {
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                user-select: none;
            }
            
            .lm-plugin-group-toggle:hover {
                color: #a855f7;
            }
            
            .plugin-dropdown-arrow {
                font-size: 10px;
                transition: transform 0.2s ease;
            }
            
            .plugin-count-badge {
                background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
                color: white;
                font-size: 10px;
                font-weight: 600;
                padding: 2px 6px;
                border-radius: 10px;
                margin-left: auto;
            }
            
            .lm-plugin-dropdown {
                margin-left: 12px;
                border-left: 2px solid rgba(148, 163, 184, 0.2);
                padding-left: 8px;
            }
            
            .lm-plugin-item {
                font-size: 13px !important;
                padding: 8px 12px !important;
            }
        '''
    
    def _generate_plugin_owner_permissions_php(self, plugins: List[Dict]) -> str:
        """Generate PHP array entries for plugin permissions (for OWNER tier)."""
        if not plugins:
            return ""
        
        lines = []
        for plugin in plugins:
            perms = plugin.get('permissions', {})
            
            view_perm = perms.get('view')
            if view_perm:
                lines.append(f"            '{view_perm}' => true,")
            
            for action in perms.get('actions', []):
                lines.append(f"            '{action['key']}' => true,")
        
        return '\n'.join(lines)
    
    def _generate_plugin_api_php(self, plugins: List[Dict]) -> str:
        """Generate plugin_api.php for routing API calls to plugins."""
        perm_map = {}
        for plugin in plugins:
            plugin_id = plugin['id']
            perm_map[plugin_id] = {}
            
            for endpoint in plugin.get('api_endpoints', []):
                action = endpoint.get('action')
                requires = endpoint.get('requires_permission')
                if action:
                    perm_map[plugin_id][action] = requires
        

        def to_php_array(obj, indent=0):
            spaces = '    ' * indent
            if obj is None:
                return 'null'
            elif isinstance(obj, bool):
                return 'true' if obj else 'false'
            elif isinstance(obj, str):
                return f"'{obj}'"
            elif isinstance(obj, dict):
                if not obj:
                    return '[]'
                items = []
                for k, v in obj.items():
                    items.append(f"{spaces}    '{k}' => {to_php_array(v, indent + 1)}")
                return '[\n' + ',\n'.join(items) + f'\n{spaces}]'
            elif isinstance(obj, list):
                if not obj:
                    return '[]'
                items = [to_php_array(item, indent + 1) for item in obj]
                return '[' + ', '.join(items) + ']'
            else:
                return str(obj)
        
        perm_map_php = to_php_array(perm_map)
        
        return '''<?php
/**
 * Dashboard Plugin System - API Router
 * 
 * Routes API requests to the appropriate plugin handler on the bot.
 * Generated by Zoryx Discord Bot Framework
 */

require_once __DIR__ . '/lm_auth.php';

lm_start_session_if_needed();
lm_ensure_schema();

$user = lm_current_user();
if (!$user) {
    http_response_code(403);
    header('Content-Type: application/json');
    echo json_encode(['error' => 'Authentication required']);
    exit;
}

// Permission requirements by plugin and action
$PLUGIN_PERMISSIONS = ''' + perm_map_php + ''';

$pluginId = $_GET['plugin'] ?? '';
$action = $_GET['action'] ?? '';

if (!$pluginId || !$action) {
    http_response_code(400);
    header('Content-Type: application/json');
    echo json_encode(['error' => 'Missing plugin or action parameter']);
    exit;
}

// Check permission for this action if defined
if (isset($PLUGIN_PERMISSIONS[$pluginId][$action])) {
    $requiredPerm = $PLUGIN_PERMISSIONS[$pluginId][$action];
    if ($requiredPerm) {
        $roleName = $user['role'] ?? 'CUSTOM';
        $roleTier = lm_resolve_role_tier($roleName);
        $rolePerms = lm_role_permissions($roleName, $roleTier);
        
        if (empty($rolePerms[$requiredPerm])) {
            http_response_code(403);
            header('Content-Type: application/json');
            echo json_encode([
                'error' => 'Permission denied',
                'required' => $requiredPerm
            ]);
            exit;
        }
    }
}

// Get POST data if any
$postData = null;
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $postData = json_decode(file_get_contents('php://input'), true);
}

// Queue request for bot to process
$queueFile = __DIR__ . '/monitor_data_plugin_requests.json';
$requests = [];

if (file_exists($queueFile)) {
    $json = file_get_contents($queueFile);
    $requests = json_decode($json, true) ?: [];
}

$requestId = uniqid('req_', true);
$request = [
    'id' => $requestId,
    'plugin' => $pluginId,
    'action' => $action,
    'data' => $postData,
    'user' => $user['username'] ?? 'unknown',
    'timestamp' => date('c')
];

$requests[] = $request;
$requests = array_slice($requests, -100);

file_put_contents($queueFile, json_encode($requests, JSON_PRETTY_PRINT));

// Wait for response (polling with timeout)
$responseFile = __DIR__ . "/monitor_data_plugin_response_$requestId.json";
$timeout = 10;
$start = time();

while (time() - $start < $timeout) {
    if (file_exists($responseFile)) {
        $response = json_decode(file_get_contents($responseFile), true);
        @unlink($responseFile);
        
        header('Content-Type: application/json');
        echo json_encode($response);
        exit;
    }
    usleep(100000);
}

header('Content-Type: application/json');
echo json_encode([
    'status' => 'pending',
    'request_id' => $requestId,
    'message' => 'Request queued, bot may be offline or busy'
]);
?>'''
    
    async def _process_plugin_api_requests(self):
        """Process pending plugin API requests from the dashboard."""
        if not self.config.get("website_url"):
            return
        
        base_url = str(self.config["website_url"]).rstrip("/")
        token = self.config.get("secret_token", "")
        

        try:
            async with aiohttp.ClientSession() as session:
                url = f"{base_url}/monitor_data_plugin_requests.json"
                async with session.get(url, timeout=aiohttp.ClientTimeout(total=5)) as resp:
                    if resp.status != 200:
                        return
                    requests = await resp.json()
        except Exception:
            return
        
        if not requests:
            return
        
        processed_ids = []
        
        for req in requests:
            request_id = req.get('id')
            plugin_id = req.get('plugin')
            action = req.get('action')
            data = req.get('data')
            
            if not plugin_id or not action or not request_id:
                continue
            
            response = {'error': f'Plugin {plugin_id} not found or not loaded'}
            

            for cog in self.bot.cogs.values():
                try:
                    cog_module = type(cog).__module__
                    import importlib
                    module = importlib.import_module(cog_module)
                    if getattr(module, 'DASHBOARD_COMPATIBLE', False):
                        plugin_config = getattr(module, 'DASHBOARD_PLUGIN', {})
                        if plugin_config.get('id') == plugin_id:
                            if hasattr(cog, 'handle_plugin_api'):
                                try:
                                    response = await cog.handle_plugin_api(action, data)
                                except Exception as e:
                                    response = {'error': str(e)}
                            else:
                                response = {'error': f'Plugin {plugin_id} has no API handler'}
                            break
                except Exception as e:
                    logger.error(f"Error finding plugin cog: {e}")
            

            try:
                response_url = f"{base_url}/receive.php?token={token}&package=plugin_response"
                async with aiohttp.ClientSession() as session:
                    payload = {
                        'request_id': request_id,
                        'response': response
                    }
                    async with session.post(response_url, json=payload, timeout=aiohttp.ClientTimeout(total=5)) as resp:
                        pass
            except Exception as e:
                logger.error(f"Failed to send plugin response: {e}")
            
            processed_ids.append(request_id)
        

        if processed_ids:
            try:
                clear_url = f"{base_url}/receive.php?token={token}&package=plugin_requests_clear"
                async with aiohttp.ClientSession() as session:
                    async with session.post(clear_url, json={'ids': processed_ids}, timeout=aiohttp.ClientTimeout(total=5)) as resp:
                        pass
            except Exception:
                pass
    




    def _log_event(self, event_type: str, details: Dict[str, Any]):
        self._event_log.append({
            "timestamp": datetime.now().isoformat(),
            "type": event_type,
            "details": details
        })
        if len(self._event_log) > self._max_event_log:
            self._event_log = self._event_log[-self._max_event_log:]
    
    def _log_hook_execution(self, hook_id: str, success: bool, execution_time: float, error: str = None):
        self._hook_execution_log.append({
            "timestamp": datetime.now().isoformat(),
            "hook_id": hook_id,
            "success": success,
            "execution_time_ms": round(execution_time, 2),
            "error": error
        })
        if len(self._hook_execution_log) > self._max_hook_execution_log:
            self._hook_execution_log = self._hook_execution_log[-self._max_hook_execution_log:]
    
    
    async def _get_db_command_stats(self) -> List[tuple]:
        if hasattr(self.bot, 'db') and self.bot.db:
            try:
                return await self.bot.db.get_command_stats()
            except Exception as e:
                logger.error(f"Failed to get DB command stats: {e}")
        return []
    
    def _get_command_type(self, cmd) -> str:
        from discord.ext.commands import HybridCommand
        
        if isinstance(cmd, HybridCommand):
            slash_limiter_cog = self.bot.get_cog("SlashLimiter")
            if slash_limiter_cog and cmd.name in slash_limiter_cog._converted_commands:
                return "prefix_only_converted"
            return "hybrid"
        
        if hasattr(cmd, 'app_command') and cmd.app_command is not None:
            return "hybrid"
        
        return "prefix_only"
    
    async def _get_all_commands(self) -> List[Dict[str, Any]]:
        commands_list = []
        db_stats = await self._get_db_command_stats()
        db_stats_dict = {cmd: count for cmd, count in db_stats}
        
        for cmd in self.bot.commands:
            cmd_type = self._get_command_type(cmd)
            
            usage_count = 0
            if hasattr(self.bot, 'metrics') and hasattr(self.bot.metrics, 'command_count'):
                usage_count = self.bot.metrics.command_count.get(cmd.qualified_name, 0)
            
            db_count = db_stats_dict.get(cmd.qualified_name, 0)
            usage_count = max(usage_count, db_count)
            
            usage = self._command_usage.get(cmd.qualified_name, {
                "count": usage_count,
                "last_used": None,
                "errors": 0,
                "avg_time": 0
            })
            
            commands_list.append({
                "name": cmd.qualified_name,
                "type": cmd_type,
                "cog": cmd.cog.qualified_name if cmd.cog else None,
                "enabled": cmd.enabled,
                "hidden": cmd.hidden,
                "description": cmd.short_doc or cmd.help or "No description",
                "usage_count": max(usage["count"], usage_count),
                "last_used": usage["last_used"],
                "error_count": usage["errors"],
                "aliases": list(cmd.aliases) if hasattr(cmd, 'aliases') else [],
                "params": [p for p in cmd.clean_params.keys()] if hasattr(cmd, 'clean_params') else []
            })
        
        if hasattr(self.bot, 'tree'):
            for cmd in self.bot.tree.walk_commands():
                usage = self._command_usage.get(cmd.qualified_name, {
                    "count": 0,
                    "last_used": None,
                    "errors": 0,
                    "avg_time": 0
                })
                
                commands_list.append({
                    "name": cmd.qualified_name,
                    "type": "slash",
                    "cog": None,
                    "enabled": True,
                    "hidden": False,
                    "description": cmd.description or "No description",
                    "usage_count": usage["count"],
                    "last_used": usage["last_used"],
                    "error_count": usage["errors"],
                    "aliases": [],
                    "params": []
                })
        
        return commands_list
    
    def _get_file_system_info(self) -> Dict[str, Any]:
        data_dir = Path("./data")
        cogs_dir = Path("./cogs")
        extensions_dir = Path("./extensions")
        botlogs_dir = Path("./botlogs")

        def get_dir_info(path: Path, name: str) -> Dict[str, Any]:
            if not path.exists():
                return {
                    "exists": False,
                    "file_count": 0,
                    "total_size": 0,
                    "path": str(path),
                    "name": name
                }

            try:
                files = list(path.rglob("*"))
                file_count = sum(1 for item in files if item.is_file())
                total_size = sum(item.stat().st_size for item in files if item.is_file())
            except Exception as e:
                logger.error(f"Error scanning {path}: {e}")
                file_count = 0
                total_size = 0

            return {
                "exists": True,
                "file_count": file_count,
                "total_size": total_size,
                "path": str(path),
                "name": name
            }

        return {
            "data": get_dir_info(data_dir, "./data"),
            "cogs": get_dir_info(cogs_dir, "./cogs"),
            "extensions": get_dir_info(extensions_dir, "./extensions"),
            "botlogs": get_dir_info(botlogs_dir, "./botlogs")
        }

    def _get_dashboard_assets(self) -> List[Path]:
        """Return a list of local asset files to ship with the Live Monitor dashboard.

        These are optional; if they don't exist the dashboard still works, just
        without branding. Expected filenames in ./assets/ are:
          - zoryx-framework.png
          - zoryx-framework.ico
          - banner.png
        """
        assets: List[Path] = []
        try:
            if not self.local_assets_dir.exists():
                return assets
            for name in ("zoryx-framework.png", "zoryx-framework.ico", "banner.png"):
                p = self.local_assets_dir / name
                if p.exists() and p.is_file():
                    assets.append(p)
        except Exception as e:
            logger.error(f"Live Monitor: Failed to enumerate dashboard assets: {e}")
        return assets

    def _copy_dashboard_assets(self, output_dir: Path) -> None:
        """Copy local dashboard assets into the generated website folder.

        This prepares an /assets directory next to index.html so users can
        simply upload everything as-is to their web hosting.
        """
        try:
            files = self._get_dashboard_assets()
            if not files:
                return

            target_dir = output_dir / "assets"
            target_dir.mkdir(parents=True, exist_ok=True)

            for src in files:
                dest = target_dir / src.name
                try:
                    shutil.copy2(src, dest)
                except Exception as e:
                    logger.error(f"Live Monitor: Failed to copy asset {src} -> {dest}: {e}")
        except Exception as e:
            logger.error(f"Live Monitor: Failed to prepare dashboard assets: {e}")

    async def _sync_assets_to_server_once(self) -> None:
        """Best-effort sync of branding assets to the remote dashboard server.

        This sends a one-off JSON package with base64-encoded files to
        receive.php?package=assets, which will write them into /assets on the
        web host so the dashboard can use them immediately.
        """
        if not self.config.get("website_url") or not self.config.get("secret_token"):
            return

        files = self._get_dashboard_assets()
        if not files:
            return

        base_url = str(self.config["website_url"]).rstrip("/")
        token = self.config["secret_token"]
        url = f"{base_url}/receive.php?token={token}&package=assets"

        payload = []
        for src in files:
            try:
                data = src.read_bytes()
            except Exception as e:
                logger.error(f"Live Monitor: Failed to read asset {src}: {e}")
                continue
            import base64
            payload.append({
                "filename": src.name,
                "content": base64.b64encode(data).decode("ascii"),
            })

        if not payload:
            return

        try:
            async with aiohttp.ClientSession() as session:
                async with session.post(url, json=payload, timeout=aiohttp.ClientTimeout(total=20)) as resp:
                    if resp.status != 200:
                        logger.warning(f"Live Monitor: Asset sync failed with HTTP {resp.status}")
                    else:
                        logger.info("Live Monitor: Dashboard assets synced to remote server")
        except Exception as e:
            logger.error(f"Live Monitor: Error syncing dashboard assets to server: {e}")
    
    @commands.Cog.listener()
    async def on_command(self, ctx):
        cmd_name = ctx.command.qualified_name if ctx.command else "unknown"
        if cmd_name not in self._command_usage:
            self._command_usage[cmd_name] = {
                "count": 0,
                "last_used": None,
                "errors": 0,
                "avg_time": 0,
                "total_time": 0
            }
        self._command_usage[cmd_name]["count"] += 1
        self._command_usage[cmd_name]["last_used"] = datetime.now().isoformat()
    
    @commands.Cog.listener()
    async def on_command_error(self, ctx, error):
        cmd_name = ctx.command.qualified_name if ctx.command else "unknown"
        if cmd_name in self._command_usage:
            self._command_usage[cmd_name]["errors"] += 1
        
        self._log_event("command_error", {
            "command": cmd_name,
            "error": str(error)[:200],
            "user": str(ctx.author)
        })
    
    @commands.Cog.listener()
    async def on_app_command_completion(self, interaction: discord.Interaction, command):
        cmd_name = command.qualified_name if hasattr(command, 'qualified_name') else str(command)
        if cmd_name not in self._command_usage:
            self._command_usage[cmd_name] = {
                "count": 0,
                "last_used": None,
                "errors": 0,
                "avg_time": 0,
                "total_time": 0
            }
        self._command_usage[cmd_name]["count"] += 1
        self._command_usage[cmd_name]["last_used"] = datetime.now().isoformat()
    
    async def cog_load(self):
        logger.info(f"Live Monitor: Config loaded - enabled={self.config.get('enabled')}, website_url={self.config.get('website_url')}, has_token={bool(self.config.get('secret_token'))}")
        if self.config.get("enabled") and self.config.get("website_url"):
            self.is_enabled = True
            interval = self.config.get("update_interval", 5)
            self.send_status_loop.change_interval(seconds=interval)
            self.send_status_loop.start()
            logger.info(f"Live Monitor: Auto-started from saved config (sending data every {interval} seconds to {self.config.get('website_url')})")
        else:
            logger.warning(f"Live Monitor: NOT auto-started - enabled={self.config.get('enabled')}, has_website_url={bool(self.config.get('website_url'))}")
    
    def cog_unload(self):
        if self.send_status_loop.is_running():
            self.send_status_loop.cancel()
        

        plugin_registry_path = Path("./data/plugin_registry.json")
        if plugin_registry_path.exists():
            try:
                plugin_registry_path.unlink()
                logger.info("Live Monitor: Deleted plugin_registry.json for clean restart")
            except Exception as e:
                logger.warning(f"Live Monitor: Could not delete plugin_registry.json: {e}")
        
        logger.info("Live Monitor: Cog unloaded")
    
    async def _get_process(self):
        if self._process is None:
            loop = asyncio.get_event_loop()
            self._process = await loop.run_in_executor(None, psutil.Process)
        return self._process
    
    async def _collect_monitor_data(self) -> Dict[str, Any]:
        collection_start = time.time()
        loop = asyncio.get_event_loop()
        process = await self._get_process()
        

        guild_summaries = []
        try:
            for g in self.bot.guilds:
                text_channels = []
                for ch in getattr(g, 'text_channels', []):
                    try:
                        is_nsfw = False
                        if hasattr(ch, 'is_nsfw') and callable(ch.is_nsfw):
                            is_nsfw = ch.is_nsfw()
                        else:
                            is_nsfw = getattr(ch, 'nsfw', False)
                        text_channels.append({
                            "id": str(ch.id),
                            "name": ch.name,
                            "nsfw": bool(is_nsfw),
                        })
                    except Exception:
                        continue
                guild_summaries.append({
                    "id": str(g.id),
                    "name": g.name,
                    "member_count": getattr(g, 'member_count', 0) or 0,
                    "owner_id": str(getattr(g, 'owner_id', '')),
                    "owner": str(getattr(getattr(g, 'owner', None), 'name', '')),
                    "joined_at": getattr(getattr(g, 'me', None), 'joined_at', None).isoformat() if getattr(getattr(g, 'me', None), 'joined_at', None) else None,
                    "text_channels": text_channels,
                })
        except Exception as e:
            logger.error(f"Live Monitor: Failed to build guild summaries: {e}")
        
        chat_history = getattr(self, "_last_chat_history", None)


        
        def _get_system_info():
            memory_info = process.memory_info()
            cpu_times = process.cpu_times()
            
            cpu_value = process.cpu_percent(interval=None)
            if cpu_value == 0:
                time.sleep(0.1)
                cpu_value = process.cpu_percent(interval=None)
            
            return {
                "cpu_percent": round(cpu_value, 1),
                "memory_mb": round(memory_info.rss / 1024 / 1024, 2),
                "memory_percent": process.memory_percent(),
                "threads": process.num_threads(),
                "open_files": len(process.open_files()),
                "connections": len(process.connections()),
                "cpu_user_time": cpu_times.user,
                "cpu_system_time": cpu_times.system,
                "platform": platform.system()
            }
        
        try:
            system_info = await loop.run_in_executor(None, _get_system_info)
        except:
            system_info = {"cpu_percent": 0, "memory_mb": 0, "threads": 0, "open_files": 0, "connections": 0}
        
        uptime = (datetime.now() - self._start_time).total_seconds()
        
        user_extensions_count = len([e for e in self.bot.extensions.keys() if e.startswith("extensions.")])
        framework_cogs_count = len([e for e in self.bot.extensions.keys() if e.startswith("cogs.")])
        
        bot_info = {
            "user": str(self.bot.user) if self.bot.user else "Unknown",
            "id": str(self.bot.user.id) if self.bot.user else "0",
            "guilds": len(self.bot.guilds),
            "users": sum(g.member_count for g in self.bot.guilds if g.member_count),
            "latency": round(self.bot.latency * 1000, 2),
            "uptime_seconds": int(uptime),
            "uptime_formatted": str(timedelta(seconds=int(uptime))),
            "cogs_loaded": len(self.bot.cogs),
            "extensions_loaded": len(self.bot.extensions),
            "user_extensions": user_extensions_count,
            "framework_cogs": framework_cogs_count,
            "guilds_detail": guild_summaries,
        }
        
        core_data = {
            "timestamp": datetime.now().isoformat(),
            "bot": bot_info,
            "system": system_info,
            "health": {},
        }
        if chat_history is not None:
            core_data["chat_history"] = chat_history
        
        event_hooks_data = {}
        if hasattr(self.bot, 'list_hooks'):
            try:
                event_hooks_cog = self.bot.get_cog("EventHooks")
                if event_hooks_cog:
                    hooks_list = []
                    
                    for event_name, callbacks in event_hooks_cog.hooks.items():
                        for hook_info in callbacks:
                            hook_id = hook_info["hook_id"]
                            
                            exec_history = [h for h in self._hook_execution_log if h["hook_id"] == hook_id][-5:]
                            
                            hooks_list.append({
                                "hook_id": hook_id,
                                "event": event_name,
                                "callback": hook_info["callback"].__name__,
                                "priority": hook_info["priority"],
                                "execution_count": hook_info["execution_count"],
                                "failure_count": hook_info["failure_count"],
                                "avg_time_ms": round(hook_info["total_execution_time"] / hook_info["execution_count"], 2) if hook_info["execution_count"] > 0 else 0,
                                "last_execution": hook_info.get("last_execution", "Never"),
                                "disabled": hook_id in event_hooks_cog.disabled_hooks,
                                "circuit_open": event_hooks_cog.circuit_breaker.is_open(hook_id),
                                "execution_history": exec_history
                            })
                    
                    event_hooks_data = {
                        "total": len(hooks_list),
                        "disabled": len(event_hooks_cog.disabled_hooks),
                        "circuit_open": len([h for h in event_hooks_cog.circuit_breaker.disabled_until.keys()]),
                        "queue_size": event_hooks_cog._hook_queue.qsize(),
                        "metrics": event_hooks_cog.metrics,
                        "hooks": hooks_list
                    }
            except Exception as e:
                logger.error(f"Live Monitor: Failed to collect event hooks data: {e}")
        
        slash_limiter_data = {}
        slash_limiter_cog = self.bot.get_cog("SlashLimiter")
        if slash_limiter_cog:
            try:
                status = await slash_limiter_cog.check_slash_command_limit()
                slash_limiter_data = {
                    "current": status.get("current", 0),
                    "limit": slash_limiter_cog.DISCORD_SLASH_LIMIT,
                    "remaining": status.get("remaining", 0),
                    "percentage": status.get("percentage", 0),
                    "status": status.get("status", "unknown"),
                    "blocked": len(slash_limiter_cog._blocked_commands),
                    "converted": len(slash_limiter_cog._converted_commands),
                    "blocked_list": [
                        {
                            "name": name,
                            "timestamp": info.get("timestamp", "Unknown")
                        }
                        for name, info in list(slash_limiter_cog._blocked_commands.items())[:10]
                    ],
                    "converted_list": [
                        {
                            "original": info["original_name"],
                            "converted": info["converted_name"],
                            "cog": info.get("cog", "Unknown")
                        }
                        for info in list(slash_limiter_cog._converted_commands.values())[:10]
                    ]
                }
            except Exception as e:
                logger.error(f"Live Monitor: Failed to collect slash limiter data: {e}")
        
        atomic_fs_data = {}
        if hasattr(self.bot.config, 'file_handler'):
            try:
                stats = self.bot.config.file_handler.get_cache_stats()
                atomic_fs_data = {
                    "cache_size": stats["cache_size"],
                    "max_cache_size": stats["max_cache_size"],
                    "hit_rate": stats["hit_rate"],
                    "active_locks": stats["active_locks"],
                    "total_reads": stats["total_reads"],
                    "total_writes": stats["total_writes"],
                    "write_failures": stats["write_failures"],
                    "read_failures": stats["read_failures"],
                }

                if hasattr(self.bot.config.file_handler, "get_lock_details"):
                    lock_info = self.bot.config.file_handler.get_lock_details()
                    atomic_fs_data["lock_summary"] = {
                        "total": lock_info.get("total_locks", 0),
                        "active": lock_info.get("active_locks", 0),
                    }
                    atomic_fs_data["locks"] = lock_info.get("locks", [])
            except Exception as e:
                logger.error(f"Live Monitor: Failed to collect atomic FS data: {e}")


        core_settings = {}
        framework_info = {}
        try:
            if hasattr(self.bot, "config") and self.bot.config is not None:
                core_settings = {
                    "auto_reload": bool(self.bot.config.get("auto_reload", False)),
                    "extensions_auto_load": bool(self.bot.config.get("extensions.auto_load", True)),
                }
                fw_section = self.bot.config.get("framework", {}) or {}
                framework_info = {
                    "version": "1.5.6",
                    "recommended_python": fw_section.get("recommended_python", "3.12.7"),
                    "python_runtime": f"{sys.version_info.major}.{sys.version_info.minor}.{sys.version_info.micro}",
                    "docs_url": "https://zsync.eu/zdbf",
                    "github_url": "https://github.com/TheHolyOneZ/discord-bot-framework",
                    "support_url": "https://zsync.eu/zygnalbot/support.html",
                }
        except Exception as e:
            logger.error(f"Live Monitor: Failed to collect core settings/framework info: {e}")
        
        plugins_data = {}
        plugin_registry_cog = self.bot.get_cog("PluginRegistry")
        plugins_list = []
        

        loaded_plugin_names = set()
        if plugin_registry_cog:
            try:
                all_plugins = plugin_registry_cog.get_all_plugins()
                
                for name, metadata in all_plugins.items():
                    loaded_plugin_names.add(name)
                    deps_ok, dep_messages = plugin_registry_cog.check_dependencies(name)
                    has_conflicts, conflict_messages = plugin_registry_cog.detect_conflicts(name)
                    has_cycle, cycle_path = plugin_registry_cog._detect_circular_dependencies(name)
                    
                    plugin_commands = list(metadata.commands)[:20]
                    
                    if metadata.cogs:
                        for cog_name in metadata.cogs:
                            cog = self.bot.get_cog(cog_name)
                            if cog and hasattr(cog, 'get_app_commands'):
                                try:
                                    for app_cmd in cog.get_app_commands():
                                        cmd_name = app_cmd.qualified_name if hasattr(app_cmd, 'qualified_name') else app_cmd.name
                                        if cmd_name not in plugin_commands and len(plugin_commands) < 20:
                                            plugin_commands.append(cmd_name)
                                except:
                                    pass
                    
                    plugins_list.append({
                        "name": name,
                        "version": metadata.version,
                        "author": metadata.author,
                        "description": metadata.description,
                        "commands": plugin_commands,
                        "commands_count": len(plugin_commands),
                        "cogs": list(metadata.cogs),
                        "cogs_count": len(metadata.cogs),
                        "dependencies": metadata.dependencies,
                        "conflicts_with": list(metadata.conflicts_with),
                        "provides_hooks": metadata.provides_hooks,
                        "listens_to_hooks": metadata.listens_to_hooks,
                        "loaded_at": metadata.loaded_at,
                        "load_time": metadata.load_time,
                        "file_path": str(metadata.file_path) if metadata.file_path else None,
                        "deps_ok": deps_ok,
                        "has_conflicts": has_conflicts,
                        "has_cycle": has_cycle,
                        "scan_errors": metadata.scan_errors,
                        "dep_messages": dep_messages if not deps_ok else [],
                        "conflict_messages": conflict_messages if has_conflicts else [],
                        "loaded": f"extensions.{name}" in self.bot.extensions
                    })
            except Exception as e:
                logger.error(f"Live Monitor: Failed to collect plugins data: {e}")
        

        extensions_path = Path("./extensions")
        if extensions_path.exists():
            for filepath in extensions_path.glob("*.py"):
                ext_name = filepath.stem
                

                if ext_name in loaded_plugin_names:
                    continue
                

                full_name = f"extensions.{ext_name}"
                is_loaded = full_name in self.bot.extensions
                load_time = self.bot.extension_load_times.get(ext_name, 0) if hasattr(self.bot, 'extension_load_times') else 0
                
                plugins_list.append({
                    "name": ext_name,
                    "version": "unknown",
                    "author": "unknown",
                    "description": "Extension file exists but not loaded or failed to load",
                    "commands": [],
                    "commands_count": 0,
                    "cogs": [],
                    "cogs_count": 0,
                    "dependencies": {},
                    "conflicts_with": [],
                    "provides_hooks": [],
                    "listens_to_hooks": [],
                    "loaded_at": None,
                    "load_time": load_time,
                    "file_path": str(filepath),
                    "deps_ok": True,  
                    "has_conflicts": False,  
                    "has_cycle": False,  
                    "scan_errors": [],
                    "dep_messages": [],
                    "conflict_messages": [],
                    "loaded": is_loaded
                })
        

        plugins_data = {
            "total": len(plugins_list),
            "plugins": plugins_list,
            "enforce_dependencies": bool(getattr(plugin_registry_cog, "enforce_dependencies", False)) if plugin_registry_cog else False,
            "enforce_conflicts": bool(getattr(plugin_registry_cog, "enforce_conflicts", False)) if plugin_registry_cog else False,
        }
        
        available_extensions = []
        extensions_path = Path("./extensions")
        if extensions_path.exists():
            for filepath in extensions_path.glob("*.py"):
                ext_name = filepath.stem
                full_name = f"extensions.{ext_name}"
                is_loaded = full_name in self.bot.extensions
                
                load_time = self.bot.extension_load_times.get(ext_name, 0) if hasattr(self.bot, 'extension_load_times') else 0
                
                available_extensions.append({
                    "name": ext_name,
                    "full_name": full_name,
                    "file_path": str(filepath),
                    "loaded": is_loaded,
                    "load_time": load_time
                })
        
        diagnostics_cog = self.bot.get_cog("FrameworkDiagnostics")
        health_data = {}
        if diagnostics_cog:
            try:
                error_rate = diagnostics_cog._calculate_error_rate()
                health_data = {
                    "error_rate": error_rate,
                    "status": "critical" if error_rate >= 10 else "degraded" if error_rate >= 5 else "healthy",
                    "event_loop_lag_ms": round(diagnostics_cog.health_metrics.get("event_loop_lag_ms", 0), 2),
                    "consecutive_write_failures": diagnostics_cog.health_metrics.get("consecutive_write_failures", 0)
                }
            except Exception as e:
                logger.error(f"Live Monitor: Failed to collect health data: {e}")
        
        commands_list = await self._get_all_commands()

        commands_data = {
            "total": len(commands_list),
            "commands": commands_list
        }
        

        file_system_data = self._get_file_system_info()


        fileops_data = self._fileops_response or {}
        self._fileops_response = None  

        recent_events = self._event_log[-30:]
        
        hook_creator_data = {}
        try:
            creator_cog = self.bot.get_cog("EventHooksCreater")
            
            if creator_cog:
                hook_creator_data = {
                    "templates": creator_cog.get_templates(),
                    "created_hooks": creator_cog.get_all_created_hooks(),
                    "stats": creator_cog.get_hook_stats(),
                    "analytics": {}
                }
                
                for hook in creator_cog.get_all_created_hooks():
                    hook_analytics = creator_cog.get_analytics(hook["hook_id"])
                    if hook_analytics:
                        hook_creator_data["analytics"][hook["hook_id"]] = hook_analytics
        except Exception as e:
            logger.error(f"Live Monitor: Failed to collect hook creator data: {e}")
        
        collection_duration_ms = round((time.time() - collection_start) * 1000, 2)
        
        monitor_settings = {
            "verbose_logging": self.verbose_logging,
            "debug_packages": getattr(self.bot.config, 'debug_packages', False) if hasattr(self.bot, 'config') else False,
            "update_interval": self.config.get("update_interval", 5),
            "collection_duration_ms": collection_duration_ms,
            "recommended_buffer_ms": max(200, min(collection_duration_ms + 200, 500)),
        }
        
        return {
            "timestamp": datetime.now().isoformat(),
            "bot": bot_info,
            "system": system_info,
            "event_hooks": event_hooks_data,
            "slash_limiter": slash_limiter_data,
            "atomic_fs": atomic_fs_data,
            "core_settings": core_settings,
            "monitor_settings": monitor_settings,
            "framework": framework_info,
            "plugins": plugins_data,
            "available_extensions": available_extensions,
            "health": health_data,
            "commands": commands_data,
            "file_system": {**file_system_data, "fileops": fileops_data},
            "events": recent_events,
            "chat_history": chat_history,
            "hook_creator": hook_creator_data,
        }

    async def _process_ticket_deletions(self):
        """Check for and process pending ticket deletion requests from the dashboard."""
        try:
            website_url = self.config.get("website_url", "").rstrip('/')
            if not website_url:
                return
            
            deletion_queue_url = f"{website_url}/monitor_data_ticket_deletions.json"
            
            async with aiohttp.ClientSession() as session:
                async with session.get(deletion_queue_url, timeout=aiohttp.ClientTimeout(total=5)) as resp:
                    if resp.status != 200:
                        return
                    
                    deletions = await resp.json()
                    if not deletions or not isinstance(deletions, list) or len(deletions) == 0:
                        return
                    
                    processed_count = 0
                    for deletion_request in deletions:
                        ticket_id = deletion_request.get('ticket_id')
                        guild_id = deletion_request.get('guild_id')
                        
                        if not ticket_id or not guild_id:
                            continue
                        
                        tickets_dir = Path(f"./data/tickets/{guild_id}/transcripts")
                        if not tickets_dir.exists():
                            continue
                        
                        meta_file = tickets_dir / f"{ticket_id}_meta.json"
                        html_file = tickets_dir / f"{ticket_id}.html"
                        
                        deleted = False
                        if meta_file.exists():
                            meta_file.unlink()
                            deleted = True
                            logger.info(f"Live Monitor: Deleted ticket meta file {ticket_id} for guild {guild_id}")
                        
                        if html_file.exists():
                            html_file.unlink()
                            deleted = True
                            logger.info(f"Live Monitor: Deleted ticket HTML file {ticket_id} for guild {guild_id}")
                        
                        if deleted:
                            processed_count += 1
                            logger.info(f"Live Monitor: Successfully processed deletion for ticket {ticket_id}")
                    

                    if processed_count > 0:
                        async with session.post(
                            deletion_queue_url,
                            data=json.dumps([]),
                            headers={'Content-Type': 'application/json'},
                            timeout=aiohttp.ClientTimeout(total=5)
                        ) as clear_resp:
                            if clear_resp.status == 200:
                                logger.info(f"Live Monitor: Cleared ticket deletion queue ({processed_count} tickets processed)")
                            else:
                                logger.warning(f"Live Monitor: Failed to clear ticket deletion queue, status: {clear_resp.status}")
        
        except asyncio.TimeoutError:
            pass
        except Exception as e:
            logger.error(f"Live Monitor: Error processing ticket deletions: {e}")
    
    async def _collect_tickets_data(self) -> Dict[str, Any]:
        tickets_data = {"guilds": []}
        tickets_dir = Path("./data/tickets")
        
        if not tickets_dir.exists():
            return tickets_data
        
        try:
            for guild_dir in tickets_dir.iterdir():
                if not guild_dir.is_dir():
                    continue
                
                guild_id = guild_dir.name
                transcripts_dir = guild_dir / "transcripts"
                
                if not transcripts_dir.exists():
                    continue
                
                tickets = []
                for file in transcripts_dir.iterdir():
                    if file.suffix == '.json' and file.stem.endswith('_meta'):
                        try:
                            with open(file, 'r', encoding='utf-8') as f:
                                ticket_meta = json.load(f)
                            
                            ticket_id = ticket_meta.get('ticket_id')
                            html_file = transcripts_dir / f"{ticket_id}.html"
                            
                            if html_file.exists():
                                try:
                                    with open(html_file, 'r', encoding='utf-8') as f:
                                        ticket_meta['html_content'] = f.read()
                                except Exception as e:
                                    logger.error(f"Live Monitor: Failed to read HTML for ticket {ticket_id}: {e}")
                                    ticket_meta['html_content'] = None
                            else:
                                ticket_meta['html_content'] = None
                            
                            tickets.append(ticket_meta)
                        except Exception as e:
                            logger.error(f"Live Monitor: Failed to read ticket metadata {file}: {e}")
                
                if tickets:
                    tickets_data["guilds"].append({
                        "guild_id": guild_id,
                        "tickets": tickets
                    })
        except Exception as e:
            logger.error(f"Live Monitor: Error collecting tickets data: {e}")
        
        return tickets_data
    
    @tasks.loop(seconds=1)
    async def send_status_loop(self):
        if not self.is_enabled:
            logger.debug("Live Monitor: send_status_loop skipped - not enabled")
            return
        if not self.config.get("website_url"):
            logger.warning("Live Monitor: send_status_loop skipped - no website_url configured")
            return
        if not self.config.get("secret_token"):
            logger.warning("Live Monitor: send_status_loop skipped - no secret_token configured")
            return
        
        try:
            await self._check_for_commands()
            
            data = await self._collect_monitor_data()
            
            packages = {
                "core": {
                    "timestamp": data["timestamp"],
                    "bot": data["bot"],
                    "system": data["system"],
                    "health": data.get("health", {}),
                    "chat_history": data.get("chat_history"),
                    "monitor_settings": data.get("monitor_settings", {}),
                },
                "commands": data.get("commands", {}),
                "plugins": data.get("plugins", {}),
                "hooks": data.get("event_hooks", {}),
                "extensions": {"available_extensions": data.get("available_extensions", [])},
                "system_details": {
                    "slash_limiter": data.get("slash_limiter", {}),
                    "atomic_fs": data.get("atomic_fs", {}),
                    "core_settings": data.get("core_settings", {}),
                    "framework": data.get("framework", {}),
                },
                "events": {"events": data.get("events", [])},
                "filesystem": data.get("file_system", {}),
                "hook_creator": data.get("hook_creator", {}),
            }
            
            await self._process_ticket_deletions()
            packages["tickets"] = await self._collect_tickets_data()
            
            base_url = self.config['website_url']
            token = self.config['secret_token']
            
            sent_count = 0
            failed_count = 0
            
            async with aiohttp.ClientSession() as session:
                for package_name, package_data in packages.items():
                    url = f"{base_url}/receive.php?token={token}&package={package_name}"
                    try:
                        async with session.post(url, json=package_data, timeout=aiohttp.ClientTimeout(total=10)) as resp:
                            if resp.status == 200:
                                sent_count += 1
                            else:
                                failed_count += 1
                                logger.warning(f"Live Monitor: Package '{package_name}' send failed with status {resp.status}")
                    except asyncio.CancelledError:

                        logger.info("Live Monitor: send_status_loop HTTP send cancelled")
                        raise
                    except Exception as e:
                        failed_count += 1
                        logger.error(f"Live Monitor: Error sending package '{package_name}': {e}")
            
            if sent_count > 0:
                if self.verbose_logging:
                    logger.info(f"Live Monitor: Data sent successfully ({sent_count} packages, {failed_count} failed)")
            self.last_send_success = datetime.now()
            self.send_failures = 0
        
        except asyncio.CancelledError:
            logger.info("Live Monitor: send_status_loop cancelled")
            raise
        except Exception as e:
            self.send_failures += 1
            logger.error(f"Live Monitor: Send error: {e}")
    
    @send_status_loop.before_loop
    async def before_send_status_loop(self):
        await self.bot.wait_until_ready()
        await asyncio.sleep(2)
    
    async def _check_for_commands(self):
        if not self.config.get("website_url") or not self.config.get("secret_token"):
            return
        
        try:
            url = f"{self.config['website_url']}/get_commands.php?token={self.config['secret_token']}"
            
            async with aiohttp.ClientSession() as session:
                async with session.get(url, timeout=aiohttp.ClientTimeout(total=5)) as resp:
                    if resp.status == 200:
                        commands = await resp.json()

                        if commands:
                            logger.info(f"Live Monitor: Received {len(commands)} command(s) from server")



                        for cmd in commands:
                            cmd_type = cmd.get("command", "unknown")
                            logger.info(f"Live Monitor: Executing command '{cmd_type}' with params: {cmd.get('params', {})}")

                            asyncio.create_task(self._execute_command(cmd))
        
        except asyncio.CancelledError:
            logger.info("Live Monitor: _check_for_commands cancelled")
            raise
        except Exception as e:
            logger.error(f"Live Monitor: Command check error: {e}")
    
    async def _execute_command(self, command: Dict[str, Any]):
        cmd_type = command.get("command")
        params = command.get("params", {})



        if isinstance(params, list):

            if params and isinstance(params[0], dict):
                params = params[0]
            else:
                params = {}
        elif not isinstance(params, dict):
            params = {}
        

        fileops_commands = [
            "list_dir", "read_file", "write_file", "rename_file", "create_dir", "delete_path",
            "fetch_marketplace_extensions", "download_marketplace_extension", "load_downloaded_extension",
            "backup_bot_directory", "validate_zygnal_id"
        ]
        if cmd_type in fileops_commands:
            self._fileops_response = None
        
        try:
            if cmd_type == "enable_hook":
                hook_id = params.get("hook_id")
                if hasattr(self.bot, 'enable_hook'):
                    self.bot.enable_hook(hook_id)
                    self._log_event("hook_enabled", {"hook_id": hook_id})
            
            elif cmd_type == "disable_hook":
                hook_id = params.get("hook_id")
                if hasattr(self.bot, 'disable_hook'):
                    self.bot.disable_hook(hook_id)
                    self._log_event("hook_disabled", {"hook_id": hook_id})
            
            elif cmd_type == "reset_circuit":
                hook_id = params.get("hook_id")
                event_hooks_cog = self.bot.get_cog("EventHooks")
                if event_hooks_cog:
                    event_hooks_cog.circuit_breaker.reset(hook_id)
                    self._log_event("circuit_reset", {"hook_id": hook_id})
            
            elif cmd_type == "create_custom_hook":
                creator_cog = self.bot.get_cog("EventHooksCreater")
                if creator_cog:
                    template_id = params.get("template_id")
                    hook_params = params.get("params", {})
                    guild_id = params.get("guild_id")
                    created_by = params.get("created_by", "Dashboard User")
                    
                    result = creator_cog.create_hook(template_id, hook_params, guild_id, created_by)
                    self._log_event("custom_hook_created", {
                        "template_id": template_id,
                        "guild_id": guild_id,
                        "success": result.get("success", False)
                    })
            
            elif cmd_type == "delete_custom_hook":
                creator_cog = self.bot.get_cog("EventHooksCreater")
                if creator_cog:
                    hook_id = params.get("hook_id")
                    result = creator_cog.delete_hook(hook_id)
                    self._log_event("custom_hook_deleted", {"hook_id": hook_id})
            
            elif cmd_type == "toggle_custom_hook":
                creator_cog = self.bot.get_cog("EventHooksCreater")
                if creator_cog:
                    hook_id = params.get("hook_id")
                    result = creator_cog.toggle_hook(hook_id)
                    self._log_event("custom_hook_toggled", {
                        "hook_id": hook_id,
                        "enabled": result.get("enabled", False)
                    })
            
            elif cmd_type == "reload_extension":
                ext_name = params.get("extension")
                try:
                    await self.bot.reload_extension(ext_name)
                    logger.info(f"Live Monitor: [OK] Extension reloaded successfully: {ext_name}")
                    self._log_event("extension_reloaded", {"extension": ext_name, "success": True})
                    

                    await asyncio.sleep(0.5)
                except Exception as e:
                    logger.error(f"Live Monitor: [ERROR] Failed to reload extension {ext_name}: {e}")
                    self._log_event("extension_reload_failed", {"extension": ext_name, "error": str(e)})
            
            elif cmd_type == "load_extension":
                ext_name = params.get("extension")
                try:
                    start_time = time.time()
                    await self.bot.load_extension(ext_name)
                    load_time = time.time() - start_time
                    

                    simple_name = ext_name.replace("extensions.", "").replace("cogs.", "")
                    if not hasattr(self.bot, 'extension_load_times'):
                        self.bot.extension_load_times = {}
                    self.bot.extension_load_times[simple_name] = load_time
                    
                    logger.info(f"Live Monitor: [OK] Extension loaded successfully: {ext_name} ({load_time:.3f}s)")
                    self._log_event("extension_loaded", {"extension": ext_name, "success": True, "load_time": load_time})
                    

                    await asyncio.sleep(0.5)
                    

                    plugin_registry_cog = self.bot.get_cog("PluginRegistry")
                    if plugin_registry_cog:
                        if simple_name not in plugin_registry_cog.registry:
                            logger.info(f"Live Monitor: Manually triggering PluginRegistry scan for {simple_name}")
                            try:
                                await plugin_registry_cog.register_plugin(simple_name, auto_scan=True)
                                logger.info(f"Live Monitor: [OK] PluginRegistry scan complete for {simple_name}")
                            except Exception as scan_err:
                                logger.error(f"Live Monitor: [ERROR] PluginRegistry scan failed for {simple_name}: {scan_err}")
                        else:

                            plugin_registry_cog.registry[simple_name].load_time = load_time
                except Exception as e:
                    logger.error(f"Live Monitor: [ERROR] Failed to load extension {ext_name}: {e}")
                    self._log_event("extension_load_failed", {"extension": ext_name, "error": str(e)})
            
            elif cmd_type == "unload_extension":
                ext_name = params.get("extension")
                try:
                    await self.bot.unload_extension(ext_name)
                    logger.info(f"Live Monitor: [OK] Extension unloaded successfully: {ext_name}")
                    self._log_event("extension_unloaded", {"extension": ext_name, "success": True})
                except Exception as e:
                    logger.error(f"Live Monitor: [ERROR] Failed to unload extension {ext_name}: {e}")
                    self._log_event("extension_unload_failed", {"extension": ext_name, "error": str(e)})
            
            elif cmd_type == "plugin_registry_set_enforcement":
                mode = params.get("mode")
                enabled = params.get("enabled")
                plugin_registry_cog = self.bot.get_cog("PluginRegistry")
                if plugin_registry_cog and isinstance(enabled, bool) and mode in {"deps", "conflicts"}:
                    if mode == "deps":
                        setattr(plugin_registry_cog, "enforce_dependencies", enabled)
                        self._log_event("plugin_enforcement_updated", {"mode": "dependencies", "enabled": enabled})
                    else:
                        setattr(plugin_registry_cog, "enforce_conflicts", enabled)
                        self._log_event("plugin_enforcement_updated", {"mode": "conflicts", "enabled": enabled})

            elif cmd_type == "slash_limiter_set_debug":
                enabled = bool(params.get("enabled"))
                slash_limiter_cog = self.bot.get_cog("SlashLimiter")
                if slash_limiter_cog and hasattr(slash_limiter_cog, "DEBUG_MODE"):
                    slash_limiter_cog.DEBUG_MODE = enabled
                    self._log_event("slash_limiter_debug_updated", {"enabled": enabled})
            
            elif cmd_type == "set_auto_reload":
                enabled = bool(params.get("enabled"))
                try:
                    if hasattr(self.bot, "config") and self.bot.config is not None:
                        await self.bot.config.set("auto_reload", enabled)
                except Exception as e:
                    logger.error(f"Live Monitor: Failed to update auto_reload in config: {e}")
                try:
                    if hasattr(self.bot, "extension_reloader"):
                        task = self.bot.extension_reloader
                        if enabled and not task.is_running():
                            task.start()
                        elif not enabled and task.is_running():
                            task.cancel()
                except Exception as e:
                    logger.error(f"Live Monitor: Failed to start/stop extension_reloader: {e}")
                self._log_event("auto_reload_updated", {"enabled": enabled})

            elif cmd_type == "set_extensions_auto_load":
                enabled = bool(params.get("enabled"))
                try:
                    if hasattr(self.bot, "config") and self.bot.config is not None:
                        await self.bot.config.set("extensions.auto_load", enabled)
                        self._log_event("extensions_auto_load_updated", {"enabled": enabled})
                except Exception as e:
                    logger.error(f"Live Monitor: Failed to update extensions.auto_load in config: {e}")
            
            elif cmd_type == "set_verbose_logging":
                enabled = bool(params.get("enabled"))
                self.verbose_logging = enabled
                self.config["verbose_logging"] = enabled
                self._save_config()
                self._log_event("verbose_logging_updated", {"enabled": enabled})
                logger.info(f"Live Monitor: Verbose logging {'enabled' if enabled else 'disabled'}")
            
            elif cmd_type == "clear_cache":
                if hasattr(self.bot.config, 'file_handler'):
                    self.bot.config.file_handler.clear_all_cache()
                    self._log_event("cache_cleared", {})
            
            elif cmd_type == "toggle_debug_packages":
                enabled = params.get("enabled", False)
                try:
                    if enabled:
                        logging.getLogger('discord').setLevel(logging.DEBUG)
                        logging.getLogger('discord.http').setLevel(logging.DEBUG)
                        logging.getLogger('discord.gateway').setLevel(logging.DEBUG)
                        logger.info("Live Monitor: Debug packages enabled - verbose logging active")
                    else:
                        logging.getLogger('discord').setLevel(logging.INFO)
                        logging.getLogger('discord.http').setLevel(logging.INFO)
                        logging.getLogger('discord.gateway').setLevel(logging.INFO)
                        logger.info("Live Monitor: Debug packages disabled - normal logging resumed")
                    
                    if hasattr(self.bot, 'config'):
                        if not hasattr(self.bot.config, 'debug_packages'):
                            self.bot.config.debug_packages = enabled
                        else:
                            self.bot.config.debug_packages = enabled
                    
                    self._log_event("debug_packages_toggled", {"enabled": enabled})
                except Exception as e:
                    logger.error(f"Failed to toggle debug packages: {e}")

            elif cmd_type == "generate_framework_diagnostics":
                diagnostics_cog = self.bot.get_cog("FrameworkDiagnostics")
                if diagnostics_cog and hasattr(diagnostics_cog, "generate_diagnostics"):
                    try:
                        diag = await diagnostics_cog.generate_diagnostics()
                        self._log_event("framework_diagnostics_generated", {"success": bool(diag)})
                    except Exception as e:
                        logger.error(f"Live Monitor: Failed to generate framework diagnostics via dashboard: {e}")
                        self._log_event("framework_diagnostics_failed", {"error": str(e)})

            elif cmd_type == "leave_guild":
                guild_id = params.get("guild_id")
                if guild_id is None:
                    return
                try:
                    gid_int = int(guild_id)
                except (TypeError, ValueError):
                    logger.error(f"Live Monitor: leave_guild called with invalid guild_id={guild_id!r}")
                    return
                guild = self.bot.get_guild(gid_int)
                if guild is None:
                    logger.error(f"Live Monitor: leave_guild - guild not found: {gid_int}")
                    return
                try:
                    await guild.leave()
                    self._log_event(
                        "guild_left",
                        {
                            "guild_id": str(guild.id),
                            "guild": guild.name,
                            "owner_id": str(getattr(guild, "owner_id", "")),
                        },
                    )
                except Exception as e:
                    logger.error(f"Live Monitor: Failed to leave guild {gid_int}: {e}")
                    self._log_event(
                        "guild_leave_failed",
                        {"guild_id": str(gid_int), "error": str(e)},
                    )

            elif cmd_type == "backup_bot_directory":



                try:
                    base = Path(".").resolve()
                    ts = datetime.now().strftime("%Y%m%d_%H%M%S")
                    backup_root = Path("./data/Dashboardbackups")
                    backup_root.mkdir(parents=True, exist_ok=True)
                    archive_base = backup_root / f"bot_backup_{ts}"

                    logger.info(f"Live Monitor: Starting backup: {archive_base}.zip")



                    archive_path_str = await asyncio.to_thread(
                        shutil.make_archive,
                        str(archive_base),
                        "zip",
                        base,
                    )
                    archive_path = Path(archive_path_str)


                    def _get_file_stats(path):
                        if path.exists():
                            size = path.stat().st_size
                            return size, size / (1024 * 1024)
                        return 0, 0

                    size_bytes, size_mb = await asyncio.to_thread(_get_file_stats, archive_path)

                    self._log_event(
                        "bot_backup_created",
                        {
                            "path": str(archive_path),
                            "directory": str(backup_root.resolve()),
                            "size_bytes": size_bytes,
                            "size_mb": f"{size_mb:.2f}"
                        },
                    )
                    logger.info(f"Live Monitor: Backup completed successfully: {archive_path.name} ({size_mb:.2f} MB)")

                    self._fileops_response = {
                        "success": True,
                        "message": f"Backup created: {archive_path.name} ({size_mb:.2f} MB)",
                        "path": str(archive_path)
                    }
                except Exception as e:
                    logger.error(f"Live Monitor: backup_bot_directory failed: {e}")
                    self._log_event("bot_backup_failed", {"error": str(e)})
                    self._fileops_response = {
                        "success": False,
                        "error": str(e)
                    }

            elif cmd_type == "validate_zygnal_id":
                zygnal_id = params.get("zygnal_id")
                request_id = params.get("request_id")
                logger.info(f"Live Monitor: Validating ZygnalID: {zygnal_id}")

                try:
                    url = f"https://zsync.eu/extension/api/validate_zid.php?zygnalid={zygnal_id}"
                    timeout = aiohttp.ClientTimeout(total=10)
                    async with aiohttp.ClientSession(timeout=timeout) as session:
                        async with session.get(url) as resp:
                            status = resp.status
                            try:
                                data = await resp.json()
                            except:
                                try:
                                    data = await resp.text()
                                except:
                                    data = None
                            
                            logger.info(f"Live Monitor: Validation response status: {status}, data: {data}")

                            self._fileops_response = {
                                "type": "validate_zygnal_id",
                                "command_type": "validate_zygnal_id",
                                "request_id": request_id,
                                "status": status,
                                "data": data,
                                "success": True
                            }
                            

                            async with self._fileops_lock:
                                try:
                                    base_url = self.config['website_url']
                                    token = self.config['secret_token']
                                    post_url = f"{base_url}/receive.php?token={token}&package=fileops"
                                    async with session.post(post_url, json=self._fileops_response, timeout=aiohttp.ClientTimeout(total=10)) as post_resp:
                                        if post_resp.status == 200:
                                            logger.info(f"Live Monitor: [OK] Validation response sent")
                                        else:
                                            logger.warning(f"Live Monitor: [ERROR] Validation response send failed: {post_resp.status}")
                                except Exception as e:
                                    logger.error(f"Live Monitor: Failed to send validation response: {e}")

                except Exception as e:
                    logger.error(f"Live Monitor: Validation failed: {e}")
                    self._fileops_response = {
                        "type": "validate_zygnal_id",
                        "command_type": "validate_zygnal_id",
                        "request_id": request_id,
                        "success": False,
                        "error": str(e)
                    }

                    async with self._fileops_lock:
                        try:
                            base_url = self.config['website_url']
                            token = self.config['secret_token']
                            post_url = f"{base_url}/receive.php?token={token}&package=fileops"
                            async with aiohttp.ClientSession() as session:
                                async with session.post(post_url, json=self._fileops_response, timeout=aiohttp.ClientTimeout(total=10)) as post_resp:
                                    pass
                        except:
                            pass

            elif cmd_type == "shutdown_bot":
                delay = int(params.get("delay", 0))
                self._log_event("bot_shutdown_requested", {"delay_seconds": delay})

                async def _delayed_shutdown():
                    try:
                        if delay > 0:
                            await asyncio.sleep(delay)
                        await self.bot.close()
                    except Exception as e:
                        logger.error(f"Live Monitor: Shutdown command failed: {e}")
                        self._log_event("bot_shutdown_failed", {"error": str(e)})

                asyncio.create_task(_delayed_shutdown())

            elif cmd_type == "af_invalidate_cache_entry":
                path = params.get("path")
                if path and hasattr(self.bot.config, 'file_handler'):
                    self.bot.config.file_handler.invalidate_cache(path)
                    self._log_event("atomic_fs_cache_invalidated", {"path": path})

            elif cmd_type == "af_force_release_lock":
                path = params.get("path")
                if path and hasattr(self.bot.config, 'file_handler') and hasattr(self.bot.config.file_handler, 'force_release_lock'):
                    released = self.bot.config.file_handler.force_release_lock(path)
                    self._log_event(
                        "atomic_fs_lock_released" if released else "atomic_fs_lock_release_failed",
                        {"path": path}
                    )

            elif cmd_type == "fetch_marketplace_extensions":
                try:
                    api_url = "https://zsync.eu/extension/api/extensions.php?action=list"
                    logger.info(f"Live Monitor: Fetching marketplace extensions from {api_url}")
                    
                    timeout = aiohttp.ClientTimeout(total=30)
                    async with aiohttp.ClientSession(timeout=timeout) as session:
                        async with session.get(api_url) as response:
                            logger.info(f"Live Monitor: Marketplace API returned status {response.status}")
                            
                            if response.status == 200:
                                try:

                                    text_content = await response.text()
                                    

                                    json_start = text_content.find('{')
                                    if json_start != -1:
                                        json_content = text_content[json_start:]
                                        data = json.loads(json_content)
                                    else:
                                        data = json.loads(text_content)
                                        
                                except Exception as json_err:
                                    logger.error(f"Live Monitor: Failed to parse marketplace JSON: {json_err}")
                                    try:
                                        logger.error(f"Live Monitor: Raw response content: {text_content[:200]}")
                                    except:
                                        pass
                                    raise json_err

                                if data.get('success'):
                                    extensions = data.get('extensions', [])
                                    logger.info(f"Live Monitor: Successfully fetched {len(extensions)} extensions")
                                    self._fileops_response = {
                                        "success": True,
                                        "command_type": "fetch_marketplace_extensions",
                                        "extensions": extensions
                                    }

                                    try:
                                        base_url = self.config['website_url']
                                        token = self.config['secret_token']
                                        url = f"{base_url}/receive.php?token={token}&package=fileops"
                                        async with aiohttp.ClientSession() as session:
                                            async with session.post(url, json=self._fileops_response, timeout=aiohttp.ClientTimeout(total=10)) as resp:
                                                if resp.status == 200:
                                                    logger.info(f"Live Monitor: [OK] Marketplace extensions sent to dashboard ({len(extensions)} extensions)")
                                                else:
                                                    logger.warning(f"Live Monitor: [ERROR] Marketplace send failed with status {resp.status}")
                                    except Exception as send_err:
                                        logger.error(f"Live Monitor: [ERROR] Failed to send marketplace response: {send_err}")
                                else:
                                    error_msg = "API returned success: false"
                                    logger.error(f"Live Monitor: {error_msg}")
                                    self._fileops_response = {"success": False, "error": error_msg}
                            elif response.status == 429:
                                error_msg = "Rate limit exceeded. Please try again in a moment."
                                logger.warning(f"Live Monitor: {error_msg}")
                                self._fileops_response = {"success": False, "error": error_msg}
                            else:
                                error_msg = f"API request failed with status {response.status}"
                                logger.error(f"Live Monitor: {error_msg}")
                                self._fileops_response = {"success": False, "error": error_msg}
                except asyncio.TimeoutError:
                    error_msg = "Request timed out after 30 seconds"
                    logger.error(f"Live Monitor: Marketplace fetch - {error_msg}")
                    self._fileops_response = {"success": False, "error": error_msg}
                except Exception as e:
                    error_msg = f"Marketplace fetch failed: {str(e)}"
                    logger.error(f"Live Monitor: {error_msg}")
                    self._fileops_response = {"success": False, "error": str(e)}
                finally:

                    if self._fileops_response and (self._fileops_response.get('success') is False or self._fileops_response.get('error')):
                        try:
                            base_url = self.config['website_url']
                            token = self.config['secret_token']
                            url = f"{base_url}/receive.php?token={token}&package=fileops"
                            async with aiohttp.ClientSession() as session:
                                async with session.post(url, json=self._fileops_response, timeout=aiohttp.ClientTimeout(total=10)) as resp:
                                    if resp.status == 200:
                                        logger.info(f"Live Monitor: [OK] Error response sent to dashboard")
                        except Exception as send_err:
                            logger.error(f"Live Monitor: [ERROR] Failed to send error response: {send_err}")

            elif cmd_type == "download_marketplace_extension":
                try:
                    extension_data = params.get("extension")
                    request_id = params.get("request_id")

                    if not extension_data:

                        self._fileops_response = {"success": False, "error": "No extension data provided", "request_id": request_id}

                    else:

                        zygnal_id_file = Path("./data/marketplace/ZygnalID.txt")

                        zygnal_id_file.parent.mkdir(parents=True, exist_ok=True)



                        zygnal_id = None

                        if zygnal_id_file.exists():

                            with open(zygnal_id_file, 'r') as f:

                                zygnal_id = f.read().strip()



                        if not zygnal_id:

                            marketplace_cog = self.bot.get_cog("ExtensionMarketplace")

                            if marketplace_cog and hasattr(marketplace_cog, 'ensure_zygnal_id'):

                                try:

                                    logger.info("Live Monitor: ZygnalID.txt not found or empty, attempting to generate via Marketplace cog...")

                                    zygnal_id = await marketplace_cog.ensure_zygnal_id()

                                    if zygnal_id:

                                        logger.info("Live Monitor: Successfully generated new ZygnalID via Marketplace cog.")

                                except Exception as e:

                                    logger.error(f"Live Monitor: Error calling ensure_zygnal_id on Marketplace cog: {e}")



                        if not zygnal_id:

                            error_message = (

                                "**ZygnalID Not Found**\n\n"

                                "Your ZygnalID file is missing.\n\n"

                                "**How to create one:**\n"

                                "1. Go to your Discord server.\n"

                                "2. Run the command `/marketplace myid`.\n"

                                "3. Come back here and refresh the page.\n\n"

                                "*Note: The `marketplace` extension must be loaded for automatic ID generation.*"

                            )

                            logger.error("Download failed - ZygnalID.txt not found and could not be generated.")

                            self._fileops_response = {"success": False, "type": "download_marketplace_extension", "error": error_message, "error_type": "zygnal_id_not_found", "request_id": request_id}



                        if zygnal_id:

                            if extension_data.get('customUrl'):

                                base_url = extension_data['customUrl']

                                if base_url.startswith('http') and zygnal_id:

                                    sep = '&' if ('?' in base_url) else '?'

                                    download_url = f"{base_url}{sep}zygnalid={zygnal_id}"

                                else:

                                    download_url = base_url

                            else:

                                extension_id = extension_data['id']

                                download_url = f"https://zsync.eu/extension/download.php?id={extension_id}&zygnalid={zygnal_id}"



                            response_text = None

                            error = None

                            max_retries = 3



                            for attempt in range(max_retries):

                                try:

                                    timeout = aiohttp.ClientTimeout(total=60)

                                    async with aiohttp.ClientSession(timeout=timeout) as session:

                                        async with session.get(download_url) as response:

                                            if response.status == 200:

                                                response_text = await response.text()

                                                break

                                            elif response.status == 403:

                                                error = "403"

                                                break

                                            elif response.status == 429:

                                                retry_after = int(response.headers.get('Retry-After', 60))

                                                if attempt < max_retries - 1:

                                                    logger.warning(f"Rate limited, retrying after {retry_after}s (attempt {attempt + 1}/{max_retries})")

                                                    await asyncio.sleep(retry_after)

                                                    continue

                                                error = "Rate limited (max retries reached)"

                                                break

                                            else:

                                                error = f"HTTP {response.status}"

                                                break

                                except asyncio.TimeoutError:

                                    if attempt < max_retries - 1:

                                        logger.warning(f"Timeout, retrying (attempt {attempt + 1}/{max_retries})")

                                        await asyncio.sleep(2 ** attempt)

                                        continue

                                    error = "Timeout (max retries reached)"

                                    break

                                except Exception as e:

                                    if attempt < max_retries - 1:

                                        logger.warning(f"Error: {e}, retrying (attempt {attempt + 1}/{max_retries})")

                                        await asyncio.sleep(2 ** attempt)

                                        continue

                                    error = f"Error: {e}"

                                    break



                            if error and ("403" in str(error) or "Forbidden" in str(error)):

                                error_message = (

                                    "**ZygnalID Not Activated**\n\n"

                                    "Your ZygnalID is probably NOT activated or got deactivated.\n\n"

                                    "**How to activate:**\n"

                                    "1. Join the ZygnalBot Discord server: `gg/sgZnXca5ts`\n"

                                    "2. Create a ticket with the category **Zygnal Activation**\n"

                                    "3. Read the embed that got sent into the ticket\n"

                                    "4. Provide the information requested\n"

                                    "5. Wait for a supporter or TheHolyOneZ to activate it\n\n"

                                    f"Use `/marketplace myid` to view your ZygnalID"

                                )

                                logger.error("Download failed - 403 Forbidden (ZygnalID not activated)")

                                self._fileops_response = {"success": False, "type": "download_marketplace_extension", "error": error_message, "error_type": "zygnal_id_not_activated", "request_id": request_id}

                            elif error:

                                self._fileops_response = {"success": False, "type": "download_marketplace_extension", "error": error, "request_id": request_id}

                            elif response_text:

                                if ("invalid" in response_text.lower() and "zygnalid" in response_text.lower()) or "not activated" in response_text.lower():

                                    error_message = (

                                        "Your ZygnalID is **invalid or not activated**.\n\n"

                                        "**To activate your ID, follow these steps:**\n"

                                        "1. Go to the official ZygnalBot Discord server: `gg/sgZnXca5ts`\n"

                                        "2. Verify yourself on the server.\n"

                                        "3. Open a ticket for **Zygnal ID Activation**.\n"

                                        "4. Read the embed sent in the ticket and provide the necessary information to start the activation process.\n\n"

                                        f"Your ZygnalID: {zygnal_id}"

                                    )

                                    logger.error("Download failed due to ZygnalID issue")

                                    self._fileops_response = {"success": False, "type": "download_marketplace_extension", "error": error_message, "error_type": "zygnal_id_not_activated", "request_id": request_id}

                                else:

                                    extensions_folder = Path("./extensions")

                                    extensions_folder.mkdir(parents=True, exist_ok=True)



                                    import re

                                    filename = f"{extension_data['title'].replace(' ', '_').lower()}.{extension_data['fileType']}"
                                    filename = re.sub(r'[^\w\-_\.]', '', filename)
                                    filepath = extensions_folder / filename

                                    with open(filepath, 'w', encoding='utf-8') as f:

                                        f.write(response_text)



                                    logger.info(f"Successfully downloaded extension to {filepath}")



                                    filepath_str = str(filepath)

                                    filepath_formatted = filepath_str.replace('\\', '/')



                                    self._fileops_response = {

                                        "success": True,

                                        "type": "download_marketplace_extension",
                                        "command_type": "download_marketplace_extension",

                                                                                         "message": f"Downloaded to {filepath}",
                                                    
                                                                                            "filepath": filepath_formatted,
                                                    
                                                                                            "filename": filename,
                                                    
                                                                                                                                                "request_id": request_id
                                                                                                        
                                                                                                                                            }                            
                            else:

                                self._fileops_response = {"success": False, "error": "Max retries exceeded", "request_id": request_id}
                                self._fileops_response = {"success": False, "type": "download_marketplace_extension", "error": "Max retries exceeded", "request_id": request_id}



                        if self._fileops_response:

                            try:

                                base_url = self.config['website_url']

                                token = self.config['secret_token']

                                url = f"{base_url}/receive.php?token={token}&package=fileops"

                                async with aiohttp.ClientSession() as session:

                                    async with session.post(url, json=self._fileops_response, timeout=aiohttp.ClientTimeout(total=10)) as resp:

                                        if resp.status == 200:

                                            logger.info(f"Live Monitor: [OK] Download response sent to dashboard")

                                        else:

                                            logger.warning(f"Live Monitor: [ERROR] Download response send failed with status {resp.status}")

                            except Exception as send_err:

                                logger.error(f"Live Monitor: [ERROR] Failed to send download response: {send_err}")

                except Exception as e:
            
                                logger.error(f"Marketplace download failed: {e}")
            
                                request_id = params.get("request_id")
            
                                self._fileops_response = {"success": False, "type": "download_marketplace_extension", "error": str(e), "request_id": request_id}
            
            
            
                                try:
            
                                    base_url = self.config['website_url']
            
                                    token = self.config['secret_token']
            
                                    url = f"{base_url}/receive.php?token={token}&package=fileops"
            
                                    async with aiohttp.ClientSession() as session:
            
                                        async with session.post(url, json=self._fileops_response, timeout=aiohttp.ClientTimeout(total=10)) as resp:
            
                                            pass
            
                                except:
            
                                    pass
            
            elif cmd_type == "load_downloaded_extension":
                try:

                    filepath = params.get("filepath")
                    filename = params.get("filename")
                    
                    if not filepath and not filename:
                        self._fileops_response = {"success": False, "type": "load_downloaded_extension", "command_type": "load_downloaded_extension", "error": "No filepath or filename provided"}
                    else:
                        if filename:

                            file_path = Path("./extensions") / filename
                        else:

                            file_path = Path(filepath)

                        if not file_path.exists():
                            self._fileops_response = {"success": False, "type": "load_downloaded_extension", "command_type": "load_downloaded_extension", "error": f"File not found: {file_path}"}
                        else:
                            extension_name = file_path.stem
                            try:
                                await self.bot.load_extension(f"extensions.{extension_name}")
                                self._fileops_response = {
                                    "success": True,
                                    "type": "load_downloaded_extension",
                                    "command_type": "load_downloaded_extension",
                                    "message": f"Loaded extension: {extension_name}",
                                    "extension_name": extension_name
                                }
                            except Exception as load_err:

                                try:
                                    await self.bot.reload_extension(f"extensions.{extension_name}")
                                    self._fileops_response = {
                                        "success": True,
                                        "type": "load_downloaded_extension",
                                        "command_type": "load_downloaded_extension",
                                        "message": f"Reloaded extension: {extension_name}",
                                        "extension_name": extension_name
                                    }
                                except Exception as reload_err:
                                    raise reload_err
                        

                        if self._fileops_response:
                            try:
                                base_url = self.config['website_url']
                                token = self.config['secret_token']
                                url = f"{base_url}/receive.php?token={token}&package=fileops"
                                async with aiohttp.ClientSession() as session:
                                    async with session.post(url, json=self._fileops_response, timeout=aiohttp.ClientTimeout(total=10)) as resp:
                                        if resp.status == 200:
                                            logger.info(f"Live Monitor: [OK] Load response sent to dashboard")
                                        else:
                                            logger.warning(f"Live Monitor: [ERROR] Load response send failed with status {resp.status}")
                            except Exception as send_err:
                                logger.error(f"Live Monitor: [ERROR] Failed to send load response: {send_err}")
                except Exception as e:
                    logger.error(f"Load downloaded extension failed: {e}")
                    self._fileops_response = {"success": False, "type": "load_downloaded_extension", "command_type": "load_downloaded_extension", "error": str(e)}

                    try:
                        base_url = self.config['website_url']
                        token = self.config['secret_token']
                        url = f"{base_url}/receive.php?token={token}&package=fileops"
                        async with aiohttp.ClientSession() as session:
                            async with session.post(url, json=self._fileops_response, timeout=aiohttp.ClientTimeout(total=10)) as resp:
                                pass
                    except:
                        pass

            elif cmd_type == "list_dir":
                path = params.get("path")
                allowed_paths = ["./", "./botlogs", "./data", "./cogs", "./extensions"]
                if not path or not any(path.startswith(p) for p in allowed_paths):
                    return
                try:

                    def _list_directory(dir_path):
                        p = Path(dir_path)
                        if not p.is_dir():
                            return None
                        files = []
                        for item in sorted(p.iterdir()):
                            if item.is_file():
                                files.append({
                                    "name": item.name,
                                    "type": "file",
                                    "size": item.stat().st_size,
                                    "modified": datetime.fromtimestamp(item.stat().st_mtime).isoformat()
                                })
                            elif item.is_dir():
                                files.append({"name": item.name, "type": "dir"})
                        return files


                    files = await asyncio.to_thread(_list_directory, path)

                    if files is not None:
                        response_data = {
                            "command_type": "list_dir",
                            "type": "list_dir",
                            "path": path,
                            "files": files,
                            "request_id": params.get("request_id")
                        }
                        logger.info(f"Live Monitor: Preparing fileops response for list_dir: {path} ({len(files)} items)")

                        async with self._fileops_lock:
                            try:
                                base_url = self.config['website_url']
                                token = self.config['secret_token']
                                url = f"{base_url}/receive.php?token={token}&package=fileops"
                                async with aiohttp.ClientSession() as session:
                                    async with session.post(url, json=response_data, timeout=aiohttp.ClientTimeout(total=10)) as resp:
                                        if resp.status == 200:
                                            logger.info(f"Live Monitor: [OK] Fileops sent successfully (list_dir: {path})")
                                        else:
                                            logger.warning(f"Live Monitor: [ERROR] Fileops send failed with status {resp.status}")
                            except Exception as e:
                                logger.error(f"Live Monitor: [ERROR] Failed to send fileops response: {e}")
                except Exception as e:
                    logger.error(f"Live Monitor: List dir error: {e}")

            elif cmd_type == "read_file":
                path = params.get("path")
                allowed_paths = ["./", "./botlogs", "./data", "./cogs", "./extensions"]
                if not path or not any(path.startswith(p) for p in allowed_paths):
                    return
                try:

                    def _read_file(file_path, max_size):
                        p = Path(file_path)
                        if not p.is_file():
                            return None, "not a file"

                        file_size = p.stat().st_size

                        if file_size > max_size:
                            return None, f"File too large ({file_size} bytes). Maximum size is {max_size} bytes."

                        with open(p, 'r', encoding='utf-8', errors='ignore') as f:
                            content = f.read()
                        return content, None


                    max_size = 10 * 1024 * 1024  
                    content, error = await asyncio.to_thread(_read_file, path, max_size)

                    if error:
                        logger.error(f"Live Monitor: read_file failed - {error}: {path}")
                        if error == "not a file":
                            return

                        response_data = {
                            "success": False,
                            "error": error,
                            "command_type": "read_file",
                            "type": "read_file",
                            "path": path,
                            "content": f"ERROR: {error}",
                            "request_id": params.get("request_id")
                        }
                    else:
                        response_data = {
                            "success": True,
                            "command_type": "read_file",
                            "type": "read_file",
                            "path": path,
                            "content": content,
                            "request_id": params.get("request_id")
                        }
                        logger.info(f"Live Monitor: Preparing fileops response for read_file: {path} ({len(content)} bytes)")


                    async with self._fileops_lock:
                        try:
                            base_url = self.config['website_url']
                            token = self.config['secret_token']
                            url = f"{base_url}/receive.php?token={token}&package=fileops"
                            async with aiohttp.ClientSession() as session:
                                async with session.post(url, json=response_data, timeout=aiohttp.ClientTimeout(total=10)) as resp:
                                    if resp.status == 200:
                                        logger.info(f"Live Monitor: [OK] Fileops sent successfully (read_file: {path})")
                                    else:
                                        logger.warning(f"Live Monitor: [ERROR] Fileops send failed with status {resp.status}")
                        except Exception as e:
                            logger.error(f"Live Monitor: [ERROR] Failed to send fileops response: {e}")
                except Exception as e:
                    logger.error(f"Live Monitor: Read file error: {e}")

                    async with self._fileops_lock:
                        try:
                            response_data = {
                                "success": False,
                                "error": str(e),
                                "command_type": "read_file",
                                "type": "read_file",
                                "path": path,
                                "content": f"ERROR: Failed to read file - {str(e)}",
                                "request_id": params.get("request_id")
                            }
                            base_url = self.config['website_url']
                            token = self.config['secret_token']
                            url = f"{base_url}/receive.php?token={token}&package=fileops"
                            async with aiohttp.ClientSession() as session:
                                async with session.post(url, json=response_data, timeout=aiohttp.ClientTimeout(total=10)) as resp:
                                    logger.info(f"Live Monitor: Sent error response for read_file: {path}")
                        except:
                            pass

            elif cmd_type == "write_file":
                path = params.get("path")
                content = params.get("content", "")
                allowed_paths = ["./", "./botlogs", "./data", "./cogs", "./extensions"]
                if not path or not any(path.startswith(p) for p in allowed_paths):
                    return
                try:

                    def _write_file(file_path, file_content):
                        p = Path(file_path)
                        p.parent.mkdir(parents=True, exist_ok=True)
                        with open(p, 'w', encoding='utf-8') as f:
                            f.write(file_content)


                    await asyncio.to_thread(_write_file, path, content)
                    self._log_event("file_written", {"path": path})
                except Exception as e:
                    logger.error(f"Live Monitor: Write file error: {e}")

            elif cmd_type == "rename_file":
                old_path = params.get("old_path")
                new_path = params.get("new_path")
                allowed_paths = ["./", "./botlogs", "./data", "./cogs", "./extensions"]
                if not old_path or not new_path:
                    return
                if not any(old_path.startswith(p) for p in allowed_paths):
                    return
                if not any(new_path.startswith(p) for p in allowed_paths):
                    return
                try:

                    def _rename_file(old_file_path, new_file_path):
                        old_p = Path(old_file_path)
                        new_p = Path(new_file_path)
                        new_p.parent.mkdir(parents=True, exist_ok=True)
                        old_p.rename(new_p)


                    await asyncio.to_thread(_rename_file, old_path, new_path)
                    self._log_event("file_renamed", {"old_path": old_path, "new_path": new_path})
                except Exception as e:
                    logger.error(f"Live Monitor: Rename file error: {e}")

            elif cmd_type == "create_dir":
                path = params.get("path")
                allowed_paths = ["./", "./botlogs", "./data", "./cogs", "./extensions"]
                if not path or not any(path.startswith(p) for p in allowed_paths):
                    return
                try:

                    def _create_dir(dir_path):
                        p = Path(dir_path)
                        p.mkdir(parents=True, exist_ok=True)


                    await asyncio.to_thread(_create_dir, path)
                    self._log_event("dir_created", {"path": path})
                except Exception as e:
                    logger.error(f"Live Monitor: Create dir error: {e}")

            elif cmd_type == "delete_path":
                path = params.get("path")
                allowed_paths = ["./", "./botlogs", "./data", "./cogs", "./extensions"]
                if not path or not any(path.startswith(p) for p in allowed_paths):
                    return
                try:

                    def _delete_path(target_path):
                        p = Path(target_path)
                        if p.is_dir():
                            shutil.rmtree(p)
                        elif p.is_file():
                            p.unlink()


                    await asyncio.to_thread(_delete_path, path)
                    self._log_event("path_deleted", {"path": path})
                except Exception as e:
                    logger.error(f"Live Monitor: Delete path error: {e}")

            elif cmd_type == "send_chat_message":
                guild_id = params.get("guild_id")
                channel_id = params.get("channel_id")
                content = (params.get("content") or "").strip()
                if not channel_id or not content:
                    return
                try:
                    channel_id_int = int(channel_id)
                except (TypeError, ValueError):
                    logger.error(f"Live Monitor: Invalid channel_id for send_chat_message: {channel_id}")
                    return
                try:
                    channel = self.bot.get_channel(channel_id_int)
                    if channel is None and guild_id:
                        try:
                            g = self.bot.get_guild(int(guild_id))
                            if g:
                                channel = g.get_channel(channel_id_int)
                        except Exception:
                            pass
                    if channel is None:
                        logger.error(f"Live Monitor: send_chat_message - channel not found: {channel_id}")
                        return
                    await channel.send(content)
                    self._log_event("chat_message_sent", {
                        "guild_id": str(getattr(getattr(channel, 'guild', None), 'id', guild_id)),
                        "guild": getattr(getattr(channel, 'guild', None), 'name', 'Unknown'),
                        "channel_id": str(channel_id_int),
                        "channel": getattr(channel, 'name', 'Unknown'),
                        "content_preview": content[:120]
                    })
                except Exception as e:
                    logger.error(f"Live Monitor: send_chat_message error: {e}")

            elif cmd_type == "request_chat_history":
                guild_id = params.get("guild_id")
                channel_id = params.get("channel_id")
                try:
                    channel_id_int = int(channel_id)
                except (TypeError, ValueError):
                    logger.error(f"Live Monitor: Invalid channel_id for request_chat_history: {channel_id}")
                    return
                try:
                    channel = self.bot.get_channel(channel_id_int)
                    if channel is None and guild_id:
                        try:
                            g = self.bot.get_guild(int(guild_id))
                            if g:
                                channel = g.get_channel(channel_id_int)
                        except Exception:
                            pass
                    if channel is None:
                        logger.error(f"Live Monitor: request_chat_history - channel not found: {channel_id}")
                        return

                    messages = []
                    try:
                        async for msg in channel.history(limit=50, oldest_first=True):
                            try:
                                messages.append({
                                    "id": str(msg.id),
                                    "author": str(msg.author),
                                    "timestamp": msg.created_at.isoformat(),
                                    "content": msg.content,
                                })
                            except Exception:
                                continue
                    except Exception as e:
                        logger.error(f"Live Monitor: Error fetching chat history: {e}")
                        messages = []

                    self._last_chat_history = {
                        "guild_id": str(getattr(getattr(channel, 'guild', None), 'id', guild_id)),
                        "guild_name": getattr(getattr(channel, 'guild', None), 'name', 'Unknown'),
                        "channel_id": str(channel.id),
                        "channel_name": getattr(channel, 'name', 'Unknown'),
                        "messages": messages,
                    }

                    logger.info(
                        f"Live Monitor: Prepared chat history for guild={self._last_chat_history['guild_id']} "
                        f"channel={self._last_chat_history['channel_id']} messages={len(messages)}"
                    )

                    self._log_event("chat_history_requested", {
                        "guild_id": self._last_chat_history["guild_id"],
                        "channel_id": self._last_chat_history["channel_id"],
                        "message_count": len(messages),
                    })
                except Exception as e:
                    logger.error(f"Live Monitor: request_chat_history error: {e}")
        
        except asyncio.CancelledError:
            logger.info("Live Monitor: _execute_command cancelled")
            raise
        except Exception as e:
            logger.error(f"Live Monitor: Command execution error: {e}")
            self._log_event("command_error", {"command": cmd_type, "error": str(e)})
    
    @app_commands.command(name="livemonitor", description="Configure the live monitoring system")
    @app_commands.describe(
        action="Action to perform",
        url="Website URL for the dashboard",
        interval="Update interval in seconds (2-60)"
    )
    @app_commands.choices(action=[
        app_commands.Choice(name="Quick Start (Setup + Files)", value="quickstart"),
        app_commands.Choice(name="Status", value="status"),
        app_commands.Choice(name="Enable", value="enable"),
        app_commands.Choice(name="Disable", value="disable"),
        app_commands.Choice(name="Get Files", value="files")
    ])
    @app_commands.check(lambda interaction: interaction.client.is_owner(interaction.user))
    async def livemonitor_slash(
        self,
        interaction: discord.Interaction,
        action: str,
        url: Optional[str] = None,
        interval: Optional[int] = None
    ):
        await self._livemonitor_logic(interaction, action, url, interval)

    
    @commands.command(name="livemonitor")
    @commands.is_owner()
    async def livemonitor_prefix(self, ctx, action: str = "status", url: Optional[str] = None, interval: Optional[int] = None):
        await self._livemonitor_logic(ctx, action, url, interval)
    
    async def _livemonitor_logic(self, ctx, action: str, url: Optional[str], interval: Optional[int]):
        if action == "status":
            embed = discord.Embed(
                title="Live Monitor Status",
                color=0x00ff00 if self.is_enabled else 0xff0000,
                timestamp=datetime.now()
            )
            
            embed.add_field(
                name="Status",
                value=" Enabled" if self.is_enabled else "â¸ï¸ Disabled",
                inline=True
            )
            
            if self.config.get("website_url"):
                embed.add_field(
                    name="Dashboard URL",
                    value=self.config["website_url"],
                    inline=False
                )
            
            if self.config.get("secret_token"):
                embed.add_field(
                    name="Setup Complete",
                    value=" Token configured",
                    inline=True
                )
            else:
                embed.add_field(
                    name="Setup Required",
                    value="âš ï¸ Run quickstart to set up",
                    inline=True
                )
            
            if self.last_send_success:
                embed.add_field(
                    name="Last Success",
                    value=self.last_send_success.strftime("%Y-%m-%d %H:%M:%S"),
                    inline=True
                )
            
            embed.add_field(
                name="Send Failures",
                value=str(self.send_failures),
                inline=True
            )
            
            embed.add_field(
                name="Update Interval",
                value=f"{self.config.get('update_interval', 5)}s",
                inline=True
            )
            
            if not self.config.get("secret_token"):
                embed.add_field(
                    name="Next Steps",
                    value="Run `/livemonitor quickstart <your_website_url>` to get started",
                    inline=False
                )
            
            await (ctx.send(embed=embed) if hasattr(ctx, 'send') else ctx.response.send_message(embed=embed))
        
        elif action == "quickstart":
            if not url:
                embed = discord.Embed(
                    title="Quick Start - Live Monitor",
                    color=0xff0000,
                    description="Please provide a URL for your dashboard"
                )
                embed.add_field(
                    name="Usage",
                    value="`/livemonitor quickstart <your_website_url>`",
                    inline=False
                )
                embed.add_field(
                    name="Example",
                    value="`/livemonitor quickstart https://mybot.com/monitor`",
                    inline=False
                )
                await (ctx.send(embed=embed) if hasattr(ctx, 'send') else ctx.response.send_message(embed=embed))
                return
            
            await (ctx.defer() if hasattr(ctx, 'defer') else ctx.response.defer())
            
            if not url.startswith('http://') and not url.startswith('https://'):
                url = 'https://' + url
            

            token = secrets.token_urlsafe(32)

            setup_token = secrets.token_urlsafe(32)
            
            self.config["website_url"] = url.rstrip('/')
            self.config["secret_token"] = token
            self.config["setup_token"] = setup_token
            self.config["update_interval"] = interval or 5
            self.config["enabled"] = False
            self._save_config()
            
            embed = discord.Embed(
                title="ğŸ“¦ Generating Files...",
                color=0x3b82f6,
                description="Creating your dashboard files"
            )
            
            msg = await (ctx.send(embed=embed) if hasattr(ctx, 'send') else ctx.followup.send(embed=embed))
            
            output_dir = Path("./live_monitor_website")
            output_dir.mkdir(exist_ok=True)
            

            (output_dir / "index.php").write_text(
                self._generate_index_php(token, self._get_default_prefix(), setup_token),
                encoding='utf-8'
            )


            (output_dir / "lm_bootstrap.php").write_text(
                self._generate_lm_bootstrap_php(token, setup_token), encoding='utf-8'
            )
            (output_dir / "lm_db.php").write_text(self._generate_lm_db_php(), encoding='utf-8')
            (output_dir / "lm_auth.php").write_text(self._generate_lm_auth_php(self._dashboard_plugins), encoding='utf-8')

            if self._dashboard_plugins:
                (output_dir / "plugin_api.php").write_text(self._generate_plugin_api_php(self._dashboard_plugins), encoding='utf-8')
            (output_dir / "setup.php").write_text(self._generate_setup_php(), encoding='utf-8')
            (output_dir / "login.php").write_text(self._generate_login_php(), encoding='utf-8')
            (output_dir / "oauth_callback.php").write_text(self._generate_oauth_callback_php(), encoding='utf-8')
            (output_dir / "logout.php").write_text(self._generate_logout_php(), encoding='utf-8')
            (output_dir / "owner_audit.php").write_text(self._generate_owner_audit_php(), encoding='utf-8')
            (output_dir / "owner_roles.php").write_text(self._generate_owner_roles_php(), encoding='utf-8')
            (output_dir / "owner_db.php").write_text(self._generate_owner_db_php(), encoding='utf-8')
            (output_dir / "backup_dashboard.php").write_text(self._generate_backup_dashboard_php(), encoding='utf-8')


            (output_dir / "receive.php").write_text(self._generate_receive_php(token), encoding='utf-8')
            (output_dir / "get_commands.php").write_text(self._generate_get_commands_php(token), encoding='utf-8')
            (output_dir / "send_command.php").write_text(self._generate_send_command_php(token), encoding='utf-8')
            (output_dir / "get_user_permissions.php").write_text(self._generate_get_user_permissions_php(), encoding='utf-8')
            (output_dir / "get_tickets.php").write_text(self._generate_get_tickets_php(), encoding='utf-8')
            (output_dir / "get_transcript.php").write_text(self._generate_get_transcript_php(), encoding='utf-8')
            (output_dir / "download_transcript.php").write_text(self._generate_download_transcript_php(), encoding='utf-8')
            (output_dir / "delete_ticket.php").write_text(self._generate_delete_ticket_php(), encoding='utf-8')
            (output_dir / "privacy_api.php").write_text(self._generate_privacy_api_php(), encoding='utf-8')
            (output_dir / "transcript_view.php").write_text(self._generate_transcript_view_php(), encoding='utf-8')


            (output_dir / ".htaccess").write_text(self._generate_htaccess(), encoding='utf-8')
            

            data_dir = output_dir / "data"
            data_dir.mkdir(exist_ok=True)
            (data_dir / ".htaccess").write_text(self._generate_data_htaccess(), encoding='utf-8')

            self._copy_dashboard_assets(output_dir)
            

            archive_path = shutil.make_archive(str(output_dir), "zip", root_dir=output_dir)


            try:
                ts = datetime.now().strftime("%Y%m%d_%H%M%S")
                backup_root = Path("./data/Dashboardbackups")
                backup_root.mkdir(parents=True, exist_ok=True)
                dash_backup = backup_root / f"web_dashboard_{ts}.zip"
                shutil.copy2(archive_path, dash_backup)
            except Exception as e:
                logger.error(f"Live Monitor: failed to copy dashboard zip to ./data/Dashboardbackups: {e}")


            files = [
                discord.File(archive_path, filename="live_monitor_website.zip"),
            ]
            
            embed = discord.Embed(
                title="âœ… Live Monitor - Setup Complete!",
                color=0x00ff00,
                description="Your dashboard files are ready. Follow the steps below:"
            )
            
            configured_interval = self.config.get("update_interval", 5)
            
            embed.add_field(
                name="ğŸ“ Step 1: Upload Files",
                value=(
                    "Download `live_monitor_website.zip`, extract it, and upload **everything inside** "
                    "(all PHP files plus the `assets` folder) into the folder on your webhost where you "
                    "want the dashboard to live, for example:\n`" + url + "`"
                ),
                inline=False
            )
            
            embed.add_field(
                name="ğŸ”‘ Step 2: Security Token",
                value=f"Your secret token (already in files):\n```{token}```",
                inline=False
            )
            
            embed.add_field(
                name="ğŸš€ Step 3: Enable Monitoring",
                value=f"Run: `/livemonitor enable`\n\n**Update Interval:** {configured_interval} seconds\nTo change: `/livemonitor enable [interval]` (e.g. `/livemonitor enable 10`)",
                inline=False
            )

            embed.add_field(
                name="ğŸŒ Step 4: Claim & Secure Dashboard",
                value=(
                    "Claim URL (one-time setup):\n"
                    f"`{url.rstrip('/')}/setup.php?setup_token={setup_token}`\n\n"
                    "Open this link in your browser, follow the on-screen guide to configure "
                    "Discord OAuth, then log in with your Discord account to lock the dashboard."
                ),
                inline=False
            )
            
            embed.add_field(
                name=" Whatâ€™s Inside the Zip",
                value=(
                    "â€¢ `index.php` - Dashboard interface (Discord login protected)\\n"\
                    "â€¢ Bridge endpoints: `receive.php`, `get_commands.php`, `send_command.php`\\n"\
                    "â€¢ Security helpers: `setup.php`, `login.php`, `logout.php`, `oauth_callback.php`, `lm_db.php`, `lm_auth.php`, `lm_bootstrap.php`, `owner_audit.php`, `owner_roles.php`, `owner_db.php`, `backup_dashboard.php`\\n"\
                    "â€¢ Branding assets in `/assets` (icons, banner) so images load without extra setup.\\n"\
                    "â€¢ **Security:** `.htaccess` files protect JSON, SQLite & sensitive files from direct web access\\n"\
                ),
                inline=False
            )
            
            embed.set_footer(text="All files contain your security token. Keep them private!")
            
            if hasattr(ctx, 'send'):
                await msg.delete()
                await ctx.send(embed=embed, files=files)
            else:
                await msg.edit(embed=embed)
                await ctx.followup.send(files=files)
        
        elif action == "enable":
            if not self.config.get("website_url") or not self.config.get("secret_token"):
                embed = discord.Embed(
                    title="âš ï¸ Setup Required",
                    color=0xff0000,
                    description="Please run quick start first"
                )
                embed.add_field(
                    name="Command",
                    value="`/livemonitor quickstart <your_website_url>`",
                    inline=False
                )
                await (ctx.send(embed=embed) if hasattr(ctx, 'send') else ctx.response.send_message(embed=embed))
                return
            

            if interval is not None:
                if interval < 2 or interval > 60:
                    embed = discord.Embed(
                        title="âš ï¸ Invalid Interval",
                        color=0xff0000,
                        description="Interval must be between 2 and 60 seconds"
                    )
                    await (ctx.send(embed=embed) if hasattr(ctx, 'send') else ctx.response.send_message(embed=embed))
                    return
                self.config["update_interval"] = interval
                self._save_config()
            
            self.is_enabled = True
            self.config["enabled"] = True
            self._save_config()
            
            effective_interval = self.config.get("update_interval", 5)
            
            if not self.send_status_loop.is_running():
                self.send_status_loop.change_interval(seconds=effective_interval)
                self.send_status_loop.start()
            else:

                self.send_status_loop.change_interval(seconds=effective_interval)




            try:
                await self._sync_assets_to_server_once()
            except Exception as e:
                logger.error(f"Live Monitor: Asset sync on enable failed: {e}")
            
            embed = discord.Embed(
                title="âœ… Live Monitor Enabled",
                color=0x00ff00,
                description="Bot is now sending data to your dashboard"
            )
            embed.add_field(
                name="Dashboard URL",
                value=f"{self.config['website_url']}/index.php",
                inline=False
            )
            embed.add_field(
                name="Update Interval",
                value=f"Every {effective_interval} seconds",
                inline=True
            )
            if interval is not None:
                embed.add_field(
                    name="Interval Updated",
                    value="âœ“ New interval applied",
                    inline=True
                )
            embed.set_footer(text="Tip: Use '/livemonitor enable [interval]' to change the update frequency")
            
            await (ctx.send(embed=embed) if hasattr(ctx, 'send') else ctx.response.send_message(embed=embed))
        
        elif action == "disable":
            self.is_enabled = False
            self.config["enabled"] = False
            self._save_config()
            
            if self.send_status_loop.is_running():
                self.send_status_loop.cancel()
            

            try:
                if self.config.get("website_url") and self.config.get("secret_token"):
                    base_url = self.config['website_url']
                    token = self.config['secret_token']
                    url = f"{base_url}/receive.php?token={token}&package=status"
                    async with aiohttp.ClientSession() as session:
                        await session.post(url, json={
                            "enabled": False,
                            "status": "disabled",
                            "message": "Live Monitor has been disabled by bot owner",
                            "timestamp": datetime.now().isoformat()
                        }, timeout=aiohttp.ClientTimeout(total=5))
                    logger.info("Live Monitor: Sent disabled status to dashboard")
            except Exception as e:
                logger.warning(f"Live Monitor: Failed to send disabled status: {e}")
            
            embed = discord.Embed(
                title="â¸ï¸ Live Monitor Disabled",
                color=0xff0000,
                description="Bot has stopped sending data to the dashboard"
            )
            embed.add_field(
                name="Dashboard Status",
                value="The dashboard will show a disconnected indicator",
                inline=False
            )
            embed.set_footer(text="Use '/livemonitor enable' to resume monitoring")
            
            await (ctx.send(embed=embed) if hasattr(ctx, 'send') else ctx.response.send_message(embed=embed))
        
        elif action == "files":
            if not self.config.get("secret_token"):
                embed = discord.Embed(
                    title="âš ï¸ Setup Required",
                    color=0xff0000,
                    description="Please run quick start first"
                )
                embed.add_field(
                    name="Command",
                    value="`/livemonitor quickstart <your_website_url>`",
                    inline=False
                )
                await (ctx.send(embed=embed) if hasattr(ctx, 'send') else ctx.response.send_message(embed=embed))
                return
            
            await (ctx.defer() if hasattr(ctx, 'defer') else ctx.response.defer())
            
            output_dir = Path("./live_monitor_website")
            output_dir.mkdir(exist_ok=True)
            
            token = self.config["secret_token"]
            setup_token = self.config.get("setup_token") or secrets.token_urlsafe(32)
            self.config["setup_token"] = setup_token
            self._save_config()


            (output_dir / "index.php").write_text(
                self._generate_index_php(token, self._get_default_prefix(), setup_token),
                encoding='utf-8'
            )
            (output_dir / "lm_bootstrap.php").write_text(
                self._generate_lm_bootstrap_php(token, setup_token), encoding='utf-8'
            )
            (output_dir / "lm_db.php").write_text(self._generate_lm_db_php(), encoding='utf-8')
            (output_dir / "lm_auth.php").write_text(self._generate_lm_auth_php(self._dashboard_plugins), encoding='utf-8')

            if self._dashboard_plugins:
                (output_dir / "plugin_api.php").write_text(self._generate_plugin_api_php(self._dashboard_plugins), encoding='utf-8')
            (output_dir / "setup.php").write_text(self._generate_setup_php(), encoding='utf-8')
            (output_dir / "login.php").write_text(self._generate_login_php(), encoding='utf-8')
            (output_dir / "oauth_callback.php").write_text(self._generate_oauth_callback_php(), encoding='utf-8')
            (output_dir / "logout.php").write_text(self._generate_logout_php(), encoding='utf-8')
            (output_dir / "owner_audit.php").write_text(self._generate_owner_audit_php(), encoding='utf-8')
            (output_dir / "owner_roles.php").write_text(self._generate_owner_roles_php(), encoding='utf-8')
            (output_dir / "owner_db.php").write_text(self._generate_owner_db_php(), encoding='utf-8')
            (output_dir / "backup_dashboard.php").write_text(self._generate_backup_dashboard_php(), encoding='utf-8')


            (output_dir / "receive.php").write_text(self._generate_receive_php(token), encoding='utf-8')
            (output_dir / "get_commands.php").write_text(self._generate_get_commands_php(token), encoding='utf-8')
            (output_dir / "send_command.php").write_text(self._generate_send_command_php(token), encoding='utf-8')
            (output_dir / "get_user_permissions.php").write_text(self._generate_get_user_permissions_php(), encoding='utf-8')
            (output_dir / "get_tickets.php").write_text(self._generate_get_tickets_php(), encoding='utf-8')
            (output_dir / "get_transcript.php").write_text(self._generate_get_transcript_php(), encoding='utf-8')
            (output_dir / "download_transcript.php").write_text(self._generate_download_transcript_php(), encoding='utf-8')
            (output_dir / "delete_ticket.php").write_text(self._generate_delete_ticket_php(), encoding='utf-8')
            (output_dir / "privacy_api.php").write_text(self._generate_privacy_api_php(), encoding='utf-8')
            (output_dir / "transcript_view.php").write_text(self._generate_transcript_view_php(), encoding='utf-8')


            (output_dir / ".htaccess").write_text(self._generate_htaccess(), encoding='utf-8')
            

            data_dir = output_dir / "data"
            data_dir.mkdir(exist_ok=True)
            (data_dir / ".htaccess").write_text(self._generate_data_htaccess(), encoding='utf-8')

            self._copy_dashboard_assets(output_dir)
            
            archive_path = shutil.make_archive(str(output_dir), "zip", root_dir=output_dir)



            try:
                ts = datetime.now().strftime("%Y%m%d_%H%M%S")
                backup_root = Path("./data/Dashboardbackups")
                backup_root.mkdir(parents=True, exist_ok=True)
                dash_backup = backup_root / f"web_dashboard_{ts}.zip"
                shutil.copy2(archive_path, dash_backup)
            except Exception as e:
                logger.error(f"Live Monitor: failed to copy dashboard files zip to ./data/Dashboardbackups: {e}")

            files = [
                discord.File(archive_path, filename="live_monitor_website.zip"),
            ]
            
            embed = discord.Embed(
                title="ğŸ“ Dashboard Files",
                color=0x3b82f6,
                description="Updated dashboard files packaged as a single zip archive."
            )
            
            embed.add_field(
                name="Upload Location",
                value=f"`{self.config['website_url']}`",
                inline=False
            )
            
            embed.add_field(
                name="Contents",
                value=(
                    "The `live_monitor_website.zip` contains all PHP files and the `assets` folder. "
                    "Extract it locally and upload everything inside to the path above."
                ),
                inline=False
            )
            
            if hasattr(ctx, 'send'):
                await ctx.send(embed=embed, files=files)
            else:
                await ctx.followup.send(embed=embed, files=files)
    
    @app_commands.command(name="zframedash", description="Directly enable sending to a ZFrame dashboard")
    @app_commands.describe(
        action="Action to perform",
        url="Dashboard URL",
        secret_token="Secret token",
        interval="Update interval in seconds (2-60)"
    )
    @app_commands.choices(action=[
        app_commands.Choice(name="Enable", value="enable"),
    ])
    @app_commands.check(lambda interaction: interaction.client.is_owner(interaction.user))
    async def zframedash_slash(
        self,
        interaction: discord.Interaction,
        action: str,
        url: Optional[str] = None,
        secret_token: Optional[str] = None,
        interval: Optional[int] = None
    ):
        await self._zframedash_logic(interaction, action, url, secret_token, interval)
    
    async def _zframedash_logic(self, ctx, action: str, url: Optional[str], secret_token: Optional[str], interval: Optional[int]):
        if action != "enable":
            embed = discord.Embed(
                title="Invalid action",
                color=0xff0000,
                description="Only 'Enable' is supported for this command"
            )
            await (ctx.send(embed=embed) if hasattr(ctx, 'send') else ctx.response.send_message(embed=embed))
            return
        
        if not url or not secret_token:
            embed = discord.Embed(
                title="Missing parameters",
                color=0xff0000,
                description="Provide URL and Secret token"
            )
            embed.add_field(
                name="Usage",
                value="/zframedash action:Enable URL:<your_url> Secret_token:<token> interval:<2-60>",
                inline=False
            )
            await (ctx.send(embed=embed) if hasattr(ctx, 'send') else ctx.response.send_message(embed=embed))
            return
        
        if not url.startswith("http://") and not url.startswith("https://"):
            url = "https://" + url
        
        if interval is not None:
            if interval < 2 or interval > 60:
                embed = discord.Embed(
                    title="Invalid interval",
                    color=0xff0000,
                    description="Interval must be between 2 and 60 seconds"
                )
                await (ctx.send(embed=embed) if hasattr(ctx, 'send') else ctx.response.send_message(embed=embed))
                return
        
        self.config["website_url"] = url.rstrip("/")
        self.config["secret_token"] = secret_token
        self.config["update_interval"] = interval or self.config.get("update_interval", 5)
        self.config["enabled"] = True
        self._save_config()
        
        self.is_enabled = True
        effective_interval = self.config.get("update_interval", 5)
        
        if not self.send_status_loop.is_running():
            self.send_status_loop.change_interval(seconds=effective_interval)
            self.send_status_loop.start()
        else:
            self.send_status_loop.change_interval(seconds=effective_interval)
        
        try:
            await self._sync_assets_to_server_once()
        except Exception as e:
            logger.error(f"Live Monitor: Asset sync on zframedash enable failed: {e}")
        
        embed = discord.Embed(
            title="ZFrame Dash Enabled",
            color=0x00ff00,
            description="Bot is now sending data to the dashboard"
        )
        embed.add_field(
            name="Dashboard URL",
            value=f"{self.config['website_url']}/index.php",
            inline=False
        )
        embed.add_field(
            name="Update Interval",
            value=f"Every {effective_interval} seconds",
            inline=True
        )
        await (ctx.send(embed=embed) if hasattr(ctx, 'send') else ctx.response.send_message(embed=embed))
    
    def _generate_index_html(self, token: str) -> str:
        return '''<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Monitor Dashboard</title>
    <link rel="icon" type="image/png" href="assets/zoryx-framework.png">
    <link rel="icon" type="image/x-icon" href="assets/zoryx-framework.ico">
    <link rel="shortcut icon" href="assets/zoryx-framework.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #3b82f6;
            --secondary: #8b5cf6;
            --accent-cyan: #22d3ee;
            --accent-pink: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0a0e27;
            --bg-darker: #050814;
            --bg-card: rgba(26, 31, 58, 0.8);
            --bg-card-hover: rgba(51, 65, 85, 0.9);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: rgba(59, 130, 246, 0.2);
            --glow: rgba(59, 130, 246, 0.4);
        }

        body.dragging {
            user-select: none;
            cursor: col-resize !important;
        }

        body.dragging * {
            cursor: col-resize !important;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb {
            background: transparent;
            border-radius: 10px;
        }
        *:hover::-webkit-scrollbar-thumb { background: var(--gh-border); }

        .explorer-unit {
            width: 100%;
            max-width: 100%;
            height: 600px;
            display: flex;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        #file-browser-content,
        #tab-files {
            width: 100%;
        }
        .file-pane {
            width: 100%;
            display: flex;
            flex-direction: column;
            background: #0d1117;
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            min-width: 300px;
            z-index: 2;
        }

        .explorer-unit.editor-open .file-pane {
            flex-shrink: 0;
            border-right: 1px solid #30363d;
        }

        .dir-header {
            padding: 8px 16px;
            background: rgba(22, 27, 34, 0.6);
            border-bottom: 1px solid rgba(48, 54, 61, 0.8);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .breadcrumb {
            font-size: 11px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(13, 17, 23, 0.8);
            border: 1px solid rgba(48, 54, 61, 0.8);
            border-radius: 6px;
            padding: 4px 10px;
        }
        
        .breadcrumb-icon {
            font-size: 14px;
            margin-right: 2px;
        }

        .breadcrumb .crumb {
            color: #58a6ff;
            cursor: pointer;
            transition: all 0.2s;
            padding: 1px 3px;
            border-radius: 3px;
        }

        .breadcrumb .crumb:hover {
            background: rgba(88, 166, 255, 0.1);
            text-decoration: none;
        }

        .breadcrumb span {
            color: #6e7681;
            font-weight: 400;
            font-size: 11px;
        }

        .view-controls {
            display: flex;
            border: 1px solid #30363d;
            border-radius: 6px;
            overflow: hidden;
        }

        .file-toolbar {
            position: relative;
            display: flex;
            align-items: center;
        }

        .file-toolbar-toggle {
            background: transparent;
            border: none;
            color: #8b949e;
            font-size: 18px;
            line-height: 1;
            padding: 4px 6px;
            cursor: pointer;
            border-radius: 4px;
        }

        .file-toolbar-toggle:hover {
            background: rgba(110, 118, 129, 0.2);
        }

        .file-toolbar-menu {
            position: absolute;
            right: 0;
            top: 32px;
            background: #161b22;
            border-radius: 8px;
            border: 1px solid #30363d;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
            padding: 4px 0;
            display: none;
            min-width: 180px;
            z-index: 30;
            flex-direction: column;
        }

        .file-toolbar-menu.open {
            display: flex;
        }

        .file-toolbar-menu .v-btn {
            width: 100%;
            border: none;
            border-radius: 0;
            text-align: left;
            justify-content: flex-start;
        }

        .view-btn {
            background: #21262d;
            border: none;
            color: #8b949e;
            padding: 6px 16px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-right: 1px solid #30363d;
            transition: all 0.2s ease;
        }
        
        .view-btn:last-child {
            border-right: none;
        }
        
        .view-btn:hover {
            background: #30363d;
            color: #c9d1d9;
        }
        
        .view-btn.active {
            background: #1e40af;
            color: #ffffff;
        }

        .v-btn {
            background: #21262d;
            border: none;
            color: #c9d1d9;
            padding: 4px 12px;
            font-size: 12px;
            cursor: pointer;
            border-right: 1px solid #30363d;
        }
        .v-btn:last-child { border-right: none; }
        .v-btn.active { background: #30363d; }

        .scroll-area { flex: 1; overflow-y: auto; padding: 0; }

        .file-grid { display: grid; }
        .file-grid.list-mode { grid-template-columns: 1fr; }
        .file-grid.grid-mode { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); padding: 16px; gap: 8px; }

        .list {
            max-height: 420px;
            overflow-y: auto;
        }

        .file-grid.loading {
            pointer-events: none;
            opacity: 0.6;
            position: relative;
        }

        .file-grid.loading::after {
            content: 'Loading...';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--gh-dark);
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--gh-border);
            font-size: 14px;
            z-index: 10;
        }

        .file-row {
            padding: 8px 16px;
            border-bottom: 1px solid #21262d;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.1s;
        }

        .grid-mode .file-row {
            flex-direction: column;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 16px;
            text-align: center;
        }

        .file-row:hover { background: #161b22; }
        .file-row.active { background: rgba(56, 139, 253, 0.1); }
        .file-row.folder { color: #58a6ff; font-weight: 500; }
        .file-name { color: #c9d1d9; }
        .file-meta { color: #8b949e; font-size: 12px; margin-left: auto; }
        .grid-mode .file-meta { margin-left: 0; }

        .resizer {
            width: 4px;
            cursor: col-resize;
            background: transparent;
            z-index: 10;
            display: none;
            transition: background 0.2s;
            user-select: none;
            flex-shrink: 0;
        }
        .explorer-unit.editor-open .resizer { display: block; }
        .resizer:hover { background: #58a6ff; }

        .editor-pane {
            display: none;
            flex-direction: column;
            background: rgba(22, 27, 34, 0.7);
            backdrop-filter: blur(25px);
            width: 0;
            overflow: hidden;
        }

        .explorer-unit.editor-open .editor-pane {
            display: flex !important;
            flex: 1 !important;
        }

        .editor-header {
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #30363d;
            background: rgba(255,255,255,0.02);
        }

        .action-group { display: flex; gap: 8px; }

        .btn {
            height: 32px;
            padding: 0 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            border: 1px solid #30363d;
            background: #21262d;
            color: #c9d1d9;
            transition: all 0.2s ease;
        }

        .btn-save { background: #238636; border-color: rgba(255,255,255,0.1); color: white; }
        .btn:hover { border-color: #8b949e; }
        .btn:active {
            transform: scale(0.95);
        }

        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: #d1d5db;
            padding: 24px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 14px;
            line-height: 1.6;
            outline: none;
            resize: none;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: auto;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-darker) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            margin-bottom: 24px;
            padding: 18px 20px;
            background:
                linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.92)),
                url('assets/banner.png') center/cover no-repeat;
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            gap: 16px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--accent-cyan), var(--secondary));
            background-size: 200% auto;

            background-clip: text;
            -webkit-background-clip: text;

            color: transparent;
            -webkit-text-fill-color: transparent;

            animation: shimmer 3s linear infinite;
            margin: 0;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .header-title-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand-logo {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            flex-shrink: 0;
            box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.5);
            background: rgba(15, 23, 42, 0.9);
            object-fit: contain;
        }

        .header-subtitle {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: var(--text-secondary);
        }

        .header-subtitle a {
            color: inherit;
        }

        .header-subtitle a:hover {
            color: #e5f3ff;
        }

        .header-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .header-status-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .lm-user-pill {
            min-width: 0;
            display: flex;
            align-items: center;
            padding: 6px 10px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            background:
                radial-gradient(circle at 0 0, rgba(56,189,248,0.22), transparent 60%),
                radial-gradient(circle at 100% 100%, rgba(59,130,246,0.16), transparent 55%),
                rgba(15,23,42,0.96);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.55);
            font-size: 11px;
            color: var(--text-secondary);
        }

        .lm-user-pill-inner {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .lm-user-pill-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .lm-user-logout-button {
            margin-left: 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            background: rgba(15,23,42,0.95);
            color: var(--text-secondary);
            font-size: 11px;
            padding: 4px 10px;
            cursor: pointer;
            white-space: nowrap;
        }

        .lm-user-logout-button:hover {
            color: var(--text-primary);
            border-color: var(--primary);
        }

        .lm-user-pill-avatar {
            width: 20px;
            height: 20px;
            border-radius: 999px;
            overflow: hidden;
            flex-shrink: 0;
            background: #020617;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #e5e7eb;
        }

        .lm-user-pill-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .lm-user-pill-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .lm-user-pill-role {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .header-info-button {
            border-radius: 999px;
            border: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.9);
            color: var(--text-secondary);
            font-size: 11px;
            padding: 4px 10px;
            cursor: pointer;
        }

        .header-info-button:hover {
            color: var(--text-primary);
            border-color: var(--primary);
        }

        .header-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .header-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 15px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            min-width: 80px;
        }

        .header-stat .label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .header-stat span:last-child {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .status-badge {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .status-healthy {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.3));
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.4);
        }

        .status-degraded {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.3));
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.4);
        }

        .guilds-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 12px;
        }

        .guild-card {
            border-radius: 14px;
            border: 1px solid rgba(30, 64, 175, 0.7);
            background:
                radial-gradient(circle at 0 0, rgba(56,189,248,0.18), transparent 55%),
                radial-gradient(circle at 100% 100%, rgba(59,130,246,0.16), transparent 55%),
                rgba(15,23,42,0.98);
            padding: 12px 14px;
            box-shadow: 0 14px 36px rgba(15,23,42,0.85);
        }

        .guild-card-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 8px;
        }

        .guild-card-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .guild-card-members {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .guild-card-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 6px 12px;
            font-size: 11px;
            margin-bottom: 10px;
        }

        .guild-card-meta-row {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .guild-meta-label {
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            font-size: 10px;
        }

        .guild-meta-value {
            color: var(--text-primary);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .guild-meta-value.mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
            font-size: 10px;
        }

        .guild-card-actions {
            display: flex;
            justify-content: flex-end;
        }

        .db-table-card {
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(15,23,42,0.96);
            padding: 10px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 8px;
        }

        .db-table-main {
            min-width: 0;
        }

        .db-table-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .db-table-meta {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .db-rows-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .db-rows-table th,
        .db-rows-table td {
            padding: 6px 8px;
            border-bottom: 1px solid rgba(30,41,59,0.9);
            text-align: left;
        }

.db-rows-table th {
            border-bottom-color: var(--border);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 11px;
        }

        .invite-card {
            width: 100%;
            max-width: 100%;
            min-height: 520px;
            border-radius: 20px;
            border: 2px solid rgba(59, 130, 246, 0.6);
            background:
                radial-gradient(circle at 10% 10%, rgba(37, 99, 235, 0.35), transparent 60%),
                radial-gradient(circle at 90% 90%, rgba(139, 92, 246, 0.30), transparent 60%),
                radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.08), transparent 80%),
                linear-gradient(135deg, rgba(13, 17, 23, 0.98) 0%, rgba(17, 24, 39, 0.98) 100%);
            box-shadow: 
                0 0 80px rgba(59, 130, 246, 0.2),
                0 25px 60px rgba(15, 23, 42, 0.9),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .invite-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(59, 130, 246, 0.8) 20%, 
                rgba(139, 92, 246, 0.8) 80%, 
                transparent 100%);
        }

        .invite-card-header {
            border-bottom: 1px solid rgba(59, 130, 246, 0.3);
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            padding: 24px 28px;
        }

        .invite-card-body {
            padding: 28px;
        }

        .invite-output {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            background: rgba(0, 0, 0, 0.3) !important;
            border: 1px solid rgba(59, 130, 246, 0.4) !important;
            color: #60a5fa !important;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MARKETPLACE CARDS - Ultra Modern Professional Design
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .marketplace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 24px;
            margin-top: 20px;
            padding: 4px;
        }

        .marketplace-extension-card {
            --card-accent: #6366f1;
            --card-glow: rgba(99, 102, 241, 0.15);
            background: linear-gradient(165deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.9) 100%);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .marketplace-extension-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at top right, var(--card-glow), transparent 70%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
        }
        
        .marketplace-extension-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--card-accent), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .marketplace-extension-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: rgba(99, 102, 241, 0.4);
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(99, 102, 241, 0.1),
                0 0 60px -10px var(--card-glow);
        }
        
        .marketplace-extension-card:hover::before {
            opacity: 1;
        }
        
        .marketplace-extension-card:hover::after {
            opacity: 1;
        }
        
        /* Status-based accent colors */
        .marketplace-extension-card[data-status="working"] {
            --card-accent: #10b981;
            --card-glow: rgba(16, 185, 129, 0.2);
        }
        
        .marketplace-extension-card[data-status="beta"] {
            --card-accent: #f59e0b;
            --card-glow: rgba(245, 158, 11, 0.2);
        }
        
        .marketplace-extension-card[data-status="broken"] {
            --card-accent: #ef4444;
            --card-glow: rgba(239, 68, 68, 0.2);
        }

        .marketplace-ext-banner-wrap {
            position: relative;
            height: 140px;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%);
        }
        
        .marketplace-ext-banner {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }
        
        .marketplace-extension-card:hover .marketplace-ext-banner {
            transform: scale(1.08);
        }
        
        .marketplace-ext-banner-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(15, 23, 42, 1) 0%, rgba(15, 23, 42, 0.4) 50%, transparent 100%);
        }
        
        .marketplace-ext-banner-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.1) 100%);
            position: relative;
            overflow: hidden;
        }
        
        .marketplace-ext-banner-placeholder::before {
            content: '';
            position: absolute;
            inset: 0;
            background: url('assets/zoryx-framework.png') center/cover no-repeat;
            opacity: 0.25;
            filter: blur(1px);
        }
        
        .marketplace-ext-banner-placeholder svg {
            width: 48px;
            height: 48px;
            color: rgba(148, 163, 184, 0.3);
            position: relative;
            z-index: 1;
        }

        .marketplace-ext-body {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        .marketplace-ext-header {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            margin-bottom: 16px;
        }

        .marketplace-ext-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            object-fit: cover;
            border: 2px solid rgba(148, 163, 184, 0.15);
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            flex-shrink: 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .marketplace-extension-card:hover .marketplace-ext-icon {
            border-color: var(--card-accent);
            box-shadow: 0 0 20px -5px var(--card-glow);
        }
        
        .marketplace-ext-icon-placeholder {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--card-accent), rgba(139, 92, 246, 0.8));
            font-size: 22px;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .marketplace-extension-card:hover .marketplace-ext-icon-placeholder {
            transform: rotate(-3deg) scale(1.05);
        }

        .marketplace-ext-info {
            flex: 1;
            min-width: 0;
        }

        .marketplace-ext-title {
            font-size: 17px;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 6px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .marketplace-ext-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .marketplace-ext-version {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #94a3b8;
            background: rgba(148, 163, 184, 0.1);
            padding: 3px 8px;
            border-radius: 6px;
        }
        
        .marketplace-ext-version svg {
            width: 12px;
            height: 12px;
        }
        
        .marketplace-ext-type {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            background: rgba(100, 116, 139, 0.1);
            padding: 3px 8px;
            border-radius: 6px;
        }

        .marketplace-ext-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: absolute;
            top: 16px;
            right: 16px;
            backdrop-filter: blur(8px);
            z-index: 2;
        }
        
        .marketplace-ext-status svg {
            width: 12px;
            height: 12px;
        }

        .marketplace-status-working {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.2);
        }

        .marketplace-status-beta {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
            box-shadow: 0 0 12px rgba(245, 158, 11, 0.2);
        }

        .marketplace-status-broken {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.2);
        }

        .marketplace-ext-description {
            font-size: 13px;
            color: #94a3b8;
            line-height: 1.6;
            flex: 1;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 16px;
        }
        
        .marketplace-ext-stats {
            display: flex;
            gap: 16px;
            padding: 12px 0;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
            margin-bottom: 16px;
        }
        
        .marketplace-ext-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #64748b;
        }
        
        .marketplace-ext-stat svg {
            width: 14px;
            height: 14px;
            color: #475569;
        }
        
        .marketplace-ext-stat-value {
            font-weight: 600;
            color: #94a3b8;
        }

        .marketplace-ext-footer {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        .marketplace-ext-footer .button {
            flex: 1;
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .marketplace-ext-footer .button svg {
            flex-shrink: 0;
            vertical-align: middle;
        }
        
        .marketplace-btn-download {
            background: linear-gradient(135deg, var(--card-accent) 0%, rgba(139, 92, 246, 0.9) 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px -2px var(--card-glow);
        }
        
        .marketplace-btn-download:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -4px var(--card-glow);
        }
        
        .marketplace-btn-download:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .marketplace-btn-details {
            background: rgba(148, 163, 184, 0.1);
            color: #94a3b8;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .marketplace-btn-details:hover {
            background: rgba(148, 163, 184, 0.15);
            color: #e2e8f0;
            border-color: rgba(148, 163, 184, 0.3);
        }
        
        /* Loading state for cards */
        .marketplace-extension-card.is-loading {
            pointer-events: none;
        }
        
        .marketplace-extension-card.is-loading::before {
            opacity: 1;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
            animation: card-shimmer 1.5s infinite;
        }
        
        @keyframes card-shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Empty state */
        .marketplace-empty-state {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
            background: rgba(15, 23, 42, 0.5);
            border: 2px dashed rgba(148, 163, 184, 0.2);
            border-radius: 20px;
        }
        
        .marketplace-empty-state svg {
            width: 64px;
            height: 64px;
            color: #475569;
            margin-bottom: 16px;
        }
        
        .marketplace-empty-state h3 {
            font-size: 18px;
            font-weight: 600;
            color: #94a3b8;
            margin-bottom: 8px;
        }
        
        .marketplace-empty-state p {
            font-size: 14px;
            color: #64748b;
        }

        .status-critical {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.3));
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .system-hero {
            display: grid;
            grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.8fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .system-hero-main {
            padding: 12px 18px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background:
                radial-gradient(circle at 0% 0%, rgba(59, 130, 246, 0.35), transparent 60%),
                radial-gradient(circle at 100% 100%, rgba(139, 92, 246, 0.25), transparent 60%),
                rgba(15, 23, 42, 0.9);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

        .system-hero-metric {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-width: 0;
        }

        .system-hero-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .system-hero-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: baseline;
            gap: 4px;
        }

        .system-hero-unit {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .system-hero-secondary {
            padding: 14px 16px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.9);
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .system-hero-pill {
            padding: 8px 10px;
            border-radius: 10px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.4);
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .system-hero-pill-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .system-hero-pill-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        @media (max-width: 900px) {
            .system-hero {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        .hero-info-panel {
            display: none;
            margin-bottom: 20px;
            padding: 10px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.9);
        }

        .hero-info-panel.visible {
            display: flex;
            flex-wrap: wrap;
            gap: 14px 24px;
        }

        .hero-info-row {
            display: flex;
            gap: 8px;
            font-size: 13px;
        }

        .hero-info-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        .hero-info-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: rgba(13, 17, 23, 0.6);
            border-radius: 8px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            transition: all 0.2s ease;
        }

        .stat:hover {
            border-color: rgba(59, 130, 246, 0.4);
            background: rgba(13, 17, 23, 0.8);
        }

        .stat-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent-cyan));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
            box-shadow: 0 12px 32px rgba(59, 130, 246, 0.2);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-label {
            font-size: 11px;
            color: #8b949e;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #60a5fa;
            line-height: 1;
        }

        .stat-unit {
            font-size: 18px;
            color: var(--text-secondary);
            font-weight: 400;
            margin-left: 4px;
        }

        .section {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 18px;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--accent-cyan));

            background-clip: text;
            -webkit-background-clip: text;

            color: transparent;
            -webkit-text-fill-color: transparent;
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 4px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 28px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            position: relative;
        }

        .tab:hover {
            color: var(--text-primary);
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px 8px 0 0;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: rgba(59, 130, 246, 0.15);
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 12px rgba(59, 130, 246, 0.3);
        }

        /* Special highlight styling for the Credits tab */
        .tab.tab-credits {
            border-radius: 999px 999px 0 0;
            overflow: visible;
        }

        .tab.tab-credits::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: inherit;
            background: conic-gradient(from 180deg, #facc15, #fb923c, #f97316, #facc15);
            opacity: 0.35;
            filter: blur(6px);
            z-index: -1;
            pointer-events: none;
            transition: opacity 0.35s ease;
        }

        .tab.tab-credits.active::before {
            opacity: 0.7;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
            width: 100%;
            min-width: 0;
        }
        .section {
            width: 100%;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            padding: 18px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 14px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, border-color 0.2s ease;
        }

        .card:hover {
            border-color: rgba(139, 92, 246, 0.4);
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.15);
        }

        /* Improved checkbox styling */
        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(139, 92, 246, 0.5);
            border-radius: 5px;
            background: rgba(15, 23, 42, 0.8);
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        input[type="checkbox"]:hover {
            border-color: rgba(139, 92, 246, 0.8);
            background: rgba(139, 92, 246, 0.1);
        }

        input[type="checkbox"]:checked {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border-color: #8b5cf6;
        }

        input[type="checkbox"]:checked::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        input[type="checkbox"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Improved role card styling */
        .card[data-role-id] {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .card[data-role-id]:hover {
            transform: translateY(-2px);
            border-color: rgba(139, 92, 246, 0.5);
        }

        .card[data-role-id] .card-body {
            padding: 20px;
            border-top: 1px solid rgba(139, 92, 246, 0.15);
            margin-top: 12px;
        }

        /* Permission grid styling */
        .card-body label {
            padding: 10px 12px;
            border-radius: 8px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.3);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .card-body label:hover {
            background: rgba(30, 41, 59, 0.8);
            border-color: rgba(139, 92, 246, 0.4);
        }

        .card-body label input[type="checkbox"]:checked + span {
            color: #a78bfa;
            font-weight: 600;
        }

        /* Role badge styling */
        .role-edited-badge {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        /* Description textarea styling */
        .card-body textarea {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(71, 85, 105, 0.4);
            border-radius: 10px;
            padding: 12px;
            transition: all 0.2s ease;
        }

        .card-body textarea:focus {
            border-color: rgba(139, 92, 246, 0.6);
            background: rgba(30, 41, 59, 0.9);
        }

        /* Base tier select styling in cards - inherits global but with purple theme */
        .card-body select {
            border-color: rgba(139, 92, 246, 0.3);
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%238b5cf6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        }

        .card-body select:focus {
            border-color: rgba(139, 92, 246, 0.6);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        /* Section headers in role editor */
        .card-body > div[style*="text-transform:uppercase"] {
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.15) 0%, transparent 100%);
            padding: 8px 12px;
            border-radius: 8px;
            border-left: 3px solid rgba(139, 92, 246, 0.6);
            margin-bottom: 12px;
        }

        /* Layout helpers for two-column sections (Plugins & Extensions, etc.) */
        .two-column-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 20px;
        }

        .column-card {
            background: rgba(15, 23, 42, 0.85);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 20px;
            backdrop-filter: blur(18px);
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .column-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .column-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Live Monitor main layout + grouped sidebar + drawer + palette */
        .lm-main-layout {
            margin-top: 12px;
            display: grid;
            grid-template-columns: 230px minmax(0, 1fr);
            gap: 18px;
            align-items: flex-start;
        }

        .lm-main-content {
            min-width: 0;
        }

        .lm-sidebar {
            border-radius: 16px;
            border: 1px solid rgba(31, 41, 55, 0.9);
            background: rgba(15, 23, 42, 0.98);
            padding: 10px 12px;
        }

        .lm-sidebar-group-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: var(--text-secondary);
            margin: 8px 0 4px;
        }

        .lm-sidebar-item {
            width: 100%;
            border-radius: 9px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            padding: 7px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.18s ease, color 0.18s ease, transform 0.15s ease;
        }

        .lm-sidebar-item:hover {
            background: rgba(30, 64, 175, 0.4);
            color: var(--text-primary);
            transform: translateX(2px);
        }

        .lm-sidebar-item.lm-active {
            background: radial-gradient(circle at 0 0, rgba(37, 99, 235, 0.9), rgba(15, 23, 42, 1));
            color: #e5f3ff;
            box-shadow: 0 16px 36px rgba(15, 23, 42, 0.95);
        }

        .lm-nav-top-row {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin: 8px 0 4px;
        }

        .nav-palette-trigger,
        .lm-drawer-trigger {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 10px;
            border-radius: 8px;
            border: 1px solid rgba(31, 41, 55, 0.9);
            background: rgba(15, 23, 42, 0.98);
            font-size: 12px;
            cursor: pointer;
            color: var(--text-primary);
        }

        .nav-palette-trigger:hover,
        .lm-drawer-trigger:hover {
            border-color: rgba(59, 130, 246, 0.9);
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.5);
        }

        .nav-palette-trigger kbd {
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 4px;
            background: rgba(17, 24, 39, 0.9);
            border: 1px solid rgba(55, 65, 81, 0.9);
            color: var(--text-secondary);
        }

        .lm-drawer-icon {
            font-size: 14px;
        }

        /* Command palette overlay (D10 style) */
        .lm-nav-palette-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.78);
            backdrop-filter: blur(10px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.18s ease;
            z-index: 80;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lm-nav-palette-overlay.lm-open {
            opacity: 1;
            pointer-events: auto;
        }

        .lm-nav-palette-dialog {
            width: min(640px, 100% - 40px);
            max-height: 70vh;
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            background: radial-gradient(circle at 0 0, rgba(30, 64, 175, 0.8), rgba(15, 23, 42, 0.98));
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.9);
            padding: 12px 14px 16px;
        }

        .lm-nav-palette-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .lm-nav-palette-sub {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .lm-nav-palette-list {
            border-radius: 10px;
            border: 1px solid rgba(31, 41, 55, 0.9);
            background: rgba(15, 23, 42, 0.98);
            max-height: 42vh;
            overflow-y: auto;
        }

        .lm-nav-palette-item {
            width: 100%;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            text-align: left;
            padding: 8px 10px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.15s ease, color 0.15s ease;
        }

        .lm-nav-palette-item .lm-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid rgba(55, 65, 81, 0.9);
            color: var(--text-secondary);
        }

        .lm-nav-palette-item:hover {
            background: rgba(31, 41, 55, 0.95);
            color: var(--text-primary);
        }

        .lm-nav-palette-item.lm-active {
            background: radial-gradient(circle at 0 0, rgba(37, 99, 235, 0.9), rgba(15, 23, 42, 1));
            color: #e5f3ff;
        }

        /* Drawer nav (D8 style) */
        .lm-drawer-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(6px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 60;
        }

        .lm-drawer {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 260px;
            transform: translateX(-100%);
            transition: transform 0.25s ease;
            z-index: 61;
            padding: 14px 12px;
            border-radius: 0 18px 18px 0;
            border-right: 1px solid rgba(148, 163, 184, 0.5);
            background: radial-gradient(circle at 0 0, rgba(30, 64, 175, 0.75), rgba(15, 23, 42, 0.98));
        }

        .lm-drawer-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .lm-drawer-sub {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .lm-drawer-group-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: var(--text-secondary);
            margin: 8px 0 4px;
        }

        .lm-drawer-item {
            width: 100%;
            border-radius: 9px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            padding: 7px 9px;
            font-size: 13px;
            text-align: left;
            cursor: pointer;
            transition: background 0.18s ease, color 0.18s ease;
        }

        .lm-drawer-item:hover {
            background: rgba(15, 23, 42, 0.97);
            color: var(--text-primary);
        }

        .lm-drawer-item.lm-active {
            background: radial-gradient(circle at 0 0, rgba(37, 99, 235, 0.95), rgba(15, 23, 42, 1));
            color: #e5f3ff;
        }

        body.lm-drawer-open .lm-drawer-backdrop {
            opacity: 1;
            pointer-events: auto;
        }

        body.lm-drawer-open .lm-drawer {
            transform: translateX(0);
        }

        /* Responsive: hide sidebar on small screens, hide drawer controls on desktop */
        @media (max-width: 900px) {
            .lm-main-layout {
                grid-template-columns: minmax(0, 1fr);
            }
            .lm-sidebar {
                display: none;
            }
        }

        @media (min-width: 901px) {
            .lm-drawer-trigger,
            #lm-drawer-backdrop,
            #lm-drawer-nav {
                display: none;
            }
        }

        /* Hide old horizontal tab bar visually, keep for compatibility */
        .tab-container {
            display: none;
        }

        .column-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .input-text {
            flex: 1 1 160px;
            min-width: 0;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.8);
            color: var(--text-primary);
            font-size: 13px;
        }

        .input-text::placeholder {
            color: var(--text-secondary);
        }

        /* ============================================
           GLOBAL DROPDOWN / SELECT STYLES
           ============================================ */
        
        /* Base select styling - applies to all selects */
        select,
        .select,
        .lm-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            padding: 10px 36px 10px 14px;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            background-color: rgba(15, 23, 42, 0.8);
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            color: #e5e7eb;
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 120px;
        }
        
        select:hover,
        .select:hover,
        .lm-select:hover {
            border-color: rgba(148, 163, 184, 0.4);
            background-color: rgba(15, 23, 42, 0.95);
        }
        
        select:focus,
        .select:focus,
        .lm-select:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }
        
        select:disabled,
        .select:disabled,
        .lm-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Option styling for dark theme */
        select option,
        .select option,
        .lm-select option {
            background-color: #0f172a;
            color: #e5e7eb;
            padding: 10px 14px;
        }
        
        select option:hover,
        .select option:hover,
        .lm-select option:hover {
            background-color: #1e293b;
        }
        
        select option:checked,
        .select option:checked,
        .lm-select option:checked {
            background-color: rgba(139, 92, 246, 0.3);
        }
        
        select optgroup,
        .select optgroup,
        .lm-select optgroup {
            background-color: #0f172a;
            color: #94a3b8;
            font-weight: 600;
        }
        
        /* Color-themed select variants */
        .lm-select-blue {
            border-color: rgba(59, 130, 246, 0.3);
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        }
        
        .lm-select-blue:focus {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .lm-select-green {
            border-color: rgba(16, 185, 129, 0.3);
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%2310b981' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        }
        
        .lm-select-green:focus {
            border-color: rgba(16, 185, 129, 0.5);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .lm-select-orange {
            border-color: rgba(249, 115, 22, 0.3);
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23f97316' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        }
        
        .lm-select-orange:focus {
            border-color: rgba(249, 115, 22, 0.5);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }
        
        .lm-select-purple {
            border-color: rgba(168, 85, 247, 0.3);
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23a855f7' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        }
        
        .lm-select-purple:focus {
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }
        
        .lm-select-yellow {
            border-color: rgba(251, 191, 36, 0.3);
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23fbbf24' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        }
        
        .lm-select-yellow:focus {
            border-color: rgba(251, 191, 36, 0.5);
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
        }
        
        /* Small select variant */
        .lm-select-sm {
            padding: 8px 32px 8px 12px;
            font-size: 12px;
            border-radius: 8px;
            min-width: 100px;
        }

        /* System tab layout */
        .system-grid {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 2.2fr);
            gap: 20px;
            align-items: flex-start;
        }
     
            #db-data-grid {
                width: 100%;
                overflow-x: auto !important;
                display: block;
                background: rgba(15, 23, 42, 0.6);
                border-radius: 12px;
                border: 1px solid rgba(148, 163, 184, 0.1);
                margin-top: 15px;
            }

            #db-data-grid table {
                width: 100%;
                border-collapse: collapse;
                min-width: 1000px; /* Erzwingt die Breite, damit man scrollen muss */
            }
        .system-main {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
        }

        .system-locks {
            min-height: 0;
        }

        @media (max-width: 1100px) {
            .system-grid {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        /* Atomic File System lock table layout */
        .af-locks-header,
        .af-lock-row {
            display: grid;
            grid-template-columns: minmax(0, 4fr) minmax(0, 1.2fr) minmax(0, 1.5fr) minmax(0, 1.8fr) minmax(0, 2.4fr);
            gap: 8px;
            align-items: center;
        }

        .af-locks-header {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-secondary);
            letter-spacing: 0.06em;
            border-bottom: 1px solid var(--border);
            padding-bottom: 6px;
            margin-bottom: 6px;
        }

        .af-lock-row {
            padding: 6px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.25);
            font-size: 12px;
        }

        .af-lock-row:last-child {
            border-bottom: none;
        }

        .af-lock-path {
            font-family: monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .af-lock-status-chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            border: 1px solid var(--border);
        }

        .af-lock-status-locked {
            background: rgba(239, 68, 68, 0.16);
            border-color: rgba(239, 68, 68, 0.4);
            color: var(--danger);
        }

        .af-lock-status-idle {
            background: rgba(34, 197, 94, 0.12);
            border-color: rgba(34, 197, 94, 0.35);
            color: var(--success);
        }

        .af-lock-actions {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .af-lock-note {
            margin-top: 6px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .button-compact {
            padding: 6px 10px;
            font-size: 11px;
            box-shadow: none;
        }

        .file-drop-active {
            outline: 2px dashed rgba(59, 130, 246, 0.7);
            outline-offset: 4px;
        }
        
        .breadcrumb-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 6px;
        }
        
        .breadcrumb-icon svg {
            width: 16px;
            height: 16px;
            vertical-align: middle;
        }
        
        #file-context-menu {
            position: absolute;
            z-index: 2000;
            background: #020617;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 4px 0;
            min-width: 180px;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
            display: none;
        }

        #tab-files {
            position: relative;
        }

        .file-context-item {
            padding: 7px 14px;
            font-size: 13px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
        }

        .file-context-item:hover {
            background: rgba(59, 130, 246, 0.18);
        }

        .file-context-item.danger {
            color: var(--danger);
        }

        .file-context-item.danger:hover {
            background: rgba(239, 68, 68, 0.16);
        }

        .card:hover {
            background: var(--bg-card-hover);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(139, 92, 246, 0.2);
        }

        /* Dashboard overview cards: unify value text + clickable health card */
        #overview-stats .overview-stat-value {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-card-clickable {
            cursor: pointer;
            transition: background 0.18s ease, box-shadow 0.18s ease, transform 0.1s ease;
        }

        .stat-card-clickable:hover {
            background: rgba(148, 163, 184, 0.06);
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.65);
            transform: translateY(-1px);
        }

        /* SVG-based status chips used in header badge + Bot Health card */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            background: radial-gradient(circle at 0 0, rgba(37, 99, 235, 0.4), rgba(15, 23, 42, 0.9));
            font-size: 12px;
        }

        .status-badge-caption {
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .status-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-chip-icon {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        .status-chip-label {
            font-size: 13px;
            font-weight: 600;
        }

        .status-chip-healthy .status-chip-label {
            color: #22c55e;
        }

        .status-chip-degraded .status-chip-label {
            color: #f59e0b;
        }

        .status-chip-critical .status-chip-label {
            color: #ef4444;
        }

        /* Simple JSON viewer for diagnostics modal */
        .code-block-json {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 10px;
            border: 1px solid var(--border);
            padding: 12px 14px;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 12px;
            max-height: 420px;
            overflow: auto;
            white-space: pre;
            line-height: 1.4;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .card-body {
            display: none;
            padding-top: 14px;
            border-top: 1px solid var(--border);
            margin-top: 14px;
        }

        .card.expanded .card-body {
            display: block;
        }

        .button {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .button:disabled,
        .button[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .button-primary {
            background: linear-gradient(135deg, var(--primary), var(--accent-cyan));
            color: white;
        }

        .button-primary:hover {
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .button-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
        }

        .button-danger:hover {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .button-secondary {
            background: rgba(59, 130, 246, 0.15);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .button-secondary:hover {
            background: rgba(59, 130, 246, 0.25);
        }

        .button-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .button-success:hover {
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        /* Button waiting/loading state */
        .button.btn-waiting {
            opacity: 0.8;
            cursor: wait;
            pointer-events: none;
            background: linear-gradient(135deg, rgba(100, 116, 139, 0.8), rgba(71, 85, 105, 0.8)) !important;
            border-color: rgba(148, 163, 184, 0.3) !important;
            color: #e2e8f0 !important;
        }
        
        .btn-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: btnSpin 0.8s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }
        
        @keyframes btnSpin {
            to { transform: rotate(360deg); }
        }
        
        /* Enhanced marketplace download button states */
        .marketplace-btn-download.btn-waiting {
            background: linear-gradient(135deg, rgba(100, 116, 139, 0.6), rgba(71, 85, 105, 0.7)) !important;
            box-shadow: none !important;
            transform: none !important;
        }
        
        .marketplace-btn-download.btn-waiting .btn-spinner {
            width: 16px;
            height: 16px;
            border-width: 2.5px;
            border-color: rgba(255, 255, 255, 0.2);
            border-top-color: rgba(255, 255, 255, 0.9);
        }
        
        .marketplace-extension-card.download-success {
            animation: downloadSuccess 0.6s ease-out;
        }
        
        .marketplace-extension-card.download-success::after {
            opacity: 1;
            background: linear-gradient(90deg, transparent, #10b981, transparent) !important;
        }
        
        @keyframes downloadSuccess {
            0%, 100% { transform: translateY(0); }
            25% { transform: translateY(-4px); }
            50% { transform: translateY(-2px); }
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.2);
            color: var(--primary);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .badge-secondary {
            background: rgba(139, 92, 246, 0.2);
            color: var(--secondary);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 10px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent-cyan));
            border-radius: 6px;
            transition: width 0.5s ease;
            box-shadow: 0 0 12px var(--glow);
        }

        .property {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
        }

        .property:last-child {
            border-bottom: none;
        }

        .property-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .property-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
        }

        /* ============================================
           GLOBAL FOOTER - CENTERED ON PAGE
           ============================================ */
        
        .lm-global-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
            padding: 12px 24px;
            background: linear-gradient(to top, rgba(15, 23, 42, 0.98) 0%, rgba(15, 23, 42, 0.9) 70%, transparent 100%);
            pointer-events: none;
        }
        
        .lm-footer-content {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
            pointer-events: auto;
        }
        
        .lm-footer-update {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 4px;
        }
        
        .lm-footer-update span {
            color: #94a3b8;
        }
        
        .lm-footer-brand {
            font-size: 12px;
            margin-bottom: 2px;
        }
        
        .lm-footer-brand a {
            color: #94a3b8;
            text-decoration: none;
            transition: color 0.2s ease;
        }
        
        .lm-footer-brand a:hover {
            color: #e5e7eb;
        }
        
        .lm-footer-credit {
            font-size: 11px;
            color: #64748b;
        }
        
        .lm-footer-credit a {
            color: #fbbf24;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s ease;
        }
        
        .lm-footer-credit a:hover {
            color: #fde047;
        }
        
        @media (max-width: 768px) {
            .lm-global-footer {
                padding: 10px 16px;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(145deg, #0f172a 0%, #1e293b 100%);
            border-radius: 20px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            padding: 0;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6), 0 0 1px 1px rgba(139, 92, 246, 0.2);
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 32px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(59, 130, 246, 0.1) 100%);
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #ffffff;
            text-shadow: 0 2px 10px rgba(139, 92, 246, 0.3);
        }

        .close-button {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-weight: 600;
        }

        .close-button:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        #modal-body {
            padding: 32px;
            max-height: calc(90vh - 100px);
            overflow-y: auto;
        }
        
        
        
        .md-h2 {
            font-size: 20px;
            font-weight: 700;
            color: #f1f5f9;
            margin: 20px 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .md-h3 {
            font-size: 17px;
            font-weight: 600;
            color: #e2e8f0;
            margin: 16px 0 10px 0;
        }
        
        .md-h4 {
            font-size: 14px;
            font-weight: 600;
            color: #cbd5e1;
            margin: 14px 0 8px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .md-bold {
            font-weight: 600;
            color: #f1f5f9;
        }
        
        .md-italic {
            font-style: italic;
            color: #cbd5e1;
        }
        
        .md-strike {
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .md-code-block {
            display: block;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 8px;
            padding: 14px 16px;
            margin: 12px 0;
            font-family: 'JetBrains Mono', 'Fira Code', 'SF Mono', Consolas, monospace;
            font-size: 12px;
            line-height: 1.6;
            color: #a5f3fc;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .md-inline-code {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.25);
            border-radius: 4px;
            padding: 2px 6px;
            font-family: 'JetBrains Mono', 'Fira Code', 'SF Mono', Consolas, monospace;
            font-size: 0.9em;
            color: #c4b5fd;
        }
        
        .md-ul, .md-ol {
            margin: 12px 0;
            padding-left: 24px;
        }
        
        .md-li, .md-li-num {
            margin: 6px 0;
            line-height: 1.6;
            color: #cbd5e1;
        }
        
        .md-li::marker {
            color: #8b5cf6;
        }
        
        .md-li-num::marker {
            color: #6366f1;
            font-weight: 600;
        }
        
        .md-quote {
            border-left: 3px solid #8b5cf6;
            background: rgba(139, 92, 246, 0.08);
            padding: 10px 16px;
            margin: 12px 0;
            border-radius: 0 8px 8px 0;
            color: #cbd5e1;
            font-style: italic;
        }
        
        .md-hr {
            border: none;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(148, 163, 184, 0.3), transparent);
            margin: 20px 0;
        }
        
        .md-link {
            color: #60a5fa;
            text-decoration: none;
            border-bottom: 1px solid rgba(96, 165, 250, 0.3);
            transition: all 0.2s ease;
        }
        
        .md-link:hover {
            color: #93c5fd;
            border-bottom-color: rgba(147, 197, 253, 0.5);
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           EXTENSION DETAILS MODAL - Premium Design
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .ext-modal-container {
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        
        .ext-modal-banner {
            width: calc(100% + 64px);
            height: 180px;
            margin: -32px -32px 0 -32px;
            object-fit: cover;
            border-radius: 0;
        }
        
        .ext-modal-banner-placeholder {
            width: calc(100% + 64px);
            height: 180px;
            margin: -32px -32px 0 -32px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.15) 50%, rgba(59, 130, 246, 0.1) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .ext-modal-banner-placeholder::before {
            content: '';
            position: absolute;
            inset: 0;
            background: url('assets/zoryx-framework.png') center/cover no-repeat;
            opacity: 0.3;
        }
        
        .ext-modal-banner-placeholder svg {
            width: 64px;
            height: 64px;
            color: rgba(148, 163, 184, 0.4);
            position: relative;
            z-index: 1;
        }
        
        .ext-modal-header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 20px 0;
            margin-top: -40px;
            position: relative;
            z-index: 2;
        }
        
        .ext-modal-icon {
            width: 80px;
            height: 80px;
            border-radius: 16px;
            object-fit: cover;
            border: 3px solid #0f172a;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            background: linear-gradient(135deg, #1e293b, #0f172a);
            flex-shrink: 0;
        }
        
        .ext-modal-icon-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            color: white;
            border: 3px solid #0f172a;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            flex-shrink: 0;
        }
        
        .ext-modal-icon-placeholder.status-working {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .ext-modal-icon-placeholder.status-beta {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .ext-modal-icon-placeholder.status-broken {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .ext-modal-title-section {
            flex: 1;
            padding-top: 44px;
        }
        
        .ext-modal-title {
            font-size: 22px;
            font-weight: 700;
            color: #f1f5f9;
            margin: 0 0 8px 0;
            line-height: 1.2;
        }
        
        .ext-modal-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        .ext-modal-meta-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .ext-modal-meta-pill svg {
            width: 14px;
            height: 14px;
        }
        
        .ext-modal-meta-pill.version {
            background: rgba(99, 102, 241, 0.15);
            color: #a5b4fc;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        
        .ext-modal-meta-pill.type {
            background: rgba(148, 163, 184, 0.1);
            color: #94a3b8;
            border: 1px solid rgba(148, 163, 184, 0.2);
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }
        
        .ext-modal-meta-pill.id {
            background: rgba(30, 41, 59, 0.8);
            color: #64748b;
            border: 1px solid rgba(148, 163, 184, 0.15);
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }
        
        .ext-modal-meta-pill.status {
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 11px;
        }
        
        .ext-modal-meta-pill.status.working {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .ext-modal-meta-pill.status.beta {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .ext-modal-meta-pill.status.broken {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .ext-modal-description {
            font-size: 14px;
            line-height: 1.7;
            color: #94a3b8;
            padding: 16px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .ext-modal-details-section {
            padding: 20px 0 0 0;
        }
        
        .ext-modal-details-title {
            font-size: 13px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ext-modal-details-title svg {
            width: 16px;
            height: 16px;
        }
        
        .ext-modal-details-content {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 20px;
            font-size: 13px;
            line-height: 1.7;
            color: #cbd5e1;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .ext-modal-actions {
            display: flex;
            gap: 12px;
            padding-top: 20px;
            margin-top: 20px;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .ext-modal-actions .button {
            flex: 1;
            padding: 14px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .ext-modal-actions .button svg {
            flex-shrink: 0;
            vertical-align: middle;
        }

                /* Custom Scrollbar Styling for Database Viewer */
        #db-tables-list::-webkit-scrollbar,
        #db-data-grid::-webkit-scrollbar,
        #db-main-content::-webkit-scrollbar,
        #db-data-grid > div::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        #db-tables-list::-webkit-scrollbar-track,
        #db-data-grid::-webkit-scrollbar-track,
        #db-main-content::-webkit-scrollbar-track,
        #db-data-grid > div::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 6px;
            margin: 2px;
        }

        #db-tables-list::-webkit-scrollbar-thumb,
        #db-data-grid::-webkit-scrollbar-thumb,
        #db-main-content::-webkit-scrollbar-thumb,
        #db-data-grid > div::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.6), rgba(139, 92, 246, 0.8));
            border-radius: 6px;
            border: 2px solid rgba(15, 23, 42, 0.8);
        }

        #db-tables-list::-webkit-scrollbar-thumb:hover,
        #db-data-grid::-webkit-scrollbar-thumb:hover,
        #db-main-content::-webkit-scrollbar-thumb:hover,
        #db-data-grid > div::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.9), rgba(139, 92, 246, 1));
        }

        /* Enhanced table scrolling */
        #db-data-grid table {
            border-spacing: 0;
        }

        #db-data-grid > div {
            scrollbar-width: thin;
            scrollbar-color: rgba(168, 85, 247, 0.8) rgba(15, 23, 42, 0.8);
        }

        /* Force horizontal scrollbar visibility for db-data-grid inner container */
        #db-data-grid > div::-webkit-scrollbar {
            width: 12px;
            height: 12px;
            display: block;
        }

        #db-data-grid > div::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 6px;
        }

        #db-data-grid > div::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.6), rgba(139, 92, 246, 0.8));
            border-radius: 6px;
            border: 2px solid rgba(15, 23, 42, 0.8);
        }

        #db-data-grid > div::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.9), rgba(139, 92, 246, 1));
        }

        #db-data-grid > div::-webkit-scrollbar-corner {
            background: rgba(15, 23, 42, 0.8);
        }



        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(139, 92, 246, 0.7);
        }

        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid rgba(139, 92, 246, 0.6);
            outline-offset: 2px;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .lm-main-layout {
                grid-template-columns: minmax(0, 1fr);
            }

            .stats-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .two-column-grid,
            .system-grid {
                grid-template-columns: minmax(0, 1fr);
            }

            .explorer-unit {
                flex-direction: column;
                height: auto;
            }

            .explorer-unit .file-pane,
            .explorer-unit .editor-pane {
                min-height: 220px;
            }
        }

        /* Global link styling so dashboard links look polished */
        a {
            color: var(--accent-cyan);
            text-decoration: none;
            position: relative;
            font-weight: 500;
            transition: color 0.25s ease, text-shadow 0.25s ease;
        }

        a::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -2px;
            width: 100%;
            height: 2px;
            border-radius: 999px;
            background: linear-gradient(90deg, var(--primary), var(--accent-cyan));
            transform: scaleX(0);
            transform-origin: left;
            opacity: 0.7;
            transition: transform 0.25s ease;
        }

        a:hover {
            color: #e5f3ff;
            text-shadow: 0 0 8px rgba(34, 211, 238, 0.7);
        }

        a:hover::after {
            transform: scaleX(1);
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .quick-actions-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        .quick-actions-column {
            flex: 1 1 240px;
            min-width: 0;
        }

        .quick-actions-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .quick-actions-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        /* ============================================
           MODERNIZED DASHBOARD TAB STYLES
           ============================================ */
        
        /* Dashboard Hero Header */
        .dash-hero {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 24px;
            padding: 32px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
        }
        
        .dash-hero-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            pointer-events: none;
        }
        
        .dash-hero-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            animation: dashOrbFloat 20s ease-in-out infinite;
        }
        
        .dash-hero-orb-1 {
            width: 300px;
            height: 300px;
            background: rgba(124, 58, 237, 0.25);
            top: -100px;
            left: -50px;
        }
        
        .dash-hero-orb-2 {
            width: 250px;
            height: 250px;
            background: rgba(59, 130, 246, 0.2);
            bottom: -80px;
            right: -30px;
            animation-delay: -10s;
        }
        
        @keyframes dashOrbFloat {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(20px, -20px) scale(1.1); }
        }
        
        .dash-hero-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(148, 163, 184, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(148, 163, 184, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        
        .dash-hero-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        
        .dash-hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: rgba(124, 58, 237, 0.15);
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 999px;
            font-size: 12px;
            font-weight: 500;
            color: #c4b5fd;
            margin-bottom: 12px;
        }
        
        .dash-hero-badge-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: dashDotPulse 2s ease-in-out infinite;
        }
        
        @keyframes dashDotPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        .dash-hero-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 0 8px 0;
        }
        
        .dash-hero-subtitle {
            font-size: 14px;
            color: #94a3b8;
            margin: 0;
        }
        
        .dash-tour-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: rgba(148, 163, 184, 0.1);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 10px;
            color: #e5e7eb;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .dash-tour-btn:hover {
            background: rgba(148, 163, 184, 0.2);
            border-color: rgba(148, 163, 184, 0.3);
            transform: translateY(-1px);
        }
        
        /* Dashboard Stats Grid */
        .dash-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .dash-stat-card {
            position: relative;
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: default;
        }
        
        .dash-stat-card:hover {
            transform: translateY(-4px);
            border-color: rgba(148, 163, 184, 0.3);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }
        
        .dash-stat-card:hover .dash-stat-glow {
            opacity: 1;
        }
        
        .dash-stat-health {
            cursor: pointer;
        }
        
        .dash-stat-health:hover {
            border-color: rgba(16, 185, 129, 0.5);
        }
        
        .dash-stat-health .dash-stat-icon {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(52, 211, 153, 0.1));
            color: #34d399;
        }
        
        .dash-stat-health .dash-stat-glow {
            background: radial-gradient(circle at center, rgba(16, 185, 129, 0.15), transparent 70%);
        }
        
        .dash-stat-uptime .dash-stat-icon {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(96, 165, 250, 0.1));
            color: #60a5fa;
        }
        
        .dash-stat-uptime .dash-stat-glow {
            background: radial-gradient(circle at center, rgba(59, 130, 246, 0.15), transparent 70%);
        }
        
        .dash-stat-activity .dash-stat-icon {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(192, 132, 252, 0.1));
            color: #c084fc;
        }
        
        .dash-stat-activity .dash-stat-glow {
            background: radial-gradient(circle at center, rgba(168, 85, 247, 0.15), transparent 70%);
        }
        
        .dash-stat-framework .dash-stat-icon {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(252, 211, 77, 0.1));
            color: #fcd34d;
        }
        
        .dash-stat-framework .dash-stat-glow {
            background: radial-gradient(circle at center, rgba(251, 191, 36, 0.15), transparent 70%);
        }
        
        .dash-stat-glow {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .dash-stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .dash-stat-content {
            flex: 1;
            min-width: 0;
        }
        
        .dash-stat-label {
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 4px;
        }
        
        .dash-stat-value {
            font-size: 15px;
            font-weight: 600;
            color: #e5e7eb;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .dash-stat-arrow {
            color: #64748b;
            opacity: 0;
            transform: translateX(-4px);
            transition: all 0.2s ease;
        }
        
        .dash-stat-health:hover .dash-stat-arrow {
            opacity: 1;
            transform: translateX(0);
        }
        
        /* Dashboard Columns */
        .dash-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        
        .dash-column-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 20px;
            overflow: hidden;
        }
        
        .dash-column-header {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 20px 24px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }
        
        .dash-column-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .dash-column-icon-alerts {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.1));
            color: #fbbf24;
        }
        
        .dash-column-icon-actions {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(99, 102, 241, 0.1));
            color: #60a5fa;
        }
        
        .dash-column-title {
            font-size: 16px;
            font-weight: 600;
            color: #e5e7eb;
        }
        
        .dash-column-subtitle {
            font-size: 12px;
            color: #64748b;
            margin-top: 2px;
        }
        
        /* Alert List */
        .dash-alert-list {
            padding: 16px;
            min-height: 200px;
        }
        
        .dash-alert-list:empty::before {
            content: 'No alerts at this time';
            display: block;
            text-align: center;
            color: #64748b;
            font-size: 13px;
            padding: 40px 20px;
        }
        
        /* Quick Actions Container */
        .dash-actions-container {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .dash-action-section {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 14px;
            padding: 16px;
            border: 1px solid rgba(148, 163, 184, 0.08);
        }
        
        .dash-action-section-danger {
            border-color: rgba(239, 68, 68, 0.2);
            background: rgba(239, 68, 68, 0.05);
        }
        
        .dash-action-section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #94a3b8;
            margin-bottom: 12px;
        }
        
        .dash-action-section-danger .dash-action-section-header {
            color: #f87171;
        }
        
        .dash-action-btn-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 8px;
        }
        
        .dash-action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 14px;
            background: rgba(148, 163, 184, 0.08);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 10px;
            color: #cbd5e1;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .dash-action-btn:hover {
            background: rgba(148, 163, 184, 0.15);
            border-color: rgba(148, 163, 184, 0.25);
            transform: translateY(-1px);
            color: #f1f5f9;
        }
        
        .dash-action-btn-danger {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }
        
        .dash-action-btn-danger:hover {
            background: rgba(239, 68, 68, 0.25);
            border-color: rgba(239, 68, 68, 0.5);
            color: #fecaca;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.2);
        }
        
        .dash-action-btn-toggle {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }
        
        .dash-action-btn-toggle:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .dash-action-btn-toggle.active {
            background: rgba(16, 185, 129, 0.15);
            border-color: rgba(16, 185, 129, 0.3);
            color: #6ee7b7;
        }
        
        .dash-action-hint {
            font-size: 11px;
            color: #64748b;
            margin-top: 10px;
            line-height: 1.5;
        }
        
        .dash-action-section-danger .dash-action-hint {
            color: #fca5a5;
            opacity: 0.7;
        }
        
        /* Responsive adjustments for dashboard */
        @media (max-width: 900px) {
            .dash-columns {
                grid-template-columns: 1fr;
            }
            
            .dash-hero-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .dash-hero-right {
                width: 100%;
            }
            
            .dash-tour-btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        @media (max-width: 600px) {
            .dash-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .dash-hero {
                padding: 24px 20px;
            }
            
            .dash-hero-title {
                font-size: 22px;
            }
        }
        
        /* ============================================
           END MODERNIZED DASHBOARD STYLES
           ============================================ */

        /* ============================================
           MODERNIZED COMMANDS TAB STYLES
           ============================================ */
        
        /* Commands Hero Customizations */
        .cmd-hero .dash-hero-orb-1,
        .cmd-orb-1 {
            background: rgba(59, 130, 246, 0.25) !important;
        }
        
        .cmd-hero .dash-hero-orb-2,
        .cmd-orb-2 {
            background: rgba(34, 211, 238, 0.2) !important;
        }
        
        .cmd-badge {
            background: rgba(59, 130, 246, 0.15) !important;
            border-color: rgba(59, 130, 246, 0.3) !important;
            color: #93c5fd !important;
        }
        
        /* Commands Stats Grid */
        .cmd-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .cmd-stat-card {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 16px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 16px;
            text-align: center;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .cmd-stat-card:hover {
            transform: translateY(-3px);
            border-color: rgba(148, 163, 184, 0.25);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
        }
        
        .cmd-stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }
        
        .cmd-stat-value {
            font-size: 26px;
            font-weight: 700;
            color: #e5e7eb;
            line-height: 1;
            margin-bottom: 6px;
        }
        
        .cmd-stat-label {
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
        }
        
        /* Command Stat Card Color Variants */
        .cmd-stat-total .cmd-stat-icon { background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(99, 102, 241, 0.1)); color: #60a5fa; }
        .cmd-stat-slash .cmd-stat-icon { background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.1)); color: #c084fc; }
        .cmd-stat-prefix .cmd-stat-icon { background: linear-gradient(135deg, rgba(34, 211, 238, 0.2), rgba(6, 182, 212, 0.1)); color: #22d3ee; }
        .cmd-stat-hybrid .cmd-stat-icon { background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.1)); color: #fbbf24; }
        .cmd-stat-cogs .cmd-stat-icon { background: linear-gradient(135deg, rgba(244, 114, 182, 0.2), rgba(236, 72, 153, 0.1)); color: #f472b6; }
        .cmd-stat-usage .cmd-stat-icon { background: linear-gradient(135deg, rgba(52, 211, 153, 0.2), rgba(16, 185, 129, 0.1)); color: #34d399; }
        .cmd-stat-errors .cmd-stat-icon { background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1)); color: #f87171; }
        .cmd-stat-success .cmd-stat-icon { background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1)); color: #10b981; }
        
        .cmd-stat-total:hover { border-color: rgba(59, 130, 246, 0.4); }
        .cmd-stat-slash:hover { border-color: rgba(168, 85, 247, 0.4); }
        .cmd-stat-prefix:hover { border-color: rgba(34, 211, 238, 0.4); }
        .cmd-stat-hybrid:hover { border-color: rgba(251, 191, 36, 0.4); }
        .cmd-stat-cogs:hover { border-color: rgba(244, 114, 182, 0.4); }
        .cmd-stat-usage:hover { border-color: rgba(52, 211, 153, 0.4); }
        .cmd-stat-errors:hover { border-color: rgba(239, 68, 68, 0.4); }
        .cmd-stat-success:hover { border-color: rgba(16, 185, 129, 0.4); }
        
        /* Commands Explorer */
        .cmd-explorer {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 20px;
            overflow: hidden;
        }
        
        .cmd-explorer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 24px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .cmd-explorer-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 600;
            color: #e5e7eb;
        }
        
        .cmd-view-controls {
            display: flex;
            gap: 6px;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px;
            border-radius: 10px;
        }
        
        .cmd-view-btn {
            padding: 8px 14px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: #94a3b8;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .cmd-view-btn:hover {
            background: rgba(148, 163, 184, 0.1);
            color: #e5e7eb;
        }
        
        .cmd-view-btn.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(99, 102, 241, 0.2));
            color: #93c5fd;
        }
        
        .cmd-explorer-toolbar {
            display: flex;
            gap: 12px;
            padding: 16px 24px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.08);
            flex-wrap: wrap;
        }
        
        .cmd-search-wrap {
            flex: 1;
            min-width: 200px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 10px;
            padding: 0 14px;
            transition: all 0.2s ease;
        }
        
        .cmd-search-wrap:focus-within {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .cmd-search-wrap svg {
            color: #64748b;
            flex-shrink: 0;
        }
        
        .cmd-search-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            padding: 12px 0;
            color: #e5e7eb;
            font-size: 13px;
        }
        
        .cmd-search-input::placeholder {
            color: #64748b;
        }
        
        .cmd-sort-select {
            border-color: rgba(59, 130, 246, 0.3);
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        }
        
        .cmd-sort-select:focus {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .cmd-list {
            padding: 16px;
            min-height: 200px;
        }
        
        /* ============================================
           MODERNIZED PLUGINS TAB STYLES
           ============================================ */
        
        /* Plugins Hero Customizations */
        .plug-hero .dash-hero-orb-1,
        .plug-orb-1 {
            background: rgba(16, 185, 129, 0.25) !important;
        }
        
        .plug-hero .dash-hero-orb-2,
        .plug-orb-2 {
            background: rgba(52, 211, 153, 0.2) !important;
        }
        
        .plug-badge {
            background: rgba(16, 185, 129, 0.15) !important;
            border-color: rgba(16, 185, 129, 0.3) !important;
            color: #6ee7b7 !important;
        }
        
        /* Plugins Stats Card */
        .plug-stats-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 20px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .plug-stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 24px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .plug-stats-header-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .plug-stats-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(52, 211, 153, 0.1));
            color: #34d399;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .plug-stats-title {
            font-size: 15px;
            font-weight: 600;
            color: #e5e7eb;
        }
        
        .plug-stats-subtitle {
            font-size: 12px;
            color: #64748b;
            margin-top: 2px;
        }
        
        .plug-stats-toggle-wrap {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .plug-stats-toggle-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #64748b;
            font-weight: 500;
        }
        
        .plug-toggle-pill {
            position: relative;
            width: 44px;
            height: 24px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            background: rgba(15, 23, 42, 0.9);
            padding: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .plug-toggle-knob {
            width: 18px;
            height: 18px;
            border-radius: 999px;
            background: #64748b;
            transition: all 0.2s ease;
            display: block;
        }
        
        .plug-toggle-pill[aria-pressed="true"] {
            background: rgba(16, 185, 129, 0.25);
            border-color: rgba(16, 185, 129, 0.5);
        }
        
        .plug-toggle-pill[aria-pressed="true"] .plug-toggle-knob {
            transform: translateX(20px);
            background: #34d399;
        }
        
        .plug-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            padding: 20px;
        }
        
        .plug-stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 16px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.08);
            transition: all 0.2s ease;
        }
        
        .plug-stat-item:hover {
            background: rgba(0, 0, 0, 0.3);
            border-color: rgba(148, 163, 184, 0.15);
        }
        
        .plug-stat-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .plug-stat-icon-total { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
        .plug-stat-icon-loaded { background: rgba(16, 185, 129, 0.15); color: #34d399; }
        .plug-stat-icon-healthy { background: rgba(52, 211, 153, 0.15); color: #6ee7b7; }
        .plug-stat-icon-issues { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
        .plug-stat-icon-commands { background: rgba(168, 85, 247, 0.15); color: #c084fc; }
        .plug-stat-icon-cogs { background: rgba(244, 114, 182, 0.15); color: #f472b6; }
        .plug-stat-icon-extensions { background: rgba(34, 211, 238, 0.15); color: #22d3ee; }
        .plug-stat-icon-time { background: rgba(99, 102, 241, 0.15); color: #818cf8; }
        
        .plug-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #e5e7eb;
            line-height: 1;
            margin-bottom: 4px;
        }
        
        .plug-stat-label {
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
        }
        
        /* Plugins Promo Card */
        .plug-promo-card {
            position: relative;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 20px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .plug-promo-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            pointer-events: none;
        }
        
        .plug-promo-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(50px);
        }
        
        .plug-promo-orb-1 {
            width: 200px;
            height: 200px;
            background: rgba(16, 185, 129, 0.15);
            top: -50px;
            right: -50px;
        }
        
        .plug-promo-orb-2 {
            width: 150px;
            height: 150px;
            background: rgba(52, 211, 153, 0.1);
            bottom: -30px;
            left: 20%;
        }
        
        .plug-promo-content {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 24px;
            flex-wrap: wrap;
        }
        
        .plug-promo-icon {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(52, 211, 153, 0.1));
            color: #34d399;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .plug-promo-text {
            flex: 1;
            min-width: 200px;
        }
        
        .plug-promo-title {
            font-size: 16px;
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 4px;
        }
        
        .plug-promo-subtitle {
            font-size: 13px;
            color: #94a3b8;
        }
        
        .plug-promo-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .plug-promo-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 11px 18px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        .plug-promo-btn-primary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .plug-promo-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .plug-promo-btn-secondary {
            background: rgba(148, 163, 184, 0.1);
            border: 1px solid rgba(148, 163, 184, 0.2);
            color: #e5e7eb;
        }
        
        .plug-promo-btn-secondary:hover {
            background: rgba(148, 163, 184, 0.2);
        }
        
        /* Plugins Explorer */
        .plug-explorer {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 20px;
            overflow: hidden;
        }
        
        .plug-explorer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 24px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .plug-explorer-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 600;
            color: #e5e7eb;
        }
        
        .plug-explorer-toolbar {
            display: flex;
            gap: 12px;
            padding: 16px 24px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.08);
            flex-wrap: wrap;
        }
        
        .plug-search-wrap {
            flex: 1;
            min-width: 200px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 10px;
            padding: 0 14px;
            transition: all 0.2s ease;
        }
        
        .plug-search-wrap:focus-within {
            border-color: rgba(16, 185, 129, 0.5);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .plug-search-wrap svg {
            color: #64748b;
            flex-shrink: 0;
        }
        
        .plug-search-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            padding: 12px 0;
            color: #e5e7eb;
            font-size: 13px;
        }
        
        .plug-search-input::placeholder {
            color: #64748b;
        }
        
        .plug-filter-select {
            border-color: rgba(16, 185, 129, 0.3);
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%2310b981' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        }
        
        .plug-filter-select:focus {
            border-color: rgba(16, 185, 129, 0.5);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .plug-list {
            padding: 16px;
            min-height: 200px;
        }
        
        /* Responsive for Commands & Plugins */
        @media (max-width: 768px) {
            .cmd-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .plug-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .plug-promo-content {
                flex-direction: column;
                text-align: center;
            }
            
            .plug-promo-actions {
                width: 100%;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .cmd-stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .cmd-stat-card {
                padding: 14px 10px;
            }
            
            .cmd-stat-value {
                font-size: 20px;
            }
            
            .plug-stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
        }
        
        /* ============================================
           END MODERNIZED COMMANDS & PLUGINS STYLES
           ============================================ */

        /* ============================================
           MODERNIZED EVENT HOOKS TAB STYLES
           ============================================ */
        
        /* Hooks Hero Customizations */
        .hooks-hero .dash-hero-orb-1,
        .hooks-orb-1 {
            background: rgba(249, 115, 22, 0.25) !important;
        }
        
        .hooks-hero .dash-hero-orb-2,
        .hooks-orb-2 {
            background: rgba(251, 191, 36, 0.2) !important;
        }
        
        .hooks-badge {
            background: rgba(249, 115, 22, 0.15) !important;
            border-color: rgba(249, 115, 22, 0.3) !important;
            color: #fdba74 !important;
        }
        
        /* Hooks Stats Grid */
        .hooks-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .hooks-stat-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 16px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 16px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .hooks-stat-card:hover {
            transform: translateY(-3px);
            border-color: rgba(148, 163, 184, 0.25);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
        }
        
        .hooks-stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }
        
        .hooks-stat-value {
            font-size: 26px;
            font-weight: 700;
            color: #e5e7eb;
            line-height: 1;
            margin-bottom: 6px;
        }
        
        .hooks-stat-label {
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
        }
        
        /* Hooks Stat Card Color Variants */
        .hooks-stat-emissions .hooks-stat-icon { background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(99, 102, 241, 0.1)); color: #60a5fa; }
        .hooks-stat-executions .hooks-stat-icon { background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(52, 211, 153, 0.1)); color: #34d399; }
        .hooks-stat-failures .hooks-stat-icon { background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1)); color: #f87171; }
        .hooks-stat-queue .hooks-stat-icon { background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.1)); color: #c084fc; }
        .hooks-stat-queuefull .hooks-stat-icon { background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.1)); color: #fbbf24; }
        .hooks-stat-restarts .hooks-stat-icon { background: linear-gradient(135deg, rgba(34, 211, 238, 0.2), rgba(6, 182, 212, 0.1)); color: #22d3ee; }
        .hooks-stat-disabled .hooks-stat-icon { background: linear-gradient(135deg, rgba(100, 116, 139, 0.2), rgba(71, 85, 105, 0.1)); color: #94a3b8; }
        .hooks-stat-circuit .hooks-stat-icon { background: linear-gradient(135deg, rgba(249, 115, 22, 0.2), rgba(234, 88, 12, 0.1)); color: #fb923c; }
        
        .hooks-stat-emissions:hover { border-color: rgba(59, 130, 246, 0.4); }
        .hooks-stat-executions:hover { border-color: rgba(16, 185, 129, 0.4); }
        .hooks-stat-failures:hover { border-color: rgba(239, 68, 68, 0.4); }
        .hooks-stat-queue:hover { border-color: rgba(168, 85, 247, 0.4); }
        .hooks-stat-queuefull:hover { border-color: rgba(251, 191, 36, 0.4); }
        .hooks-stat-restarts:hover { border-color: rgba(34, 211, 238, 0.4); }
        .hooks-stat-disabled:hover { border-color: rgba(100, 116, 139, 0.4); }
        .hooks-stat-circuit:hover { border-color: rgba(249, 115, 22, 0.4); }
        
        /* Hooks Explorer */
        .hooks-explorer {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 20px;
            overflow: hidden;
        }
        
        .hooks-explorer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 24px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .hooks-explorer-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 600;
            color: #e5e7eb;
        }
        
        .hooks-view-controls {
            display: flex;
            gap: 6px;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px;
            border-radius: 10px;
            flex-wrap: wrap;
        }
        
        .hooks-view-btn {
            padding: 8px 14px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: #94a3b8;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .hooks-view-btn:hover {
            background: rgba(148, 163, 184, 0.1);
            color: #e5e7eb;
        }
        
        .hooks-view-btn.active {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.3), rgba(251, 191, 36, 0.2));
            color: #fdba74;
        }
        
        .hooks-explorer-toolbar {
            display: flex;
            gap: 12px;
            padding: 16px 24px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.08);
            flex-wrap: wrap;
        }
        
        .hooks-search-wrap {
            flex: 1;
            min-width: 200px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 10px;
            padding: 0 14px;
            transition: all 0.2s ease;
        }
        
        .hooks-search-wrap:focus-within {
            border-color: rgba(249, 115, 22, 0.5);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }
        
        .hooks-search-wrap svg { color: #64748b; flex-shrink: 0; }
        
        .hooks-search-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            padding: 12px 0;
            color: #e5e7eb;
            font-size: 13px;
        }
        
        .hooks-search-input::placeholder { color: #64748b; }
        
        .hooks-sort-select {
            border-color: rgba(249, 115, 22, 0.3);
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23f97316' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        }
        
        .hooks-sort-select:focus {
            border-color: rgba(249, 115, 22, 0.5);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }
        
        .hooks-list {
            padding: 16px;
            min-height: 200px;
        }
        
        /* ============================================
           MODERNIZED HOOK CREATOR TAB STYLES
           ============================================ */
        
        /* Hook Creator Hero Customizations */
        .hc-hero .dash-hero-orb-1,
        .hc-orb-1 {
            background: rgba(168, 85, 247, 0.25) !important;
        }
        
        .hc-hero .dash-hero-orb-2,
        .hc-orb-2 {
            background: rgba(139, 92, 246, 0.2) !important;
        }
        
        .hc-badge {
            background: rgba(168, 85, 247, 0.15) !important;
            border-color: rgba(168, 85, 247, 0.3) !important;
            color: #c4b5fd !important;
        }
        
        .hc-export-btn {
            background: rgba(168, 85, 247, 0.15) !important;
            border-color: rgba(168, 85, 247, 0.3) !important;
            color: #c4b5fd !important;
        }
        
        .hc-export-btn:hover {
            background: rgba(168, 85, 247, 0.25) !important;
        }
        
        /* Hook Creator Stats Grid */
        .hc-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .hc-stat-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 18px 14px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 14px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .hc-stat-card:hover {
            transform: translateY(-2px);
            border-color: rgba(148, 163, 184, 0.25);
        }
        
        .hc-stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .hc-stat-value {
            font-size: 22px;
            font-weight: 700;
            color: #e5e7eb;
            margin-bottom: 4px;
        }
        
        .hc-stat-label {
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
        }
        
        .hc-stat-total .hc-stat-icon { background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.1)); color: #c084fc; }
        .hc-stat-active .hc-stat-icon { background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(52, 211, 153, 0.1)); color: #34d399; }
        .hc-stat-disabled .hc-stat-icon { background: linear-gradient(135deg, rgba(100, 116, 139, 0.2), rgba(71, 85, 105, 0.1)); color: #94a3b8; }
        .hc-stat-templates .hc-stat-icon { background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(99, 102, 241, 0.1)); color: #60a5fa; }
        .hc-stat-executions .hc-stat-icon { background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.1)); color: #fbbf24; }
        .hc-stat-success .hc-stat-icon { background: linear-gradient(135deg, rgba(52, 211, 153, 0.2), rgba(16, 185, 129, 0.1)); color: #6ee7b7; }
        
        /* Hook Creator Main Layout */
        .hc-main-layout {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 20px;
        }
        
        /* Hook Creator Sidebar */
        .hc-sidebar {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 20px;
            overflow: hidden;
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 140px);
        }
        
        .hc-sidebar-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 18px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .hc-sidebar-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.1));
            color: #c084fc;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .hc-sidebar-title {
            font-size: 15px;
            font-weight: 600;
            color: #e5e7eb;
        }
        
        .hc-sidebar-content {
            padding: 16px;
            overflow-y: auto;
            max-height: calc(100vh - 240px);
        }
        
        .hc-search-wrap {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 10px;
            padding: 0 12px;
            margin-bottom: 12px;
        }
        
        .hc-search-wrap:focus-within {
            border-color: rgba(168, 85, 247, 0.5);
        }
        
        .hc-search-wrap svg { color: #64748b; }
        
        .hc-search-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            padding: 10px 0;
            color: #e5e7eb;
            font-size: 13px;
        }
        
        .hc-category-select {
            width: 100%;
            border-color: rgba(168, 85, 247, 0.3);
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23a855f7' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            margin-bottom: 16px;
        }
        
        .hc-category-select:focus {
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }
        
        .hc-templates-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* Hook Creator Cards */
        .hc-create-card,
        .hc-hooks-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .hc-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 18px 24px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            flex-wrap: wrap;
        }
        
        .hc-card-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .hc-card-icon-create {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(52, 211, 153, 0.1));
            color: #34d399;
        }
        
        .hc-card-icon-list {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(99, 102, 241, 0.1));
            color: #60a5fa;
        }
        
        .hc-card-title {
            font-size: 15px;
            font-weight: 600;
            color: #e5e7eb;
            flex: 1;
        }
        
        .hc-card-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .hc-filter-select {
            border-color: rgba(168, 85, 247, 0.25);
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23a855f7' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            padding: 8px 32px 8px 12px;
            font-size: 12px;
            min-width: 120px;
            border-radius: 8px;
        }
        
        .hc-filter-select:focus {
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }
        
        .hc-card-body {
            padding: 20px 24px;
        }
        
        /* Hook Creator Form */
        .hc-form-group {
            margin-bottom: 16px;
        }
        
        .hc-label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #94a3b8;
        }
        
        .hc-required {
            color: #ef4444;
            margin-left: 4px;
        }
        
        .hc-select {
            width: 100%;
            border-color: rgba(168, 85, 247, 0.3);
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23a855f7' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        }
        
        .hc-select:focus {
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }
        
        .hc-template-info {
            padding: 16px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(139, 92, 246, 0.08));
            border: 1px solid rgba(168, 85, 247, 0.25);
            border-radius: 12px;
            margin-bottom: 16px;
        }
        
        .hc-template-info-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 10px;
        }
        
        .hc-template-info-icon {
            font-size: 24px;
        }
        
        .hc-template-info-name {
            font-size: 14px;
            font-weight: 700;
            color: #c084fc;
            margin-bottom: 4px;
        }
        
        .hc-template-info-desc {
            font-size: 12px;
            color: #cbd5e1;
        }
        
        .hc-template-info-event {
            display: inline-block;
            font-size: 11px;
            color: #94a3b8;
            padding: 6px 12px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 6px;
        }
        
        .hc-form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .hc-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .hc-btn-primary {
            flex: 1;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        .hc-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .hc-btn-secondary {
            background: rgba(148, 163, 184, 0.1);
            border: 1px solid rgba(148, 163, 184, 0.2);
            color: #e5e7eb;
        }
        
        .hc-btn-secondary:hover {
            background: rgba(148, 163, 184, 0.2);
        }
        
        .hc-created-list {
            min-height: 100px;
        }
        
        /* ============================================
           MODERNIZED MAIN HEADER STYLES
           ============================================ */
        
        .main-header {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 20px;
            padding: 24px 28px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.15);
        }
        
        .main-header-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            pointer-events: none;
        }
        
        .main-header-banner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            object-fit: cover;
            opacity: 0.35;
            filter: blur(1px);
        }
        
        .main-header-light {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 40%;
            pointer-events: none;
            z-index: 1;
        }
        
        .main-header-light-left {
            left: 0;
            background: linear-gradient(90deg, 
                rgba(168, 85, 247, 0.4) 0%,
                rgba(139, 92, 246, 0.25) 30%,
                transparent 100%);
            animation: headerLightPulseLeft 4s ease-in-out infinite;
        }
        
        .main-header-light-right {
            right: 0;
            background: linear-gradient(-90deg, 
                rgba(59, 130, 246, 0.4) 0%,
                rgba(99, 102, 241, 0.25) 30%,
                transparent 100%);
            animation: headerLightPulseRight 4s ease-in-out infinite;
            animation-delay: -2s;
        }
        
        @keyframes headerLightPulseLeft {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        @keyframes headerLightPulseRight {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .main-header-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg,
                rgba(15, 23, 42, 0.3) 0%,
                rgba(15, 23, 42, 0.6) 100%);
            z-index: 2;
        }
        
        .main-header-content {
            position: relative;
            z-index: 3;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
            flex-wrap: wrap;
        }
        
        .main-header-left {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .main-header-brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .main-header-logo {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .main-header-titles {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .main-header-title {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            line-height: 1.2;
        }
        
        .main-header-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #94a3b8;
            text-decoration: none;
            transition: color 0.2s ease;
        }
        
        .main-header-link:hover {
            color: #60a5fa;
        }
        
        .main-header-status {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CONNECTION STATUS INDICATOR - Red/Green dot with label
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        .connection-status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: default;
        }
        
        .connection-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        /* Connected state - Green */
        .connection-status-indicator.connected {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #34d399;
        }
        
        .connection-status-indicator.connected .connection-dot {
            background: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
            animation: pulse-green 2s infinite;
        }
        
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 8px rgba(16, 185, 129, 0.6); }
            50% { box-shadow: 0 0 16px rgba(16, 185, 129, 0.9); }
        }
        
        /* Connecting state - Yellow/Amber */
        .connection-status-indicator.connecting {
            background: rgba(251, 191, 36, 0.15);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: #fbbf24;
        }
        
        .connection-status-indicator.connecting .connection-dot {
            background: #f59e0b;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.6);
            animation: pulse-yellow 1s infinite;
        }
        
        @keyframes pulse-yellow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Disconnected state - Red */
        .connection-status-indicator.disconnected {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }
        
        .connection-status-indicator.disconnected .connection-dot {
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
        }
        
        /* Disabled state - Gray */
        .connection-status-indicator.disabled {
            background: rgba(100, 116, 139, 0.15);
            border: 1px solid rgba(100, 116, 139, 0.3);
            color: #94a3b8;
        }
        
        .connection-status-indicator.disabled .connection-dot {
            background: #64748b;
            box-shadow: none;
        }
        
        .main-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 999px;
            font-size: 12px;
            font-weight: 500;
            color: #6ee7b7;
        }
        
        .main-status-badge.offline {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }
        
        .main-status-badge.connecting {
            background: rgba(251, 191, 36, 0.15);
            border-color: rgba(251, 191, 36, 0.3);
            color: #fcd34d;
        }
        
        .main-header-details-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(148, 163, 184, 0.1);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .main-header-details-btn:hover {
            background: rgba(148, 163, 184, 0.2);
            color: #e5e7eb;
        }
        
        /* Main Header Metrics */
        .main-header-metrics {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .main-metric {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(148, 163, 184, 0.12);
            border-radius: 14px;
            min-width: 130px;
            transition: all 0.2s ease;
        }
        
        .main-metric:hover {
            border-color: rgba(148, 163, 184, 0.25);
            background: rgba(0, 0, 0, 0.35);
        }
        
        .main-metric-icon {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .main-metric-icon-cpu {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(99, 102, 241, 0.1));
            color: #60a5fa;
        }
        
        .main-metric-icon-memory {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(52, 211, 153, 0.1));
            color: #34d399;
        }
        
        .main-metric-icon-latency {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.1));
            color: #c084fc;
        }
        
        .main-metric-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .main-metric-label {
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
        }
        
        .main-metric-value {
            font-size: 18px;
            font-weight: 700;
            color: #e5e7eb;
        }
        
        /* Responsive for Hooks, Hook Creator, Header */
        @media (max-width: 1100px) {
            .hc-main-layout {
                grid-template-columns: 1fr;
            }
            
            .hc-sidebar {
                position: static;
                max-height: none;
            }
            
            .hc-sidebar-content {
                max-height: 300px;
            }
        }
        
        @media (max-width: 768px) {
            .hooks-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .hc-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .main-header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .main-header-metrics {
                width: 100%;
            }
            
            .main-metric {
                flex: 1;
                min-width: 0;
            }
        }
        
        @media (max-width: 480px) {
            .hooks-stats-grid,
            .hc-stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .main-header {
                padding: 20px;
            }
            
            .main-header-title {
                font-size: 20px;
            }
            
            .main-header-metrics {
                flex-direction: column;
            }
        }
        
        /* ============================================
           END MODERNIZED HOOKS & HEADER STYLES
           ============================================ */

        /* ============================================
           MODERNIZED FILE SYSTEM TAB STYLES
           ============================================ */
        
        /* File System Hero Customizations */
        .fs-hero .dash-hero-orb-1,
        .fs-orb-1 {
            background: rgba(34, 211, 238, 0.25) !important;
        }
        
        .fs-hero .dash-hero-orb-2,
        .fs-orb-2 {
            background: rgba(6, 182, 212, 0.2) !important;
        }
        
        .fs-badge {
            background: rgba(34, 211, 238, 0.15) !important;
            border-color: rgba(34, 211, 238, 0.3) !important;
            color: #67e8f9 !important;
        }
        
        /* File System Stats Grid */
        .fs-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .fs-stat-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 16px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 16px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .fs-stat-card:hover {
            transform: translateY(-3px);
            border-color: rgba(148, 163, 184, 0.25);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
        }
        
        .fs-stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }
        
        .fs-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #e5e7eb;
            line-height: 1;
            margin-bottom: 6px;
        }
        
        .fs-stat-label {
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
        }
        
        /* File System Stat Card Color Variants */
        .fs-stat-files .fs-stat-icon { background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(99, 102, 241, 0.1)); color: #60a5fa; }
        .fs-stat-size .fs-stat-icon { background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.1)); color: #c084fc; }
        .fs-stat-data .fs-stat-icon { background: linear-gradient(135deg, rgba(34, 211, 238, 0.2), rgba(6, 182, 212, 0.1)); color: #22d3ee; }
        .fs-stat-cogs .fs-stat-icon { background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.1)); color: #fbbf24; }
        .fs-stat-ext .fs-stat-icon { background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(52, 211, 153, 0.1)); color: #34d399; }
        .fs-stat-logs .fs-stat-icon { background: linear-gradient(135deg, rgba(249, 115, 22, 0.2), rgba(234, 88, 12, 0.1)); color: #fb923c; }
        .fs-stat-hits .fs-stat-icon { background: linear-gradient(135deg, rgba(52, 211, 153, 0.2), rgba(16, 185, 129, 0.1)); color: #6ee7b7; }
        .fs-stat-misses .fs-stat-icon { background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1)); color: #f87171; }
        
        .fs-stat-files:hover { border-color: rgba(59, 130, 246, 0.4); }
        .fs-stat-size:hover { border-color: rgba(168, 85, 247, 0.4); }
        .fs-stat-data:hover { border-color: rgba(34, 211, 238, 0.4); }
        .fs-stat-cogs:hover { border-color: rgba(251, 191, 36, 0.4); }
        .fs-stat-ext:hover { border-color: rgba(16, 185, 129, 0.4); }
        .fs-stat-logs:hover { border-color: rgba(249, 115, 22, 0.4); }
        .fs-stat-hits:hover { border-color: rgba(52, 211, 153, 0.4); }
        .fs-stat-misses:hover { border-color: rgba(239, 68, 68, 0.4); }
        
        /* File System Explorer */
        .fs-explorer {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 20px;
            overflow: hidden;
        }
        
        .fs-explorer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 24px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .fs-explorer-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 600;
            color: #e5e7eb;
        }
        
        .fs-list {
            padding: 16px;
            min-height: 200px;
        }
        
        /* ============================================
           MODERNIZED FILE BROWSER TAB STYLES
           ============================================ */
        
        /* File Browser Hero Customizations */
        .fb-hero .dash-hero-orb-1,
        .fb-orb-1 {
            background: rgba(251, 191, 36, 0.25) !important;
        }
        
        .fb-hero .dash-hero-orb-2,
        .fb-orb-2 {
            background: rgba(245, 158, 11, 0.2) !important;
        }
        
        .fb-badge {
            background: rgba(251, 191, 36, 0.15) !important;
            border-color: rgba(251, 191, 36, 0.3) !important;
            color: #fcd34d !important;
        }
        
        .fb-explorer {
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, 0.15);
        }
        
        .fb-dir-header {
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .fb-editor-pane {
            background: rgba(15, 23, 42, 0.95);
            border-left: 1px solid rgba(148, 163, 184, 0.15);
        }
        
        .fb-editor-header {
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            padding: 12px 16px;
        }
        
        .fb-filename {
            font-size: 12px;
            font-weight: 600;
            color: #fcd34d;
        }
        
        .fb-btn {
            background: rgba(148, 163, 184, 0.1);
            border: 1px solid rgba(148, 163, 184, 0.2);
            color: #e5e7eb;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 11px;
            transition: all 0.2s ease;
        }
        
        .fb-btn:hover {
            background: rgba(148, 163, 184, 0.2);
        }
        
        .fb-btn-save {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(52, 211, 153, 0.1)) !important;
            border-color: rgba(16, 185, 129, 0.3) !important;
            color: #34d399 !important;
        }
        
        .fb-btn-save:hover {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(52, 211, 153, 0.2)) !important;
        }
        
        .fb-textarea {
            background: rgba(0, 0, 0, 0.4);
            border: none;
            color: #e5e7eb;
            font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        /* ============================================
           MODERNIZED CHAT CONSOLE TAB STYLES
           ============================================ */
        
        /* Chat Console Hero Customizations */
        .chat-hero .dash-hero-orb-1,
        .chat-orb-1 {
            background: rgba(236, 72, 153, 0.25) !important;
        }
        
        .chat-hero .dash-hero-orb-2,
        .chat-orb-2 {
            background: rgba(219, 39, 119, 0.2) !important;
        }
        
        .chat-badge {
            background: rgba(236, 72, 153, 0.15) !important;
            border-color: rgba(236, 72, 153, 0.3) !important;
            color: #f9a8d4 !important;
        }
        
        .chat-experimental-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.15));
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.05em;
            color: #fcd34d;
        }
        
        .chat-columns {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }
        
        .chat-column-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 20px;
            overflow: hidden;
        }
        
        .chat-column-header {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 18px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .chat-column-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-column-icon-servers {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.1));
            color: #c084fc;
        }
        
        .chat-column-icon-channel {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.2), rgba(219, 39, 119, 0.1));
            color: #f9a8d4;
        }
        
        .chat-column-title {
            font-size: 15px;
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 2px;
        }
        
        .chat-column-subtitle {
            font-size: 12px;
            color: #64748b;
        }
        
        .chat-guilds-list {
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .chat-channels-list {
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .chat-message-area {
            padding: 16px;
        }
        
        .chat-message-log {
            height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
        }
        
        .chat-input-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .chat-input {
            flex: 1;
            min-width: 180px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 10px;
            padding: 12px 16px;
            color: #e5e7eb;
            font-size: 13px;
            transition: all 0.2s ease;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: rgba(236, 72, 153, 0.5);
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }
        
        .chat-input::placeholder { color: #64748b; }
        
        .chat-send-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #ec4899, #db2777);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.3);
        }
        
        .chat-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(236, 72, 153, 0.4);
        }
        
        .chat-history-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(148, 163, 184, 0.1);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 10px;
            color: #e5e7eb;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .chat-history-btn:hover {
            background: rgba(148, 163, 184, 0.2);
        }
        
        /* ============================================
           MODERNIZED SYSTEM TAB STYLES
           ============================================ */
        
        /* System Hero Customizations */
        .sys-hero .dash-hero-orb-1,
        .sys-orb-1 {
            background: rgba(99, 102, 241, 0.25) !important;
        }
        
        .sys-hero .dash-hero-orb-2,
        .sys-orb-2 {
            background: rgba(79, 70, 229, 0.2) !important;
        }
        
        .sys-badge {
            background: rgba(99, 102, 241, 0.15) !important;
            border-color: rgba(99, 102, 241, 0.3) !important;
            color: #a5b4fc !important;
        }
        
        .sys-details-container {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 20px;
            padding: 24px;
        }
        
        /* Responsive for New Tabs */
        @media (max-width: 1000px) {
            .chat-columns {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .fs-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .fs-stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .chat-input-row {
                flex-direction: column;
            }
            
            .chat-send-btn,
            .chat-history-btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* ============================================
           END FILE SYSTEM/BROWSER/CHAT/SYSTEM STYLES
           ============================================ */

        /* ============================================
           MODERNIZED SYSTEM TAB - DASHBOARD LAYOUT
           ============================================ */
        
        .sys-dashboard {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .sys-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 16px;
        }
        
        .sys-card {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .sys-card:hover {
            border-color: var(--card-color, rgba(148, 163, 184, 0.3));
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        
        .sys-card-wide {
            grid-column: 1 / -1;
        }
        
        .sys-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.25);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .sys-card-icon {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            background: linear-gradient(135deg, color-mix(in srgb, var(--card-color, #6366f1) 20%, transparent), color-mix(in srgb, var(--card-color, #6366f1) 10%, transparent));
            color: var(--card-color, #a5b4fc);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .sys-card-title {
            font-size: 14px;
            font-weight: 600;
            color: #e5e7eb;
            flex: 1;
        }
        
        .sys-card-stats {
            display: flex;
            gap: 16px;
        }
        
        .sys-mini-stat {
            font-size: 12px;
            color: #94a3b8;
        }
        
        .sys-mini-stat strong {
            color: #e5e7eb;
        }
        
        .sys-card-body {
            padding: 16px 20px;
        }
        
        .sys-card-actions {
            display: flex;
            gap: 8px;
            padding: 12px 20px 16px;
            flex-wrap: wrap;
        }
        
        .sys-prop {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.08);
        }
        
        .sys-prop:last-child {
            border-bottom: none;
        }
        
        .sys-prop-label {
            font-size: 13px;
            color: #94a3b8;
        }
        
        .sys-prop-value {
            font-size: 13px;
            font-weight: 600;
            color: #e5e7eb;
        }
        
        .sys-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            border: 1px solid;
        }
        
        .sys-progress {
            height: 6px;
            background: rgba(148, 163, 184, 0.15);
            border-radius: 3px;
            margin: 12px 0;
            overflow: hidden;
        }
        
        .sys-progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .sys-hint {
            font-size: 11px;
            color: #64748b;
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }
        
        .sys-btn {
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid rgba(148, 163, 184, 0.2);
            background: rgba(148, 163, 184, 0.1);
            color: #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .sys-btn:hover {
            background: rgba(148, 163, 184, 0.2);
        }
        
        .sys-btn-sm {
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            border: 1px solid rgba(148, 163, 184, 0.2);
            background: rgba(148, 163, 184, 0.1);
            color: #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .sys-btn-sm:hover {
            background: rgba(148, 163, 184, 0.2);
        }
        
        .sys-btn-danger {
            border-color: rgba(239, 68, 68, 0.3);
            color: #f87171;
        }
        
        .sys-btn-danger:hover {
            background: rgba(239, 68, 68, 0.15);
        }
        
        /* System Locks Table */
        .sys-locks-body {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .sys-locks-table {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .sys-locks-header {
            display: grid;
            grid-template-columns: 1fr 80px 90px 100px 140px;
            gap: 12px;
            padding: 10px 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        .sys-locks-row {
            display: grid;
            grid-template-columns: 1fr 80px 90px 100px 140px;
            gap: 12px;
            padding: 10px 12px;
            align-items: center;
            font-size: 12px;
            color: #e5e7eb;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            transition: background 0.2s ease;
        }
        
        .sys-locks-row:hover {
            background: rgba(236, 72, 153, 0.08);
        }
        
        .sys-lock-path {
            font-family: 'Fira Code', monospace;
            font-size: 11px;
            color: #94a3b8;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .sys-lock-chip {
            display: inline-flex;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .sys-lock-chip.locked {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
        }
        
        .sys-lock-chip.idle {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
        }
        
        .sys-lock-time {
            font-size: 11px;
            color: #64748b;
        }
        
        .sys-lock-actions {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
        }
        
        .sys-empty-locks {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 40px 20px;
            text-align: center;
            color: #94a3b8;
        }
        
        .sys-empty-sub {
            font-size: 12px;
            color: #64748b;
        }
        
        @media (max-width: 1200px) {
            .sys-locks-header,
            .sys-locks-row {
                grid-template-columns: 1fr 70px 80px 90px 120px;
            }
        }
        
        @media (max-width: 900px) {
            .sys-grid {
                grid-template-columns: 1fr;
            }
            
            .sys-locks-header,
            .sys-locks-row {
                grid-template-columns: 1fr 60px auto;
            }
            
            .sys-locks-header > *:nth-child(3),
            .sys-locks-header > *:nth-child(4),
            .sys-locks-row > *:nth-child(3),
            .sys-locks-row > *:nth-child(4) {
                display: none;
            }
        }
        
        /* ============================================
           MODERNIZED EVENTS TIMELINE STYLES
           ============================================ */
        
        .events-timeline {
            padding: 20px;
            position: relative;
        }
        
        .events-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 60px 20px;
            text-align: center;
        }
        
        .events-empty-title {
            font-size: 16px;
            font-weight: 600;
            color: #e5e7eb;
        }
        
        .events-empty-text {
            font-size: 14px;
            color: #64748b;
        }
        
        .event-item {
            position: relative;
            padding-left: 28px;
            padding-bottom: 20px;
        }
        
        .event-item:last-child {
            padding-bottom: 0;
        }
        
        .event-item:last-child .event-line {
            display: none;
        }
        
        .event-line {
            position: absolute;
            left: 5px;
            top: 12px;
            bottom: 0;
            width: 2px;
            opacity: 0.3;
        }
        
        .event-dot {
            position: absolute;
            left: 0;
            top: 4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .event-content {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.12);
            border-radius: 12px;
            padding: 14px 16px;
            transition: all 0.2s ease;
        }
        
        .event-content:hover {
            border-color: rgba(148, 163, 184, 0.25);
            background: rgba(15, 23, 42, 0.8);
        }
        
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        
        .event-type {
            display: inline-flex;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            border: 1px solid;
        }
        
        .event-time {
            font-size: 11px;
            color: #64748b;
        }
        
        .event-details {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .event-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            padding: 6px 0;
        }
        
        .event-detail-key {
            font-size: 12px;
            color: #94a3b8;
            flex-shrink: 0;
        }
        
        .event-detail-value {
            font-size: 11px;
            color: #e5e7eb;
            font-family: 'Fira Code', monospace;
            word-break: break-all;
            text-align: right;
        }
        
        /* ============================================
           MODERNIZED TICKETS TAB STYLES
           ============================================ */
        
        /* Tickets Hero Customizations */
        .tickets-hero .dash-hero-orb-1,
        .tickets-orb-1 {
            background: rgba(168, 85, 247, 0.25) !important;
        }
        
        .tickets-hero .dash-hero-orb-2,
        .tickets-orb-2 {
            background: rgba(139, 92, 246, 0.2) !important;
        }
        
        .tickets-badge {
            background: rgba(168, 85, 247, 0.15) !important;
            border-color: rgba(168, 85, 247, 0.3) !important;
            color: #c4b5fd !important;
        }
        
        /* Tickets Notice */
        .tickets-notice {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(139, 92, 246, 0.08));
            border: 1px solid rgba(168, 85, 247, 0.25);
            border-radius: 16px;
            margin-bottom: 20px;
        }
        
        .tickets-notice-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(168, 85, 247, 0.15);
            color: #a855f7;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .tickets-notice-content { flex: 1; }
        
        .tickets-notice-title {
            font-size: 14px;
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 4px;
        }
        
        .tickets-notice-text {
            font-size: 13px;
            color: #94a3b8;
        }
        
        .tickets-notice-text strong { color: #c084fc; }
        
        .tickets-notice-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #a855f7, #7c3aed);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
        }
        
        .tickets-notice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(168, 85, 247, 0.4);
        }
        
        /* Tickets Filters Card */
        .tickets-filters-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .tickets-filters-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .tickets-filters-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.1));
            color: #c084fc;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tickets-filters-title {
            font-size: 15px;
            font-weight: 600;
            color: #e5e7eb;
        }
        
        .tickets-filters-body { padding: 20px 24px; }
        
        .tickets-filters-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .tickets-filter-group { display: flex; flex-direction: column; gap: 8px; }
        
        .tickets-filter-label {
            font-size: 12px;
            font-weight: 500;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .tickets-filter-select {
            border-color: rgba(168, 85, 247, 0.3);
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23a855f7' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            width: 100%;
        }
        
        .tickets-filter-select:focus {
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }
        
        .tickets-search-row { display: flex; gap: 12px; }
        
        .tickets-search-wrap {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 10px;
            padding: 0 14px;
        }
        
        .tickets-search-wrap:focus-within {
            border-color: rgba(168, 85, 247, 0.5);
        }
        
        .tickets-search-wrap svg { color: #64748b; }
        
        .tickets-search-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            padding: 12px 0;
            color: #e5e7eb;
            font-size: 13px;
        }
        
        /* Tickets Table Card */
        .tickets-table-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 20px;
            overflow: hidden;
        }
        
        .tickets-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .tickets-table-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 600;
            color: #e5e7eb;
        }
        
        .tickets-count {
            font-size: 13px;
            color: #94a3b8;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .tickets-table-body { min-height: 200px; }
        
        .tickets-empty {
            padding: 60px 24px;
            text-align: center;
        }
        
        .tickets-empty-icon { font-size: 48px; margin-bottom: 16px; }
        .tickets-empty-title { font-size: 16px; font-weight: 600; color: #e5e7eb; margin-bottom: 8px; }
        .tickets-empty-text { font-size: 14px; color: #94a3b8; margin-bottom: 16px; }
        .tickets-empty-link { color: #a855f7; text-decoration: none; font-weight: 600; }
        
        .tickets-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 60px 24px;
            color: #94a3b8;
        }
        
        .tickets-loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(168, 85, 247, 0.2);
            border-top-color: #a855f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .tickets-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .tickets-table th {
            padding: 14px 16px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .tickets-table td {
            padding: 14px 16px;
            font-size: 13px;
            color: #e5e7eb;
            border-bottom: 1px solid rgba(148, 163, 184, 0.08);
        }
        
        .tickets-table tr:hover td {
            background: rgba(168, 85, 247, 0.05);
        }
        
        .tickets-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .tickets-page-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: rgba(148, 163, 184, 0.1);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            color: #e5e7eb;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .tickets-page-btn:hover:not(:disabled) { background: rgba(148, 163, 184, 0.2); }
        .tickets-page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .tickets-page-info { font-size: 13px; color: #94a3b8; }
        
        @media (max-width: 900px) {
            .tickets-filters-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 600px) {
            .tickets-filters-grid { grid-template-columns: 1fr; }
            .tickets-notice { flex-direction: column; text-align: center; }
        }
        
        /* ============================================
           MODERNIZED GUILDS TAB STYLES
           ============================================ */
        
        .guilds-hero .dash-hero-orb-1,
        .guilds-orb-1 {
            background: rgba(16, 185, 129, 0.25) !important;
        }
        
        .guilds-hero .dash-hero-orb-2,
        .guilds-orb-2 {
            background: rgba(52, 211, 153, 0.2) !important;
        }
        
        .guilds-badge {
            background: rgba(16, 185, 129, 0.15) !important;
            border-color: rgba(16, 185, 129, 0.3) !important;
            color: #6ee7b7 !important;
        }
        
        .guilds-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 20px;
            overflow: hidden;
        }
        
        .guilds-card-header {
            padding: 18px 24px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .guilds-card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 4px;
        }
        
        .guilds-card-subtitle {
            font-size: 13px;
            color: #64748b;
        }
        
        .guilds-card-body { padding: 20px; }
        
        .guilds-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        
        .guilds-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 60px 24px;
            color: #94a3b8;
            grid-column: 1 / -1;
        }
        
        .guilds-loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(16, 185, 129, 0.2);
            border-top-color: #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* ============================================
           MODERNIZED EVENTS TAB STYLES
           ============================================ */
        
        .events-hero .dash-hero-orb-1,
        .events-orb-1 {
            background: rgba(239, 68, 68, 0.25) !important;
        }
        
        .events-hero .dash-hero-orb-2,
        .events-orb-2 {
            background: rgba(248, 113, 113, 0.2) !important;
        }
        
        .events-badge {
            background: rgba(239, 68, 68, 0.15) !important;
            border-color: rgba(239, 68, 68, 0.3) !important;
            color: #fca5a5 !important;
        }
        
        .events-live-dot {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: eventsPulse 2s ease-in-out infinite;
        }
        
        @keyframes eventsPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.9); }
        }
        
        .events-counter {
            padding: 8px 16px;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            color: #fca5a5;
        }
        
        .events-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 20px;
            overflow: hidden;
        }
        
        .events-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 24px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .events-card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 600;
            color: #e5e7eb;
        }
        
        .events-card-subtitle {
            font-size: 13px;
            color: #64748b;
        }
        
        .events-timeline {
            padding: 16px;
            min-height: 300px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        /* ============================================
           MODERNIZED INVITE TAB STYLES
           ============================================ */
        
        .invite-hero .dash-hero-orb-1,
        .invite-orb-1 {
            background: rgba(59, 130, 246, 0.25) !important;
        }
        
        .invite-hero .dash-hero-orb-2,
        .invite-orb-2 {
            background: rgba(99, 102, 241, 0.2) !important;
        }
        
        .invite-badge {
            background: rgba(59, 130, 246, 0.15) !important;
            border-color: rgba(59, 130, 246, 0.3) !important;
            color: #93c5fd !important;
        }
        
        .invite-portal-btn {
            background: rgba(59, 130, 246, 0.15) !important;
            border: 1px solid rgba(59, 130, 246, 0.3) !important;
            color: #93c5fd !important;
            text-decoration: none;
        }
        
        .invite-portal-btn:hover {
            background: rgba(59, 130, 246, 0.25) !important;
        }
        
        .invite-builder-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 20px;
            overflow: hidden;
        }
        
        .invite-builder-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px 24px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .invite-builder-icon {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(99, 102, 241, 0.1));
            color: #60a5fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .invite-builder-title {
            font-size: 17px;
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 4px;
        }
        
        .invite-builder-subtitle {
            font-size: 13px;
            color: #64748b;
        }
        
        .invite-builder-body { padding: 24px; }
        
        .invite-form-group { margin-bottom: 20px; }
        .invite-form-full { grid-column: 1 / -1; }
        
        .invite-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .invite-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 10px;
        }
        
        .invite-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.25);
            border-radius: 12px;
            padding: 14px 18px;
            color: #e5e7eb;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .invite-input:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .invite-hint {
            font-size: 12px;
            color: #64748b;
            margin-top: 8px;
        }
        
        .invite-scopes-box {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 12px;
        }
        
        .invite-scope-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .invite-scope-option:hover { background: rgba(59, 130, 246, 0.1); }
        
        .invite-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #3b82f6;
        }
        
        .invite-scope-name {
            font-size: 14px;
            font-weight: 600;
            color: #e5e7eb;
        }
        
        .invite-scope-desc {
            font-size: 11px;
            color: #64748b;
            margin-left: auto;
        }
        
        .invite-output-section {
            padding: 20px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(99, 102, 241, 0.05));
            border: 1px solid rgba(59, 130, 246, 0.25);
            border-radius: 16px;
            margin-bottom: 20px;
        }
        
        .invite-output-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 12px;
        }
        
        .invite-output-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.25);
            border-radius: 10px;
            padding: 14px 18px;
            color: #94a3b8;
            font-size: 13px;
            margin-bottom: 16px;
        }
        
        .invite-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .invite-generate-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 24px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .invite-generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .invite-secondary-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 20px;
            background: rgba(148, 163, 184, 0.1);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            color: #e5e7eb;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .invite-secondary-btn:hover { background: rgba(148, 163, 184, 0.2); }
        
        .invite-tip {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 14px 18px;
            background: rgba(59, 130, 246, 0.05);
            border-left: 3px solid rgba(59, 130, 246, 0.5);
            border-radius: 0 10px 10px 0;
            font-size: 12px;
            color: #94a3b8;
        }
        
        .invite-tip svg { flex-shrink: 0; color: #60a5fa; margin-top: 1px; }
        
        @media (max-width: 768px) {
            .invite-form-row { grid-template-columns: 1fr; }
        }
        
        /* ============================================
           END TICKETS/GUILDS/EVENTS/INVITE STYLES
           ============================================ */

        /* ============================================
           MODERNIZED ROLES & ACCESS TAB STYLES
           ============================================ */
        
        .roles-hero .dash-hero-orb-1,
        .roles-orb-1 {
            background: rgba(251, 191, 36, 0.25) !important;
        }
        
        .roles-hero .dash-hero-orb-2,
        .roles-orb-2 {
            background: rgba(245, 158, 11, 0.2) !important;
        }
        
        .roles-badge {
            background: rgba(251, 191, 36, 0.15) !important;
            border-color: rgba(251, 191, 36, 0.3) !important;
            color: #fcd34d !important;
        }
        
        .roles-container {
            min-height: 300px;
        }
        
        .roles-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 60px 24px;
            color: #94a3b8;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 20px;
        }
        
        .roles-loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(251, 191, 36, 0.2);
            border-top-color: #fbbf24;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* Roles Grid Layout */
        .roles-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 1100px) {
            .roles-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Roles Section Card */
        .roles-section {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 20px;
            overflow: hidden;
        }
        
        .roles-section-header {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 20px 24px;
            background: rgba(0, 0, 0, 0.25);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .roles-section-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .roles-section-icon.users {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(99, 102, 241, 0.15));
            color: #60a5fa;
        }
        
        .roles-section-icon.profiles {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.15));
            color: #fbbf24;
        }
        
        .roles-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #e5e7eb;
        }
        
        .roles-section-subtitle {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 2px;
        }
        
        .roles-section-body {
            padding: 20px 24px;
        }
        
        /* Add User Form */
        .roles-add-form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-end;
            padding: 16px;
            background: rgba(59, 130, 246, 0.08);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 14px;
            margin-bottom: 20px;
        }
        
        .roles-form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
            min-width: 180px;
        }
        
        .roles-form-label {
            font-size: 11px;
            font-weight: 600;
            color: #60a5fa;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .roles-form-input {
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            color: #e5e7eb;
            font-size: 13px;
            transition: all 0.2s ease;
        }
        
        .roles-form-input:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .roles-form-select {
            padding: 10px 36px 10px 14px;
            border-color: rgba(251, 191, 36, 0.25);
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23fbbf24' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            font-size: 13px;
        }
        
        .roles-form-select:focus {
            border-color: rgba(251, 191, 36, 0.5);
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
        }
        
        .roles-add-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .roles-add-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .roles-form-hint {
            font-size: 11px;
            color: #64748b;
            margin-top: 8px;
        }
        
        /* Users Table */
        .roles-table-wrap {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .roles-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .roles-table thead {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .roles-table th {
            padding: 12px 14px;
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            text-align: left;
            border-bottom: 1px solid rgba(148, 163, 184, 0.15);
        }
        
        .roles-table td {
            padding: 12px 14px;
            font-size: 13px;
            color: #e5e7eb;
            border-bottom: 1px solid rgba(148, 163, 184, 0.08);
        }
        
        .roles-table tbody tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .roles-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .roles-user-id {
            font-family: 'Fira Code', monospace;
            font-size: 11px;
            color: #94a3b8;
        }
        
        .roles-user-discord {
            font-family: 'Fira Code', monospace;
            font-size: 12px;
            color: #60a5fa;
        }
        
        .roles-user-name {
            font-weight: 500;
            color: #e5e7eb;
        }
        
        .roles-table-actions {
            display: flex;
            gap: 6px;
        }
        
        .roles-btn-save {
            padding: 6px 12px;
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 6px;
            color: #34d399;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .roles-btn-save:hover {
            background: rgba(16, 185, 129, 0.25);
        }
        
        .roles-btn-save:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .roles-btn-remove {
            padding: 6px 12px;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 6px;
            color: #f87171;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .roles-btn-remove:hover {
            background: rgba(239, 68, 68, 0.25);
        }
        
        .roles-btn-remove:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .roles-table-empty {
            padding: 30px;
            text-align: center;
            color: #64748b;
        }
        
        /* Role Profiles */
        .roles-profile-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(148, 163, 184, 0.12);
            border-radius: 14px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        
        .roles-profile-card:hover {
            border-color: rgba(251, 191, 36, 0.25);
        }
        
        .roles-profile-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 14px;
            padding: 16px;
            cursor: pointer;
        }
        
        .roles-profile-info {
            flex: 1;
        }
        
        .roles-profile-name {
            font-size: 15px;
            font-weight: 600;
            color: #fbbf24;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .roles-profile-edited {
            padding: 3px 8px;
            background: rgba(251, 191, 36, 0.2);
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            color: #fbbf24;
            display: none;
        }
        
        .roles-profile-base {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }
        
        .roles-profile-summary {
            font-size: 11px;
            color: #64748b;
            margin-top: 6px;
            line-height: 1.5;
        }
        
        .roles-profile-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .roles-btn-edit {
            padding: 6px 14px;
            background: rgba(148, 163, 184, 0.1);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 6px;
            color: #94a3b8;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .roles-btn-edit:hover {
            background: rgba(148, 163, 184, 0.2);
            color: #e5e7eb;
        }
        
        .roles-btn-delete {
            padding: 6px 14px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 6px;
            color: #f87171;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .roles-btn-delete:hover {
            background: rgba(239, 68, 68, 0.2);
        }
        
        .roles-profile-body {
            display: none;
            padding: 16px;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
            background: rgba(0, 0, 0, 0.15);
        }
        
        .roles-profile-body.active {
            display: block;
        }
        
        .roles-perm-section {
            margin-bottom: 16px;
        }
        
        .roles-perm-section:last-child {
            margin-bottom: 0;
        }
        
        .roles-perm-title {
            font-size: 11px;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .roles-perm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 8px;
        }
        
        .roles-perm-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            font-size: 12px;
            color: #94a3b8;
            transition: background 0.2s ease;
        }
        
        .roles-perm-item:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .roles-perm-item input[type="checkbox"] {
            accent-color: #fbbf24;
        }
        
        .roles-profile-save {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .roles-btn-primary {
            padding: 10px 20px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border: none;
            border-radius: 8px;
            color: #1e293b;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .roles-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }
        
        /* Create Role Form */
        .roles-create-form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-end;
            padding: 16px;
            background: rgba(251, 191, 36, 0.08);
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 14px;
            margin-bottom: 20px;
        }
        
        .roles-create-label {
            font-size: 11px;
            font-weight: 600;
            color: #fbbf24;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .roles-create-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border: none;
            border-radius: 8px;
            color: #1e293b;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .roles-create-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }
        
        /* Built-in Roles Card */
        .roles-builtin-card {
            padding: 16px;
            background: rgba(99, 102, 241, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 14px;
            margin-bottom: 20px;
        }
        
        .roles-builtin-title {
            font-size: 13px;
            font-weight: 600;
            color: #a5b4fc;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .roles-builtin-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .roles-builtin-item {
            font-size: 12px;
            color: #94a3b8;
        }
        
        .roles-builtin-item strong {
            color: #c7d2fe;
        }
        
        .roles-builtin-note {
            font-size: 11px;
            color: #64748b;
            margin-top: 10px;
        }
        
        /* ============================================
           MODERNIZED MARKETPLACE TAB STYLES
           ============================================ */
        
        .market-hero .dash-hero-orb-1,
        .market-orb-1 {
            background: rgba(34, 197, 94, 0.25) !important;
        }
        
        .market-hero .dash-hero-orb-2,
        .market-orb-2 {
            background: rgba(22, 163, 74, 0.2) !important;
        }
        
        .market-badge {
            background: rgba(34, 197, 94, 0.15) !important;
            border-color: rgba(34, 197, 94, 0.3) !important;
            color: #86efac !important;
        }
        
        .market-beta-tag {
            padding: 4px 10px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            color: white;
            letter-spacing: 0.05em;
        }
        
        .market-license-notice {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 20px;
            background: rgba(34, 197, 94, 0.08);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 14px;
            margin-bottom: 16px;
        }
        
        .market-license-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .market-license-content { flex: 1; }
        .market-license-title { font-size: 13px; font-weight: 600; color: #4ade80; margin-bottom: 2px; }
        .market-license-text { font-size: 12px; color: #94a3b8; }
        
        .market-license-folder {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-size: 12px;
            color: #94a3b8;
        }
        
        .market-license-folder code {
            color: #4ade80;
            font-family: 'Fira Code', monospace;
        }
        
        .market-activation-card {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.12), rgba(249, 115, 22, 0.08));
            border: 1px solid rgba(251, 146, 60, 0.25);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .market-activation-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
        }
        
        .market-activation-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(251, 146, 60, 0.2);
            color: #fb923c;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .market-activation-title { font-size: 15px; font-weight: 600; color: #fb923c; }
        .market-activation-subtitle { font-size: 12px; color: #fcd34d; margin-top: 2px; }
        .market-activation-subtitle code { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; }
        
        .market-activation-steps {
            display: grid;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .market-step {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            color: #fde68a;
        }
        
        .market-step-num {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(251, 146, 60, 0.2);
            color: #fb923c;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .market-step code { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; color: #fcd34d; }
        .market-step strong { color: #fb923c; }
        
        .market-refresh-id-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: rgba(251, 146, 60, 0.15);
            border: 1px solid rgba(251, 146, 60, 0.3);
            border-radius: 10px;
            color: #fcd34d;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .market-refresh-id-btn:hover {
            background: rgba(251, 146, 60, 0.25);
        }
        
        .market-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .market-search-wrap {
            flex: 1;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 10px;
            padding: 0 14px;
        }
        
        .market-search-wrap:focus-within {
            border-color: rgba(34, 197, 94, 0.5);
        }
        
        .market-search-wrap svg { color: #64748b; flex-shrink: 0; }
        
        .market-search-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            padding: 12px 0;
            color: #e5e7eb;
            font-size: 13px;
        }
        
        .market-filter-select {
            border-color: rgba(34, 197, 94, 0.3);
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%2322c55e' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        }
        
        .market-filter-select:focus {
            border-color: rgba(34, 197, 94, 0.5);
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }
        
        .market-grid {
            min-height: 200px;
        }
        
        .market-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 60px 24px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 20px;
            text-align: center;
        }
        
        .market-empty-title { font-size: 16px; font-weight: 600; color: #e5e7eb; }
        .market-empty-text { font-size: 14px; color: #64748b; }
        
        /* ============================================
           MODERNIZED CREDITS TAB STYLES
           ============================================ */
        
        .credits-hero .dash-hero-orb-1,
        .credits-orb-1 {
            background: rgba(250, 204, 21, 0.3) !important;
        }
        
        .credits-hero .dash-hero-orb-2,
        .credits-orb-2 {
            background: rgba(251, 113, 133, 0.25) !important;
        }
        
        .credits-badge {
            background: rgba(250, 204, 21, 0.15) !important;
            border-color: rgba(250, 204, 21, 0.3) !important;
            color: #fde047 !important;
        }
        
        .credits-copyright-banner {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 20px;
            background: linear-gradient(135deg, rgba(250, 204, 21, 0.12), rgba(251, 113, 133, 0.08));
            border: 1px solid rgba(250, 204, 21, 0.4);
            border-radius: 50px;
            margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(250, 204, 21, 0.2);
        }
        
        .credits-crown-icon {
            width: 28px;
            height: 28px;
            flex-shrink: 0;
        }
        
        .credits-copyright-text {
            font-size: 12px;
            color: #e5e7eb;
        }
        
        .credits-main-card {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 0;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(250, 204, 21, 0.2);
            border-radius: 24px;
            overflow: hidden;
            position: relative;
        }
        
        .credits-main-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: 
                radial-gradient(circle at 0% 0%, rgba(250, 204, 21, 0.15), transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(251, 113, 133, 0.1), transparent 50%);
            pointer-events: none;
        }
        
        .credits-creator-section {
            padding: 28px;
            border-right: 1px solid rgba(148, 163, 184, 0.1);
            position: relative;
        }
        
        .credits-creator-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .credits-crown-large {
            width: 56px;
            height: 56px;
            flex-shrink: 0;
        }
        
        .credits-creator-name {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, #facc15, #fb7185);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .credits-creator-role {
            font-size: 13px;
            color: #94a3b8;
            margin-top: 2px;
        }
        
        .credits-info-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .credits-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .credits-info-item:last-child { border-bottom: none; }
        
        .credits-info-label {
            font-size: 13px;
            color: #94a3b8;
        }
        
        .credits-info-value {
            font-size: 13px;
            font-weight: 500;
            color: #e5e7eb;
        }
        
        .credits-info-link {
            font-size: 13px;
            color: #60a5fa;
            text-decoration: none;
            transition: color 0.2s ease;
        }
        
        .credits-info-link:hover { color: #93c5fd; }
        
        .credits-features-section {
            padding: 28px;
            position: relative;
        }
        
        .credits-features-header {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 12px;
        }
        
        .credits-features-header svg { color: #facc15; }
        
        .credits-features-desc {
            font-size: 13px;
            color: #94a3b8;
            line-height: 1.7;
            margin-bottom: 20px;
        }
        
        .credits-features-desc strong { color: #fde047; }
        
        .credits-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .credits-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid;
        }
        
        .credits-tag-backend { background: rgba(139, 92, 246, 0.15); border-color: rgba(139, 92, 246, 0.3); color: #a78bfa; }
        .credits-tag-frontend { background: rgba(59, 130, 246, 0.15); border-color: rgba(59, 130, 246, 0.3); color: #60a5fa; }
        .credits-tag-realtime { background: rgba(239, 68, 68, 0.15); border-color: rgba(239, 68, 68, 0.3); color: #f87171; }
        .credits-tag-api { background: rgba(16, 185, 129, 0.15); border-color: rgba(16, 185, 129, 0.3); color: #34d399; }
        .credits-tag-ui { background: rgba(236, 72, 153, 0.15); border-color: rgba(236, 72, 153, 0.3); color: #f472b6; }
        .credits-tag-secure { background: rgba(251, 191, 36, 0.15); border-color: rgba(251, 191, 36, 0.3); color: #fbbf24; }
        
        .credits-feature-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .credits-feature-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #94a3b8;
        }
        
        .credits-feature-item svg { flex-shrink: 0; }
        
        .credits-support-note {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(251, 113, 133, 0.1), rgba(250, 204, 21, 0.08));
            border-radius: 12px;
            font-size: 12px;
            color: #fde68a;
        }
        
        .credits-support-note svg { color: #fb7185; flex-shrink: 0; }
        
        .credits-license-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 10px 18px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.15));
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 10px;
            color: #a5b4fc;
            font-size: 13px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .credits-license-btn:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(139, 92, 246, 0.25));
            border-color: rgba(99, 102, 241, 0.5);
            color: #c7d2fe;
            transform: translateY(-1px);
        }
        
        .credits-license-btn svg {
            flex-shrink: 0;
        }
        
        @media (max-width: 900px) {
            .credits-main-card {
                grid-template-columns: 1fr;
            }
            
            .credits-creator-section {
                border-right: none;
                border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            }
        }
        
        @media (max-width: 600px) {
            .credits-copyright-banner {
                flex-direction: column;
                text-align: center;
                border-radius: 16px;
            }
            
            .market-controls {
                flex-direction: column;
            }
            
            .market-search-wrap {
                max-width: none;
            }
        }

        .toggle-pill {
            position: relative;
            width: 40px;
            height: 20px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.9);
            padding: 2px;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease;
        }

        .toggle-pill-knob {
            width: 16px;
            height: 16px;
            border-radius: 999px;
            background: #e5e7eb;
            transform: translateX(0);
            transition: transform 0.2s ease, background 0.2s ease;
        }

        .toggle-pill.on {
            background: rgba(16, 185, 129, 0.25);
            border-color: rgba(16, 185, 129, 0.7);
        }

        .toggle-pill.on .toggle-pill-knob {
            transform: translateX(18px);
            background: #bbf7d0;
        }

        .execution-history {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 12px;
        }

        .history-item {
            background: rgba(15, 23, 42, 0.5);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--border);
        }

        .history-item.success {
            border-left-color: var(--success);
        }

        .history-item.failure {
            border-left-color: var(--danger);
        }

        .file-browser {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .file-browser-header {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .file-browser-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .breadcrumb {
            font-family: 'Inter', monospace;
            font-size: 14px;
            color: var(--text-primary);
            background: rgba(59, 130, 246, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            cursor: pointer;
            color: var(--primary);
            transition: color 0.2s ease;
        }

        .breadcrumb-item:hover {
            color: var(--accent-cyan);
        }

        .breadcrumb-separator {
            color: var(--text-secondary);
        }

        .path-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .file-tree {
            font-family: 'Inter', monospace;
            font-size: 14px;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            margin-bottom: 2px;
        }

        .file-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .file-item.expanded {
            background: rgba(59, 130, 246, 0.15);
        }

        .file-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .file-name {
            flex: 1;
            color: var(--text-primary);
        }

        .file-size {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .file-children {
            margin-left: 20px;
            border-left: 2px solid var(--border);
            padding-left: 10px;
            margin-top: 5px;
        }

        .terminal-modal .modal-content {
            max-width: 90vw;
            width: 90vw;
            max-height: 90vh;
        }

        .terminal-window {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            color: #f8f8f2;
            position: relative;
            max-width: 95vw;
            max-height: 90vh;
        }

        .terminal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .terminal-title {
            font-weight: 600;
            color: #61dafb;
            font-size: 14px;
        }

        .terminal-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .terminal-content {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            max-height: 60vh;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 13px;
            line-height: 1.4;
            position: relative;
        }

        .terminal-content.with-lines {
            padding-left: 60px;
        }

        .line-numbers {
            position: absolute;
            left: 10px;
            top: 15px;
            color: #666;
            font-size: 12px;
            user-select: none;
            pointer-events: none;
        }

        .terminal-edit {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            max-height: 60vh;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #f8f8f2;
            resize: vertical;
            min-height: 200px;
            line-height: 1.4;
            white-space: pre;
            word-wrap: normal;
            overflow-wrap: normal;
        }

        .terminal-edit:focus {
            outline: none;
            border-color: var(--primary);
        }

        .code-editor {
            position: relative;
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 4px;
            max-height: 60vh;
            overflow: hidden;
        }

        .code-editor .line-numbers {
            width: 50px;
            text-align: right;
            padding-right: 10px;
            border-right: 1px solid #333;
            background: #252526;
        }

        .code-editor textarea {
            margin-left: 60px;
            width: calc(100% - 60px);
            background: transparent;
            border: none;
            color: #f8f8f2;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            resize: none;
            outline: none;
            padding: 15px 15px 15px 0;
            min-height: 200px;
            overflow-y: auto;
        }

        .tickets-select {
            width: 100%;
            border-color: rgba(124, 58, 237, 0.3);
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23a855f7' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        }
        
        .tickets-select:hover {
            border-color: rgba(124, 58, 237, 0.5);
        }
        
        .tickets-select:focus {
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }
        
        .tickets-select option {
            background: #0f172a;
            color: #e5e7eb;
            padding: 8px;
        }

        /* DASHBOARD_PLUGINS_CSS_PLACEHOLDER */
    </style>
</head>
<body>
    <div class="container">
        <!-- Modernized Header with Banner Background -->
        <div class="main-header">
            <div class="main-header-bg">
                <img src="assets/banner.png" alt="" class="main-header-banner">
                <div class="main-header-light main-header-light-left"></div>
                <div class="main-header-light main-header-light-right"></div>
                <div class="main-header-overlay"></div>
            </div>
            <div class="main-header-content">
                <div class="main-header-left">
                    <div class="main-header-brand">
                        <img src="assets/zoryx-framework.png" alt="Zoryx Framework" class="main-header-logo">
                        <div class="main-header-titles">
                            <h1 class="main-header-title">Live Monitor Dashboard</h1>
                            <a href="https://github.com/TheHolyOneZ/discord-bot-framework" target="_blank" rel="noopener noreferrer" class="main-header-link">
                                Zoryx Discord Bot Framework
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                            </a>
                        </div>
                    </div>
                    <div class="main-header-status">
                        <div id="connection-status" class="connection-status-indicator connecting" title="Connecting to bot...">
                            <span class="connection-dot"></span>
                            <span class="connection-text">Connecting</span>
                        </div>
                        <div id="status-badge" class="main-status-badge">Loading...</div>
                        <button id="hero-info-button" class="main-header-details-btn" onclick="toggleHeroInfo()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                            Details
                        </button>
                        <div id="lm-user-pill" class="lm-user-pill"></div>
                        <button id="privacy-settings-btn" class="header-info-button" onclick="openPrivacyModal()">Privacy Settings</button>
                    </div>
                </div>
                <div class="main-header-metrics">
                    <div class="main-metric">
                        <div class="main-metric-icon main-metric-icon-cpu">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="14" x2="23" y2="14"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="14" x2="4" y2="14"/></svg>
                        </div>
                        <div class="main-metric-content">
                            <div class="main-metric-label">CPU</div>
                            <div class="main-metric-value"><span id="cpu-value">0</span>%</div>
                        </div>
                    </div>
                    <div class="main-metric">
                        <div class="main-metric-icon main-metric-icon-memory">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
                        </div>
                        <div class="main-metric-content">
                            <div class="main-metric-label">Memory</div>
                            <div class="main-metric-value" id="memory-value">0 MB</div>
                        </div>
                    </div>
                    <div class="main-metric">
                        <div class="main-metric-icon main-metric-icon-latency">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                        </div>
                        <div class="main-metric-content">
                            <div class="main-metric-label">Latency</div>
                            <div class="main-metric-value"><span id="latency-value">0</span>ms</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="hero-info-panel" class="hero-info-panel">
            <div class="hero-info-row">
                <span class="hero-info-label">Guilds</span>
                <span class="hero-info-value" id="guilds-value">0</span>
            </div>
            <div class="hero-info-row">
                <span class="hero-info-label">Users</span>
                <span class="hero-info-value" id="users-value">0</span>
            </div>
            <div class="hero-info-row">
                <span class="hero-info-label">Uptime</span>
                <span class="hero-info-value" id="uptime-value">0s</span>
            </div>
        </div>

        <div id="loading" class="loading">
            <p>Loading data from bot...</p>
        </div>

        <div id="content" style="display: none;">

            <div class="lm-nav-top-row">
                <button class="nav-palette-trigger" id="lm-nav-palette-trigger">
                    <span>Open Navigation</span>
                    <kbd>Ctrl</kbd><kbd>K</kbd>
                </button>
                <button class="lm-drawer-trigger" id="lm-drawer-trigger">
                    <span class="lm-drawer-icon">â˜°</span>
                    <span>Navigation</span>
                </button>
            </div>

                <div class="lm-main-layout">
                <aside class="lm-sidebar" id="lm-sidebar-nav">
                    <div class="lm-sidebar-group-label">Core</div>
                    <button class="lm-sidebar-item" data-tab="dashboard">Dashboard</button>
                    <button class="lm-sidebar-item" data-tab="commands">Commands</button>
                    <button class="lm-sidebar-item" data-tab="plugins">Plugins &amp; Extensions</button>
                    <button class="lm-sidebar-item" data-tab="hooks">Event Hooks</button>
                    <button class="lm-sidebar-item" data-tab="hook-creator">Hook Creator</button>
                    <button class="lm-sidebar-item" data-tab="filesystem">File System</button>
                    <button class="lm-sidebar-item" data-tab="system">System</button>

                    <div class="lm-sidebar-group-label">Tools</div>
                    <button class="lm-sidebar-item" data-tab="files">File Browser</button>
                    <button class="lm-sidebar-item" data-tab="chat">Chat Console</button>
                    <button class="lm-sidebar-item" data-tab="tickets">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="display:inline-block;vertical-align:middle;margin-right:8px;">
                            <path d="M3 7C3 5.89543 3.89543 5 5 5H19C20.1046 5 21 5.89543 21 7V10C19.8954 10 19 10.8954 19 12C19 13.1046 19.8954 14 21 14V17C21 18.1046 20.1046 19 19 19H5C3.89543 19 3 18.1046 3 17V14C4.10457 14 5 13.1046 5 12C5 10.8954 4.10457 10 3 10V7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M9 9L9 15M12 9V15M15 9V15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Discord Tickets
                    </button>
                    <button class="lm-sidebar-item" data-tab="guilds">Guilds / Servers</button>
                    <button class="lm-sidebar-item" data-tab="events">Events</button>
                    <button class="lm-sidebar-item" data-tab="invite">Bot Invite Helper</button>
                    <button class="lm-sidebar-item" data-tab="marketplace">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;display:inline-block;vertical-align:middle;">
                            <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                        </svg>
                        Extension Marketplace <span style="font-size:10px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);padding:2px 6px;border-radius:4px;margin-left:6px;">BETA</span></button>

                    <!-- DASHBOARD_PLUGINS_SIDEBAR_PLACEHOLDER -->

                    <div class="lm-sidebar-group-label">Admin</div>
                    <button class="lm-sidebar-item" data-tab="roles">Roles &amp; Access</button>
                    <button class="lm-sidebar-item" data-tab="security">Security &amp; Logs</button>
                    <button class="lm-sidebar-item" data-tab="database">Database</button>

                    <div class="lm-sidebar-group-label">Meta</div>
                    <button class="lm-sidebar-item" data-tab="credits">Credits ğŸ‘‘</button>
                </aside>

                <div class="lm-main-content">
                    <div class="section">
                        <div class="tab-container">
                    <button class="tab active" onclick="switchTab('dashboard')">Dashboard</button>
                    <button class="tab" onclick="switchTab('commands')">Commands</button>
                    <button class="tab" onclick="switchTab('plugins')">Plugins & Extensions</button>
                    <button class="tab" onclick="switchTab('hooks')">Event Hooks</button>
                    <button class="tab" onclick="switchTab('hook-creator')">Hook Creator</button>
                    <button class="tab" onclick="switchTab('filesystem')">File System</button>
                    <button class="tab" onclick="switchTab('files')">File Browser</button>
                    <button class="tab" onclick="switchTab('chat')">Chat Console (EXPERIMENTAL)</button>
                    <button class="tab" onclick="switchTab('tickets')">Discord Tickets</button>
                    <button class="tab" onclick="switchTab('guilds')">Guilds / Servers</button>
                    <button class="tab" onclick="switchTab('events')">Events</button>
                    <button class="tab" onclick="switchTab('system')">System</button>
                    <button class="tab" onclick="switchTab('invite')">Bot Invite Helper</button>
                    <button class="tab" onclick="switchTab('database')">Database</button>
                    <button class="tab" onclick="switchTab('roles')">Roles &amp; Access</button>
                    <button class="tab" onclick="switchTab('security')">Security &amp; Logs</button>
                    <button class="tab tab-credits" onclick="switchTab('credits')">
                        <span style="display:inline-flex;align-items:center;gap:8px;">
                            <span style="width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;">
                                <svg viewBox="0 0 24 24" aria-hidden="true">
                                    <defs>
                                        <linearGradient id="credfits-crown-gradient" x1="0" y1="0" x2="1" y2="1">
                                            <stop offset="0%" stop-color="#facc15">
                                                <animate attributeName="stop-color" values="#facc15;#fb923c;#facc15" dur="4s" repeatCount="indefinite" />
                                            </stop>
                                            <stop offset="100%" stop-color="#fb923c">
                                                <animate attributeName="stop-color" values="#fb923c;#f97316;#fb923c" dur="4s" repeatCount="indefinite" />
                                            </stop>
                                        </linearGradient>
                                    </defs>
                                    <path fill="url(#credfits-crown-gradient)" d="M4 18h16l-1.5-9-4 3-2.5-6-2.5 6-4-3L4 18z" />
                                    <circle cx="6" cy="7" r="1.4" fill="#facc15">
                                        <animate attributeName="r" values="1.4;1.7;1.4" dur="2.6s" repeatCount="indefinite" />
                                    </circle>
                                    <circle cx="12" cy="5" r="1.4" fill="#facc15">
                                        <animate attributeName="r" values="1.4;1.9;1.4" dur="2.2s" repeatCount="indefinite" />
                                    </circle>
                                    <circle cx="18" cy="7" r="1.4" fill="#facc15">
                                        <animate attributeName="r" values="1.4;1.7;1.4" dur="2.9s" repeatCount="indefinite" />
                                    </circle>
                                </svg>
                            </span>
                            <span>Credits</span>
                        </span>
                    </button>
                </div>

                <div id="tab-dashboard" class="tab-content active">
                    <!-- Dashboard Hero Header -->
                    <div class="dash-hero">
                        <div class="dash-hero-bg">
                            <div class="dash-hero-orb dash-hero-orb-1"></div>
                            <div class="dash-hero-orb dash-hero-orb-2"></div>
                            <div class="dash-hero-grid"></div>
                        </div>
                        <div class="dash-hero-content">
                            <div class="dash-hero-left">
                                <div class="dash-hero-badge">
                                    <span class="dash-hero-badge-dot"></span>
                                    Live Dashboard
                                </div>
                                <h1 class="dash-hero-title">Dashboard Overview</h1>
                                <p class="dash-hero-subtitle">Monitor your bot's health, performance, and activity in real-time</p>
                            </div>
                            <div class="dash-hero-right">
                                <button class="dash-tour-btn" id="tour-trigger">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                    Quick Tour
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="alerts-bar"></div>

                    <!-- Stats Grid - Modernized -->
                    <div class="dash-stats-grid" id="overview-stats">
                        <div class="dash-stat-card dash-stat-health" onclick="openDiagnosticsModal()">
                            <div class="dash-stat-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                            </div>
                            <div class="dash-stat-content">
                                <div class="dash-stat-label">Bot Health</div>
                                <div class="dash-stat-value" id="overview-health-text">Checking...</div>
                            </div>
                            <div class="dash-stat-arrow">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
                            </div>
                            <div class="dash-stat-glow"></div>
                        </div>
                        <div class="dash-stat-card dash-stat-uptime">
                            <div class="dash-stat-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            </div>
                            <div class="dash-stat-content">
                                <div class="dash-stat-label">Uptime &amp; Reach</div>
                                <div class="dash-stat-value" id="overview-uptime-guilds">--</div>
                            </div>
                            <div class="dash-stat-glow"></div>
                        </div>
                        <div class="dash-stat-card dash-stat-activity">
                            <div class="dash-stat-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                            </div>
                            <div class="dash-stat-content">
                                <div class="dash-stat-label">Activity Snapshot</div>
                                <div class="dash-stat-value" id="overview-activity">--</div>
                            </div>
                            <div class="dash-stat-glow"></div>
                        </div>
                        <div class="dash-stat-card dash-stat-framework">
                            <div class="dash-stat-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                            </div>
                            <div class="dash-stat-content">
                                <div class="dash-stat-label">Framework</div>
                                <div class="dash-stat-value" id="overview-framework">Version: --</div>
                            </div>
                            <div class="dash-stat-glow"></div>
                        </div>
                    </div>

                    <!-- Two Column Layout - Modernized -->
                    <div class="dash-columns">
                        <!-- Alerts Column -->
                        <div class="dash-column-card dash-alerts-card">
                            <div class="dash-column-header">
                                <div class="dash-column-icon dash-column-icon-alerts">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                </div>
                                <div>
                                    <div class="dash-column-title">Alerts</div>
                                    <div class="dash-column-subtitle">Key things you should know right now</div>
                                </div>
                            </div>
                            <div id="overview-alert-list" class="dash-alert-list"></div>
                        </div>

                        <!-- Quick Actions Column -->
                        <div class="dash-column-card dash-actions-card">
                            <div class="dash-column-header">
                                <div class="dash-column-icon dash-column-icon-actions">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                                </div>
                                <div>
                                    <div class="dash-column-title">Quick Actions</div>
                                    <div class="dash-column-subtitle">Common operations for operators</div>
                                </div>
                            </div>
                            <div class="dash-actions-container">
                                <!-- Lifecycle Section -->
                                <div class="dash-action-section dash-action-section-danger">
                                    <div class="dash-action-section-header">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                                        Lifecycle
                                    </div>
                                    <button class="dash-action-btn dash-action-btn-danger" onclick="confirmShutdownBot()">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>
                                        Shutdown Bot
                                    </button>
                                    <div class="dash-action-hint">Cleanly closes the bot process. Restart via your hosting panel.</div>
                                </div>

                                <!-- Diagnostics Section -->
                                <div class="dash-action-section">
                                    <div class="dash-action-section-header">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                        Diagnostics &amp; Files
                                    </div>
                                    <div class="dash-action-btn-grid">
                                        <button class="dash-action-btn" onclick="sendCommand('clear_cache', {})">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                                            Clear Cache
                                        </button>
                                        <button class="dash-action-btn" onclick="switchTab('filesystem')">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                                            File System
                                        </button>
                                        <button class="dash-action-btn" onclick="openMainConfig()">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                                            config.json
                                        </button>
                                        <button class="dash-action-btn" onclick="openLiveMonitorConfig()">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                                            LM config
                                        </button>
                                        <button class="dash-action-btn" onclick="window.location='backup_dashboard.php'">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                            Dashboard Backup
                                        </button>
                                        <button class="dash-action-btn" onclick="requestBotBackup()">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>
                                            Bot Backup
                                        </button>
                                    </div>
                                </div>

                                <!-- Debug Section -->
                                <div class="dash-action-section">
                                    <div class="dash-action-section-header">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                                        Debug &amp; Logging
                                    </div>
                                    <div class="dash-action-btn-grid">
                                        <button class="dash-action-btn dash-action-btn-toggle" id="toggle-verbose-btn" onclick="toggleVerboseLogging()">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                            Verbose Logging: OFF
                                        </button>
                                        <button class="dash-action-btn dash-action-btn-toggle" id="toggle-debug-packages-btn" onclick="toggleDebugPackages()">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                                            Debug Packages: OFF
                                        </button>
                                    </div>
                                    <div class="dash-action-hint">
                                        <strong>Verbose:</strong> Hides "Data sent successfully" spam &nbsp;|&nbsp; <strong>Debug:</strong> Shows pip/npm install output
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-commands" class="tab-content">
                    <!-- Commands Hero Header -->
                    <div class="dash-hero cmd-hero">
                        <div class="dash-hero-bg">
                            <div class="dash-hero-orb cmd-orb-1"></div>
                            <div class="dash-hero-orb cmd-orb-2"></div>
                            <div class="dash-hero-grid"></div>
                        </div>
                        <div class="dash-hero-content">
                            <div class="dash-hero-left">
                                <div class="dash-hero-badge cmd-badge">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
                                    Command Registry
                                </div>
                                <h1 class="dash-hero-title">Commands Overview</h1>
                                <p class="dash-hero-subtitle">Browse and monitor all registered bot commands, usage statistics, and error rates</p>
                            </div>
                            <div class="dash-hero-right" style="display:flex;gap:10px;">
                                <button class="dash-tour-btn" onclick="openSectionHelp('commands')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                    Help
                                </button>
                                <button class="dash-action-btn" onclick="refreshCommands()" style="padding:10px 18px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                                    Refresh
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Commands Stats Grid -->
                    <div class="cmd-stats-grid">
                        <div class="cmd-stat-card cmd-stat-total">
                            <div class="cmd-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
                            </div>
                            <div class="cmd-stat-value" id="cmd-total">0</div>
                            <div class="cmd-stat-label">Total Commands</div>
                        </div>
                        <div class="cmd-stat-card cmd-stat-slash">
                            <div class="cmd-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="7" y1="20" x2="17" y2="4"/></svg>
                            </div>
                            <div class="cmd-stat-value" id="cmd-slash">0</div>
                            <div class="cmd-stat-label">Slash</div>
                        </div>
                        <div class="cmd-stat-card cmd-stat-prefix">
                            <div class="cmd-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7h16M4 12h16M4 17h10"/></svg>
                            </div>
                            <div class="cmd-stat-value" id="cmd-prefix">0</div>
                            <div class="cmd-stat-label">Prefix</div>
                        </div>
                        <div class="cmd-stat-card cmd-stat-hybrid">
                            <div class="cmd-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v10"/><path d="M21 12h-6m-6 0H1"/></svg>
                            </div>
                            <div class="cmd-stat-value" id="cmd-hybrid">0</div>
                            <div class="cmd-stat-label">Hybrid</div>
                        </div>
                        <div class="cmd-stat-card cmd-stat-cogs">
                            <div class="cmd-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                            </div>
                            <div class="cmd-stat-value" id="cmd-cogs">0</div>
                            <div class="cmd-stat-label">Cogs</div>
                        </div>
                        <div class="cmd-stat-card cmd-stat-usage">
                            <div class="cmd-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                            </div>
                            <div class="cmd-stat-value" id="cmd-usage">0</div>
                            <div class="cmd-stat-label">Total Usage</div>
                        </div>
                        <div class="cmd-stat-card cmd-stat-errors">
                            <div class="cmd-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                            </div>
                            <div class="cmd-stat-value" id="cmd-errors">0</div>
                            <div class="cmd-stat-label">Errors</div>
                        </div>
                        <div class="cmd-stat-card cmd-stat-success">
                            <div class="cmd-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            </div>
                            <div class="cmd-stat-value" id="cmd-success">100%</div>
                            <div class="cmd-stat-label">Success Rate</div>
                        </div>
                    </div>

                    <!-- Commands Explorer -->
                    <div class="cmd-explorer">
                        <div class="cmd-explorer-header">
                            <div class="cmd-explorer-title">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                                Registered Commands
                            </div>
                            <div class="cmd-view-controls">
                                <button class="cmd-view-btn active" data-view="all">All</button>
                                <button class="cmd-view-btn" data-view="slash">Slash</button>
                                <button class="cmd-view-btn" data-view="prefix">Prefix</button>
                                <button class="cmd-view-btn" data-view="hybrid">Hybrid</button>
                            </div>
                        </div>
                        <div class="cmd-explorer-toolbar">
                            <div class="cmd-search-wrap">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                                <input id="cmd-search" class="cmd-search-input" type="text" placeholder="Search by name, description, or cog..."/>
                            </div>
                            <select id="cmd-sort" class="cmd-sort-select">
                                <option value="name">Sort by Name</option>
                                <option value="usage">Sort by Usage</option>
                                <option value="errors">Sort by Errors</option>
                                <option value="cog">Sort by Cog</option>
                            </select>
                        </div>
                        <div class="cmd-list" id="commands-list"></div>
                    </div>
                </div>

                <div id="tab-plugins" class="tab-content">
                    <!-- Plugins Hero Header -->
                    <div class="dash-hero plug-hero">
                        <div class="dash-hero-bg">
                            <div class="dash-hero-orb plug-orb-1"></div>
                            <div class="dash-hero-orb plug-orb-2"></div>
                            <div class="dash-hero-grid"></div>
                        </div>
                        <div class="dash-hero-content">
                            <div class="dash-hero-left">
                                <div class="dash-hero-badge plug-badge">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                                    Extension Manager
                                </div>
                                <h1 class="dash-hero-title">Plugins &amp; Extensions</h1>
                                <p class="dash-hero-subtitle">Manage your bot's modular functionality, monitor health status, and discover new extensions</p>
                            </div>
                            <div class="dash-hero-right" style="display:flex;gap:10px;">
                                <button class="dash-tour-btn" onclick="openSectionHelp('plugins')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                    Help
                                </button>
                                <button class="dash-action-btn" onclick="refreshPlugins()" style="padding:10px 18px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                                    Refresh
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Plugins Stats Card (Collapsible) -->
                    <div class="plug-stats-card" id="plugins-stats-card">
                        <div class="plug-stats-header">
                            <div class="plug-stats-header-left">
                                <div class="plug-stats-icon">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
                                </div>
                                <div>
                                    <div class="plug-stats-title">System Overview</div>
                                    <div class="plug-stats-subtitle">Summary of plugin and extension health</div>
                                </div>
                            </div>
                            <div class="plug-stats-toggle-wrap">
                                <span class="plug-stats-toggle-label">Show Stats</span>
                                <button type="button" class="plug-toggle-pill" id="plugins-stats-toggle" aria-pressed="false" aria-label="Toggle plugin stats overview">
                                    <span class="plug-toggle-knob"></span>
                                </button>
                            </div>
                        </div>
                        <div class="plug-stats-grid" id="plugins-stats-body">
                            <div class="plug-stat-item">
                                <div class="plug-stat-icon plug-stat-icon-total">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>
                                </div>
                                <div class="plug-stat-value" id="total-plugins">0</div>
                                <div class="plug-stat-label">Total Plugins</div>
                            </div>
                            <div class="plug-stat-item">
                                <div class="plug-stat-icon plug-stat-icon-loaded">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                                </div>
                                <div class="plug-stat-value" id="loaded-plugins">0</div>
                                <div class="plug-stat-label">Loaded</div>
                            </div>
                            <div class="plug-stat-item">
                                <div class="plug-stat-icon plug-stat-icon-healthy">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                                </div>
                                <div class="plug-stat-value" id="healthy-plugins">0</div>
                                <div class="plug-stat-label">Healthy</div>
                            </div>
                            <div class="plug-stat-item">
                                <div class="plug-stat-icon plug-stat-icon-issues">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                </div>
                                <div class="plug-stat-value" id="issues-plugins">0</div>
                                <div class="plug-stat-label">With Issues</div>
                            </div>
                            <div class="plug-stat-item">
                                <div class="plug-stat-icon plug-stat-icon-commands">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
                                </div>
                                <div class="plug-stat-value" id="total-commands">0</div>
                                <div class="plug-stat-label">Commands</div>
                            </div>
                            <div class="plug-stat-item">
                                <div class="plug-stat-icon plug-stat-icon-cogs">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                                </div>
                                <div class="plug-stat-value" id="total-cogs">0</div>
                                <div class="plug-stat-label">Cogs</div>
                            </div>
                            <div class="plug-stat-item">
                                <div class="plug-stat-icon plug-stat-icon-extensions">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                                </div>
                                <div class="plug-stat-value" id="total-extensions">0</div>
                                <div class="plug-stat-label">Extensions</div>
                            </div>
                            <div class="plug-stat-item">
                                <div class="plug-stat-icon plug-stat-icon-time">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                </div>
                                <div class="plug-stat-value" id="avg-load-time">0ms</div>
                                <div class="plug-stat-label">Avg Load</div>
                            </div>
                        </div>
                    </div>

                    <!-- Discover Extensions Promo -->
                    <div class="plug-promo-card" id="plugins-promo-card">
                        <div class="plug-promo-bg">
                            <div class="plug-promo-orb plug-promo-orb-1"></div>
                            <div class="plug-promo-orb plug-promo-orb-2"></div>
                        </div>
                        <div class="plug-promo-content">
                            <div class="plug-promo-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                            </div>
                            <div class="plug-promo-text">
                                <div class="plug-promo-title">Discover More Extensions</div>
                                <div class="plug-promo-subtitle">Browse the official ZygnalBot Extension Portal for additional extensions and plugins</div>
                            </div>
                            <div class="plug-promo-actions">
                                <a href="https://zsync.eu/extension/" target="_blank" rel="noreferrer noopener" class="plug-promo-btn plug-promo-btn-primary">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                                    Extension Portal
                                </a>
                                <button class="plug-promo-btn plug-promo-btn-secondary" onclick="switchTab('marketplace')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                                    Beta Marketplace
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Plugins Explorer -->
                    <div class="plug-explorer">
                        <div class="plug-explorer-header">
                            <div class="plug-explorer-title">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                                Plugins &amp; Extensions
                            </div>
                        </div>
                        <div class="plug-explorer-toolbar">
                            <div class="plug-search-wrap">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                                <input id="plugin-search" class="plug-search-input" type="text" placeholder="Search by name, description, or command..."/>
                            </div>
                            <select id="plugin-filter" class="plug-filter-select">
                                <option value="all">All</option>
                                <option value="loaded">Loaded Only</option>
                                <option value="not_loaded">Not Loaded Only</option>
                                <option value="healthy">Healthy Only</option>
                                <option value="issues">With Issues</option>
                            </select>
                        </div>
                        <div class="plug-list" id="plugins-extensions-list"></div>
                    </div>
                </div>

                <div id="tab-hooks" class="tab-content">
                    <!-- Hooks Hero Header -->
                    <div class="dash-hero hooks-hero">
                        <div class="dash-hero-bg">
                            <div class="dash-hero-orb hooks-orb-1"></div>
                            <div class="dash-hero-orb hooks-orb-2"></div>
                            <div class="dash-hero-grid"></div>
                        </div>
                        <div class="dash-hero-content">
                            <div class="dash-hero-left">
                                <div class="dash-hero-badge hooks-badge">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                    Event System
                                </div>
                                <h1 class="dash-hero-title">Event Hooks System</h1>
                                <p class="dash-hero-subtitle">Monitor event emissions, executions, and hook performance in real-time</p>
                            </div>
                            <div class="dash-hero-right" style="display:flex;gap:10px;">
                                <button class="dash-tour-btn" onclick="openSectionHelp('hooks')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                    Help
                                </button>
                                <button class="dash-action-btn" onclick="refreshHooks()" style="padding:10px 18px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                                    Refresh
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Hooks Stats Grid -->
                    <div class="hooks-stats-grid">
                        <div class="hooks-stat-card hooks-stat-emissions">
                            <div class="hooks-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                            </div>
                            <div class="hooks-stat-value" id="hooks-emissions">0</div>
                            <div class="hooks-stat-label">Emissions</div>
                        </div>
                        <div class="hooks-stat-card hooks-stat-executions">
                            <div class="hooks-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                            </div>
                            <div class="hooks-stat-value" id="hooks-executions">0</div>
                            <div class="hooks-stat-label">Executions</div>
                        </div>
                        <div class="hooks-stat-card hooks-stat-failures">
                            <div class="hooks-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                            </div>
                            <div class="hooks-stat-value" id="hooks-failures">0</div>
                            <div class="hooks-stat-label">Failures</div>
                        </div>
                        <div class="hooks-stat-card hooks-stat-queue">
                            <div class="hooks-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                            </div>
                            <div class="hooks-stat-value" id="hooks-queue-size">0</div>
                            <div class="hooks-stat-label">Queue Size</div>
                        </div>
                        <div class="hooks-stat-card hooks-stat-queuefull">
                            <div class="hooks-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                            </div>
                            <div class="hooks-stat-value" id="hooks-queue-full">0</div>
                            <div class="hooks-stat-label">Queue Full</div>
                        </div>
                        <div class="hooks-stat-card hooks-stat-restarts">
                            <div class="hooks-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                            </div>
                            <div class="hooks-stat-value" id="hooks-worker-restarts">0</div>
                            <div class="hooks-stat-label">Restarts</div>
                        </div>
                        <div class="hooks-stat-card hooks-stat-disabled">
                            <div class="hooks-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
                            </div>
                            <div class="hooks-stat-value" id="hooks-disabled">0</div>
                            <div class="hooks-stat-label">Disabled</div>
                        </div>
                        <div class="hooks-stat-card hooks-stat-circuit">
                            <div class="hooks-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>
                            </div>
                            <div class="hooks-stat-value" id="hooks-circuit-open">0</div>
                            <div class="hooks-stat-label">Circuit Open</div>
                        </div>
                    </div>

                    <!-- Hooks Explorer -->
                    <div class="hooks-explorer">
                        <div class="hooks-explorer-header">
                            <div class="hooks-explorer-title">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                Registered Event Hooks
                            </div>
                            <div class="hooks-view-controls">
                                <button class="hooks-view-btn active" data-view="all">All Hooks</button>
                                <button class="hooks-view-btn" data-view="active">Active</button>
                                <button class="hooks-view-btn" data-view="disabled">Disabled</button>
                                <button class="hooks-view-btn" data-view="issues">With Issues</button>
                            </div>
                        </div>
                        <div class="hooks-explorer-toolbar">
                            <div class="hooks-search-wrap">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                                <input id="hooks-search" class="hooks-search-input" type="text" placeholder="Search by event name or callback..."/>
                            </div>
                            <select id="hooks-sort" class="hooks-sort-select">
                                <option value="priority">Sort by Priority</option>
                                <option value="executions">Sort by Executions</option>
                                <option value="failures">Sort by Failures</option>
                                <option value="time">Sort by Avg Time</option>
                            </select>
                        </div>
                        <div class="hooks-list" id="hooks-list"></div>
                    </div>
                </div>

                <!-- Event Hooks Creator Tab - Modernized Version -->
<div id="tab-hook-creator" class="tab-content">
    <!-- Hook Creator Hero Header -->
    <div class="dash-hero hc-hero">
        <div class="dash-hero-bg">
            <div class="dash-hero-orb hc-orb-1"></div>
            <div class="dash-hero-orb hc-orb-2"></div>
            <div class="dash-hero-grid"></div>
        </div>
        <div class="dash-hero-content">
            <div class="dash-hero-left">
                <div class="dash-hero-badge hc-badge">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                    Builder Studio
                </div>
                <h1 class="dash-hero-title">Advanced Hook Creator</h1>
                <p class="dash-hero-subtitle">Create, configure, and manage custom event hooks with templates</p>
            </div>
            <div class="dash-hero-right" style="display:flex;gap:10px;">
                <button class="dash-tour-btn" onclick="openSectionHelp('hook-creator')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    Help
                </button>
                <button class="dash-action-btn" onclick="refreshHookCreator()" style="padding:10px 18px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                    Refresh
                </button>
                <button class="dash-action-btn hc-export-btn" onclick="exportHooksJSON()" id="export-hooks-btn" style="padding:10px 18px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Export
                </button>
            </div>
        </div>
    </div>

    <!-- Hook Creator Stats Grid -->
    <div class="hc-stats-grid">
        <div class="hc-stat-card hc-stat-total">
            <div class="hc-stat-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
            </div>
            <div class="hc-stat-value" id="hc-total">0</div>
            <div class="hc-stat-label">Total Hooks</div>
        </div>
        <div class="hc-stat-card hc-stat-active">
            <div class="hc-stat-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
            <div class="hc-stat-value" id="hc-enabled">0</div>
            <div class="hc-stat-label">Active</div>
        </div>
        <div class="hc-stat-card hc-stat-disabled">
            <div class="hc-stat-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
            </div>
            <div class="hc-stat-value" id="hc-disabled">0</div>
            <div class="hc-stat-label">Disabled</div>
        </div>
        <div class="hc-stat-card hc-stat-templates">
            <div class="hc-stat-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
            </div>
            <div class="hc-stat-value" id="hc-templates">0</div>
            <div class="hc-stat-label">Templates</div>
        </div>
        <div class="hc-stat-card hc-stat-executions">
            <div class="hc-stat-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            </div>
            <div class="hc-stat-value" id="hc-executions">0</div>
            <div class="hc-stat-label">Executions</div>
        </div>
        <div class="hc-stat-card hc-stat-success">
            <div class="hc-stat-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            </div>
            <div class="hc-stat-value" id="hc-success-rate">100%</div>
            <div class="hc-stat-label">Success Rate</div>
        </div>
    </div>

    <!-- Hook Creator Main Layout -->
    <div class="hc-main-layout">
        <!-- Template Library Sidebar -->
        <div class="hc-sidebar">
            <div class="hc-sidebar-header">
                <div class="hc-sidebar-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                </div>
                <div class="hc-sidebar-title">Template Library</div>
            </div>
            <div class="hc-sidebar-content">
                <div class="hc-search-wrap">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    <input type="text" id="template-search" class="hc-search-input" placeholder="Search templates..." oninput="filterTemplates()"/>
                </div>
                <select id="category-filter" class="hc-category-select" onchange="filterTemplates()">
                    <option value="">All Categories</option>
                </select>
                <div id="hc-templates-list" class="hc-templates-list"></div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="hc-content">
            <!-- Create New Hook Card -->
            <div class="hc-create-card">
                <div class="hc-card-header">
                    <div class="hc-card-icon hc-card-icon-create">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                    </div>
                    <div class="hc-card-title">Create New Hook</div>
                </div>
                <div class="hc-card-body">
                    <div class="hc-form-group">
                        <label class="hc-label">Select Template <span class="hc-required">*</span></label>
                        <select id="hc-template-select" class="hc-select" onchange="loadTemplateParams()">
                            <option value="">Choose a template...</option>
                        </select>
                    </div>
                    
                    <div id="hc-template-info" class="hc-template-info" style="display: none;">
                        <div class="hc-template-info-header">
                            <span id="hc-template-icon" class="hc-template-info-icon"></span>
                            <div class="hc-template-info-text">
                                <div class="hc-template-info-name" id="hc-template-name"></div>
                                <div class="hc-template-info-desc" id="hc-template-description"></div>
                            </div>
                        </div>
                        <div class="hc-template-info-event" id="hc-template-event"></div>
                    </div>

                    <div id="hc-params-container"></div>

                    <div class="hc-form-actions">
                        <button class="hc-btn hc-btn-primary" onclick="createCustomHook(this)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                            Create Hook
                        </button>
                        <button class="hc-btn hc-btn-secondary" onclick="clearHookForm()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                            Clear
                        </button>
                    </div>
                </div>
            </div>

            <!-- Created Hooks Card -->
            <div class="hc-hooks-card">
                <div class="hc-card-header">
                    <div class="hc-card-icon hc-card-icon-list">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                    </div>
                    <div class="hc-card-title">Created Hooks</div>
                    <div class="hc-card-filters">
                        <select id="hc-filter-guild" class="hc-filter-select" onchange="filterCreatedHooks()">
                            <option value="">All Guilds</option>
                        </select>
                        <select id="hc-filter-template" class="hc-filter-select" onchange="filterCreatedHooks()">
                            <option value="">All Templates</option>
                        </select>
                        <select id="hc-filter-status" class="hc-filter-select" onchange="filterCreatedHooks()">
                            <option value="">All Status</option>
                            <option value="enabled">Active Only</option>
                            <option value="disabled">Disabled Only</option>
                        </select>
                    </div>
                </div>
                <div class="hc-card-body">
                    <div id="hc-created-hooks-list" class="hc-created-list"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.hook-template-card {
    background: rgba(15, 23, 42, 0.4);
    border: 1px solid rgba(148, 163, 184, 0.15);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
}

.hook-template-card:hover {
    background: rgba(15, 23, 42, 0.6);
    border-color: rgba(168, 85, 247, 0.4);
    transform: translateX(4px);
}

.hook-template-card.selected {
    background: linear-gradient(135deg, rgba(124, 58, 237, 0.2), rgba(168, 85, 247, 0.2));
    border-color: rgba(168, 85, 247, 0.6);
}

.hook-template-icon {
    font-size: 20px;
    margin-right: 10px;
}

.hook-template-badge {
    display: inline-block;
    font-size: 9px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.hook-template-badge.advanced {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.hook-template-badge.basic {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.param-input-wrapper {
    margin-bottom: 16px;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.param-label {
    display: block;
    margin-bottom: 8px;
    font-size: 13px;
    font-weight: 600;
    color: #94a3b8;
}

.param-label .required {
    color: #ef4444;
    margin-left: 4px;
}

.param-description {
    font-size: 11px;
    color: #64748b;
    margin-top: 4px;
    line-height: 1.4;
}

.json-editor {
    font-family: 'Courier New', monospace;
    font-size: 12px;
    background: #0f172a;
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 6px;
    padding: 12px;
    color: #e5e7eb;
    min-height: 100px;
    resize: vertical;
}

.json-editor:focus {
    outline: none;
    border-color: rgba(168, 85, 247, 0.5);
    box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
}

.json-validate-btn {
    font-size: 11px;
    padding: 4px 10px;
    background: rgba(168, 85, 247, 0.2);
    border: 1px solid rgba(168, 85, 247, 0.3);
    border-radius: 4px;
    color: #a855f7;
    cursor: pointer;
    margin-top: 6px;
    transition: all 0.2s;
}

.json-validate-btn:hover {
    background: rgba(168, 85, 247, 0.3);
}

.color-picker-wrapper {
    display: flex;
    gap: 8px;
    align-items: center;
}

.color-preview {
    width: 40px;
    height: 40px;
    border-radius: 6px;
    border: 2px solid rgba(148, 163, 184, 0.2);
    cursor: pointer;
}

.hook-card {
    background: rgba(15, 23, 42, 0.5);
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.2s;
}

.hook-card:hover {
    border-color: rgba(168, 85, 247, 0.4);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.hook-card.disabled {
    opacity: 0.6;
    background: rgba(15, 23, 42, 0.3);
}

.hook-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 4px;
    text-transform: uppercase;
}

.hook-status-badge.active {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.hook-status-badge.disabled {
    background: rgba(100, 116, 139, 0.2);
    color: #64748b;
    border: 1px solid rgba(100, 116, 139, 0.3);
}

.hook-actions {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.hook-btn {
    font-size: 11px;
    padding: 6px 12px;
    border-radius: 4px;
    border: 1px solid;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 600;
}

.hook-btn.toggle {
    background: rgba(168, 85, 247, 0.2);
    border-color: rgba(168, 85, 247, 0.3);
    color: #a855f7;
}

.hook-btn.toggle:hover {
    background: rgba(168, 85, 247, 0.3);
}

.hook-btn.delete {
    background: rgba(239, 68, 68, 0.2);
    border-color: rgba(239, 68, 68, 0.3);
    color: #ef4444;
}

.hook-btn.delete:hover {
    background: rgba(239, 68, 68, 0.3);
}

.hook-btn.analytics {
    background: rgba(59, 130, 246, 0.2);
    border-color: rgba(59, 130, 246, 0.3);
    color: #3b82f6;
}

.hook-btn.analytics:hover {
    background: rgba(59, 130, 246, 0.3);
}
</style>

<script>
function refreshHookCreator() {
    fetch('monitor_data_hook_creator.json?t=' + Date.now())
        .then(response => response.json())
        .then(data => {
            if (data) {
                updateHookCreator(data);
            }
        })
        .catch(error => console.error('Failed to refresh hook creator:', error));
}

function filterTemplates() {
    const searchTerm = document.getElementById('template-search').value.toLowerCase();
    const category = document.getElementById('category-filter').value;
    
    let filtered = hookCreatorData.templates || [];
    
    if (searchTerm) {
        filtered = filtered.filter(t => 
            t.name.toLowerCase().includes(searchTerm) || 
            t.description.toLowerCase().includes(searchTerm)
        );
    }
    
    if (category) {
        filtered = filtered.filter(t => t.category === category);
    }
    
    renderTemplatesList(filtered);
}

function getHookIconSVG(iconName) {
    const icons = {
        'wave': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>',
        'zap': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
        'shield': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
        'chart': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
        'clock': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
        'ticket': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></svg>',
        'volume': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>',
        'link': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>',
        'microphone': '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/></svg>',
    };
    return icons[iconName] || icons['link'];
}

function renderTemplatesList(templates) {
    const container = document.getElementById('hc-templates-list');
    if (!container) return;
    
    const grouped = {};
    templates.forEach(t => {
        if (!grouped[t.category]) grouped[t.category] = [];
        grouped[t.category].push(t);
    });
    
    let html = '';
    Object.keys(grouped).sort().forEach(category => {
        html += `<div style="margin-bottom: 20px;">`;
        html += `<div style="font-size: 11px; font-weight: 700; color: #a855f7; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">${category}</div>`;
        
        grouped[category].forEach(template => {
            const isSelected = document.getElementById('hc-template-select')?.value === template.id;
            html += `
                <div class="hook-template-card ${isSelected ? 'selected' : ''}" onclick="selectTemplate('${template.id}')">
                    <div style="display: flex; align-items: start; gap: 12px;">
                        <span class="hook-template-icon">${getHookIconSVG(template.icon)}</span>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 13px; font-weight: 600; color: #e5e7eb; margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
                                ${template.name}
                                <span class="hook-template-badge ${template.advanced ? 'advanced' : 'basic'}">
                                    ${template.advanced ? 'Advanced' : 'Basic'}
                                </span>
                            </div>
                            <div style="font-size: 11px; color: #94a3b8; line-height: 1.4;">
                                ${template.description}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `</div>`;
    });
    
    container.innerHTML = html || '<div style="text-align: center; padding: 20px; color: #64748b;">No templates found</div>';
}

function selectTemplate(templateId) {
    document.getElementById('hc-template-select').value = templateId;
    loadTemplateParams();
    renderTemplatesList(hookCreatorData.templates || []);
}

function loadTemplateParams() {
    const templateId = document.getElementById('hc-template-select').value;
    if (!templateId) {
        document.getElementById('hc-template-info').style.display = 'none';
        document.getElementById('hc-params-container').innerHTML = '';
        renderTemplatesList(hookCreatorData.templates || []);
        return;
    }

    const template = hookCreatorData.templates?.find(t => t.id === templateId);
    if (!template) return;

    document.getElementById('hc-template-info').style.display = 'block';
    document.getElementById('hc-template-icon').textContent = template.icon || '';
    document.getElementById('hc-template-name').textContent = template.name;
    document.getElementById('hc-template-description').textContent = template.description;
    document.getElementById('hc-template-event').textContent = `Event: ${template.event} | Category: ${template.category}`;

    let paramsHtml = '';
    template.params.forEach((param, index) => {
        let inputHtml = '';
        const defaultValue = param.default || '';
        
        if (param.type === 'text') {
            inputHtml = `<input type="text" id="param-${param.name}" class="input-text" value="${defaultValue}" placeholder="${param.description || ''}" style="width: 100%;">`;
        } 
        else if (param.type === 'textarea') {
            inputHtml = `<textarea id="param-${param.name}" class="input-text" placeholder="${param.description || ''}" style="width: 100%; min-height: 80px; resize: vertical;">${defaultValue}</textarea>`;
        }
        else if (param.type === 'number') {
            inputHtml = `<input type="number" id="param-${param.name}" class="input-text" value="${defaultValue}" placeholder="${param.description || ''}" style="width: 100%;">`;
        }
        else if (param.type === 'boolean') {
            const checked = defaultValue === true || defaultValue === 'true' ? 'checked' : '';
            inputHtml = `
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
                    <input type="checkbox" id="param-${param.name}" ${checked} style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-size: 12px; color: #cbd5e1;">Enable this option</span>
                </label>
            `;
        }
        else if (param.type === 'select') {
            inputHtml = `<select id="param-${param.name}" class="hc-select">`;
            (param.options || []).forEach(opt => {
                const selected = opt === defaultValue ? 'selected' : '';
                inputHtml += `<option value="${opt}" ${selected}>${opt}</option>`;
            });
            inputHtml += `</select>`;
        }
        else if (param.type === 'channel') {
            inputHtml = `<input type="text" id="param-${param.name}" class="input-text" placeholder="Enter channel ID" style="width: 100%;">`;
        }
        else if (param.type === 'role') {
            inputHtml = `<input type="text" id="param-${param.name}" class="input-text" placeholder="Enter role ID" style="width: 100%;">`;
        }
        else if (param.type === 'color') {
            const colorVal = defaultValue || '7C3AED';
            inputHtml = `
                <div class="color-picker-wrapper">
                    <div class="color-preview" id="color-preview-${param.name}" style="background-color: #${colorVal};" onclick="document.getElementById('param-${param.name}').focus();"></div>
                    <input type="text" id="param-${param.name}" class="input-text" value="${colorVal}" placeholder="Hex color (e.g., 7C3AED)" style="flex: 1;" oninput="updateColorPreview('${param.name}', this.value)">
                </div>
            `;
        }
        else if (param.type === 'json') {
            inputHtml = `
                <textarea id="param-${param.name}" class="json-editor" placeholder='${param.description || "Enter JSON..."}'>${defaultValue}</textarea>
                <button class="json-validate-btn" onclick="validateJSON('param-${param.name}')">âœ“ Validate JSON</button>
            `;
        }

        paramsHtml += `
            <div class="param-input-wrapper">
                <label class="param-label">
                    ${param.name}${param.required ? '<span class="required">*</span>' : ''}
                </label>
                ${inputHtml}
                ${param.description ? `<div class="param-description">${param.description}</div>` : ''}
            </div>
        `;
    });

    paramsHtml += `
        <div class="param-input-wrapper">
            <label class="param-label">
                Guild / Server<span class="required">*</span>
            </label>
            <select id="param-guild-id" class="hc-select">
                <option value="">Select a guild...</option>
            </select>
        </div>
    `;

    document.getElementById('hc-params-container').innerHTML = paramsHtml;

    const guildSelect = document.getElementById('param-guild-id');
    if (guildSelect && currentGuilds) {
        currentGuilds.forEach(guild => {
            const option = document.createElement('option');
            option.value = guild.id;
            option.textContent = guild.name;
            guildSelect.appendChild(option);
        });
    }
    
    renderTemplatesList(hookCreatorData.templates || []);
}

function updateColorPreview(paramName, value) {
    const preview = document.getElementById(`color-preview-${paramName}`);
    if (preview) {
        const cleanHex = value.replace('#', '');
        preview.style.backgroundColor = `#${cleanHex}`;
    }
}

function validateJSON(inputId) {
    const input = document.getElementById(inputId);
    if (!input) return;
    
    try {
        JSON.parse(input.value);
        showNotification('âœ“ Valid JSON', 'success');
        input.style.borderColor = 'rgba(16, 185, 129, 0.5)';
        setTimeout(() => {
            input.style.borderColor = '';
        }, 2000);
    } catch (e) {
        showNotification('âœ— Invalid JSON: ' + e.message, 'error');
        input.style.borderColor = 'rgba(239, 68, 68, 0.5)';
    }
}

function createCustomHook(btn) {
    const templateId = document.getElementById('hc-template-select').value;
    if (!templateId) {
        showNotification('Please select a template', 'error');
        return;
    }

    const template = hookCreatorData.templates?.find(t => t.id === templateId);
    if (!template) return;

    const guildId = document.getElementById('param-guild-id')?.value;
    if (!guildId) {
        showNotification('Please select a guild', 'error');
        return;
    }

    const params = {};
    let hasError = false;

    template.params.forEach(param => {
        const input = document.getElementById(`param-${param.name}`);
        if (input) {
            let value;
            
            if (param.type === 'boolean') {
                value = input.checked;
            } else if (param.type === 'number') {
                value = parseFloat(input.value);
                if (isNaN(value)) value = param.default || 0;
            } else if (param.type === 'json') {
                try {
                    value = input.value.trim() ? JSON.parse(input.value) : (param.default ? JSON.parse(param.default) : {});
                } catch (e) {
                    showNotification(`Invalid JSON in ${param.name}: ${e.message}`, 'error');
                    hasError = true;
                    return;
                }
            } else {
                value = input.value.trim();
            }
            
            if (param.required && !value && value !== false && value !== 0) {
                showNotification(`${param.name} is required`, 'error');
                hasError = true;
                return;
            }
            
            if (value || value === false || value === 0) {
                params[param.name] = value;
            }
        }
    });

    if (hasError) return;

    // Handle button waiting state
    const originalHTML = btn ? btn.innerHTML : '';
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="btn-spinner"></span> Creating...';
        btn.classList.add('btn-waiting');
    }

    sendCommand('create_custom_hook', {
        template_id: templateId,
        params: params,
        guild_id: guildId,
        created_by: 'Dashboard User'
    });

    showNotification(' Creating custom hook...', 'success');
    setTimeout(() => {
        clearHookForm();
        refreshHookCreator();
        // Restore button
        if (btn && btn.parentNode) {
            btn.disabled = false;
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-waiting');
        }
    }, 1000);
}

function clearHookForm() {
    document.getElementById('hc-template-select').value = '';
    document.getElementById('hc-template-info').style.display = 'none';
    document.getElementById('hc-params-container').innerHTML = '';
    renderTemplatesList(hookCreatorData.templates || []);
}

function toggleCustomHook(btn, hookId) {
    // Store original button state
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="btn-spinner"></span> Waiting...';
    btn.classList.add('btn-waiting');
    
    sendCommand('toggle_custom_hook', { hook_id: hookId });

    showNotification('Toggling hook...', 'info');
    setTimeout(() => {
        refreshHookCreator();
        // Button will be re-rendered anyway
    }, 500);
}

function deleteCustomHook(btn, hookId) {
    if (!confirm('Are you sure you want to delete this hook?')) return;
    
    // Store original button state
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="btn-spinner"></span> Deleting...';
    btn.classList.add('btn-waiting');
    
    sendCommand('delete_custom_hook', { hook_id: hookId });

    showNotification(' Deleting hook...', 'info');
    setTimeout(refreshHookCreator, 500);
}

function filterCreatedHooks() {
    renderCreatedHooks(hookCreatorData.created_hooks || []);
}

function renderCreatedHooks(hooks) {
    const container = document.getElementById('hc-created-hooks-list');
    if (!container) return;

    const guildFilter = document.getElementById('hc-filter-guild')?.value;
    const templateFilter = document.getElementById('hc-filter-template')?.value;
    const statusFilter = document.getElementById('hc-filter-status')?.value;

    let filtered = hooks;
    if (guildFilter) filtered = filtered.filter(h => String(h.guild_id) === String(guildFilter));
    if (templateFilter) filtered = filtered.filter(h => h.template_id === templateFilter);
    if (statusFilter === 'enabled') filtered = filtered.filter(h => h.enabled);
    if (statusFilter === 'disabled') filtered = filtered.filter(h => !h.enabled);

    if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">No hooks found matching your filters</div>';
        return;
    }

    let html = '<div style="display: grid; gap: 12px;">';
    filtered.forEach(hook => {
        const guild = currentGuilds.find(g => g.id === hook.guild_id);
        const guildName = guild ? guild.name : `Guild ${hook.guild_id}`;
        const template = hookCreatorData.templates?.find(t => t.id === hook.template_id);
        const icon = template?.icon || 'link';
        const successRate = hook.execution_count > 0 ? 
            ((hook.execution_count - (hook.error_count || 0)) / hook.execution_count * 100).toFixed(1) : 100;

        html += `
            <div class="hook-card ${hook.enabled ? '' : 'disabled'}">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                            <span style="display: flex; align-items: center; color: #a855f7;">${getHookIconSVG(icon)}</span>
                            <div style="font-size: 14px; font-weight: 600; color: #e5e7eb;">
                                ${hook.template_name}
                            </div>
                            <span class="hook-status-badge ${hook.enabled ? 'active' : 'disabled'}">
                                ${hook.enabled ? 'â— Active' : 'â—‹ Disabled'}
                            </span>
                        </div>
                        <div style="font-size: 11px; color: #94a3b8; margin-bottom: 8px;">
                            ${hook.event} | ${guildName}
                        </div>
                        <div style="display: flex; gap: 16px; font-size: 11px; color: #64748b;">
                            <span>Executions: <strong style="color: #a855f7;">${hook.execution_count || 0}</strong></span>
                            <span>Errors: <strong style="color: ${hook.error_count > 0 ? '#ef4444' : '#10b981'};">${hook.error_count || 0}</strong></span>
                            <span>Success: <strong style="color: #10b981;">${successRate}%</strong></span>
                        </div>
                    </div>
                    <div class="hook-actions">
                        <button onclick="toggleCustomHook(this, this.getAttribute('data-hook-id'))" data-hook-id="${hook.hook_id}" class="hook-btn toggle">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                            ${hook.enabled ? 'Disable' : 'Enable'}
                        </button>
                        <button onclick="viewHookAnalytics(this.getAttribute('data-hook-id'))" data-hook-id="${hook.hook_id}" class="hook-btn analytics">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                            Analytics
                        </button>
                        <button onclick="deleteCustomHook(this, this.getAttribute('data-hook-id'))" data-hook-id="${hook.hook_id}" class="hook-btn delete">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            Delete
                        </button>
                    </div>
                </div>
                <div style="font-size: 10px; color: #64748b; padding-top: 8px; border-top: 1px solid rgba(148, 163, 184, 0.1);">
                    Created: ${new Date(hook.created_at).toLocaleString()} | ID: ${hook.hook_id}
                </div>
            </div>
        `;
    });
    html += '</div>';

    container.innerHTML = html;
}

function viewHookAnalytics(hookId) {
    const hook = hookCreatorData.created_hooks?.find(h => h.hook_id === hookId);
    if (!hook) return;
    
    const successRate = hook.execution_count > 0 ? 
        ((hook.execution_count - (hook.error_count || 0)) / hook.execution_count * 100).toFixed(2) : 100;
    
    showNotification(`
        Analytics for ${hook.template_name}
        
        Total Executions: ${hook.execution_count || 0}
        Successful: ${(hook.execution_count || 0) - (hook.error_count || 0)}
        Failed: ${hook.error_count || 0}
        Success Rate: ${successRate}%
        
        Status: ${hook.enabled ? 'Active' : 'Disabled'}
        Created: ${new Date(hook.created_at).toLocaleString()}
    `, 'info');
}

function exportHooksJSON() {
    const dataStr = JSON.stringify(hookCreatorData.created_hooks, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `hooks-export-${Date.now()}.json`;
    link.click();
    URL.revokeObjectURL(url);
    showNotification(' Hooks exported successfully', 'success');
}

function updateHookCreator(data) {
    if (!data) return;

    hookCreatorData = data;

    if (data.stats) {
        document.getElementById('hc-total').textContent = data.stats.total || 0;
        document.getElementById('hc-enabled').textContent = data.stats.enabled || 0;
        document.getElementById('hc-disabled').textContent = data.stats.disabled || 0;
        document.getElementById('hc-executions').textContent = data.stats.total_executions || 0;
        document.getElementById('hc-success-rate').textContent = (data.stats.success_rate || 100) + '%';
    }

    if (data.templates) {
        document.getElementById('hc-templates').textContent = data.templates.length;

        const templateSelect = document.getElementById('hc-template-select');
        if (templateSelect) {
            const currentValue = templateSelect.value;
            templateSelect.innerHTML = '<option value="">Choose a template...</option>';
            data.templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = `${template.icon || ''} ${template.name}`;
                templateSelect.appendChild(option);
            });
            templateSelect.value = currentValue;
        }

        const categories = [...new Set(data.templates.map(t => t.category))].sort();
        const categoryFilter = document.getElementById('category-filter');
        if (categoryFilter) {
            const currentCat = categoryFilter.value;
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
            categoryFilter.value = currentCat;
        }

        renderTemplatesList(data.templates);
    }

    if (data.created_hooks) {
        renderCreatedHooks(data.created_hooks);

        const guildFilterSelect = document.getElementById('hc-filter-guild');
        const templateFilterSelect = document.getElementById('hc-filter-template');

        if (guildFilterSelect) {
            const guilds = [...new Set(data.created_hooks.map(h => h.guild_id))];
            const currentGuild = guildFilterSelect.value;
            guildFilterSelect.innerHTML = '<option value="">All Guilds</option>';
            guilds.forEach(guildId => {
                const guild = currentGuilds.find(g => g.id === guildId);
                if (guild) {
                    const option = document.createElement('option');
                    option.value = guildId;
                    option.textContent = guild.name;
                    guildFilterSelect.appendChild(option);
                }
            });
            guildFilterSelect.value = currentGuild;
        }

        if (templateFilterSelect && data.templates) {
            const templates = [...new Set(data.created_hooks.map(h => h.template_id))];
            const currentTemplate = templateFilterSelect.value;
            templateFilterSelect.innerHTML = '<option value="">All Templates</option>';
            templates.forEach(templateId => {
                const template = data.templates.find(t => t.id === templateId);
                if (template) {
                    const option = document.createElement('option');
                    option.value = templateId;
                    option.textContent = template.name;
                    templateFilterSelect.appendChild(option);
                }
            });
            templateFilterSelect.value = currentTemplate;
        }
    }
}

if (typeof window !== 'undefined') {
    window.addEventListener('DOMContentLoaded', () => {
        setTimeout(refreshHookCreator, 1000);
    });
}
</script>

                <div id="tab-filesystem" class="tab-content">
                    <!-- File System Hero Header -->
                    <div class="dash-hero fs-hero">
                        <div class="dash-hero-bg">
                            <div class="dash-hero-orb fs-orb-1"></div>
                            <div class="dash-hero-orb fs-orb-2"></div>
                            <div class="dash-hero-grid"></div>
                        </div>
                        <div class="dash-hero-content">
                            <div class="dash-hero-left">
                                <div class="dash-hero-badge fs-badge">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                                    Storage Analytics
                                </div>
                                <h1 class="dash-hero-title">File System Overview</h1>
                                <p class="dash-hero-subtitle">Monitor directory sizes, file counts, and cache performance</p>
                            </div>
                            <div class="dash-hero-right" style="display:flex;gap:10px;">
                                <button class="dash-tour-btn" onclick="openSectionHelp('filesystem')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                    Help
                                </button>
                                <button class="dash-action-btn" onclick="refreshFileSystem()" style="padding:10px 18px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                                    Refresh
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- File System Stats Grid -->
                    <div class="fs-stats-grid">
                        <div class="fs-stat-card fs-stat-files">
                            <div class="fs-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                            </div>
                            <div class="fs-stat-value" id="fs-total-files">0</div>
                            <div class="fs-stat-label">Total Files</div>
                        </div>
                        <div class="fs-stat-card fs-stat-size">
                            <div class="fs-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>
                            </div>
                            <div class="fs-stat-value" id="fs-total-size">0 MB</div>
                            <div class="fs-stat-label">Total Size</div>
                        </div>
                        <div class="fs-stat-card fs-stat-data">
                            <div class="fs-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                            </div>
                            <div class="fs-stat-value" id="fs-data-files">0</div>
                            <div class="fs-stat-label">Data Files</div>
                        </div>
                        <div class="fs-stat-card fs-stat-cogs">
                            <div class="fs-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                            </div>
                            <div class="fs-stat-value" id="fs-cogs-files">0</div>
                            <div class="fs-stat-label">Cogs Files</div>
                        </div>
                        <div class="fs-stat-card fs-stat-ext">
                            <div class="fs-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                            </div>
                            <div class="fs-stat-value" id="fs-ext-files">0</div>
                            <div class="fs-stat-label">Extensions</div>
                        </div>
                        <div class="fs-stat-card fs-stat-logs">
                            <div class="fs-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                            </div>
                            <div class="fs-stat-value" id="fs-logs-files">0</div>
                            <div class="fs-stat-label">Bot Logs</div>
                        </div>
                        <div class="fs-stat-card fs-stat-hits">
                            <div class="fs-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                            <div class="fs-stat-value" id="fs-cache-hits">0</div>
                            <div class="fs-stat-label">Cache Hits</div>
                        </div>
                        <div class="fs-stat-card fs-stat-misses">
                            <div class="fs-stat-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                            </div>
                            <div class="fs-stat-value" id="fs-cache-misses">0</div>
                            <div class="fs-stat-label">Cache Misses</div>
                        </div>
                    </div>

                    <!-- File System Explorer -->
                    <div class="fs-explorer">
                        <div class="fs-explorer-header">
                            <div class="fs-explorer-title">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                                Directory Statistics
                            </div>
                        </div>
                        <div class="fs-list" id="filesystem-content"></div>
                    </div>
                </div>

                <div id="tab-files" class="tab-content">
                    <!-- File Browser Hero Header -->
                    <div class="dash-hero fb-hero">
                        <div class="dash-hero-bg">
                            <div class="dash-hero-orb fb-orb-1"></div>
                            <div class="dash-hero-orb fb-orb-2"></div>
                            <div class="dash-hero-grid"></div>
                        </div>
                        <div class="dash-hero-content">
                            <div class="dash-hero-left">
                                <div class="dash-hero-badge fb-badge">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
                                    Code Editor
                                </div>
                                <h1 class="dash-hero-title">File Browser</h1>
                                <p class="dash-hero-subtitle">Browse, edit, and manage your bot's files directly from the dashboard</p>
                            </div>
                            <div class="dash-hero-right" style="display:flex;gap:10px;">
                                <button class="dash-tour-btn" onclick="openSectionHelp('files')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                    Help
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="file-browser-content">
                        <div class="explorer-unit fb-explorer">
                            <div class="file-pane" id="pane">
                                <div class="dir-header fb-dir-header">
                                    <div class="breadcrumb" id="breadcrumb"></div>
                                    <div class="file-toolbar">
                                        <button class="file-toolbar-toggle" id="file-toolbar-toggle" aria-label="File actions" aria-haspopup="true" aria-expanded="false">â‹®</button>
                                        <div class="file-toolbar-menu" id="file-toolbar-menu">
                                            <button class="v-btn" onclick="refreshFileBrowser()">Refresh</button>
                                            <button class="v-btn" onclick="createNewFile()">New File</button>
                                            <button class="v-btn" onclick="createNewFolder()">New Folder</button>
                                            <hr style="border:none;border-top:1px solid #30363d;margin:4px 0;" />
                                            <button class="v-btn active" onclick="setView('list', this)">List view</button>
                                            <button class="v-btn" onclick="setView('grid', this)">Grid view</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="scroll-area"><div class="file-grid list-mode" id="list"></div></div>
                            </div>
                            <div class="resizer" id="resize"></div>
                            <div class="editor-pane fb-editor-pane">
                                <div class="editor-header fb-editor-header">
                                    <span id="fileName" class="fb-filename">file.ts</span>
                                    <div class="action-group">
                                        <button class="btn fb-btn" onclick="jumpEditorScroll()">Jump to Bottom</button>
                                        <button class="btn fb-btn" onclick="closeEditor()">Close</button>
                                        <button class="btn fb-btn" onclick="promptRenameCurrentFile()">Rename</button>
                                        <button class="btn btn-save fb-btn-save" onclick="save()">Save</button>
                                    </div>
                                </div>
                                <textarea id="fileContent" class="fb-textarea"></textarea>
                            </div>
                        </div>
                    </div>
                    <div id="file-context-menu">
                        <div class="file-context-item" onclick="contextRename()">Rename</div>
                        <div class="file-context-item" onclick="contextMove()">Move</div>
                        <div class="file-context-item danger" onclick="contextDelete()">Delete</div>
                    </div>
                </div>

                <div id="tab-chat" class="tab-content">
                    <!-- Chat Console Hero Header -->
                    <div class="dash-hero chat-hero">
                        <div class="dash-hero-bg">
                            <div class="dash-hero-orb chat-orb-1"></div>
                            <div class="dash-hero-orb chat-orb-2"></div>
                            <div class="dash-hero-grid"></div>
                        </div>
                        <div class="dash-hero-content">
                            <div class="dash-hero-left">
                                <div class="dash-hero-badge chat-badge">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                    Bot Messenger
                                </div>
                                <h1 class="dash-hero-title">Chat Console</h1>
                                <p class="dash-hero-subtitle">Send messages as your bot to any server channel (Experimental Feature)</p>
                            </div>
                            <div class="dash-hero-right" style="display:flex;gap:10px;">
                                <span class="chat-experimental-badge">EXPERIMENTAL</span>
                                <button class="dash-tour-btn" onclick="openSectionHelp('chat')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                    Help
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="chat-columns" id="chat-console">
                        <!-- Servers Column -->
                        <div class="chat-column-card chat-servers-card">
                            <div class="chat-column-header">
                                <div class="chat-column-icon chat-column-icon-servers">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>
                                </div>
                                <div>
                                    <div class="chat-column-title">Servers</div>
                                    <div class="chat-column-subtitle">Select a server to see its text channels</div>
                                </div>
                            </div>
                            <div id="chat-guilds" class="chat-guilds-list"></div>
                        </div>
                        <!-- Channel & Conversation Column -->
                        <div class="chat-column-card chat-conversation-card">
                            <div class="chat-column-header">
                                <div class="chat-column-icon chat-column-icon-channel">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                </div>
                                <div>
                                    <div class="chat-column-title">Channel & Conversation</div>
                                    <div class="chat-column-subtitle" id="chat-channel-subtitle">No channel selected</div>
                                </div>
                            </div>
                            <div class="chat-channels-list" id="chat-channels"></div>
                            <div class="chat-message-area">
                                <div id="chat-message-log" class="chat-message-log"></div>
                                <div class="chat-input-row">
                                    <input id="chat-message-input" class="chat-input" type="text" placeholder="Type a message to send as the bot..." />
                                    <button class="chat-send-btn" onclick="sendChatMessage()">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                                        Send
                                    </button>
                                    <button class="chat-history-btn" onclick="requestChatHistory()">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                        History
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div id="tab-tickets" class="tab-content">
                    <!-- Tickets Hero Header -->
                    <div class="dash-hero tickets-hero">
                        <div class="dash-hero-bg">
                            <div class="dash-hero-orb tickets-orb-1"></div>
                            <div class="dash-hero-orb tickets-orb-2"></div>
                            <div class="dash-hero-grid"></div>
                        </div>
                        <div class="dash-hero-content">
                            <div class="dash-hero-left">
                                <div class="dash-hero-badge tickets-badge">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7C3 5.89543 3.89543 5 5 5H19C20.1046 5 21 5.89543 21 7V10C19.8954 10 19 10.8954 19 12C19 13.1046 19.8954 14 21 14V17C21 18.1046 20.1046 19 19 19H5C3.89543 19 3 18.1046 3 17V14C4.10457 14 5 13.1046 5 12C5 10.8954 4.10457 10 3 10V7Z"/></svg>
                                    Support System
                                </div>
                                <h1 class="dash-hero-title">Discord Tickets</h1>
                                <p class="dash-hero-subtitle">View, manage, and analyze support tickets across all your servers</p>
                            </div>
                            <div class="dash-hero-right" style="display:flex;gap:10px;">
                                <button class="dash-action-btn" onclick="loadTickets()" style="padding:10px 18px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                                    Refresh
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Extension Notice -->
                    <div class="tickets-notice">
                        <div class="tickets-notice-icon">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                        </div>
                        <div class="tickets-notice-content">
                            <div class="tickets-notice-title">Multi-Ticket System Required</div>
                            <div class="tickets-notice-text">
                                This dashboard integrates with <strong>Multi-Ticket System V4.0.0+</strong> from the ZygnalBot Marketplace.
                            </div>
                        </div>
                        <a href="https://zsync.eu/extension/view.php?id=116" target="_blank" class="tickets-notice-btn">
                            Install Extension
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                        </a>
                    </div>

                    <!-- Filters Card -->
                    <div class="tickets-filters-card">
                        <div class="tickets-filters-header">
                            <div class="tickets-filters-icon">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                            </div>
                            <div class="tickets-filters-title">Filters & Controls</div>
                        </div>
                        <div class="tickets-filters-body">
                            <div class="tickets-filters-grid">
                                <div class="tickets-filter-group">
                                    <label class="tickets-filter-label">Guild/Server</label>
                                    <select id="tickets-guild-filter" class="tickets-filter-select">
                                        <option value="">All Guilds</option>
                                    </select>
                                </div>
                                <div class="tickets-filter-group">
                                    <label class="tickets-filter-label">Category</label>
                                    <select id="tickets-category-filter" class="tickets-filter-select">
                                        <option value="">All Categories</option>
                                    </select>
                                </div>
                                <div class="tickets-filter-group">
                                    <label class="tickets-filter-label">Sort By</label>
                                    <select id="tickets-sort" class="tickets-filter-select">
                                        <option value="closed_desc">Closed (Newest)</option>
                                        <option value="closed_asc">Closed (Oldest)</option>
                                        <option value="created_desc">Created (Newest)</option>
                                        <option value="created_asc">Created (Oldest)</option>
                                        <option value="number_desc">Ticket # â†“</option>
                                        <option value="number_asc">Ticket # â†‘</option>
                                    </select>
                                </div>
                                <div class="tickets-filter-group">
                                    <label class="tickets-filter-label">Auto-Refresh</label>
                                    <select id="tickets-autorefresh" class="tickets-filter-select">
                                        <option value="0">Off</option>
                                        <option value="5000">5 seconds</option>
                                        <option value="10000">10 seconds</option>
                                        <option value="20000">20 seconds</option>
                                    </select>
                                </div>
                            </div>
                            <div class="tickets-search-row">
                                <div class="tickets-search-wrap">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                                    <input type="text" id="tickets-search" class="tickets-search-input" placeholder="Search by ticket #, creator, or subject..."/>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tickets Table Card -->
                    <div class="tickets-table-card">
                        <div class="tickets-table-header">
                            <div class="tickets-table-title">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                                Ticket Archive
                            </div>
                            <div id="tickets-count" class="tickets-count">Loading...</div>
                        </div>
                        <div class="tickets-table-body">
                            <div id="tickets-empty-state" class="tickets-empty" style="display:none;">
                                <div class="tickets-empty-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7C3 5.89543 3.89543 5 5 5H19C20.1046 5 21 5.89543 21 7V10C19.8954 10 19 10.8954 19 12C19 13.1046 19.8954 14 21 14V17C21 18.1046 20.1046 19 19 19H5C3.89543 19 3 18.1046 3 17V14C4.10457 14 5 13.1046 5 12C5 10.8954 4.10457 10 3 10V7Z"/><line x1="9" y1="9" x2="9" y2="15"/><line x1="12" y1="9" x2="12" y2="15"/><line x1="15" y1="9" x2="15" y2="15"/></svg></div>
                                <div class="tickets-empty-title">No tickets found</div>
                                <div class="tickets-empty-text">No tickets exist yet or match your filters</div>
                                <a href="https://zsync.eu/extension/view.php?id=116" target="_blank" class="tickets-empty-link">Get Multi-Ticket System â†’</a>
                            </div>
                            <div id="tickets-loading" class="tickets-loading">
                                <div class="tickets-loading-spinner"></div>
                                <div>Loading tickets...</div>
                            </div>
                            <div id="tickets-table-container" style="display:none;">
                                <table class="tickets-table">
                                    <thead>
                                        <tr>
                                            <th>Ticket #</th>
                                            <th>Category</th>
                                            <th>Creator</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Closed</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tickets-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                        <div id="tickets-pagination" class="tickets-pagination" style="display:none;">
                            <button class="tickets-page-btn" id="tickets-prev-btn" onclick="ticketsPreviousPage()" disabled>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
                                Previous
                            </button>
                            <div id="tickets-page-info" class="tickets-page-info">Page 1 of 1</div>
                            <button class="tickets-page-btn" id="tickets-next-btn" onclick="ticketsNextPage()" disabled>
                                Next
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="tab-guilds" class="tab-content">
                    <!-- Guilds Hero Header -->
                    <div class="dash-hero guilds-hero">
                        <div class="dash-hero-bg">
                            <div class="dash-hero-orb guilds-orb-1"></div>
                            <div class="dash-hero-orb guilds-orb-2"></div>
                            <div class="dash-hero-grid"></div>
                        </div>
                        <div class="dash-hero-content">
                            <div class="dash-hero-left">
                                <div class="dash-hero-badge guilds-badge">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>
                                    Server Network
                                </div>
                                <h1 class="dash-hero-title">Guilds / Servers</h1>
                                <p class="dash-hero-subtitle">Overview of all Discord servers where your bot is currently active</p>
                            </div>
                            <div class="dash-hero-right" style="display:flex;gap:10px;">
                                <button class="dash-tour-btn" onclick="openSectionHelp('guilds')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                    Help
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Guilds Explorer Card -->
                    <div class="guilds-card">
                        <div class="guilds-card-header">
                            <div class="guilds-card-title">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                Current Servers
                            </div>
                            <div class="guilds-card-subtitle">All guilds the bot is currently connected to</div>
                        </div>
                        <div class="guilds-card-body">
                            <div id="guilds-list" class="guilds-grid">
                                <div class="guilds-loading">
                                    <div class="guilds-loading-spinner"></div>
                                    <span>Loading servers...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-events" class="tab-content">
                    <!-- Events Hero Header -->
                    <div class="dash-hero events-hero">
                        <div class="dash-hero-bg">
                            <div class="dash-hero-orb events-orb-1"></div>
                            <div class="dash-hero-orb events-orb-2"></div>
                            <div class="dash-hero-grid"></div>
                        </div>
                        <div class="dash-hero-content">
                            <div class="dash-hero-left">
                                <div class="dash-hero-badge events-badge">
                                    <span class="events-live-dot"></span>
                                    Live Feed
                                </div>
                                <h1 class="dash-hero-title">Recent Events</h1>
                                <p class="dash-hero-subtitle">Real-time stream of Discord events captured by your bot</p>
                            </div>
                            <div class="dash-hero-right" style="display:flex;gap:10px;align-items:center;">
                                <div id="events-count" class="events-counter">0 Events</div>
                                <button class="dash-tour-btn" onclick="openSectionHelp('events')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                    Help
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Events Timeline Card -->
                    <div class="events-card">
                        <div class="events-card-header">
                            <div class="events-card-title">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                                Event Timeline
                            </div>
                            <div class="events-card-subtitle">Most recent events appear first</div>
                        </div>
                        <div id="events-list" class="events-timeline"></div>
                    </div>
                </div>

                <div id="tab-system" class="tab-content">
                    <!-- System Hero Header -->
                    <div class="dash-hero sys-hero">
                        <div class="dash-hero-bg">
                            <div class="dash-hero-orb sys-orb-1"></div>
                            <div class="dash-hero-orb sys-orb-2"></div>
                            <div class="dash-hero-grid"></div>
                        </div>
                        <div class="dash-hero-content">
                            <div class="dash-hero-left">
                                <div class="dash-hero-badge sys-badge">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="14" x2="23" y2="14"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="14" x2="4" y2="14"/></svg>
                                    Runtime Environment
                                </div>
                                <h1 class="dash-hero-title">System Details</h1>
                                <p class="dash-hero-subtitle">Comprehensive view of bot configuration, resources, health metrics, and framework settings</p>
                            </div>
                            <div class="dash-hero-right" style="display:flex;gap:10px;">
                                <button class="dash-tour-btn" onclick="openSectionHelp('system')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                    Help
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Content Container - Modern Dashboard Layout -->
                    <div id="system-details" class="sys-dashboard"></div>
                </div>

                <div id="tab-invite" class="tab-content">
                    <!-- Invite Hero Header -->
                    <div class="dash-hero invite-hero">
                        <div class="dash-hero-bg">
                            <div class="dash-hero-orb invite-orb-1"></div>
                            <div class="dash-hero-orb invite-orb-2"></div>
                            <div class="dash-hero-grid"></div>
                        </div>
                        <div class="dash-hero-content">
                            <div class="dash-hero-left">
                                <div class="dash-hero-badge invite-badge">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                    OAuth2 Generator
                                </div>
                                <h1 class="dash-hero-title">Bot Invite Helper</h1>
                                <p class="dash-hero-subtitle">Generate secure OAuth2 invite links with custom permissions</p>
                            </div>
                            <div class="dash-hero-right" style="display:flex;gap:10px;">
                                <a href="https://discord.com/developers/applications" target="_blank" rel="noreferrer noopener" class="dash-action-btn invite-portal-btn">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                                    Developer Portal
                                </a>
                                <button class="dash-tour-btn" onclick="openSectionHelp('invite')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                    Help
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Invite Builder Card -->
                    <div class="invite-builder-card">
                        <div class="invite-builder-header">
                            <div class="invite-builder-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                            </div>
                            <div>
                                <div class="invite-builder-title">Generate Invite Link</div>
                                <div class="invite-builder-subtitle">Build a correct OAuth2 invite URL for your bot</div>
                            </div>
                        </div>
                        <div class="invite-builder-body">
                            <!-- Application ID -->
                            <div class="invite-form-group invite-form-full">
                                <label class="invite-label">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                    Application / Client ID
                                </label>
                                <input id="invite-app-id" class="invite-input" type="text" placeholder="Enter your bot application's client ID (numeric)"/>
                            </div>
                            
                            <div class="invite-form-row">
                                <!-- OAuth2 Scopes -->
                                <div class="invite-form-group">
                                    <label class="invite-label">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                        OAuth2 Scopes
                                    </label>
                                    <div class="invite-scopes-box">
                                        <label class="invite-scope-option">
                                            <input id="invite-scope-bot" type="checkbox" checked class="invite-checkbox"/>
                                            <span class="invite-scope-name">bot</span>
                                            <span class="invite-scope-desc">Required for bot functionality</span>
                                        </label>
                                        <label class="invite-scope-option">
                                            <input id="invite-scope-commands" type="checkbox" checked class="invite-checkbox"/>
                                            <span class="invite-scope-name">applications.commands</span>
                                            <span class="invite-scope-desc">Required for slash commands</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Permissions -->
                                <div class="invite-form-group">
                                    <label class="invite-label">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                                        Permissions Bitmask
                                    </label>
                                    <input id="invite-permissions" class="invite-input" type="text" placeholder="e.g. 0 (no perms), 8 (admin)"/>
                                    <div class="invite-hint">Leave empty for user-selectable permissions</div>
                                </div>
                            </div>

                            <!-- Generated URL Section -->
                            <div class="invite-output-section">
                                <div class="invite-output-label">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                    Generated Invite URL
                                </div>
                                <input id="invite-output-url" class="invite-output-input" type="text" readonly placeholder="Click 'Generate' to build your invite URL"/>
                                <div class="invite-actions">
                                    <button class="invite-generate-btn" onclick="generateInviteLink()">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                                        Generate Link
                                    </button>
                                    <button class="invite-secondary-btn" onclick="openInviteLink()">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                                        Open
                                    </button>
                                    <button class="invite-secondary-btn" onclick="copyInviteLink()">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                                        Copy
                                    </button>
                                </div>
                            </div>

                            <!-- Tip -->
                            <div class="invite-tip">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z"/></svg>
                                <span>Tip: You can reuse the same Application ID for multiple servers. Share the link only with trusted users.</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-marketplace" class="tab-content">
                    <!-- Marketplace Hero Header -->
                    <div class="dash-hero market-hero">
                        <div class="dash-hero-bg">
                            <div class="dash-hero-orb market-orb-1"></div>
                            <div class="dash-hero-orb market-orb-2"></div>
                            <div class="dash-hero-grid"></div>
                        </div>
                        <div class="dash-hero-content">
                            <div class="dash-hero-left">
                                <div class="dash-hero-badge market-badge">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                                    Extension Store
                                </div>
                                <div style="display:flex;align-items:center;gap:12px;">
                                    <h1 class="dash-hero-title">Marketplace</h1>
                                    <span class="market-beta-tag">BETA</span>
                                </div>
                                <p class="dash-hero-subtitle">Browse and install extensions from the ZygnalBot ecosystem</p>
                            </div>
                            <div class="dash-hero-right" style="display:flex;gap:10px;">
                                <button class="dash-action-btn" onclick="fetchMarketplaceExtensions()">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                                    Refresh
                                </button>
                                <button class="dash-tour-btn" onclick="openSectionHelp('marketplace')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                    Help
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- License Notice -->
                    <div class="market-license-notice">
                        <div class="market-license-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                        </div>
                        <div class="market-license-content">
                            <div class="market-license-title">License Notice</div>
                            <div class="market-license-text">Downloaded extensions may ONLY be used within ZygnalBot ecosystem. Do NOT remove or alter names: ZygnalBot, TheHolyOneZ, TheZ.</div>
                        </div>
                        <div class="market-license-folder">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                            <code>./extensions/</code>
                        </div>
                    </div>

                    <!-- ZygnalID Activation -->
                    <div id="zygnalid-activation-notice" class="market-activation-card">
                        <div class="market-activation-header">
                            <div class="market-activation-icon">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                            </div>
                            <div>
                                <div class="market-activation-title">ZygnalID Activation Required</div>
                                <div class="market-activation-subtitle">Your ID is stored in <code>./data/marketplace/ZygnalID.txt</code></div>
                            </div>
                        </div>
                        <div class="market-activation-steps">
                            <div class="market-step"><span class="market-step-num">1</span>Copy your ZygnalID from the error message</div>
                            <div class="market-step"><span class="market-step-num">2</span>Join support server: <code>discord.gg/sgZnXca5ts</code></div>
                            <div class="market-step"><span class="market-step-num">3</span>Verify yourself and open a ticket with subject: <strong>"zygnal activation"</strong></div>
                            <div class="market-step"><span class="market-step-num">4</span>Paste your ZygnalID in the ticket</div>
                        </div>
                        <button class="market-refresh-id-btn" onclick="refreshZygnalIDCache()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                            Refresh ZygnalID Cache
                        </button>
                    </div>

                    <!-- Search & Filter Bar -->
                    <div class="market-controls">
                        <div class="market-search-wrap">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                            <input type="text" id="marketplace-search" class="market-search-input" placeholder="Search extensions..." onkeyup="filterMarketplaceExtensions()"/>
                        </div>
                        <select id="marketplace-filter" class="market-filter-select" onchange="filterMarketplaceExtensions()">
                            <option value="all">All Status</option>
                            <option value="working">Working</option>
                            <option value="beta">Beta</option>
                            <option value="broken">Broken</option>
                        </select>
                    </div>

                    <!-- Extensions Grid -->
                    <div id="marketplace-content" class="market-grid">
                        <div class="market-empty">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                            <div class="market-empty-title">Marketplace Ready</div>
                            <div class="market-empty-text">Click "Refresh" to load available extensions</div>
                        </div>
                    </div>
                </div>

                <div id="tab-roles" class="tab-content">
                    <!-- Roles Hero Header -->
                    <div class="dash-hero roles-hero">
                        <div class="dash-hero-bg">
                            <div class="dash-hero-orb roles-orb-1"></div>
                            <div class="dash-hero-orb roles-orb-2"></div>
                            <div class="dash-hero-grid"></div>
                        </div>
                        <div class="dash-hero-content">
                            <div class="dash-hero-left">
                                <div class="dash-hero-badge roles-badge">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                    Access Control
                                </div>
                                <h1 class="dash-hero-title">Roles &amp; Access</h1>
                                <p class="dash-hero-subtitle">Manage dashboard permissions and user access levels</p>
                            </div>
                            <div class="dash-hero-right" style="display:flex;gap:10px;">
                                <button class="dash-tour-btn" onclick="openSectionHelp('roles')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                    Help
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Roles Content Container -->
                    <div id="roles-content" class="roles-container">
                        <div class="roles-loading">
                            <div class="roles-loading-spinner"></div>
                            <span>Loading roles...</span>
                        </div>
                    </div>
                </div>

                <div id="tab-security" class="tab-content">
                    <div id="security-no-logs-warning" style="display:none;background:linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(245, 158, 11, 0.1));border:1px solid rgba(251, 191, 36, 0.4);border-radius:12px;padding:16px 20px;margin-bottom:16px;">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                            <div>
                                <div style="font-weight:600;color:#fbbf24;font-size:14px;">Limited Access</div>
                                <div style="color:#fcd34d;font-size:13px;margin-top:2px;">You can view this tab but not its content. Ask the owner to grant you the <strong>View Audit Logs</strong> permission to see the logs.</div>
                            </div>
                        </div>
                    </div>
        <div class="section-header">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <div class="section-title">Security &amp; Logs</div>
                            <button class="header-info-button" onclick="openSectionHelp('security')">?</button>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <select id="logs-refresh-interval" class="lm-select lm-select-sm" onchange="setLogsAutoRefresh(this.value)">
                                <option value="0">Auto-refresh: Off</option>
                                <option value="5">Every 5s</option>
                                <option value="10">Every 10s</option>
                                <option value="20">Every 20s</option>
                            </select>
                            <button class="button button-secondary button-compact" onclick="refreshSecurityLogs()">Refresh Now</button>
                            <button class="button button-secondary button-compact" onclick="window.location='owner_audit.php?export=csv'">Export Logs</button>
                        </div>
                    </div>
                    <div style="border-radius:12px;overflow:hidden;border:1px solid var(--border);height:520px;">
                        <iframe src="owner_audit.php" style="width:100%;height:100%;border:0;background:transparent;"></iframe>
                    </div>
                </div>

                <div id="tab-database" class="tab-content">
                    <div class="section-header" style="margin-bottom: 0; padding-bottom: 16px; border-bottom: 1px solid rgba(148, 163, 184, 0.2);">
                        <div style="display:flex;align-items:center;justify-content:space-between;width:100%;">
                            <div style="display:flex;align-items:center;gap:8px;">
                                <div class="section-title">Database Explorer</div>
                                <button class="header-info-button" onclick="openSectionHelp('database')">?</button>
                            </div>
                            <div id="db-action-bar" style="display:flex;gap:8px;align-items:center;">
                                <button id="db-refresh-btn" class="button button-secondary button-compact" onclick="refreshDatabaseView()" title="Refresh data" style="display:inline-flex;align-items:center;gap:6px;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                                    Refresh
                                </button>
                                <button id="db-export-btn" class="button button-secondary button-compact" onclick="exportTableData()" style="display:none;align-items:center;gap:6px;" title="Export table data">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                    Export
                                </button>
                                <button id="db-create-btn" class="button button-primary button-compact" onclick="openCreateRecordForm()" style="display:none;align-items:center;gap:6px;" title="Create new record">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                    Create Record
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:280px 1fr;gap:0;height:calc(100vh - 200px);margin-top:16px;border-radius:12px;overflow:hidden;border:1px solid rgba(148, 163, 184, 0.2);">
                        
                        <div id="db-sidebar" style="background:rgba(15, 23, 42, 0.6);border-right:1px solid rgba(148, 163, 184, 0.2);display:flex;flex-direction:column;">
                            <div style="padding:16px;border-bottom:1px solid rgba(148, 163, 184, 0.2);">
                                <input type="text" id="db-search-tables" placeholder="Search tables..." onkeyup="filterDatabaseTables()" style="width:100%;padding:10px 12px;background:rgba(15, 23, 42, 0.8);border:1px solid rgba(148, 163, 184, 0.3);border-radius:8px;color:#e2e8f0;font-size:13px;">
                            </div>
                            
                            <div style="padding:12px 16px;font-size:11px;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;">
                                Schema Navigator
                            </div>
                            
                            <div id="db-tables-list" style="flex:1;overflow-y:auto;padding:0 12px 12px 12px;">
                                <div class="loading" style="padding:20px;text-align:center;color:#94a3b8;">Loading tables...</div>
                            </div>
                        </div>
                        
                        <div id="db-main-content" style="background:rgba(10, 15, 30, 0.4);display:flex;flex-direction:column;min-width:0;overflow:hidden;">
                            <div id="db-content-header" style="padding:16px 20px;border-bottom:1px solid rgba(148, 163, 184, 0.2);background:rgba(15, 23, 42, 0.4);display:none;">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                    <div>
                                        <div id="db-current-table-name" style="font-size:18px;font-weight:600;color:#a855f7;"></div>
                                        <div id="db-current-table-info" style="font-size:13px;color:#94a3b8;margin-top:4px;"></div>
                                    </div>
                                    <div id="db-selected-count" style="display:none;padding:8px 16px;background:rgba(168, 85, 247, 0.2);border:1px solid rgba(168, 85, 247, 0.3);border-radius:8px;font-size:13px;color:#a855f7;font-weight:600;">
                                        <span id="db-selected-count-text">0 selected</span>
                                    </div>
                                </div>
                                
                                <div id="db-filters-bar" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
                            </div>
                            
                            <div id="db-data-grid" style="flex:1;overflow:hidden;padding:0;min-width:0;">
                                <div style="display:flex;align-items:center;justify-content:center;height:100%;color:#94a3b8;font-size:14px;flex-direction:column;gap:12px;">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.5"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
                                    <div>Select a table from the sidebar to begin</div>
                                </div>
                            </div>
                            
                            <div id="db-pagination" style="padding:12px 20px;border-top:1px solid rgba(148, 163, 184, 0.2);background:rgba(15, 23, 42, 0.4);display:none;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div style="font-size:13px;color:#94a3b8;">
                                        <span id="db-pagination-info">Showing 0-0 of 0 records</span>
                                    </div>
                                    <div style="display:flex;gap:12px;margin-left:24px;">
                                        <button id="db-prev-page" class="button button-secondary button-compact" onclick="loadDatabasePage('prev')" disabled>
                                            â† Previous
                                        </button>
                                        <button id="db-next-page" class="button button-secondary button-compact" onclick="loadDatabasePage('next')" disabled>
                                            Next â†’
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-credits" class="tab-content">
                    <!-- Credits Hero Header -->
                    <div class="dash-hero credits-hero">
                        <div class="dash-hero-bg">
                            <div class="dash-hero-orb credits-orb-1"></div>
                            <div class="dash-hero-orb credits-orb-2"></div>
                            <div class="dash-hero-grid"></div>
                        </div>
                        <div class="dash-hero-content">
                            <div class="dash-hero-left">
                                <div class="dash-hero-badge credits-badge">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                    Recognition
                                </div>
                                <h1 class="dash-hero-title">Credits</h1>
                                <p class="dash-hero-subtitle">Acknowledging the creator and the ZygnalBot ecosystem</p>
                            </div>
                        </div>
                    </div>

                    <!-- Copyright Notice Banner -->
                    <div class="credits-copyright-banner">
                        <div class="credits-crown-icon">
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                                <defs>
                                    <linearGradient id="credits-crown-grad" x1="0" y1="0" x2="1" y2="1">
                                        <stop offset="0%" stop-color="#facc15"><animate attributeName="stop-color" values="#facc15;#fde047;#facc15" dur="5s" repeatCount="indefinite"/></stop>
                                        <stop offset="100%" stop-color="#fb923c"><animate attributeName="stop-color" values="#fb923c;#f97316;#fb923c" dur="5s" repeatCount="indefinite"/></stop>
                                    </linearGradient>
                                </defs>
                                <path fill="url(#credits-crown-grad)" d="M4 18h16l-1.5-9-4 3-2.5-6-2.5 6-4-3L4 18z"/>
                            </svg>
                        </div>
                        <div class="credits-copyright-text">
                            <strong>Credits &amp; Design Copyright &copy; 2025 TheHolyOneZ.</strong>
                            This Credits tab must remain visible in all uses or modifications of this dashboard.
                        </div>
                    </div>

                    <!-- Main Credits Card -->
                    <div class="credits-main-card">
                        <!-- Left Column: Creator Info -->
                        <div class="credits-creator-section">
                            <div class="credits-creator-header">
                                <div class="credits-crown-large">
                                    <svg viewBox="0 0 24 24" aria-hidden="true">
                                        <defs>
                                            <linearGradient id="credits-hero-grad" x1="0" y1="0" x2="1" y2="1">
                                                <stop offset="0%" stop-color="#facc15"><animate attributeName="stop-color" values="#facc15;#fde047;#facc15" dur="6s" repeatCount="indefinite"/></stop>
                                                <stop offset="100%" stop-color="#fb7185"><animate attributeName="stop-color" values="#fb7185;#f97316;#fb7185" dur="6s" repeatCount="indefinite"/></stop>
                                            </linearGradient>
                                        </defs>
                                        <g>
                                            <path fill="url(#credits-hero-grad)" d="M4 18h16l-1.5-9-4 3-2.5-6-2.5 6-4-3L4 18z"/>
                                            <circle cx="6" cy="7" r="1.6" fill="#facc15"><animate attributeName="r" values="1.6;2.0;1.6" dur="3.2s" repeatCount="indefinite"/></circle>
                                            <circle cx="12" cy="5" r="1.8" fill="#facc15"><animate attributeName="r" values="1.8;2.4;1.8" dur="2.7s" repeatCount="indefinite"/></circle>
                                            <circle cx="18" cy="7" r="1.6" fill="#facc15"><animate attributeName="r" values="1.6;2.0;1.6" dur="3.5s" repeatCount="indefinite"/></circle>
                                        </g>
                                    </svg>
                                </div>
                                <div>
                                    <div class="credits-creator-name">TheHolyOneZ</div>
                                    <div class="credits-creator-role">Creator &amp; Lead Developer</div>
                                </div>
                            </div>

                            <div class="credits-info-grid">
                                <div class="credits-info-item">
                                    <span class="credits-info-label">Framework</span>
                                    <span class="credits-info-value">Zoryx Discord Bot Framework</span>
                                </div>
                                <div class="credits-info-item">
                                    <span class="credits-info-label">Ecosystem</span>
                                    <span class="credits-info-value">Zygnal</span>
                                </div>
                                <div class="credits-info-item">
                                    <span class="credits-info-label">Overview</span>
                                    <a href="https://zsync.eu/zdbf" target="_blank" class="credits-info-link">zsync.eu/zygnalbot/zdbf</a>
                                </div>
                                <div class="credits-info-item">
                                    <span class="credits-info-label">Repository</span>
                                    <a href="https://github.com/TheHolyOneZ/discord-bot-framework" target="_blank" class="credits-info-link">github.com/TheHolyOneZ</a>
                                </div>
                                <div class="credits-info-item">
                                    <span class="credits-info-label">Support</span>
                                    <a href="https://zsync.eu/zygnalbot/support.html" target="_blank" class="credits-info-link">zysnc.eu/zygnalbot/support</a>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Dashboard Features -->
                        <div class="credits-features-section">
                            <div class="credits-features-header">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                                <span>Built This Dashboard</span>
                            </div>
                            <p class="credits-features-desc">
                                Designed and developed by <strong>TheHolyOneZ</strong> â€” a comprehensive control center for Discord bots with real-time monitoring, deep plugin management, and production-ready tooling.
                            </p>

                            <!-- Capability Tags -->
                            <div class="credits-tags">
                                <span class="credits-tag credits-tag-backend">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>
                                    Backend
                                </span>
                                <span class="credits-tag credits-tag-frontend">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                                    Frontend
                                </span>
                                <span class="credits-tag credits-tag-realtime">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                                    Real-time
                                </span>
                                <span class="credits-tag credits-tag-api">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                                    WebSocket API
                                </span>
                                <span class="credits-tag credits-tag-ui">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/></svg>
                                    Modern UI
                                </span>
                                <span class="credits-tag credits-tag-secure">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                    Secure
                                </span>
                            </div>

                            <!-- Feature List -->
                            <div class="credits-feature-list">
                                <div class="credits-feature-item">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                    Plugin &amp; extension lifecycle management
                                </div>
                                <div class="credits-feature-item">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                    Atomic file operations with per-guild data
                                </div>
                                <div class="credits-feature-item">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                    Live event hooks &amp; custom automation
                                </div>
                                <div class="credits-feature-item">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                    Role-based access control system
                                </div>
                                <div class="credits-feature-item">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                    Self-host friendly with full data ownership
                                </div>
                            </div>

                            <div class="credits-support-note">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                <span>If this framework powers your bot, a star on the repo goes a long way!</span>
                            </div>

                            <a href="https://github.com/TheHolyOneZ/discord-bot-framework/blob/main/LICENSE" target="_blank" rel="noopener noreferrer" class="credits-license-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                                View License
                            </a>
                        </div>
                    </div>
                </div>

                <!-- DASHBOARD_PLUGINS_TABS_PLACEHOLDER -->

            </div>
        </div>

        <div id="lm-nav-palette-overlay" class="lm-nav-palette-overlay">
            <div class="lm-nav-palette-dialog">
                <div class="lm-nav-palette-title">Navigation</div>
                <div class="lm-nav-palette-sub">Jump to a dashboard section</div>
                <div class="lm-nav-palette-list">
                    <button class="lm-nav-palette-item" data-tab="dashboard">
                        <span>Dashboard</span><span class="lm-badge">Core</span>
                    </button>
                    <button class="lm-nav-palette-item" data-tab="commands">
                        <span>Commands</span><span class="lm-badge">Core</span>
                    </button>
                    <button class="lm-nav-palette-item" data-tab="plugins">
                        <span>Plugins &amp; Extensions</span><span class="lm-badge">Core</span>
                    </button>
                    <button class="lm-nav-palette-item" data-tab="hooks">
                        <span>Event Hooks</span><span class="lm-badge">Core</span>
                    </button>
                    <button class="lm-nav-palette-item" data-tab="filesystem">
                        <span>File System</span><span class="lm-badge">Core</span>
                    </button>
                    <button class="lm-nav-palette-item" data-tab="files">
                        <span>File Browser</span><span class="lm-badge">Tools</span>
                    </button>
                    <button class="lm-nav-palette-item" data-tab="chat">
                        <span>Chat Console</span><span class="lm-badge">Tools</span>
                    <button class="lm-nav-palette-item" data-tab="tickets">
                        <span>Discord Tickets</span><span class="lm-badge">Tools</span>
                    </button>
                    </button>
                    <button class="lm-nav-palette-item" data-tab="guilds">
                        <span>Guilds / Servers</span><span class="lm-badge">Tools</span>
                    </button>
                    <button class="lm-nav-palette-item" data-tab="events">
                        <span>Events</span><span class="lm-badge">Tools</span>
                    </button>
                    <button class="lm-nav-palette-item" data-tab="invite">
                        <div class="lm-nav-palette-icon">ğŸ”—</div>
                        <div class="lm-nav-palette-label">Bot Invite</div>
                    </button>
                    <button class="lm-nav-palette-item" data-tab="marketplace">
                        <div class="lm-nav-palette-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                            </svg>
                        </div>
                        <div class="lm-nav-palette-label">Marketplace <span style="font-size:9px;">BETA</span></div>
                    </button>
                    <button class="lm-nav-palette-item" data-tab="invite" style="display:none;">
                        <span>Bot Invite Helper</span><span class="lm-badge">Tools</span>
                    </button>
                    <button class="lm-nav-palette-item" data-tab="system">
                        <span>System</span><span class="lm-badge">Core</span>
                    </button>
                    <button class="lm-nav-palette-item" data-tab="roles">
                        <span>Roles &amp; Access</span><span class="lm-badge">Admin</span>
                    </button>
                    <button class="lm-nav-palette-item" data-tab="security">
                        <span>Security &amp; Logs</span><span class="lm-badge">Admin</span>
                    </button>
                    <button class="lm-nav-palette-item" data-tab="database">
                        <span>Database</span><span class="lm-badge">Admin</span>
                    </button>
                    <button class="lm-nav-palette-item" data-tab="credits">
                        <span>Credits</span><span class="lm-badge">ğŸ‘‘ Meta</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="lm-drawer-backdrop" class="lm-drawer-backdrop"></div>
        <nav id="lm-drawer-nav" class="lm-drawer" aria-label="Live Monitor Navigation">
            <div class="lm-drawer-title">Navigation</div>
            <div class="lm-drawer-sub">Live Monitor Sections</div>

            <div class="lm-drawer-group-label">Core</div>
            <button class="lm-drawer-item" data-tab="dashboard">Dashboard</button>
            <button class="lm-drawer-item" data-tab="commands">Commands</button>
            <button class="lm-drawer-item" data-tab="plugins">Plugins &amp; Extensions</button>
            <button class="lm-drawer-item" data-tab="hooks">Event Hooks</button>
            <button class="lm-drawer-item" data-tab="hook-creator">Hook Creator</button>
            <button class="lm-drawer-item" data-tab="filesystem">File System</button>
            <button class="lm-drawer-item" data-tab="system">System</button>

            <div class="lm-drawer-group-label">Tools</div>
            <button class="lm-drawer-item" data-tab="files">File Browser</button>
            <button class="lm-drawer-item" data-tab="chat">Chat Console</button>
            <button class="lm-drawer-item" data-tab="tickets">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="display:inline-block;vertical-align:middle;margin-right:8px;">
                    <path d="M3 7C3 5.89543 3.89543 5 5 5H19C20.1046 5 21 5.89543 21 7V10C19.8954 10 19 10.8954 19 12C19 13.1046 19.8954 14 21 14V17C21 18.1046 20.1046 19 19 19H5C3.89543 19 3 18.1046 3 17V14C4.10457 14 5 13.1046 5 12C5 10.8954 4.10457 10 3 10V7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9 9L9 15M12 9V15M15 9V15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Discord Tickets
            </button>
            <button class="lm-drawer-item" data-tab="guilds">Guilds / Servers</button>
            <button class="lm-drawer-item" data-tab="events">Events</button>
            <button class="lm-drawer-item" data-tab="invite">Bot Invite Helper</button>
            <button class="lm-drawer-item" data-tab="marketplace">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;display:inline-block;vertical-align:middle;">
                    <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                </svg>
                Marketplace (BETA)
            </button>

            <!-- DASHBOARD_PLUGINS_DRAWER_PLACEHOLDER -->

            <div class="lm-drawer-group-label">Admin</div>
            <button class="lm-drawer-item" data-tab="roles">Roles &amp; Access</button>
            <button class="lm-drawer-item" data-tab="security">Security &amp; Logs</button>
            <button class="lm-drawer-item" data-tab="database">Database</button>

            <div class="lm-drawer-group-label">Meta</div>
            <button class="lm-drawer-item" data-tab="credits">Credits ğŸ‘‘</button>
        </nav>
    </div>

        <!-- Global Footer - Centered on page -->
        <footer class="lm-global-footer">
            <div class="lm-footer-content">
                <p class="lm-footer-update">Last Updated: <span id="last-update">Never</span></p>
                <p class="lm-footer-brand">
                    <a href="https://github.com/TheHolyOneZ/discord-bot-framework" target="_blank" rel="noopener noreferrer">
                        Zoryx Discord Bot Framework Â· Live Monitor
                    </a>
                </p>
                <p class="lm-footer-credit">Â© 2026 <a href="https://github.com/TheHolyOneZ" target="_blank" rel="noopener noreferrer">TheHolyOneZ</a></p>
            </div>
        </footer>

        <div id="lm-tour-overlay" class="lm-nav-palette-overlay" style="display:none;">
            <div class="lm-nav-palette-dialog" style="max-width:720px;">
                <div class="lm-nav-palette-title">Welcome to the Live Monitor Dashboard</div>
                <div class="lm-nav-palette-sub">Quick tour for first-time users</div>
                <div style="font-size:13px;color:var(--text-secondary);margin-bottom:8px;">
                    &bull; <strong>Dashboard</strong> &mdash; real-time health, alerts, and quick actions (including backups).<br>
                    &bull; <strong>Commands</strong> &mdash; detailed usage, errors, and performance per command.<br>
                    &bull; <strong>Plugins &amp; Extensions</strong> &mdash; plugin health, load times, and conflicts.<br>
                    &bull; <strong>File System &amp; File Browser</strong> &mdash; browse logs and config files safely.<br>
                    &bull; <strong>Guilds &amp; Servers</strong> &mdash; see where your bot is and leave servers when needed.<br>
                    &bull; <strong>Database</strong> &mdash; explore the Live Monitor SQLite database (if your role allows it).<br>
                    &bull; <strong>Roles &amp; Security</strong> &mdash; manage who can access which features and review audit logs.
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
                    <div style="font-size:12px;color:var(--text-secondary);">You can re-open this tour anytime from the Dashboard's Quick Tour button.</div>
                    <button class="button button-primary button-compact" onclick="completeTour()">Got it</button>
                </div>
            </div>
        </div>

        <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title"></div>
                <button class="close-button" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

        <div id="privacy-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Privacy Settings</div>
                    <button class="close-button" onclick="closePrivacyModal()">&times;</button>
                </div>
                <div id="privacy-modal-body" style="padding: 24px;">
                    <p style="font-size:14px; color: var(--text-secondary); margin-bottom: 20px;">Your privacy is important. Here you can control how your data is handled within the dashboard.</p>
                    <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 16px; border: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <label for="modal-log-ip-toggle" style="font-size: 14px; font-weight: 600; color: #cbd5e1; cursor: pointer; margin: 0;">Allow IP Address Logging</label>
                                <p style="font-size: 12px; color: #9ca3af; margin-top: 4px;">When enabled, your IP address is recorded in the audit log for security purposes.</p>
                            </div>
                            <div class="toggle-pill" id="modal-log-ip-toggle-pill" onclick="this.classList.toggle('on')">
                                <span class="toggle-pill-knob"></span>
                            </div>
                        </div>
                    </div>
                    <div class="actions" style="margin-top: 24px; display:flex; justify-content: flex-end; gap: 12px;">
                         <button class="button button-secondary" onclick="closePrivacyModal()">Cancel</button>
                         <button class="button button-primary" onclick="savePrivacySettings()">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

    <script>
<?php
    $u = lm_current_user();
    if (!$u) {
        // User not logged in - redirect or show error
        echo "console.error('[CRITICAL] User not logged in to index.php');";
        echo "console.error('[CRITICAL] This should not happen - lm_require_auth should have caught this');";
        echo "window.LM_PERMS = {}; window.LM_CURRENT_USER = {};";
    } else {
        $roleName = $u['role'] ?? 'CUSTOM';
        $tier = lm_resolve_role_tier($roleName);
        $perms = lm_role_permissions($roleName, $tier);
        $info = [
            'display_name' => $u['display_name'] ?? '',
            'discord_user_id' => $u['discord_user_id'] ?? '',
            'avatar_url' => $u['avatar_url'] ?? '',
            'role' => $roleName,
        ];
        echo 'window.LM_CURRENT_USER = ' . json_encode($info, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE) . ';';
        echo "\n";
        echo 'window.LM_PERMS = ' . json_encode($perms, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE) . ';';
        echo "\n";
        echo "console.log('[PERMISSIONS] LM_PERMS successfully loaded');";
        echo "\n";
        echo "console.log('[PERMISSIONS] Role: {$roleName}, Tier: {$tier}');";
        echo "\n";
        echo "console.log('[PERMISSIONS] Database permissions:', {";
        echo "'view_database': " . (isset($perms['view_database']) && $perms['view_database'] ? 'true' : 'false') . ",";
        echo "'action_db_read': " . (isset($perms['action_db_read']) && $perms['action_db_read'] ? 'true' : 'false') . ",";
        echo "'action_db_create': " . (isset($perms['action_db_create']) && $perms['action_db_create'] ? 'true' : 'false') . ",";
        echo "'action_db_update': " . (isset($perms['action_db_update']) && $perms['action_db_update'] ? 'true' : 'false') . ",";
        echo "'action_db_delete': " . (isset($perms['action_db_delete']) && $perms['action_db_delete'] ? 'true' : 'false');
        echo "});";
        echo "\n";
    }
?>
        // Fallback: Ensure LM_PERMS exists even if PHP failed
        if (typeof window.LM_PERMS === 'undefined') {
            console.error('[CRITICAL] LM_PERMS was not defined by PHP! This means the PHP code did not execute.');
            console.error('[CRITICAL] Possible causes: 1) Bot did not regenerate index.php, 2) PHP error before this point, 3) File not uploaded');
            window.LM_PERMS = {};
            window.LM_CURRENT_USER = {};
        }
        
        const DEFAULT_PREFIX = '{{PREFIX}}';
        let currentTab = 'dashboard';
        let currentData = null;
        let currentGuilds = [];
        let platformOS = null;
        
        // Permission refresh mechanism
        async function refreshPermissions() {
            try {
                const response = await fetch('get_user_permissions.php', {
                    credentials: 'include',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.permissions) {
                        // Update global permissions
                        window.LM_PERMS = data.permissions;
                        
                        // CRITICAL: Reapply permission visibility for current tab
                        // This ensures if permissions change (e.g., role updated), buttons update immediately
                        applyPermissionVisibility(currentTab);
                        console.log('[PERMISSIONS] Auto-refreshed permissions for tab:', currentTab);
                        
                        showNotification('Permissions refreshed successfully!', 'success');
                        return true;
                    }
                }
                
                throw new Error('Failed to refresh permissions');
            } catch (error) {
                console.error('Permission refresh error:', error);
                showNotification('Failed to refresh permissions. Try reloading the page.', 'error');
                return false;
            }
        }
        
        // CRITICAL: Auto-refresh permissions every 30 seconds
        // This ensures if an OWNER changes your permissions, they take effect quickly
        setInterval(() => {
            refreshPermissions();
        }, 30000);

        function switchTab(tabName) {
            if (!tabName) return;
            currentTab = tabName;

            // Activate tab contents
            document.querySelectorAll('.tab-content').forEach(panel => {
                panel.classList.toggle('active', panel.id === 'tab-' + tabName);
            });

            // Legacy horizontal tabs (kept for compatibility, may be hidden)
            document.querySelectorAll('.tab').forEach(btn => {
                const onclick = btn.getAttribute('onclick') || '';
                const isMatch = onclick.includes("'" + tabName + "'") || onclick.includes('"' + tabName + '"');
                btn.classList.toggle('active', isMatch);
            });

            // Sidebar (S4-style)
            document.querySelectorAll('#lm-sidebar-nav .lm-sidebar-item').forEach(btn => {
                btn.classList.toggle('lm-active', btn.dataset.tab === tabName);
            });

            // Drawer (D8-style)
            document.querySelectorAll('#lm-drawer-nav .lm-drawer-item').forEach(btn => {
                btn.classList.toggle('lm-active', btn.dataset.tab === tabName);
            });
            
            // CRITICAL: Apply permission-based visibility EVERY TIME tab changes
            // This ensures buttons are always properly gated based on current permissions
            applyPermissionVisibility(tabName);
            console.log('[PERMISSIONS] Applied permission checks to tab:', tabName);
            
            // Auto-load tickets on first visit
            if (tabName === 'tickets' && !window._ticketsLoaded) {
                window._ticketsLoaded = true;
                setTimeout(() => loadTickets(), 100);
            }
        }
        
        window.hasPermission = function(permissionKey) {
            if (!window.LM_PERMS) return false;
            return window.LM_PERMS[permissionKey] || false;
        };
        
        function applyPermissionVisibility(tabName) {
            if (!window.LM_PERMS) return;
            const perms = window.LM_PERMS;
            
            // Helper function to check permission with fallback
            const hasPermission = (newPerm, oldPerm) => {
                return perms[newPerm] || perms[oldPerm] || false;
            };
            
            // Helper function to disable button
            const disableButton = (selector, newPerm, oldPerm) => {
                document.querySelectorAll(selector).forEach(btn => {
                    const allowed = hasPermission(newPerm, oldPerm);
                    btn.disabled = !allowed;
                    btn.style.opacity = allowed ? '1' : '0.5';
                    btn.style.cursor = allowed ? 'pointer' : 'not-allowed';
                    if (!allowed) {
                        btn.title = `Requires ${newPerm} permission`;
                    } else {
                        btn.title = '';
                    }
                });
            };
            
            // DASHBOARD TAB
            if (tabName === 'dashboard') {
                disableButton('button[onclick*="clear_cache"]', 'action_clear_cache', 'control_core');
                disableButton('button[onclick*="toggle_verbose_logging"]', 'action_toggle_logging', 'control_core');
                disableButton('button[onclick*="toggle_debug_packages"]', 'action_toggle_debug_packages', 'control_core');
                disableButton('button[onclick*="backup_bot_directory"]', 'action_backup_bot', 'control_backup');
                
                // Backup Dashboard button (uses window.location onclick)
                document.querySelectorAll('button[onclick*="backup_dashboard.php"], a[href*="backup_dashboard.php"]').forEach(link => {
                    const allowed = hasPermission('action_backup_dashboard', 'control_backup');
                    link.disabled = !allowed;
                    link.style.opacity = allowed ? '1' : '0.5';
                    link.style.pointerEvents = allowed ? '' : 'none';
                    if (!allowed) link.title = 'Requires action_backup_dashboard permission';
                });
            }
            
            // PLUGINS TAB
            if (tabName === 'plugins') {
                disableButton('button[onclick*="reload_extension"]', 'action_reload_extension', 'control_plugins');
                disableButton('button[onclick*="load_extension"]', 'action_load_extension', 'control_plugins');
                disableButton('button[onclick*="unload_extension"]', 'action_unload_extension', 'control_plugins');
                disableButton('button[onclick*="set_auto_reload"]', 'action_set_auto_reload', 'control_plugins');
                disableButton('button[onclick*="set_extensions_auto_load"]', 'action_set_auto_load', 'control_plugins');
                disableButton('button[onclick*="plugin_registry_set_enforcement"]', 'action_set_enforcement', 'control_plugins');
            }
            
            // EVENT HOOKS TAB
            if (tabName === 'hooks') {
                disableButton('button[onclick*="enable_hook"]', 'action_enable_hook', 'control_hooks');
                disableButton('button[onclick*="disable_hook"]', 'action_disable_hook', 'control_hooks');
                disableButton('button[onclick*="reset_circuit"]', 'action_reset_circuit', 'control_hooks');
                disableButton('button[onclick*="delete_custom_hook"]', 'action_delete_hook', 'control_hooks');
                disableButton('button[onclick*="deleteCustomHook"]', 'action_delete_hook', 'control_hooks');
            }
            
            // HOOK CREATOR TAB
            if (tabName === 'hook-creator') {
                disableButton('#export-hooks-btn', 'action_export_hooks', 'control_hooks');
                disableButton('button[onclick*="create_custom_hook"]', 'action_create_hook', 'control_hooks');
                disableButton('button[onclick*="createCustomHook"]', 'action_create_hook', 'control_hooks');
            }
            
            // FILE BROWSER TAB
            if (tabName === 'files') {
                disableButton('button[onclick*="uploadFile"]', 'action_upload_file', 'control_files');
                disableButton('button[onclick*="renameFile"]', 'action_rename_file', 'control_files');
                disableButton('button[onclick*="deleteFile"]', 'action_delete_file', 'control_files');
                disableButton('button[onclick*="deletePath"]', 'action_delete_file', 'control_files');
                disableButton('button[onclick*="createFolder"]', 'action_create_folder', 'control_files');
                disableButton('button[onclick*="editFile"]', 'action_edit_file', 'control_files');
                disableButton('button[onclick*="saveFile"]', 'action_save_file', 'control_files');
            }
            
            // SYSTEM TAB
            if (tabName === 'system') {
                disableButton('button[onclick*="confirmShutdownBot"]', 'action_shutdown_bot', 'control_core');
                disableButton('button[onclick*="generate_framework_diagnostics"]', 'action_generate_diagnostics', 'control_core');
                disableButton('button[onclick*="af_invalidate_cache_entry"]', 'action_invalidate_cache', 'control_core');
                disableButton('button[onclick*="af_force_release_lock"]', 'action_force_release_lock', 'control_core');
                
                // Force button in file locks section
                document.querySelectorAll('.af-release-lock').forEach(btn => {
                    const allowed = hasPermission('action_force_release_lock', 'control_core');
                    btn.disabled = !allowed;
                    btn.style.opacity = allowed ? '1' : '0.5';
                    if (!allowed) btn.title = 'Requires action_force_release_lock permission';
                });
            }
            
            // CHAT CONSOLE TAB
            if (tabName === 'chat') {
                disableButton('button[onclick*="send_chat_message"]', 'action_send_message', 'control_chat');
                disableButton('button[onclick*="sendChatMessage"]', 'action_send_message', 'control_chat');
                disableButton('button[onclick*="requestChatHistory"]', 'action_request_chat_data', 'control_chat');
                
                // Also disable the input field if no permission
                document.querySelectorAll('#chat-input').forEach(input => {
                    const allowed = hasPermission('action_send_message', 'control_chat');
                    input.disabled = !allowed;
                    input.style.opacity = allowed ? '1' : '0.5';
                    if (!allowed) input.placeholder = 'You do not have permission to send messages';
                });
            }
            
            // DISCORD TICKETS TAB
            if (tabName === 'tickets') {
                disableButton('button[onclick*="deleteTicket"]', 'action_delete_ticket', 'control_tickets');
                
                // Open ticket transcript buttons
                document.querySelectorAll('button[onclick*="openTicket"], .ticket-open-btn').forEach(btn => {
                    const allowed = hasPermission('action_view_ticket', 'control_tickets');
                    btn.disabled = !allowed;
                    btn.style.opacity = allowed ? '1' : '0.5';
                    btn.style.cursor = allowed ? 'pointer' : 'not-allowed';
                    if (!allowed) btn.title = 'Requires action_view_ticket permission';
                });
                
                // Download ticket transcript buttons
                document.querySelectorAll('button[onclick*="downloadTicket"], .ticket-download-btn').forEach(btn => {
                    const allowed = hasPermission('action_download_ticket', 'control_tickets');
                    btn.disabled = !allowed;
                    btn.style.opacity = allowed ? '1' : '0.5';
                    btn.style.cursor = allowed ? 'pointer' : 'not-allowed';
                    if (!allowed) btn.title = 'Requires action_download_ticket permission';
                });
                
                // All delete buttons in ticket list
                document.querySelectorAll('.ticket-delete-btn').forEach(btn => {
                    const allowed = hasPermission('action_delete_ticket', 'control_tickets');
                    btn.disabled = !allowed;
                    btn.style.opacity = allowed ? '1' : '0.5';
                    if (!allowed) btn.title = 'Requires action_delete_ticket permission';
                });
            }
            
            // GUILDS / SERVERS TAB
            if (tabName === 'guilds') {
                disableButton('button[onclick*="leave_guild"]', 'action_leave_guild', 'control_guilds');
                disableButton('button[onclick*="leaveGuild"]', 'action_leave_guild', 'control_guilds');
            }
            
            // BOT INVITE HELPER TAB
            if (tabName === 'invite') {
                disableButton('button[onclick*="generateInviteLink"]', 'action_generate_invite', 'control_bot_invite');
                disableButton('button[onclick*="openInviteLink"]', 'action_open_invite', 'control_bot_invite');
                disableButton('button[onclick*="copyInviteLink"]', 'action_copy_invite', 'control_bot_invite');
                
                // Disable inputs if no generate permission
                if (!hasPermission('action_generate_invite', 'control_bot_invite')) {
                    document.querySelectorAll('#invite-app-id, #invite-permissions, #invite-scope-bot, #invite-scope-commands').forEach(input => {
                        input.disabled = true;
                        input.style.opacity = '0.5';
                    });
                }
            }
            
            // EXTENSION MARKETPLACE TAB
            if (tabName === 'marketplace') {
                disableButton('button[onclick*="fetchMarketplaceExtensions"]', 'action_refresh_marketplace', 'control_marketplace');
                disableButton('button[onclick*="refreshZygnalIDCache"]', 'action_refresh_zygnalid', 'control_marketplace');
                disableButton('button[onclick*="downloadMarketplaceExtension"]', 'action_download_extension', 'control_marketplace');
                disableButton('button[onclick*="download_marketplace_extension"]', 'action_download_extension', 'control_marketplace');
                
                // Download buttons in extension cards
                document.querySelectorAll('.extension-download-btn').forEach(btn => {
                    const allowed = hasPermission('action_download_extension', 'control_marketplace');
                    btn.disabled = !allowed;
                    btn.style.opacity = allowed ? '1' : '0.5';
                    if (!allowed) btn.title = 'Requires action_download_extension permission';
                });
                
                // Load extension button
                disableButton('button[onclick*="load_downloaded_extension"]', 'action_load_marketplace_extension', 'control_marketplace');
            }
            
            // ROLES & ACCESS TAB
            if (tabName === 'roles') {
                // Role profile edit buttons
                document.querySelectorAll('[data-role-action="toggle"]').forEach(btn => {
                    const allowed = hasPermission('action_save_role', 'control_roles');
                    btn.disabled = !allowed;
                    btn.style.opacity = allowed ? '1' : '0.5';
                    btn.style.cursor = allowed ? 'pointer' : 'not-allowed';
                    if (!allowed) btn.title = 'Requires action_save_role permission to edit roles';
                });
                
                // Role profile save buttons  
                document.querySelectorAll('[data-role-action="save"]').forEach(btn => {
                    const allowed = hasPermission('action_save_role', 'control_roles');
                    btn.disabled = !allowed;
                    btn.style.opacity = allowed ? '1' : '0.5';
                    btn.style.cursor = allowed ? 'pointer' : 'not-allowed';
                    if (!allowed) btn.title = 'Requires action_save_role permission';
                });
                
                // Role profile delete buttons
                document.querySelectorAll('[data-role-action="delete"]').forEach(btn => {
                    const allowed = hasPermission('action_delete_role', 'control_roles');
                    btn.disabled = !allowed;
                    btn.style.opacity = allowed ? '1' : '0.5';
                    btn.style.cursor = allowed ? 'pointer' : 'not-allowed';
                    if (!allowed) btn.title = 'Requires action_delete_role permission';
                });
                
                // Create new role button
                const createBtn = document.getElementById('role-new-create');
                if (createBtn) {
                    const allowed = hasPermission('action_create_role', 'control_roles');
                    createBtn.disabled = !allowed;
                    createBtn.style.opacity = allowed ? '1' : '0.5';
                    createBtn.style.cursor = allowed ? 'pointer' : 'not-allowed';
                    if (!allowed) createBtn.title = 'Requires action_create_role permission';
                }
                
                // Create new role input fields
                if (!hasPermission('action_create_role', 'control_roles')) {
                    const nameInput = document.getElementById('role-new-name');
                    const baseSelect = document.getElementById('role-new-base');
                    if (nameInput) {
                        nameInput.disabled = true;
                        nameInput.style.opacity = '0.5';
                        nameInput.placeholder = 'No permission to create roles';
                    }
                    if (baseSelect) {
                        baseSelect.disabled = true;
                        baseSelect.style.opacity = '0.5';
                    }
                }
                
                // Role profile buttons
                disableButton('button[data-action="save-role"]', 'action_save_role', 'control_roles');
                
                // User management buttons
                document.querySelectorAll('button[data-action="delete-user"]').forEach(btn => {
                    const allowed = hasPermission('action_remove_user', 'control_roles');
                    btn.disabled = !allowed;
                    btn.style.opacity = allowed ? '1' : '0.5';
                    btn.style.cursor = allowed ? 'pointer' : 'not-allowed';
                    if (!allowed) btn.title = 'Requires action_remove_user permission';
                });
                
                document.querySelectorAll('select.role-select').forEach(sel => {
                    const allowed = hasPermission('action_change_user_role', 'control_roles');
                    sel.disabled = !allowed;
                    sel.style.opacity = allowed ? '1' : '0.5';
                    if (!allowed) sel.title = 'Requires action_change_user_role permission';
                });
                
                // Save role change buttons (for user role assignments)
                document.querySelectorAll('button[data-action="save-role"][data-user-id]').forEach(btn => {
                    const allowed = hasPermission('action_change_user_role', 'control_roles');
                    btn.disabled = !allowed;
                    btn.style.opacity = allowed ? '1' : '0.5';
                    btn.style.cursor = allowed ? 'pointer' : 'not-allowed';
                    if (!allowed) btn.title = 'Requires action_change_user_role permission';
                });
                
                // Add user button and inputs
                const addUserBtn = document.getElementById('roles-add-submit');
                if (addUserBtn) {
                    const allowed = hasPermission('action_add_user', 'control_roles');
                    addUserBtn.disabled = !allowed;
                    addUserBtn.style.opacity = allowed ? '1' : '0.5';
                    addUserBtn.style.cursor = allowed ? 'pointer' : 'not-allowed';
                    if (!allowed) addUserBtn.title = 'Requires action_add_user permission';
                }
                
                if (!hasPermission('action_add_user', 'control_roles')) {
                    ['roles-add-discord', 'roles-add-name', 'roles-add-role'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.disabled = true;
                            el.style.opacity = '0.5';
                        }
                    });
                }
            }
            
            // SECURITY & LOGS TAB
            if (tabName === 'security') {
                const warningEl = document.getElementById('security-no-logs-warning');
                const iframeContainer = document.querySelector('#tab-security iframe');
                const hasViewLogs = hasPermission('action_view_logs', 'view_logs');
                
                if (warningEl) {
                    warningEl.style.display = hasViewLogs ? 'none' : 'block';
                }
                if (iframeContainer) {
                    iframeContainer.style.display = hasViewLogs ? '' : 'none';
                }
                
                disableButton('button[onclick*="exportLogs"]', 'action_export_logs', 'export_logs');
                disableButton('button[onclick*="export_logs"]', 'action_export_logs', 'export_logs');
                disableButton('button[onclick*="refreshSecurityLogs"]', 'action_view_logs', 'view_logs');
            }
            
            // DATABASE TAB
            if (tabName === 'database') {
                disableButton('button[onclick*="executeQuery"]', 'action_execute_query', 'control_database');
                disableButton('button[onclick*="execute_query"]', 'action_execute_query', 'control_database');
                disableButton('button[onclick*="createRecord"]', 'action_db_create', 'control_database');
                disableButton('button[onclick*="updateRecord"]', 'action_db_update', 'control_database');
                disableButton('button[onclick*="deleteRecord"]', 'action_db_delete', 'control_database');
            }
        }

        // Sidebar navigation click handlers
        (function () {
            const sidebar = document.getElementById('lm-sidebar-nav');
            if (!sidebar) return;
            sidebar.querySelectorAll('.lm-sidebar-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchTab(btn.dataset.tab);
                });
            });
        })();

        // Drawer handling (D8 style)
        (function () {
            const trigger = document.getElementById('lm-drawer-trigger');
            const backdrop = document.getElementById('lm-drawer-backdrop');
            const drawer = document.getElementById('lm-drawer-nav');
            if (!trigger || !backdrop || !drawer) return;

            function setOpen(open) {
                document.body.classList.toggle('lm-drawer-open', open);
            }

            trigger.addEventListener('click', () => {
                setOpen(!document.body.classList.contains('lm-drawer-open'));
            });

            backdrop.addEventListener('click', () => setOpen(false));

            drawer.querySelectorAll('.lm-drawer-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchTab(btn.dataset.tab);
                    setOpen(false);
                });
            });
        })();

        // Command palette handling (D10 style)
        (function () {
            const trigger = document.getElementById('lm-nav-palette-trigger');
            const overlay = document.getElementById('lm-nav-palette-overlay');
            if (!trigger || !overlay) return;

            function openPalette() {
                overlay.classList.add('lm-open');
            }

            function closePalette() {
                overlay.classList.remove('lm-open');
            }

            trigger.addEventListener('click', openPalette);

            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closePalette();
                }
            });

            window.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
                    e.preventDefault();
                    openPalette();
                }
                if (e.key === 'Escape') {
                    closePalette();
                }
            });

            overlay.querySelectorAll('.lm-nav-palette-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchTab(btn.dataset.tab);
                    closePalette();
                });
            });
        })();

        function isTabAllowedByPerms(tabName) {
            if (!tabName || typeof LM_PERMS === 'undefined') {
                return true;
            }
            const map = {
                dashboard: 'view_dashboard',
                commands: 'view_commands',
                plugins: 'view_plugins',
                hooks: 'view_hooks',
                'hook-creator': 'view_hooks',
                filesystem: 'view_filesystem',
                files: 'view_files',
                chat: 'view_chat',
                events: 'view_events',
                system: 'view_system',
                invite: 'view_bot_invite',
                roles: 'view_roles',
                security: 'view_security',
                guilds: 'view_guilds',
                database: 'view_database',
                marketplace: 'view_marketplace',
                tickets: 'view_tickets',
                credits: null,
                /* DASHBOARD_PLUGINS_TAB_MAP_PLACEHOLDER */
            };
            const key = map[tabName];
            if (!key) return true;
            return !!LM_PERMS[key];
        }

        function applyPermissionsToUI() {
            if (typeof window.LM_PERMS === 'undefined') {
                return;
            }

            const tabPermMap = {
                dashboard: 'view_dashboard',
                commands: 'view_commands',
                plugins: 'view_plugins',
                hooks: 'view_hooks',
                'hook-creator': 'view_hooks',
                filesystem: 'view_filesystem',
                files: 'view_files',
                chat: 'view_chat',
                events: 'view_events',
                system: 'view_system',
                invite: 'view_bot_invite',    // Fixed: was view_system
                tickets: 'view_tickets',
                roles: 'view_roles',          // Fixed: was view_security
                security: 'view_security',
                guilds: 'view_guilds',
                database: 'view_database',
                marketplace: 'view_marketplace',
                credits: null,
                /* DASHBOARD_PLUGINS_TAB_PERM_MAP_PLACEHOLDER */
            };

            Object.keys(tabPermMap).forEach(tab => {
                const permKey = tabPermMap[tab];
                const allowed = permKey ? !!LM_PERMS[permKey] : true;

                ['.lm-sidebar-item', '.lm-drawer-item', '.lm-nav-palette-item'].forEach(selector => {
                    document.querySelectorAll(`${selector}[data-tab="${tab}"]`).forEach(el => {
                        el.style.display = allowed ? '' : 'none';
                    });
                });

                const tabContent = document.getElementById('tab-' + tab);
                if (tabContent) {
                    tabContent.style.display = allowed ? '' : 'none';
                }
            });
            
            // Check plugin section visibility - hide entire dropdown if no plugins are accessible
            const pluginSection = document.getElementById('lm-plugin-section');
            if (pluginSection) {
                const pluginItems = pluginSection.querySelectorAll('.lm-plugin-item');
                let visibleCount = 0;
                
                pluginItems.forEach(item => {
                    const viewPerm = item.getAttribute('data-view-perm');
                    const hasAccess = viewPerm ? !!LM_PERMS[viewPerm] : true;
                    item.style.display = hasAccess ? '' : 'none';
                    if (hasAccess) visibleCount++;
                });
                
                // Hide entire plugin section if no plugins are visible
                pluginSection.style.display = visibleCount > 0 ? '' : 'none';
                
                // Update the visible count badge
                const countBadge = document.getElementById('lm-plugin-visible-count');
                if (countBadge) {
                    countBadge.textContent = visibleCount;
                }
            }
            
            // Also handle drawer plugin section
            const drawerPluginSection = document.getElementById('lm-drawer-plugin-section');
            if (drawerPluginSection) {
                const pluginItems = drawerPluginSection.querySelectorAll('.lm-drawer-item');
                let visibleCount = 0;
                
                pluginItems.forEach(item => {
                    const viewPerm = item.getAttribute('data-view-perm');
                    const hasAccess = viewPerm ? !!LM_PERMS[viewPerm] : true;
                    item.style.display = hasAccess ? '' : 'none';
                    if (hasAccess) visibleCount++;
                });
                
                drawerPluginSection.style.display = visibleCount > 0 ? '' : 'none';
            }
        }

        // Apply permissions and ensure we start on the Dashboard view
        applyPermissionsToUI();
        
        // IMPORTANT: Apply permission visibility to ALL tabs on page load
        // This ensures buttons are enabled/disabled immediately, not after 30 seconds
        const allTabs = ['dashboard', 'commands', 'plugins', 'hooks', 'hook-creator', 
                         'filesystem', 'files', 'chat', 'events', 'system', 'invite', 
                         'tickets', 'roles', 'security', 'guilds', 'database', 'marketplace'];
        allTabs.forEach(tab => applyPermissionVisibility(tab));
        
        switchTab('dashboard');

        function toggleCard(cardId) {
            const card = document.getElementById(cardId);
            card.classList.toggle('expanded');
        }

        function openModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }
        
        function showModal(title, content) {
            openModal(title, content);
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function confirmShutdownBot() {
            const ok = confirm('Shutdown the bot now? This will close the bot and it will NOT restart automatically.');
            if (!ok) return;
            sendCommand('shutdown_bot', {});
        }

        function requestBotBackup() {
            sendCommand('backup_bot_directory', {});
            showNotification('Bot backup requested. The archive will be saved on the bot host under ./data/Dashboardbackups as bot_backup_YYYYMMDD_HHMMSS.zip.', 'info');
        }

        function buildInviteUrl() {
            const appIdInput = document.getElementById('invite-app-id');
            const scopeBot = document.getElementById('invite-scope-bot');
            const scopeCmd = document.getElementById('invite-scope-commands');
            const permsInput = document.getElementById('invite-permissions');
            if (!appIdInput || !scopeBot || !scopeCmd || !permsInput) {
                showNotification('Invite helper inputs are missing from the page.', 'error');
                return null;
            }
            const appId = appIdInput.value.trim();
            if (!appId) {
                showNotification('Please enter your bot Application / Client ID.', 'error');
                return null;
            }
            if (!/^\\d{5,}$/.test(appId)) {
                showNotification('The Application ID should be a numeric Discord snowflake.', 'error');
                return null;
            }
            const scopes = [];
            if (scopeBot.checked) scopes.push('bot');
            if (scopeCmd.checked) scopes.push('applications.commands');
            if (!scopes.length) {
                showNotification('Select at least one scope (typically "bot" and/or "applications.commands").', 'error');
                return null;
            }
            const permsRaw = permsInput.value.trim();
            const params = new URLSearchParams();
            params.set('client_id', appId);
            params.set('scope', scopes.join(' '));
            if (permsRaw) {
                if (!/^\\d+$/.test(permsRaw)) {
                    showNotification('Permissions bitmask must be a numeric value (or leave it empty).', 'error');
                    return null;
                }
                params.set('permissions', permsRaw);
            }
            // Let Discord handle the rest of the OAuth2 flow; this is only for building the URL.
            const baseUrl = 'https://discord.com/api/oauth2/authorize';
            return baseUrl + '?' + params.toString();
        }

        function generateInviteLink() {
            if (!window.LM_PERMS?.action_generate_invite) {
                showNotification('You do not have permission to generate invite links. Requires action_generate_invite permission.', 'error');
                return;
            }
            const url = buildInviteUrl();
            if (!url) return;
            const out = document.getElementById('invite-output-url');
            if (out) {
                out.value = url;
                out.scrollLeft = 0;
            }
            showNotification('Invite link generated. You can copy it or open it in a new tab.', 'success');
        }

        function openInviteLink() {
            if (!window.LM_PERMS?.action_open_invite) {
                showNotification('You do not have permission to open invite links. Requires action_open_invite permission.', 'error');
                return;
            }
            const out = document.getElementById('invite-output-url');
            let url = out && out.value.trim();
            if (!url) {
                url = buildInviteUrl();
            }
            if (!url) return;
            window.open(url, '_blank', 'noopener');
        }

        async function copyInviteLink() {
            if (!window.LM_PERMS?.action_copy_invite) {
                showNotification('You do not have permission to copy invite links. Requires action_copy_invite permission.', 'error');
                return;
            }
            const out = document.getElementById('invite-output-url');
            if (!out || !out.value.trim()) {
                showNotification('Nothing to copy yet. Generate an invite link first.', 'error');
                return;
            }
            const url = out.value.trim();
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(url);
                } else {
                    out.select();
                    document.execCommand('copy');
                }
                showNotification('Invite link copied to clipboard.', 'success');
            } catch (e) {
                console.error('Clipboard error:', e);
                showNotification('Failed to copy invite link. You can copy it manually from the input field.', 'error');
            }
        }

        let marketplaceExtensions = [];

        async function fetchMarketplaceExtensions() {
            if (!window.LM_PERMS?.action_refresh_marketplace && !window.LM_PERMS?.action_fetch_marketplace) {
                showNotification('You do not have permission to refresh marketplace. Requires action_refresh_marketplace permission.', 'error');
                return;
            }
            const content = document.getElementById('marketplace-content');
            content.innerHTML = '<div class="loading">Loading extensions...</div>';
            
            // Use 60 attempts (30 seconds) to match API timeout
            sendCommandWithResponse('fetch_marketplace_extensions', {}, (data) => {
                if (data && data.success && data.extensions) {
                    marketplaceExtensions = data.extensions;
                    renderMarketplaceExtensions(marketplaceExtensions);
                    showNotification(`Loaded ${marketplaceExtensions.length} extensions`, 'success');
                } else {
                    content.innerHTML = '<div class="empty-state"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="margin-right:8px;display:inline-block;vertical-align:middle;"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> ' + (data.error || 'Failed to load extensions') + '</div>';
                    showNotification(data.error || 'Failed to load extensions', 'error');
                }
            }, 60);
        }
        
        let zygnalIDCache = null;
        
        function refreshZygnalIDCache() {
            if (!window.LM_PERMS?.action_refresh_zygnalid) {
                showNotification('You do not have permission to refresh Zygnalid cache. Requires action_refresh_zygnalid permission.', 'error');
                return;
            }
            // Clear the cached ZygnalID WITHOUT logging it to console
            zygnalIDCache = null;
            showNotification('ZygnalID cache cleared. Next download will read the file fresh.', 'success');
        }

        function renderMarketplaceExtensions(extensions) {
            const content = document.getElementById('marketplace-content');
            
            if (!extensions || extensions.length === 0) {
                content.innerHTML = `
                    <div class="marketplace-empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                        </svg>
                        <h3>No Extensions Found</h3>
                        <p>Click "Refresh Extensions" to load available extensions from the marketplace.</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="marketplace-grid">';
            
            extensions.forEach(ext => {
                const statusLower = ext.status.toLowerCase();
                const statusClass = `marketplace-status-${statusLower}`;
                const statusIcons = {
                    working: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>',
                    beta: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
                    broken: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 18L18 6M6 6l12 12"/></svg>'
                };
                const statusIcon = statusIcons[statusLower] || statusIcons.beta;
                const fileTypeUpper = ext.fileType ? ext.fileType.toUpperCase() : 'COG';
                const downloadDisabled = typeof LM_PERMS !== 'undefined' && !(LM_PERMS.action_download_extension || LM_PERMS.control_marketplace);
                
                html += `
                    <div class="marketplace-extension-card" data-status="${statusLower}" data-title="${ext.title.toLowerCase()}" data-description="${ext.description.toLowerCase()}">
                        <div class="marketplace-ext-status ${statusClass}">
                            ${statusIcon}
                            ${ext.status}
                        </div>
                        
                        <div class="marketplace-ext-banner-wrap">
                            ${ext.banner 
                                ? `<img src="${ext.banner}" class="marketplace-ext-banner" onerror="this.parentElement.innerHTML='<div class=\\'marketplace-ext-banner-placeholder\\'><svg viewBox=\\'0 0 24 24\\' fill=\\'none\\' stroke=\\'currentColor\\' stroke-width=\\'1.5\\'><rect x=\\'3\\' y=\\'3\\' width=\\'18\\' height=\\'18\\' rx=\\'2\\'/><circle cx=\\'8.5\\' cy=\\'8.5\\' r=\\'1.5\\'/><path d=\\'M21 15l-5-5L5 21\\'/></svg></div>'" />`
                                : `<div class="marketplace-ext-banner-placeholder">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <path d="M21 15l-5-5L5 21"/>
                                    </svg>
                                </div>`
                            }
                            <div class="marketplace-ext-banner-overlay"></div>
                        </div>
                        
                        <div class="marketplace-ext-body">
                            <div class="marketplace-ext-header">
                                ${ext.icon 
                                    ? `<img src="${ext.icon}" class="marketplace-ext-icon" onerror="this.outerHTML='<div class=\\'marketplace-ext-icon-placeholder\\'>${ext.title[0]}</div>'" />`
                                    : `<div class="marketplace-ext-icon-placeholder">${ext.title[0]}</div>`
                                }
                                <div class="marketplace-ext-info">
                                    <div class="marketplace-ext-title">${ext.title}</div>
                                    <div class="marketplace-ext-meta">
                                        <span class="marketplace-ext-version">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/></svg>
                                            v${ext.version}
                                        </span>
                                        <span class="marketplace-ext-type">${fileTypeUpper}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="marketplace-ext-description">${ext.description}</div>
                            
                            <div class="marketplace-ext-stats">
                                <div class="marketplace-ext-stat">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg>
                                    <span>ID: <span class="marketplace-ext-stat-value">${ext.id}</span></span>
                                </div>
                                ${ext.downloads ? `
                                <div class="marketplace-ext-stat">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                                    <span class="marketplace-ext-stat-value">${ext.downloads}</span> downloads
                                </div>` : ''}
                            </div>
                            
                            <div class="marketplace-ext-footer">
                                <button class="button marketplace-btn-download extension-download-btn" onclick="downloadExtension(this, ${ext.id})" ${downloadDisabled ? 'disabled title="You do not have permission to download extensions"' : ''}>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                                    </svg>
                                    Download
                                </button>
                                <button class="button marketplace-btn-details" onclick="showExtensionDetails(${ext.id})">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/>
                                    </svg>
                                    Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        function filterMarketplaceExtensions() {
            const searchTerm = document.getElementById('marketplace-search').value.toLowerCase();
            const statusFilter = document.getElementById('marketplace-filter').value;
            
            const filtered = marketplaceExtensions.filter(ext => {
                const matchesSearch = !searchTerm || 
                    ext.title.toLowerCase().includes(searchTerm) || 
                    ext.description.toLowerCase().includes(searchTerm) ||
                    ext.details.toLowerCase().includes(searchTerm);
                
                const matchesStatus = statusFilter === 'all' || ext.status.toLowerCase() === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            renderMarketplaceExtensions(filtered);
        }

        async function downloadExtension(btn, extensionId) {
            // Handle button state
            const originalHTML = btn ? btn.innerHTML : '';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="btn-spinner"></span> Downloading...';
                btn.classList.add('btn-waiting');
            }
            
            const restoreButton = () => {
                if (btn && btn.parentNode) {
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('btn-waiting');
                }
            };
            
            const extension = marketplaceExtensions.find(e => e.id === extensionId);
            if (!extension) {
                showNotification('Extension not found', 'error');
                restoreButton();
                return;
            }
            
            // Read ZygnalID from bot's data file via command
            showNotification('Reading ZygnalID from bot... (this may take a moment)', 'info');
            
            const zygnalIdResult = await new Promise((resolve) => {
                sendCommandWithResponse('read_file', {path: './data/marketplace/ZygnalID.txt'}, (resp) => {
                    console.log('[MARKETPLACE] ZygnalID read result:', resp);
                    resolve(resp);
                }, 30); // Increased timeout to 30 seconds
            });
            
            if (!zygnalIdResult || !zygnalIdResult.success || !zygnalIdResult.content) {
                console.error('[MARKETPLACE] Failed to read ZygnalID:', zygnalIdResult);
                openModal('ZygnalID Not Found', 
                    'ZygnalID file not found or could not be read.\\n\\n' +
                    'Please ensure:\\n' +
                    '1. File exists at: ./data/marketplace/ZygnalID.txt\\n' +
                    '2. File contains your 16-character ZygnalID\\n' +
                    '3. Bot has read permissions\\n\\n' +
                    'Error: ' + (zygnalIdResult?.error || 'File not accessible')
                );
                restoreButton();
                return;
            }
            
            const zygnalId = zygnalIdResult.content.trim();
            console.log('[MARKETPLACE] ZygnalID read:', zygnalId, 'Length:', zygnalId.length);
            
            if (!zygnalId || zygnalId.length < 16) {
                openModal('Invalid ZygnalID', 
                    'ZygnalID must be exactly 16 characters.\\n\\n' +
                    'Current length: ' + (zygnalId ? zygnalId.length : 0) + ' characters\\n' +
                    'Content preview: ' + (zygnalId ? zygnalId.substring(0, 20) : 'empty')
                );
                restoreButton();
                return;
            }
            
            showNotification('Validating ZygnalID...', 'info');
            
            // Use backend to validate to avoid CORS issues
            const validationResult = await new Promise((resolve) => {
                sendCommandWithResponse('validate_zygnal_id', {zygnal_id: zygnalId}, (resp) => {
                    console.log('[MARKETPLACE] Validation result:', resp);
                    resolve(resp);
                }, 30);
            });
            
            if (!validationResult || !validationResult.success) {
                 console.error('[MARKETPLACE] Validation error:', validationResult?.error || 'Unknown error');
                 openModal('Validation Error', 
                    'Failed to validate ZygnalID via bot.\\n\\n' +
                    'Error: ' + (validationResult?.error || 'Bot communication failed') + '\\n\\n' +
                    'Please check your bot connection.'
                );
                restoreButton();
                return;
            }

            if (validationResult.status !== 200) {
                 openModal('ZygnalID Validation Failed', 
                        'Could not connect to validation server.\\n\\n' +
                        'ZygnalID: ' + zygnalId + '\\n' +
                        'Status: ' + validationResult.status + '\\n\\n' +
                        'Please try again later.'
                    );
                    restoreButton();
                    return;
            }

            const validationData = validationResult.data;
            if (!validationData || validationData.valid !== true) {
                 openModal('ZygnalID Not Activated', 
                        'âŒ Your ZygnalID is not activated or is invalid.\\n\\n' +
                        'ZygnalID: ' + zygnalId + '\\n\\n' +
                        'ğŸ“‹ ACTIVATION STEPS:\\n' +
                        '1. Copy your ZygnalID above\\n' +
                        '2. Join ZygnalBot support: discord.gg/sgZnXca5ts\\n' +
                        '3. Verify yourself (enable all channels)\\n' +
                        '4. Go to "Create Ticket" channel\\n' +
                        '5. Open ticket with subject: "zygnal activation"\\n' +
                        '6. Paste your ZygnalID in the ticket\\n\\n' +
                        'â° Activation usually takes 1-24 hours after submission.'
                    );
                    restoreButton();
                    return;
            }
            
            showNotification('ZygnalID validated successfully!', 'success');
            
            const shouldLoad = confirm(`Download ${extension.title}?\\n\\nWould you like to automatically load it after download?`);
            console.log('[MARKETPLACE] Auto-load after download:', shouldLoad);
            
            showNotification(`Downloading ${extension.title}...`, 'info');
            
            sendCommandWithResponse('download_marketplace_extension', { extension, request_id: generateRequestId() }, (response) => {
                console.log('[MARKETPLACE] Download response:', response);
                restoreButton();
                
                if (response && response.success) {
                    // Add success animation to the card
                    if (btn) {
                        const card = btn.closest('.marketplace-extension-card');
                        if (card) {
                            card.classList.add('download-success');
                            setTimeout(() => card.classList.remove('download-success'), 600);
                        }
                    }
                    showNotification(`Downloaded ${extension.title} to ./extensions/`, 'success');
                    
                    if (shouldLoad && response.filepath) {
                        console.log('[MARKETPLACE] Auto-loading extension:', response.filepath);
                        setTimeout(() => {
                            loadDownloadedExtension(response.filepath, extension.title, response.filename);
                        }, 1500);
                    } else if (shouldLoad && !response.filepath) {
                        console.warn('[MARKETPLACE] Cannot auto-load: filepath not provided in response');
                        showNotification('Downloaded successfully, but auto-load failed. Please load manually from Plugins & Extensions tab.', 'warning');
                    }
                } else {
                    const errorMsg = response.error || 'Download failed';
                    
                    if (response.error_type === 'zygnal_id_not_activated') {
                        let formattedMsg = errorMsg
                            .replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>')
                            // Use hex escape \\x60 for backtick to avoid syntax errors in generated code
                            .replace(/\\x60(.+?)\\x60/g, '<code style="background:rgba(0,0,0,0.3);padding:2px 6px;border-radius:4px;">$1</code>')
                            .replace(/\\n\\n/g, '<br/><br/>')
                            .replace(/\\n/g, '<br/>');
                        
                        openModal('Download Failed - Activation Required', 
                            `<div style="font-size:14px;line-height:1.8;color:#e6edf3;">${formattedMsg}</div>`);
                    } else {
                        showNotification(errorMsg, 'error');
                    }
                }
            }, 120);
        }

        function loadDownloadedExtension(filepath, extensionName, filenameOverride) {
            let filename;
            if (filenameOverride) {
                filename = filenameOverride;
            } else {
                const separator = (platformOS === 'Windows') ? '\\\\' : '/';
                filename = filepath.split(separator).pop() || filepath.split(/[\\\\/]/).pop();
            }
            
            console.log('[MARKETPLACE] Loading extension from filepath:', filepath, 'filename:', filename);
            showNotification(`Attempting to load ${extensionName}...`, 'info');

            sendCommandWithResponse('load_downloaded_extension', { filepath: filepath, filename: filename }, (response) => {
                console.log('[MARKETPLACE] Load response:', response);
                if (response && response.success) {
                    showNotification(response.message || `Successfully loaded ${extensionName}`, 'success');
                    
                    setTimeout(refreshPlugins, 1000);
                } else {
                    showNotification(response.error || `Failed to load ${extensionName}. Check bot logs.`, 'error');
                }
            });
        }

        function renderMarkdown(text) {
            if (!text) return '';
            
            // Escape HTML first
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Code blocks (```) - must be before inline code
            html = html.replace(/```([\\\\s\\\\S]*?)```/g, '<pre class="md-code-block">$1</pre>');
            
            // Inline code (`)
            html = html.replace(/`([^`]+)`/g, '<code class="md-inline-code">$1</code>');
            
            // Headers (### ## #)
            html = html.replace(/^### (.+)$/gm, '<h4 class="md-h4">$1</h4>');
            html = html.replace(/^## (.+)$/gm, '<h3 class="md-h3">$1</h3>');
            html = html.replace(/^# (.+)$/gm, '<h2 class="md-h2">$1</h2>');
            
            // Bold (**text** or __text__)
            html = html.replace(/\\*\\*([^*]+)\\*\\*/g, '<strong class="md-bold">$1</strong>');
            html = html.replace(/__([^_]+)__/g, '<strong class="md-bold">$1</strong>');
            
            // Italic (*text* or _text_)
            html = html.replace(/\\*([^*]+)\\*/g, '<em class="md-italic">$1</em>');
            html = html.replace(/_([^_]+)_/g, '<em class="md-italic">$1</em>');
            
            // Strikethrough (~~text~~)
            html = html.replace(/~~([^~]+)~~/g, '<del class="md-strike">$1</del>');
            
            // Unordered lists (- item or * item)
            html = html.replace(/^[\\-\\*] (.+)$/gm, '<li class="md-li">$1</li>');
            html = html.replace(/(<li class="md-li">.*<\\/li>\\\\n?)+/g, '<ul class="md-ul">$&</ul>');
            
            // Ordered lists (1. item)
            html = html.replace(/^\\d+\\. (.+)$/gm, '<li class="md-li-num">$1</li>');
            html = html.replace(/(<li class="md-li-num">.*<\\/li>\\\\n?)+/g, '<ol class="md-ol">$&</ol>');
            
            // Blockquotes (> text)
            html = html.replace(/^&gt; (.+)$/gm, '<blockquote class="md-quote">$1</blockquote>');
            
            // Horizontal rule (---)
            html = html.replace(/^---$/gm, '<hr class="md-hr"/>');
            
            // Links [text](url)
            html = html.replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, '<a href="$2" target="_blank" class="md-link">$1</a>');
            
            // Line breaks
            html = html.replace(/\\\\n/g, '<br/>');
            
            // Clean up double <br/> after block elements
            html = html.replace(/(<\\/h[234]>)<br\\/>/g, '$1');
            html = html.replace(/(<\\/pre>)<br\\/>/g, '$1');
            html = html.replace(/(<\\/ul>)<br\\/>/g, '$1');
            html = html.replace(/(<\\/ol>)<br\\/>/g, '$1');
            html = html.replace(/(<\\/blockquote>)<br\\/>/g, '$1');
            html = html.replace(/(<hr class="md-hr"\\/>)<br\\/>/g, '$1');
            
            return html;
        }

        function showExtensionDetails(extensionId) {
            const ext = marketplaceExtensions.find(e => e.id === extensionId);
            if (!ext) return;
            
            const statusLower = ext.status.toLowerCase();
            const statusIcons = {
                working: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>',
                beta: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
                broken: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 18L18 6M6 6l12 12"/></svg>'
            };
            const statusIcon = statusIcons[statusLower] || statusIcons.beta;
            const fileTypeUpper = ext.fileType ? ext.fileType.toUpperCase() : 'COG';
            
            const renderedDetails = renderMarkdown(ext.details || 'No additional details provided.');
            const downloadDisabled = typeof LM_PERMS !== 'undefined' && !(LM_PERMS.action_download_extension || LM_PERMS.control_marketplace);
            
            const html = `
                <div class="ext-modal-container">
                    ${ext.banner 
                        ? `<img src="${ext.banner}" class="ext-modal-banner" onerror="this.outerHTML='<div class=\\'ext-modal-banner-placeholder\\'><svg viewBox=\\'0 0 24 24\\' fill=\\'none\\' stroke=\\'currentColor\\' stroke-width=\\'1.5\\'><rect x=\\'3\\' y=\\'3\\' width=\\'18\\' height=\\'18\\' rx=\\'2\\'/><circle cx=\\'8.5\\' cy=\\'8.5\\' r=\\'1.5\\'/><path d=\\'M21 15l-5-5L5 21\\'/></svg></div>'" />`
                        : `<div class="ext-modal-banner-placeholder">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <path d="M21 15l-5-5L5 21"/>
                            </svg>
                        </div>`
                    }
                    
                    <div class="ext-modal-header">
                        ${ext.icon 
                            ? `<img src="${ext.icon}" class="ext-modal-icon" onerror="this.outerHTML='<div class=\\'ext-modal-icon-placeholder status-${statusLower}\\'>${ext.title[0]}</div>'" />`
                            : `<div class="ext-modal-icon-placeholder status-${statusLower}">${ext.title[0]}</div>`
                        }
                        <div class="ext-modal-title-section">
                            <h2 class="ext-modal-title">${ext.title}</h2>
                            <div class="ext-modal-meta">
                                <span class="ext-modal-meta-pill status ${statusLower}">
                                    ${statusIcon}
                                    ${ext.status}
                                </span>
                                <span class="ext-modal-meta-pill version">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m11-7h-6m-6 0H1m15.36-5.64l-4.24 4.24m0 2.83l4.24 4.24M6.64 6.64l4.24 4.24m0 2.83l-4.24 4.24"/></svg>
                                    v${ext.version}
                                </span>
                                <span class="ext-modal-meta-pill type">${fileTypeUpper}</span>
                                <span class="ext-modal-meta-pill id">#${ext.id}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ext-modal-description">${ext.description}</div>
                    
                    <div class="ext-modal-details-section">
                        <div class="ext-modal-details-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10 9 9 9 8 9"/>
                            </svg>
                            Documentation & Details
                        </div>
                        <div class="ext-modal-details-content">${renderedDetails}</div>
                    </div>
                    
                    <div class="ext-modal-actions">
                        <button class="button marketplace-btn-download" onclick="closeModal(); downloadExtension(null, ${ext.id});" ${downloadDisabled ? 'disabled title="You do not have permission to download extensions"' : ''}>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                            </svg>
                            Download Extension
                        </button>
                        <button class="button marketplace-btn-details" onclick="closeModal();">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            openModal(ext.title, html);
        }

        function interpretHttpError(status, payload, context) {
            // context: 'command', 'file', 'roles', 'database', etc.
            if (status === 403) {
                const base = context === 'roles'
                    ? 'You do not have permission to manage Roles & Access on this dashboard.'
                    : context === 'file'
                        ? 'You do not have permission to perform this file operation.'
                        : context === 'database'
                            ? 'You do not have permission to view the dashboard database.'
                            : 'You do not have permission to perform this action.';
                let extra = '';
                if (payload && typeof payload === 'object') {
                    if (payload.error) {
                        extra = ' Details: ' + payload.error;
                    } else if (payload.reason) {
                        extra = ' Details: ' + payload.reason;
                    } else if (payload.message) {
                        extra = ' Details: ' + payload.message;
                    }
                }
                return base + extra;
            }
            if (status === 401) {
                return 'Your session expired or you are not logged in. Please reload the page and log in again.';
            }
            if (status >= 500) {
                return 'The dashboard backend returned an internal error (' + status + '). Check your hosting logs.';
            }
            return 'Request failed with HTTP ' + status + '. Please check the browser console for details.';
        }

        function sendCommand(command, params) {
            if (isCommandPending) {
                showNotification('Please wait, a command is already being processed...', 'info');
                return;
            }

            isCommandPending = true;
            showNotification('Sending command...', 'info');

            fetch('./send_command.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin',
                body: JSON.stringify({ command: command, params: params })
            })
            .then(async r => {
                let payload = null;
                try {
                    payload = await r.json();
                } catch (_) {
                    // ignore JSON parse errors
                }
                if (!r.ok) {
                    const msg = interpretHttpError(r.status, payload, 'command');
                    throw new Error(msg);
                }
                return payload || {};
            })
            .then(data => {
                isCommandPending = false;
                showNotification('Command sent successfully', 'success');
                setTimeout(loadData, 1000);
            })
            .catch(err => {
                isCommandPending = false;
                console.error('Command error:', err);
                showNotification(err.message || 'Error while sending command.', 'error');
            });
        }

        // Send command with button state management (disables button, shows "Waiting...")
        function sendCommandWithButton(btn, command, params) {
            if (isCommandPending) {
                showNotification('Please wait, a command is already being processed...', 'info');
                return;
            }

            // Store original button state
            const originalText = btn.innerHTML;
            const originalDisabled = btn.disabled;
            
            // Disable button and show waiting state
            btn.disabled = true;
            btn.innerHTML = '<span class="btn-spinner"></span> Waiting...';
            btn.classList.add('btn-waiting');

            isCommandPending = true;
            showNotification('Sending command...', 'info');

            fetch('./send_command.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin',
                body: JSON.stringify({ command: command, params: params })
            })
            .then(async r => {
                let payload = null;
                try {
                    payload = await r.json();
                } catch (_) {
                    // ignore JSON parse errors
                }
                if (!r.ok) {
                    const msg = interpretHttpError(r.status, payload, 'command');
                    throw new Error(msg);
                }
                return payload || {};
            })
            .then(data => {
                isCommandPending = false;
                showNotification('Command sent successfully', 'success');
                // Keep button disabled until data refreshes
                setTimeout(() => {
                    loadData();
                    // Restore button after data loads (the UI will re-render anyway)
                    setTimeout(() => {
                        if (btn && btn.parentNode) {
                            btn.disabled = originalDisabled;
                            btn.innerHTML = originalText;
                            btn.classList.remove('btn-waiting');
                        }
                    }, 500);
                }, 1000);
            })
            .catch(err => {
                isCommandPending = false;
                console.error('Command error:', err);
                showNotification(err.message || 'Error while sending command.', 'error');
                // Restore button on error
                btn.disabled = originalDisabled;
                btn.innerHTML = originalText;
                btn.classList.remove('btn-waiting');
            });
        }

        function sendCommandWithResponse(command, params, callback, maxAttempts = 30) {
            if (isCommandPending) {
                showNotification('Please wait, a command is already being processed...', 'info');
                return;
            }

            isCommandPending = true;
            const expectedCommandType = command; // Match command type to sent command

            fetch('./send_command.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin',
                body: JSON.stringify({ command: command, params: params })
            })
            .then(async r => {
                let payload = null;
                try {
                    payload = await r.json();
                } catch (_) {
                    // ignore JSON parse errors
                }
                if (!r.ok) {
                    const msg = interpretHttpError(r.status, payload, 'command');
                    throw new Error(msg);
                }
                return payload || {};
            })
            .then(data => {
                // Poll for fileops response
                let attempts = 0;
                const pollInterval = setInterval(() => {
                    attempts++;
                    fetch('monitor_data_fileops.json?t=' + Date.now())
                        .then(r => {
                            // 404 is expected when bot hasn't written response yet
                            if (!r.ok && r.status !== 404) {
                                throw new Error(`HTTP ${r.status}`);
                            }
                            return r.status === 404 ? null : r.json();
                        })
                        .then(fileops => {
                            if (fileops && (fileops.success !== undefined || fileops.error !== undefined)) {
                                const responseType = fileops.command_type || fileops.type;
                                if (responseType && responseType !== expectedCommandType) {
                                    console.log(`[FILEOPS] Ignoring response for ${responseType}, waiting for ${expectedCommandType}`);
                                    return; // Continue polling
                                }
                                
                                clearInterval(pollInterval);
                                isCommandPending = false;
                                callback(fileops);
                            } else if (attempts >= maxAttempts) {
                                clearInterval(pollInterval);
                                isCommandPending = false;
                                showNotification('Command timeout - no response received after ' + (maxAttempts/2) + ' seconds', 'error');
                                callback({ success: false, error: 'Timeout waiting for bot response' });
                            }
                        })
                        .catch(err => {
                            // Only fail on max attempts to allow transient errors
                            if (attempts >= maxAttempts) {
                                clearInterval(pollInterval);
                                isCommandPending = false;
                                showNotification('Error polling for response: ' + err.message, 'error');
                                callback({ success: false, error: err.message });
                            }
                        });
                }, 500);
            })
            .catch(err => {
                isCommandPending = false;
                console.error('Command error:', err);
                showNotification(err.message || 'Error while sending command.', 'error');
                callback({ success: false, error: err.message });
            });
        }

        function refreshPlugins() {
            alert('Refreshing plugins and extensions data...');
            loadData();
        }
        
        function viewPluginStatus(plugin) {
            let statusContent = '';
            
            if (plugin.deps_ok && !plugin.has_conflicts && !plugin.has_cycle && plugin.scan_errors.length === 0) {
                statusContent = `
                    <div style="padding: 20px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;"></div>
                        <h3 style="color: var(--success); margin-bottom: 12px;">Plugin is Healthy!</h3>
                        <p style="color: var(--text-secondary);">No issues detected with ${plugin.name}</p>
                        <div style="margin-top: 20px; padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3);">
                            <div class="property">
                                <span class="property-label">Dependencies</span>
                                <span class="property-value" style="color: var(--success);">âœ“ All satisfied</span>
                            </div>
                            <div class="property">
                                <span class="property-label">Conflicts</span>
                                <span class="property-value" style="color: var(--success);">âœ“ None detected</span>
                            </div>
                            <div class="property">
                                <span class="property-label">Circular Dependencies</span>
                                <span class="property-value" style="color: var(--success);">âœ“ None detected</span>
                            </div>
                            <div class="property">
                                <span class="property-label">Scan Errors</span>
                                <span class="property-value" style="color: var(--success);">âœ“ No errors</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const issues = [];
                
                if (!plugin.deps_ok && plugin.dep_messages && plugin.dep_messages.length > 0) {
                    issues.push({
                        title: 'âŒ Dependency Issues',
                        items: plugin.dep_messages,
                        color: 'var(--danger)'
                    });
                }
                
                if (plugin.has_conflicts && plugin.conflict_messages && plugin.conflict_messages.length > 0) {
                    issues.push({
                        title: 'âš ï¸ Conflicts Detected',
                        items: plugin.conflict_messages,
                        color: 'var(--warning)'
                    });
                }
                
                if (plugin.has_cycle) {
                    issues.push({
                        title: 'Circular Dependency',
                        items: ['This plugin has a circular dependency that could cause loading issues'],
                        color: 'var(--danger)'
                    });
                }
                
                if (plugin.scan_errors && plugin.scan_errors.length > 0) {
                    issues.push({
                        title: 'âš ï¸ Scan Errors',
                        items: plugin.scan_errors,
                        color: 'var(--warning)'
                    });
                }
                
                statusContent = `
                    <div style="padding: 20px;">
                        <div style="text-align: center; margin-bottom: 24px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
                            <h3 style="color: var(--danger); margin-bottom: 8px;">Plugin Has Issues</h3>
                            <p style="color: var(--text-secondary);">${issues.length} issue${issues.length > 1 ? 's' : ''} detected with ${plugin.name}</p>
                        </div>
                        ${issues.map(issue => `
                            <div style="margin-bottom: 20px; padding: 16px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3);">
                                <h4 style="color: ${issue.color}; margin-bottom: 12px;">${issue.title}</h4>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    ${issue.items.map(item => `
                                        <li style="padding: 8px 0; border-bottom: 1px solid var(--border); color: var(--text-secondary); font-size: 14px;">
                                            ${item}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        `).join('')}
                        <div style="margin-top: 20px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">
                            <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">
                                ğŸ’¡ <strong>Tip:</strong> Fix these issues to ensure the plugin works correctly
                            </p>
                        </div>
                    </div>
                `;
            }
            
            showModal('Plugin Status: ' + plugin.name, statusContent);
        }

        function viewPluginDetails(plugin) {
            const content = `
                <div style="padding: 20px;">
                    <div class="property-group" style="margin-bottom: 24px;">
                        <h4 style="color: #58a6ff; margin-bottom: 12px; font-size: 16px; font-weight: 600;">General Information</h4>
                        <div class="property">
                            <span class="property-label">Name</span>
                            <span class="property-value">${plugin.name}</span>
                        </div>
                        <div class="property">
                            <span class="property-label">Version</span>
                            <span class="property-value">${plugin.version}</span>
                        </div>
                        <div class="property">
                            <span class="property-label">Author</span>
                            <span class="property-value">${plugin.author}</span>
                        </div>
                        <div class="property">
                            <span class="property-label">Description</span>
                            <span class="property-value">${plugin.description || 'No description'}</span>
                        </div>
                        <div class="property">
                            <span class="property-label">Loaded At</span>
                            <span class="property-value" style="font-size: 11px; font-family: monospace;">${plugin.loaded_at}</span>
                        </div>
                        <div class="property">
                            <span class="property-label">Load Time</span>
                            <span class="property-value">${Math.round((plugin.load_time || 0) * 1000)}ms</span>
                        </div>
                        ${plugin.file_path ? `
                        <div class="property">
                            <span class="property-label">File Path</span>
                            <span class="property-value" style="font-size: 11px; font-family: monospace;">${plugin.file_path}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="property-group" style="margin-bottom: 24px;">
                        <h4 style="color: #58a6ff; margin-bottom: 12px; font-size: 16px; font-weight: 600;">Features</h4>
                        <div class="property">
                            <span class="property-label">Commands</span>
                            <span class="property-value">${plugin.commands_count || 0}</span>
                        </div>
                        <div class="property">
                            <span class="property-label">Cogs</span>
                            <span class="property-value">${(plugin.cogs || []).length}</span>
                        </div>
                        ${(plugin.provides_hooks || []).length > 0 ? `
                        <div class="property">
                            <span class="property-label">Provides Hooks</span>
                            <span class="property-value">${(plugin.provides_hooks || []).join(', ')}</span>
                        </div>
                        ` : ''}
                        ${(plugin.listens_to_hooks || []).length > 0 ? `
                        <div class="property">
                            <span class="property-label">Listens to Hooks</span>
                            <span class="property-value">${(plugin.listens_to_hooks || []).join(', ')}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${(plugin.commands || []).length > 0 ? `
                    <div class="property-group" style="margin-bottom: 24px;">
                        <h4 style="color: #58a6ff; margin-bottom: 12px; font-size: 16px; font-weight: 600;">Commands (${plugin.commands.length})</h4>
                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                            ${(plugin.commands || []).map(cmd => 
                                `<span class="badge" style="background: #1e3a8a; font-size: 12px;">${cmd}</span>`
                            ).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${(plugin.cogs || []).length > 0 ? `
                    <div class="property-group" style="margin-bottom: 24px;">
                        <h4 style="color: #58a6ff; margin-bottom: 12px; font-size: 16px; font-weight: 600;">Cogs (${plugin.cogs.length})</h4>
                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                            ${(plugin.cogs || []).map(cog => 
                                `<span class="badge badge-secondary" style="font-size: 12px;">${cog}</span>`
                            ).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${Object.keys(plugin.dependencies || {}).length > 0 ? `
                    <div class="property-group" style="margin-bottom: 24px;">
                        <h4 style="color: #58a6ff; margin-bottom: 12px; font-size: 16px; font-weight: 600;">Dependencies</h4>
                        ${Object.entries(plugin.dependencies || {}).map(([name, version]) => `
                            <div class="property">
                                <span class="property-label">${name}</span>
                                <span class="property-value">${version}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${(plugin.conflicts_with || []).length > 0 ? `
                    <div class="property-group" style="margin-bottom: 24px;">
                        <h4 style="color: #ef4444; margin-bottom: 12px; font-size: 16px; font-weight: 600;">Conflicts With</h4>
                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                            ${(plugin.conflicts_with || []).map(conflict => 
                                `<span class="badge badge-warning" style="font-size: 12px;">${conflict}</span>`
                            ).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            showModal('Plugin Details: ' + plugin.name, content);
        }

        function viewHookDetails(hook) {
            let content = `
                <div class="property">
                    <span class="property-label">Hook ID</span>
                    <span class="property-value" style="font-size: 11px; font-family: monospace;">${hook.hook_id}</span>
                </div>
                <div class="property">
                    <span class="property-label">Event</span>
                    <span class="property-value">${hook.event}</span>
                </div>
                <div class="property">
                    <span class="property-label">Callback</span>
                    <span class="property-value">${hook.callback}</span>
                </div>
                <div class="property">
                    <span class="property-label">Priority</span>
                    <span class="property-value">${hook.priority}</span>
                </div>
                <div class="property">
                    <span class="property-label">Executions</span>
                    <span class="property-value">${hook.execution_count}</span>
                </div>
                <div class="property">
                    <span class="property-label">Failures</span>
                    <span class="property-value">${hook.failure_count}</span>
                </div>
                <div class="property">
                    <span class="property-label">Avg Time</span>
                    <span class="property-value">${hook.avg_time_ms}ms</span>
                </div>
                <div class="property">
                    <span class="property-label">Status</span>
                    <span class="property-value">
                        <span class="badge" style="background: ${hook.disabled ? '#6b7280' : hook.circuit_open ? '#f59e0b' : '#3b82f6'};">
                            ${hook.disabled ? 'Disabled' : hook.circuit_open ? 'Circuit Open' : 'Active'}
                        </span>
                    </span>
                </div>
            `;

            if (hook.execution_history && hook.execution_history.length > 0) {
                content += `
                    <h3 style="margin-top: 20px; margin-bottom: 12px; color: #58a6ff;">Execution History (Last ${hook.execution_history.length})</h3>
                    <div class="execution-history">
                `;
                
                hook.execution_history.slice().reverse().forEach(entry => {
                    const badge = entry.success ? 
                        '<span class="badge" style="background: #3b82f6;">Success</span>' : 
                        '<span class="badge" style="background: #ef4444;">Failure</span>';
                    
                    const errorText = entry.error ? `<div style="margin-top: 8px; color: #ef4444; font-size: 12px;">Error: ${entry.error}</div>` : '';
                    
                    content += `
                        <div class="history-item ${entry.success ? 'success' : 'failure'}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                ${badge}
                                <span style="font-size: 11px; color: var(--text-secondary);">${formatTime(entry.timestamp)}</span>
                            </div>
                            <div style="font-size: 13px;">Execution Time: <strong>${entry.execution_time_ms}ms</strong></div>
                            ${errorText}
                        </div>
                    `;
                });
                
                content += '</div>';
            }

            content += `
                <div class="button-group">
                    <button class="button button-${hook.disabled ? 'success' : 'danger'}" onclick="sendCommandWithButton(this, '${hook.disabled ? 'enable_hook' : 'disable_hook'}', {hook_id: this.getAttribute('data-hook-id')})" data-hook-id="${hook.hook_id}">
                        ${hook.disabled ? 'Enable Hook' : 'Disable Hook'}
                    </button>
                    ${hook.circuit_open ? `
                        <button class="button button-secondary" onclick="sendCommandWithButton(this, 'reset_circuit', {hook_id: this.getAttribute('data-hook-id')})" data-hook-id="${hook.hook_id}">
                            Reset Circuit
                        </button>
                    ` : ''}
                </div>
            `;

            openModal('Hook Details', content);
        }

        window.refreshHooks = () => {
            showNotification('Refreshing Event Hooks...', 'info');
            loadData();
        };

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatTime(isoString) {
            if (!isoString) return 'Never';
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        let currentCommandView = 'all';
        let currentCommandSort = 'name';

        function renderCommands(commands) {
            const container = document.getElementById('commands-list');
            
            if (commands.length === 0) {
                container.innerHTML = '<div class="empty-state">No commands found</div>';
                return;
            }
            
            const slashCount = commands.filter(c => c.type === 'slash').length;
            const prefixCount = commands.filter(c => (c.type === 'prefix' || c.type === 'prefix_only')).length;
            const hybridCount = commands.filter(c => c.type === 'hybrid').length;
            const uniqueCogs = new Set(commands.map(c => c.cog).filter(Boolean)).size;
            const totalUsage = commands.reduce((sum, c) => sum + (c.usage_count || 0), 0);
            const totalErrors = commands.reduce((sum, c) => sum + (c.error_count || 0), 0);
            const successRate = totalUsage > 0 ? Math.round(((totalUsage - totalErrors) / totalUsage) * 100) : 100;
            
            document.getElementById('cmd-total').textContent = commands.length;
            document.getElementById('cmd-slash').textContent = slashCount;
            document.getElementById('cmd-prefix').textContent = prefixCount;
            document.getElementById('cmd-hybrid').textContent = hybridCount;
            document.getElementById('cmd-cogs').textContent = uniqueCogs;
            document.getElementById('cmd-usage').textContent = totalUsage;
            document.getElementById('cmd-errors').textContent = totalErrors;
            document.getElementById('cmd-success').textContent = successRate + '%';
            
            const viewButtons = document.querySelectorAll('#tab-commands .cmd-view-btn');
            viewButtons.forEach(btn => {
                btn.onclick = () => {
                    viewButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCommandView = btn.dataset.view;
                    renderCommandsList();
                };
            });
            
            const searchInput = document.getElementById('cmd-search');
            const sortSelect = document.getElementById('cmd-sort');
            
            searchInput.oninput = renderCommandsList;
            sortSelect.onchange = () => {
                currentCommandSort = sortSelect.value;
                renderCommandsList();
            };
            
            renderCommandsList();
            
            function renderCommandsList() {
                const searchTerm = searchInput.value.toLowerCase();
                
                let filteredCommands = commands.filter(cmd => {
                    const matchesSearch = !searchTerm || 
                        cmd.name.toLowerCase().includes(searchTerm) ||
                        (cmd.description || '').toLowerCase().includes(searchTerm) ||
                        (cmd.cog || '').toLowerCase().includes(searchTerm);
                    
                    const matchesFilter =
                        currentCommandView === 'all' ||
                        (currentCommandView === 'slash' && cmd.type === 'slash') ||
                        (currentCommandView === 'prefix' && (cmd.type === 'prefix' || cmd.type === 'prefix_only')) ||
                        (currentCommandView === 'hybrid' && cmd.type === 'hybrid');
                    
                    return matchesSearch && matchesFilter;
                });
                
                filteredCommands.sort((a, b) => {
                    switch (currentCommandSort) {
                        case 'name':
                            return a.name.localeCompare(b.name);
                        case 'usage':
                            return (b.usage_count || 0) - (a.usage_count || 0);
                        case 'errors':
                            return (b.error_count || 0) - (a.error_count || 0);
                        case 'cog':
                            return (a.cog || '').localeCompare(b.cog || '');
                        default:
                            return 0;
                    }
                });
                
                if (filteredCommands.length === 0) {
                    container.innerHTML = '<div class="empty-state">No commands found</div>';
                    return;
                }
                
                container.innerHTML = filteredCommands.map((cmd, idx) => {
                    const typeColors = {
                        'slash': '#3b82f6',
                        'hybrid': '#10b981',
                        'prefix': '#6b7280',
                        'prefix_only': '#6b7280'
                    };
                    const typeColor = typeColors[cmd.type] || '#6b7280';
                    
                    const hasErrors = (cmd.error_count || 0) > 0;
                    const cmdSuccessRate = (cmd.usage_count || 0) > 0 ? 
                        Math.round(((cmd.usage_count - (cmd.error_count || 0)) / cmd.usage_count) * 100) : 100;

                    const globalPrefix = (typeof DEFAULT_PREFIX !== 'undefined' && DEFAULT_PREFIX) ? DEFAULT_PREFIX : '!';
                    const baseName = cmd.name;
                    let invocationChips = '';

                    if (cmd.type === 'hybrid') {
                        const prefixCall = `${globalPrefix}${baseName}`;
                        const slashCall = `/${baseName}`;
                        invocationChips = `
                            <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 6px;">
                                <span class="badge" style="background: #1e3a8a; font-size: 11px;">${prefixCall}</span>
                                <span class="badge" style="background: #3b82f6; font-size: 11px;">${slashCall}</span>
                            </div>
                        `;
                    } else if (cmd.type === 'slash') {
                        const slashCall = `/${baseName}`;
                        invocationChips = `
                            <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 6px;">
                                <span class="badge" style="background: #3b82f6; font-size: 11px;">${slashCall}</span>
                            </div>
                        `;
                    } else {
                        const prefixCall = `${globalPrefix}${baseName}`;
                        invocationChips = `
                            <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 6px;">
                                <span class="badge" style="background: #1e3a8a; font-size: 11px;">${prefixCall}</span>
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="file-row" style="flex-direction: column; align-items: stretch; padding: 10px 12px; margin-bottom: 6px; border: 1px solid #30363d; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; font-weight: 600; color: #58a6ff; margin-bottom: 2px;">
                                        ${cmd.name}
                                    </div>
                                    ${invocationChips}
                                    <div style="font-size: 12px; color: #8b949e; margin-bottom: 6px;">
                                        ${cmd.description || 'No description'}
                                    </div>
                                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                        <span class="badge" style="background: ${typeColor}; font-size: 10px;">${cmd.type.toUpperCase()}</span>
                                        ${cmd.cog ? `<span class="badge" style="background: #1e40af; font-size: 10px;">${cmd.cog}</span>` : ''}
                                        ${hasErrors ? '<span class="badge" style="background: #ef4444; font-size: 10px;">Has Errors</span>' : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 6px; margin-bottom: 8px; padding: 6px 8px; background: rgba(13, 17, 23, 0.5); border-radius: 6px; border: 1px solid rgba(59, 130, 246, 0.25);">
                                <div>
                                    <div style="font-size: 10px; color: #8b949e; text-transform: uppercase;">Usage</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #60a5fa;">${cmd.usage_count || 0}</div>
                                </div>
                                <div>
                                    <div style="font-size: 10px; color: #8b949e; text-transform: uppercase;">Errors</div>
                                    <div style="font-size: 14px; font-weight: 600; color: ${hasErrors ? '#f87171' : '#60a5fa'};">${cmd.error_count || 0}</div>
                                </div>
                                <div>
                                    <div style="font-size: 10px; color: #8b949e; text-transform: uppercase;">Success</div>
                                    <div style="font-size: 14px; font-weight: 600; color: #60a5fa;">${cmdSuccessRate}%</div>
                                </div>
                                <div>
                                    <div style="font-size: 10px; color: #8b949e; text-transform: uppercase;">Last Used</div>
                                    <div style="font-size: 12px; font-weight: 600; color: #60a5fa;">${cmd.last_used ? formatTime(cmd.last_used) : 'Never'}</div>
                                </div>
                            </div>
                            
                            ${(cmd.params && cmd.params.length > 0) || (cmd.subcommands && cmd.subcommands.length > 0) ? `
                            <div style="margin-bottom: 8px;">
                                ${cmd.params && cmd.params.length > 0 ? `
                                <div style="margin-bottom: 6px;">
                                    <div style="font-size: 11px; color: #8b949e; margin-bottom: 4px;">Parameters (${cmd.params.length}):</div>
                                    <div style="display: flex; gap: 3px; flex-wrap: wrap;">
                                        ${cmd.params.map(param => {
                                            const required = param.required !== false;
                                            const paramName = typeof param === 'string' ? param : (param.name || param);
                                            const paramType = typeof param === 'object' ? param.type : '';
                                            const paramDesc = typeof param === 'object' ? param.description : '';
                                            return `<span class="badge" style="background: ${required ? '#1e40af' : '#374151'}; font-size: 10px;" title="${paramDesc || paramName}">
                                                ${paramName}${paramType ? `: ${paramType}` : ''}${required ? '' : ' (optional)'}
                                            </span>`;
                                        }).join('')}
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${cmd.subcommands && cmd.subcommands.length > 0 ? `
                                <div>
                                    <div style="font-size: 11px; color: #8b949e; margin-bottom: 4px;">Subcommands (${cmd.subcommands.length}):</div>
                                    <div style="display: flex; gap: 3px; flex-wrap: wrap;">
                                        ${cmd.subcommands.slice(0, 10).map(sub => {
                                            const subName = typeof sub === 'string' ? sub : (sub.name || sub);
                                            const subDesc = typeof sub === 'object' ? sub.description : '';
                                            return `<span class="badge" style="background: #7c3aed; font-size: 10px;" title="${subDesc || subName}">${subName}</span>`;
                                        }).join('')}
                                        ${cmd.subcommands.length > 10 ? `<span class="badge" style="background: #6b7280; font-size: 10px;">+${cmd.subcommands.length - 10} more</span>` : ''}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            ` : ''}
                            
                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                <button class="button button-primary" onclick="viewCommandDetails(${JSON.stringify(cmd).replace(/"/g, '&quot;')})" style="padding: 6px 10px; font-size: 11px; box-shadow: none;">
                                    View Details
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        window.refreshCommands = () => {
            showNotification('Refreshing Commands...', 'info');
            loadData();
        };

        function viewCommandDetails(cmd) {
            const globalPrefix = (typeof DEFAULT_PREFIX !== 'undefined' && DEFAULT_PREFIX) ? DEFAULT_PREFIX : '!';
            let invocationText = '';
            if (cmd.type === 'hybrid') {
                invocationText = `${globalPrefix}${cmd.name}  or  /${cmd.name}`;
            } else if (cmd.type === 'slash') {
                invocationText = `/${cmd.name}`;
            } else {
                invocationText = `${globalPrefix}${cmd.name}`;
            }

            let content = `
                <div style="padding: 20px;">
                    <div class="property-group" style="margin-bottom: 24px;">
                        <h4 style="color: #58a6ff; margin-bottom: 12px; font-size: 16px; font-weight: 600;">General Information</h4>
                        <div class="property">
                            <span class="property-label">Name</span>
                            <span class="property-value">${cmd.name}</span>
                        </div>
                        <div class="property">
                            <span class="property-label">Description</span>
                            <span class="property-value">${cmd.description || 'No description'}</span>
                        </div>
                        <div class="property">
                            <span class="property-label">Type</span>
                            <span class="property-value">${cmd.type.toUpperCase()}</span>
                        </div>
                        <div class="property">
                            <span class="property-label">Invocation</span>
                            <span class="property-value" style="font-family: monospace;">${invocationText}</span>
                        </div>
                        ${cmd.cog ? `
                        <div class="property">
                            <span class="property-label">Cog</span>
                            <span class="property-value">${cmd.cog}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="property-group" style="margin-bottom: 24px;">
                        <h4 style="color: #58a6ff; margin-bottom: 12px; font-size: 16px; font-weight: 600;">Usage Statistics</h4>
                        <div class="property">
                            <span class="property-label">Total Uses</span>
                            <span class="property-value">${cmd.usage_count || 0}</span>
                        </div>
                        <div class="property">
                            <span class="property-label">Errors</span>
                            <span class="property-value">${cmd.error_count || 0}</span>
                        </div>
                        <div class="property">
                            <span class="property-label">Success Rate</span>
                            <span class="property-value">${cmd.usage_count > 0 ? Math.round(((cmd.usage_count - (cmd.error_count || 0)) / cmd.usage_count) * 100) : 100}%</span>
                        </div>
                        <div class="property">
                            <span class="property-label">Last Used</span>
                            <span class="property-value">${cmd.last_used ? formatTime(cmd.last_used) : 'Never'}</span>
                        </div>
                    </div>
                    
                    ${cmd.params && cmd.params.length > 0 ? `
                    <div class="property-group" style="margin-bottom: 24px;">
                        <h4 style="color: #58a6ff; margin-bottom: 12px; font-size: 16px; font-weight: 600;">Parameters (${cmd.params.length})</h4>
                        ${cmd.params.map(param => {
                            const paramName = typeof param === 'string' ? param : (param.name || param);
                            const paramType = typeof param === 'object' ? param.type : 'unknown';
                            const paramDesc = typeof param === 'object' ? param.description : '';
                            const required = typeof param === 'object' ? (param.required !== false) : true;
                            return `
                                <div class="property">
                                    <span class="property-label">${paramName}</span>
                                    <span class="property-value">
                                        <span class="badge" style="background: #1e40af;">${paramType}</span>
                                        ${required ? '<span class="badge" style="background: #ef4444; margin-left: 4px;">Required</span>' : '<span class="badge" style="background: #6b7280; margin-left: 4px;">Optional</span>'}
                                        ${paramDesc ? `<div style="font-size: 12px; color: #8b949e; margin-top: 4px;">${paramDesc}</div>` : ''}
                                    </span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    ` : ''}
                    
                    ${cmd.subcommands && cmd.subcommands.length > 0 ? `
                    <div class="property-group" style="margin-bottom: 24px;">
                        <h4 style="color: #58a6ff; margin-bottom: 12px; font-size: 16px; font-weight: 600;">Subcommands (${cmd.subcommands.length})</h4>
                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                            ${cmd.subcommands.map(sub => {
                                const subName = typeof sub === 'string' ? sub : (sub.name || sub);
                                const subDesc = typeof sub === 'object' ? sub.description : '';
                                return `<span class="badge" style="background: #7c3aed; font-size: 12px;" title="${subDesc || subName}">${subName}</span>`;
                            }).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            openModal('Command Details', content);
        }

        
        let pluginStatsToggleInitialized = false;
        let pluginStatsVisible = false;

        function setPluginStatsVisibility(visible) {
            const body = document.getElementById('plugins-stats-body');
            const toggle = document.getElementById('plugins-stats-toggle');
            if (!body || !toggle) return;
            pluginStatsVisible = visible;
            body.style.display = visible ? 'grid' : 'none';
            toggle.classList.toggle('on', visible);
            toggle.setAttribute('aria-pressed', visible ? 'true' : 'false');
        }

        function initPluginStatsToggle() {
            if (pluginStatsToggleInitialized) return;
            const toggle = document.getElementById('plugins-stats-toggle');
            const body = document.getElementById('plugins-stats-body');
            if (!toggle || !body) return;
            setPluginStatsVisibility(false);
            toggle.addEventListener('click', () => {
                setPluginStatsVisibility(!pluginStatsVisible);
            });
            pluginStatsToggleInitialized = true;
        }

        function renderPlugins(pluginsData) {
            const plugins = pluginsData.plugins || [];
            const availableExtensions = currentData.available_extensions || [];
            
            updatePluginStats(plugins, availableExtensions);
            initPluginStatsToggle();

            // Enforcement controls (deps/conflicts) if available
            const enforcementContainerId = 'plugin-enforcement-controls';
            const overviewCardHeader = document.querySelector('#tab-plugins .card .card-header');
            if (overviewCardHeader && (pluginsData.enforce_dependencies !== undefined || pluginsData.enforce_conflicts !== undefined)) {
                let existing = document.getElementById(enforcementContainerId);
                const depsEnabled = !!pluginsData.enforce_dependencies;
                const conflictsEnabled = !!pluginsData.enforce_conflicts;

                const depsClass = depsEnabled ? 'button-success' : 'button-secondary';
                const confClass = conflictsEnabled ? 'button-success' : 'button-secondary';

                const html = `
                    <div id="${enforcementContainerId}" style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                        <span style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.08em;">Enforcement</span>
                        <button class="button ${depsClass} button-compact" onclick="togglePluginEnforcement('deps', ${depsEnabled ? 'false' : 'true'})">
                            Dependencies: ${depsEnabled ? 'On' : 'Off'}
                        </button>
                        <button class="button ${confClass} button-compact" onclick="togglePluginEnforcement('conflicts', ${conflictsEnabled ? 'false' : 'true'})">
                            Conflicts: ${conflictsEnabled ? 'On' : 'Off'}
                        </button>
                    </div>
                `;

                if (existing) {
                    existing.outerHTML = html;
                } else {
                    const wrapper = document.createElement('div');
                    wrapper.innerHTML = html;
                    overviewCardHeader.appendChild(wrapper.firstElementChild);
                }
            }
            
            
            const searchInput = document.getElementById('plugin-search');
            const filterSelect = document.getElementById('plugin-filter');
            
            searchInput.oninput = renderPluginsList;
            filterSelect.onchange = renderPluginsList;
            
            renderPluginsList();
            
            function updatePluginStats(plugins, extensions) {
                const totalPlugins = plugins.length;
                const loadedPlugins = plugins.filter(p => p.loaded).length;
                const healthyPlugins = plugins.filter(p => 
                    p.deps_ok && !p.has_conflicts && !p.has_cycle && (!p.scan_errors || p.scan_errors.length === 0)
                ).length;
                const issuesPlugins = totalPlugins - healthyPlugins;
                const totalCommands = plugins.reduce((sum, p) => sum + (p.commands_count || 0), 0);
                const totalCogs = plugins.reduce((sum, p) => sum + (p.cogs ? p.cogs.length : 0), 0);
                const avgLoadTime = totalPlugins > 0 
                    ? Math.round(plugins.reduce((sum, p) => sum + (p.load_time || 0), 0) / totalPlugins * 1000)
                    : 0;
                
                document.getElementById('total-plugins').textContent = totalPlugins;
                document.getElementById('loaded-plugins').textContent = loadedPlugins;
                document.getElementById('healthy-plugins').textContent = healthyPlugins;
                document.getElementById('issues-plugins').textContent = issuesPlugins;
                document.getElementById('total-commands').textContent = totalCommands;
                document.getElementById('total-cogs').textContent = totalCogs;
                document.getElementById('total-extensions').textContent = extensions.length;
                document.getElementById('avg-load-time').textContent = avgLoadTime + 'ms';
            }
            
            function renderPluginsList() {
                const container = document.getElementById('plugins-extensions-list');
                const searchTerm = searchInput.value.toLowerCase();
                const filter = filterSelect.value;
                
                // Merge plugins (from PluginRegistry) with availableExtensions (from disk)
                // This ensures we show ALL extension files, even if they failed to load
                let items = [...plugins];
                
                // Add any extensions that exist on disk but aren't in PluginRegistry
                availableExtensions.forEach(ext => {
                    if (!items.find(p => p.name === ext.name)) {
                        // This extension exists on disk but failed to load or hasn't been scanned
                        items.push({
                            name: ext.name,
                            full_name: ext.full_name,
                            file_path: ext.file_path,
                            loaded: ext.loaded,
                            load_time: ext.load_time,
                            // Missing PluginRegistry data - fill with defaults
                            version: 'unknown',
                            author: 'unknown',
                            description: 'Extension file exists but not registered in PluginRegistry (may have failed to load)',
                            commands: [],
                            commands_count: 0,
                            cogs: [],
                            dependencies: {},
                            conflicts_with: [],
                            provides_hooks: [],
                            listens_to_hooks: [],
                            loaded_at: null,
                            deps_ok: false,
                            has_conflicts: false,
                            has_cycle: false,
                            scan_errors: ['Not registered in PluginRegistry']
                        });
                    }
                });
                
                items = items.filter(item => {
                    const matchesSearch = !searchTerm || 
                        item.name.toLowerCase().includes(searchTerm) ||
                            (item.description || '').toLowerCase().includes(searchTerm) ||
                            (item.commands || []).some(cmd => cmd.toLowerCase().includes(searchTerm));
                        
                        const isHealthy = item.deps_ok && !item.has_conflicts && !item.has_cycle && (!item.scan_errors || item.scan_errors.length === 0);
                        
                        const matchesFilter = 
                            filter === 'all' ||
                            (filter === 'loaded' && item.loaded) ||
                            (filter === 'not_loaded' && !item.loaded) ||
                            (filter === 'healthy' && isHealthy) ||
                            (filter === 'issues' && !isHealthy);
                        
                        return matchesSearch && matchesFilter;
                });
                
                if (items.length === 0) {
                    container.innerHTML = `<div class=\"empty-state\">No plugins found</div>`;
                    return;
                }
                
                container.innerHTML = items.map((plugin, idx) => {
                        const isHealthy = plugin.deps_ok && !plugin.has_conflicts && !plugin.has_cycle && (!plugin.scan_errors || plugin.scan_errors.length === 0);
                        const statusText = isHealthy ? 'Healthy' : 'Issues';
                        const statusColor = isHealthy ? '#3b82f6' : '#ef4444';
                        const statusBg = isHealthy ? 'rgba(59, 130, 246, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                        
                        return `
                            <div class="file-row" style="flex-direction: column; align-items: stretch; padding: 16px; margin-bottom: 8px; border: 1px solid #30363d; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 15px; font-weight: 600; color: #58a6ff; margin-bottom: 4px;">
                                            ${plugin.name}
                                        </div>
                                        <div style="font-size: 13px; color: #8b949e; margin-bottom: 8px;">
                                            ${plugin.description || 'No description'}
                                        </div>
                                        <div style=\"display: flex; gap: 8px; flex-wrap: wrap;\">
                                            <span class=\"badge\" style=\"background: ${plugin.loaded ? '#3b82f6' : '#6b7280'};\">${plugin.loaded ? 'Loaded' : 'Not Loaded'}</span>
                                            <span class=\"badge\" style=\"background: ${statusColor};${isHealthy ? '' : ' cursor:pointer;'}\" ${isHealthy ? '' : `onclick=\"viewPluginStatus(${JSON.stringify(plugin).replace(/"/g, '&quot;')})\"`}>
                                                ${statusText}
                                            </span>
                                            <span class=\"badge\" style=\"background: #1e40af;\">v${plugin.version}</span>
                                            ${plugin.author !== 'unknown' ? `<span class="badge badge-secondary">by ${plugin.author}</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 12px; padding: 12px; background: rgba(13, 17, 23, 0.6); border-radius: 6px; border: 1px solid rgba(59, 130, 246, 0.2);">
                                    <div>
                                        <div style="font-size: 11px; color: #8b949e; text-transform: uppercase;">Commands</div>
                                        <div style="font-size: 16px; font-weight: 600; color: #60a5fa;">${plugin.commands_count || 0}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: #8b949e; text-transform: uppercase;">Cogs</div>
                                        <div style="font-size: 16px; font-weight: 600; color: #60a5fa;">${(plugin.cogs || []).length}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: #8b949e; text-transform: uppercase;">Load Time</div>
                                        <div style="font-size: 16px; font-weight: 600; color: #60a5fa;">${Math.round((plugin.load_time || 0) * 1000)}ms</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: #8b949e; text-transform: uppercase;">Dependencies</div>
                                        <div style="font-size: 16px; font-weight: 600; color: #60a5fa;">${Object.keys(plugin.dependencies || {}).length}</div>
                                    </div>
                                </div>
                                
                                ${(plugin.commands || []).length > 0 ? `
                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 12px; color: #8b949e; margin-bottom: 6px;">Commands:</div>
                                    <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                        ${(plugin.commands || []).slice(0, 15).map(cmd => 
                                            `<span class="badge" style="background: #1e3a8a; font-size: 11px;">${cmd}</span>`
                                        ).join('')}
                                        ${(plugin.commands || []).length > 15 ? `<span class="badge badge-secondary" style="font-size: 11px;">+${(plugin.commands || []).length - 15} more</span>` : ''}
                                    </div>
                                </div>
                                ` : ''}
                                
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button class="button button-primary" onclick="viewPluginDetails(${JSON.stringify(plugin).replace(/"/g, '&quot;')})">
                                        Details
                                    </button>
                                    <button class="button button-secondary" onclick="sendCommandWithButton(this, 'reload_extension', {extension: 'extensions.${plugin.name}'})">
                                        Reload
                                    </button>
                                    ${plugin.loaded ? `
                                        <button class="button button-danger" onclick="sendCommandWithButton(this, 'unload_extension', {extension: 'extensions.${plugin.name}'})">
                                            Unload
                                        </button>
                                    ` : `
                                        <button class="button button-success" onclick="sendCommandWithButton(this, 'load_extension', {extension: 'extensions.${plugin.name}'})">
                                            Load
                                        </button>
                                    `}
                                    ${!isHealthy ? `
                                        <button class="button button-warning" onclick="viewPluginStatus(${JSON.stringify(plugin).replace(/"/g, '&quot;')})">
                                            View Issues
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
            }
        }

        let currentHookView = 'all';
        let currentHookSort = 'priority';

        function renderHooks(eventHooksData) {
            const hooks = eventHooksData.hooks || [];
            const metrics = eventHooksData.metrics || {};
            
            document.getElementById('hooks-emissions').textContent = metrics.total_emissions || 0;
            document.getElementById('hooks-executions').textContent = metrics.total_executions || 0;
            document.getElementById('hooks-failures').textContent = metrics.total_failures || 0;
            document.getElementById('hooks-queue-size').textContent = eventHooksData.queue_size || 0;
            document.getElementById('hooks-queue-full').textContent = metrics.queue_full_count || 0;
            document.getElementById('hooks-worker-restarts').textContent = metrics.worker_restarts || 0;
            document.getElementById('hooks-disabled').textContent = eventHooksData.disabled || 0;
            document.getElementById('hooks-circuit-open').textContent = eventHooksData.circuit_open || 0;
            
            const viewButtons = document.querySelectorAll('#tab-hooks .hooks-view-btn');
            viewButtons.forEach(btn => {
                btn.onclick = () => {
                    viewButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentHookView = btn.dataset.view;
                    renderHooksList();
                };
            });
            
            const searchInput = document.getElementById('hooks-search');
            const sortSelect = document.getElementById('hooks-sort');
            
            searchInput.oninput = renderHooksList;
            sortSelect.onchange = () => {
                currentHookSort = sortSelect.value;
                renderHooksList();
            };
            
            renderHooksList();
            
            function renderHooksList() {
                const container = document.getElementById('hooks-list');
                const searchTerm = searchInput.value.toLowerCase();
                
                let filteredHooks = hooks.filter(hook => {
                    const matchesSearch = !searchTerm || 
                        hook.event.toLowerCase().includes(searchTerm) ||
                        hook.callback.toLowerCase().includes(searchTerm) ||
                        hook.hook_id.toLowerCase().includes(searchTerm);
                    
                    const isActive = !hook.disabled && !hook.circuit_open;
                    const hasIssues = hook.circuit_open || hook.failure_count > 0;
                    
                    const matchesFilter =
                        currentHookView === 'all' ||
                        (currentHookView === 'active' && isActive) ||
                        (currentHookView === 'disabled' && hook.disabled) ||
                        (currentHookView === 'issues' && hasIssues);
                    
                    return matchesSearch && matchesFilter;
                });
                
                filteredHooks.sort((a, b) => {
                    switch (currentHookSort) {
                        case 'priority':
                            return b.priority - a.priority;
                        case 'executions':
                            return b.execution_count - a.execution_count;
                        case 'failures':
                            return b.failure_count - a.failure_count;
                        case 'time':
                            return b.avg_time_ms - a.avg_time_ms;
                        default:
                            return 0;
                    }
                });
                
                if (filteredHooks.length === 0) {
                    container.innerHTML = '<div class="empty-state">No hooks found</div>';
                    return;
                }
                
                container.innerHTML = filteredHooks.map((hook, idx) => {
                    const isActive = !hook.disabled && !hook.circuit_open;
                    const statusColor = hook.disabled ? '#6b7280' : hook.circuit_open ? '#f59e0b' : '#3b82f6';
                    const statusText = hook.disabled ? 'Disabled' : hook.circuit_open ? 'Circuit Open' : 'Active';
                    const hasIssues = hook.circuit_open || hook.failure_count > 0;
                    
                    return `
                        <div class="file-row" style="flex-direction: column; align-items: stretch; padding: 16px; margin-bottom: 8px; border: 1px solid #30363d; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 15px; font-weight: 600; color: #58a6ff; margin-bottom: 4px;">
                                        ${hook.event} â†’ ${hook.callback}
                                    </div>
                                    <div style="font-size: 12px; color: #8b949e; margin-bottom: 8px;">
                                        Hook ID: ${hook.hook_id}
                                    </div>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <span class="badge" style="background: ${statusColor};">${statusText}</span>
                                        <span class="badge" style="background: #1e40af;">Priority ${hook.priority}</span>
                                        ${hasIssues ? '<span class="badge" style="background: #ef4444;">Has Issues</span>' : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 12px; padding: 12px; background: rgba(13, 17, 23, 0.6); border-radius: 6px; border: 1px solid rgba(59, 130, 246, 0.2);">
                                <div>
                                    <div style="font-size: 11px; color: #8b949e; text-transform: uppercase;">Executions</div>
                                    <div style="font-size: 16px; font-weight: 600; color: #60a5fa;">${hook.execution_count || 0}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #8b949e; text-transform: uppercase;">Failures</div>
                                    <div style="font-size: 16px; font-weight: 600; color: ${hook.failure_count > 0 ? '#f87171' : '#60a5fa'};">${hook.failure_count || 0}</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #8b949e; text-transform: uppercase;">Avg Time</div>
                                    <div style="font-size: 16px; font-weight: 600; color: #60a5fa;">${hook.avg_time_ms || 0}ms</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #8b949e; text-transform: uppercase;">Success Rate</div>
                                    <div style="font-size: 16px; font-weight: 600; color: #60a5fa;">${hook.execution_count > 0 ? Math.round(((hook.execution_count - hook.failure_count) / hook.execution_count) * 100) : 100}%</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="button button-primary" onclick="viewHookDetails(${JSON.stringify(hook).replace(/"/g, '&quot;')})">
                                    Details
                                </button>
                                <button class="button button-${hook.disabled ? 'success' : 'secondary'}" onclick="sendCommandWithButton(this, '${hook.disabled ? 'enable_hook' : 'disable_hook'}', {hook_id: this.getAttribute('data-hook-id')})" data-hook-id="${hook.hook_id}">
                                    ${hook.disabled ? 'Enable' : 'Disable'}
                                </button>
                                ${hook.circuit_open ? `
                                    <button class="button button-warning" onclick="sendCommandWithButton(this, 'reset_circuit', {hook_id: this.getAttribute('data-hook-id')})" data-hook-id="${hook.hook_id}">
                                        Reset Circuit
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function renderFileSystem(fs) {
            const container = document.getElementById('filesystem-content');

            if (!fs || Object.keys(fs).length === 0) {
                container.innerHTML = '<div class="empty-state">File system monitoring disabled to reduce data size</div>';
                document.getElementById('fs-total-files').textContent = '0';
                document.getElementById('fs-total-size').textContent = '0 MB';
                document.getElementById('fs-data-files').textContent = '0';
                document.getElementById('fs-cogs-files').textContent = '0';
                document.getElementById('fs-ext-files').textContent = '0';
                document.getElementById('fs-logs-files').textContent = '0';
                document.getElementById('fs-cache-hits').textContent = '0';
                document.getElementById('fs-cache-misses').textContent = '0';
                return;
            }

            let totalFiles = 0;
            let totalSize = 0;
            
            if (fs.data && fs.data.exists) {
                totalFiles += fs.data.file_count || 0;
                totalSize += fs.data.total_size || 0;
            }
            if (fs.cogs && fs.cogs.exists) {
                totalFiles += fs.cogs.file_count || 0;
                totalSize += fs.cogs.total_size || 0;
            }
            if (fs.extensions && fs.extensions.exists) {
                totalFiles += fs.extensions.file_count || 0;
                totalSize += fs.extensions.total_size || 0;
            }
            if (fs.botlogs && fs.botlogs.exists) {
                totalFiles += fs.botlogs.file_count || 0;
                totalSize += fs.botlogs.total_size || 0;
            }
            
            document.getElementById('fs-total-files').textContent = totalFiles;
            document.getElementById('fs-total-size').textContent = formatBytes(totalSize);
            document.getElementById('fs-data-files').textContent = (fs.data && fs.data.exists) ? fs.data.file_count : 0;
            document.getElementById('fs-cogs-files').textContent = (fs.cogs && fs.cogs.exists) ? fs.cogs.file_count : 0;
            document.getElementById('fs-ext-files').textContent = (fs.extensions && fs.extensions.exists) ? fs.extensions.file_count : 0;
            document.getElementById('fs-logs-files').textContent = (fs.botlogs && fs.botlogs.exists) ? fs.botlogs.file_count : 0;
            
            if (fs.cache_metrics) {
                document.getElementById('fs-cache-hits').textContent = fs.cache_metrics.hits || 0;
                document.getElementById('fs-cache-misses').textContent = fs.cache_metrics.misses || 0;
            }

            const renderDirectory = (name, data, icon) => {
                if (!data || !data.exists) {
                    return `
                        <div class="file-row" style="flex-direction: column; align-items: stretch; padding: 16px; margin-bottom: 8px; border: 1px solid #30363d; border-radius: 6px; opacity: 0.5;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 15px; font-weight: 600; color: #8b949e; margin-bottom: 4px;">
                                        ${name}
                                    </div>
                                    <div style="font-size: 13px; color: #6b7280;">
                                        Directory not available
                                    </div>
                                </div>
                                <span class="badge" style="background: #6b7280;">Not Found</span>
                            </div>
                        </div>
                    `;
                }

                const sizeColor = data.total_size > 10485760 ? '#f59e0b' : '#60a5fa';
                
                return `
                    <div class="file-row" style="flex-direction: column; align-items: stretch; padding: 16px; margin-bottom: 8px; border: 1px solid #30363d; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="font-size: 15px; font-weight: 600; color: #58a6ff; margin-bottom: 4px;">
                                    ${name}
                                </div>
                                <div style="font-size: 13px; color: #8b949e; margin-bottom: 8px;">
                                    ${data.path || data.name || data.file_path || 'Unknown'}
                                </div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <span class="badge" style="background: #10b981;">Exists</span>
                                    ${data.file_count > 0 ? '<span class="badge" style="background: #3b82f6;">Has Files</span>' : '<span class="badge" style="background: #6b7280;">Empty</span>'}
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 12px; padding: 12px; background: rgba(13, 17, 23, 0.6); border-radius: 6px; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <div>
                                <div style="font-size: 11px; color: #8b949e; text-transform: uppercase;">Files</div>
                                <div style="font-size: 16px; font-weight: 600; color: #60a5fa;">${data.file_count || 0}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #8b949e; text-transform: uppercase;">Total Size</div>
                                <div style="font-size: 16px; font-weight: 600; color: ${sizeColor};">${formatBytes(data.total_size || 0)}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #8b949e; text-transform: uppercase;">Avg File Size</div>
                                <div style="font-size: 16px; font-weight: 600; color: #60a5fa;">${data.file_count > 0 ? formatBytes((data.total_size || 0) / data.file_count) : '0 B'}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #8b949e; text-transform: uppercase;">Largest File</div>
                                <div style="font-size: 16px; font-weight: 600; color: #60a5fa;">${data.largest_file ? formatBytes(data.largest_file.size) : 'N/A'}</div>
                            </div>
                        </div>
                        
                        ${data.largest_file ? `
                        <div style="margin-bottom: 12px; padding: 8px 12px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; border-left: 3px solid #3b82f6;">
                            <div style="font-size: 11px; color: #8b949e; margin-bottom: 4px;">LARGEST FILE</div>
                            <div style="font-size: 13px; color: #c9d1d9; font-family: monospace;">${data.largest_file.name}</div>
                        </div>
                        ` : ''}
                        
                        ${data.recent_files && data.recent_files.length > 0 ? `
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 12px; color: #8b949e; margin-bottom: 6px;">Recent Files (${Math.min(data.recent_files.length, 5)}):</div>
                            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                ${data.recent_files.slice(0, 5).map(f => 
                                    `<span class="badge" style="background: #1e3a8a; font-size: 11px;" title="${formatBytes(f.size)}">${f.name}</span>`
                                ).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            };

            container.innerHTML = `
                ${fs.data ? renderDirectory('Data Directory', fs.data) : ''}
                ${fs.cogs ? renderDirectory('Cogs Directory', fs.cogs) : ''}
                ${fs.extensions ? renderDirectory('Extensions Directory', fs.extensions) : ''}
                ${fs.botlogs ? renderDirectory('Botlogs Directory', fs.botlogs) : ''}
            `;
        }

        window.refreshFileSystem = () => {
            showNotification('Refreshing File System...', 'info');
            loadData();
        };

        let currentFileTree = {};
        let currentPath = '';
        let fileBrowserInitialized = false;
        let requestIdCounter = 0;
        let contextMenuPath = null;
        let contextMenuName = null;
        let contextMenuIsDir = false;
        function generateRequestId() {
            return `req_${Date.now()}_${++requestIdCounter}`;
        }

        function sendFileCommand(command, params = {}) {
            // Use polling-based command system (no WebSocket needed)
            const requestId = generateRequestId();
            params.request_id = requestId;

            fetch('./send_command.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ command, params })
            })
            .then(async r => {
                let payload = null;
                try {
                    payload = await r.json();
                } catch (_) {}
                if (!r.ok) {
                    const msg = interpretHttpError(r.status, payload, 'file');
                    throw new Error(msg);
                }
                return payload || {};
            })
            .catch(e => {
                // Only show error notification if it's not a network/connection issue during init
                if (e.message !== 'Failed to fetch') {
                    console.error('File command error:', e);
                    showNotification(e.message || 'File operation failed.', 'error');
                } else {
                    console.warn('[FILE] Network unavailable for command:', command);
                }
            });
            
            return requestId;
        }

        function updateFileTree(fileops) {
            if (fileops.type === 'list_dir') {
                currentFileTree[fileops.path.replace('./', '')] = { files: fileops.files, loaded: true };
            }
        }

        function renderFileBrowser(fs, fileops) {
            if (fileBrowserInitialized) return; // Don't re-render

            // Initialize with botlogs, data, cogs, extensions if available
            if (Object.keys(currentFileTree).length === 0) {
            if (fs.botlogs && fs.botlogs.exists) {
                currentFileTree['botlogs'] = { files: [], loaded: false };
            }
            if (fs.data && fs.data.exists) {
                currentFileTree['data'] = { files: [], loaded: false };
            }
            if (fs.cogs && fs.cogs.exists) {
                currentFileTree['cogs'] = { files: [], loaded: false };
            }
            if (fs.extensions && fs.extensions.exists) {
                currentFileTree['extensions'] = { files: [], loaded: false };
            }
            }

            // If we have fileops data, update the tree
            if (fileops) {
                updateFileTree(fileops);
            }

            renderBreadcrumb();
            renderFiles();
            initExplorer();
            initFileToolbar();
            fileBrowserInitialized = true;

            // Enable drag & drop upload for text files into the current directory
            const dropZone = document.getElementById('file-browser-content');
            if (dropZone && !dropZone._dragInitialized) {
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('file-drop-active');
                });
                dropZone.addEventListener('dragleave', (e) => {
                    if (e.target === dropZone) {
                        dropZone.classList.remove('file-drop-active');
                    }
                });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('file-drop-active');
                    const files = Array.from(e.dataTransfer?.files || []);
                    if (!files.length) return;

                    files.forEach(file => {
                        if (file.size > 10 * 1024 * 1024) {
                            showNotification(`Skipping ${file.name} (too large)`, 'error');
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = (evt) => {
                            const relPath = currentPath ? currentPath + '/' + file.name : file.name;
                            const fullPath = relPath.startsWith('./') ? relPath : './' + relPath;
                            sendCommand('write_file', { path: fullPath, content: evt.target.result });
                        };
                        reader.readAsText(file);
                    });

                    showNotification('Upload requested. Files will appear shortly.', 'success');
                    setTimeout(reloadCurrentDirectory, 1500);
                });
                dropZone._dragInitialized = true;
            }
            
            setTimeout(() => {
                ['data', 'botlogs'].forEach(dir => {
                    if (currentFileTree[dir] && !currentFileTree[dir].loaded) {
                        const fullPath = './' + dir;
                        const rid = sendFileCommand('list_dir', { path: fullPath });
                        
                        let retries = 0;
                        const poll = () => {
                            retries++;
                            fetch('monitor_data_fileops.json?t=' + Date.now())
                                .then(r => r.ok ? r.text() : null)
                                .then(text => {
                                    if (text) {
                                        try {
                                            const data = JSON.parse(text);
                                            if (data && data.type === 'list_dir' && 
                                                data.path === fullPath && 
                                                data.request_id === rid) {
                                                currentFileTree[dir] = { files: data.files, loaded: true };
                                                console.log(`Pre-loaded directory: ${dir}`);
                                            } else if (retries < 10) {
                                                setTimeout(poll, 1000);
                                            }
                                        } catch (e) {
                                            if (retries < 10) setTimeout(poll, 1000);
                                        }
                                    } else if (retries < 10) {
                                        setTimeout(poll, 1000);
                                    }
                                })
                                .catch(() => {
                                    if (retries < 10) setTimeout(poll, 1000);
                                });
                        };
                        setTimeout(poll, 2000 + (dir === 'botlogs' ? 2000 : 0));
                    }
                });
            }, 1000);
        }

        function getFiles(path) {
            // Normalize path to match how it's stored: remove leading './' if present
            const normalizedPath = path.startsWith('./') ? path.substring(2) : path;
            const entry = currentFileTree[normalizedPath];

            if (entry && entry.files && Array.isArray(entry.files)) {
                return entry.files;
            }

            return [];
        }

        function renderBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            const path = currentPath.split('/').filter(p => p);

            let html = '<span class="breadcrumb-icon"><svg width="14" height="14" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M3 4.5A1.5 1.5 0 0 1 4.5 3h3.382a1.5 1.5 0 0 1 1.06.44L10.94 5H15.5A1.5 1.5 0 0 1 17 6.5v7A1.5 1.5 0 0 1 15.5 15h-11A1.5 1.5 0 0 1 3 13.5v-9Z" fill="#38bdf8"/></svg></span><span class="crumb" onclick="navigateTo(-1)">Root</span>';
            if (path.length > 0) {
                html += '<span>/</span>';
            }

            html += path.map((part, i) => {
                const isLast = i === path.length - 1;
                return `<span class="crumb" onclick="navigateTo(${i})">${part}</span>${!isLast ? '<span>/</span>' : ''}`;
            }).join('');

            breadcrumb.innerHTML = html;
        }

        function renderFiles() {
            const list = document.getElementById('list');
            let files = [];

            if (currentPath === '') {
                const rootDirs = ['botlogs', 'data', 'cogs', 'extensions'];
                files = rootDirs.filter(dir => currentFileTree[dir]).map(dir => ({ name: dir, type: 'folder' }));
            } else {
                files = getFiles(currentPath);
            }
            
            // SECURITY: Always hide sensitive dashboard files from ALL users
            const sensitiveFiles = [
                'live_monitor_config.json',
                'live_monitor_website.zip',
                'live_monitor_website',
                'dashboard_users.db',
                'dashboard_users.db-wal',
                'dashboard_users.db-shm'
            ];
            
            files = files.filter(f => {
                // Check if file/folder name matches any sensitive file
                if (sensitiveFiles.includes(f.name)) {
                    return false; // Hide it!
                }
                // Also check if we're in a path containing live_monitor_website
                const fullPath = currentPath ? currentPath + '/' + f.name : f.name;
                if (fullPath.includes('live_monitor_website')) {
                    return false; // Hide everything in that folder!
                }
                return true; // Show it
            });

            let fileIndex = 0;
            list.innerHTML = files.map((f, i) => {
                const safeName = f.name.replace(/'/g, "\\\\'");
                if(f.type === 'folder' || f.type === 'dir') {
                    return `
                        <div class="file-row folder" onclick="openFolder('${safeName}')" oncontextmenu="openFileContextMenu(event, '${safeName}', true)">
                            <div class="file-name">${f.name}</div>
                            <div class="file-meta">Folder</div>
                        </div>
                    `;
                }
                const currentFileIndex = fileIndex++;
                return `
                    <div class="file-row" id="f-${currentFileIndex}" onclick="openFileByName(this, '${safeName}')" oncontextmenu="openFileContextMenu(event, '${safeName}', false)">
                        <div class="file-name">${f.name}</div>
                        <div class="file-meta">${f.size || 'File'}</div>
                    </div>
                `;
            }).join('');
        }

        function openFileContextMenu(event, name, isDir) {
            event.preventDefault();
            const menu = document.getElementById('file-context-menu');
            if (!menu) return;

            contextMenuName = name;
            contextMenuIsDir = !!isDir;
            const base = currentPath ? currentPath + '/' : '';
            const rel = base + name;
            contextMenuPath = rel.startsWith('./') ? rel : './' + rel;

            // Position relative to the File Browser tab so it follows the mouse precisely
            const container = document.getElementById('tab-files') || document.body;
            const rect = container.getBoundingClientRect();

            let x = event.clientX - rect.left;
            let y = event.clientY - rect.top;

            const menuRect = menu.getBoundingClientRect();
            const menuWidth = menuRect.width || 200;
            const menuHeight = menuRect.height || 120;

            // Clamp within the container
            const maxX = Math.max(0, rect.width - menuWidth - 8);
            const maxY = Math.max(0, rect.height - menuHeight - 8);
            if (x < 8) x = 8; else if (x > maxX) x = maxX;
            if (y < 8) y = 8; else if (y > maxY) y = maxY;

            menu.style.display = 'block';
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
        }

        function closeFileContextMenu() {
            const menu = document.getElementById('file-context-menu');
            if (!menu) return;
            menu.style.display = 'none';
            contextMenuPath = null;
            contextMenuName = null;
            contextMenuIsDir = false;
        }

        function contextRename() {
            if (!contextMenuPath || !contextMenuName) return;
            const newName = prompt('New name', contextMenuName);
            if (!newName || newName === contextMenuName) {
                closeFileContextMenu();
                return;
            }
            let baseDir = currentPath || '';
            const newRel = baseDir ? baseDir + '/' + newName : newName;
            const oldPath = contextMenuPath;
            const newPath = newRel.startsWith('./') ? newRel : './' + newRel;
            sendCommand('rename_file', { old_path: oldPath, new_path: newPath });
            showNotification('Rename requested', 'info');
            closeFileContextMenu();
            setTimeout(reloadCurrentDirectory, 800);
        }

        function contextMove() {
            if (!contextMenuPath || !contextMenuName) return;
            const targetDir = prompt(
                'Move to which directory?\\n\\n' +
                '- Path is relative to the bot root (same as File Browser).\\n' +
                '- Examples: data, data/config, cogs, botlogs/debug, ./extensions.\\n\\n' +
                'Leave empty to move back to root.',
                currentPath
            );
            if (targetDir === null) {
                closeFileContextMenu();
                return;
            }
            let base = (targetDir || '').trim();
            if (base.startsWith('./')) base = base.slice(2);
            if (base.startsWith('/')) base = base.slice(1);
            if (base.endsWith('/')) base = base.slice(0, -1);
            const newRel = base ? base + '/' + contextMenuName : contextMenuName;
            const oldPath = contextMenuPath;
            const newPath = newRel.startsWith('./') ? newRel : './' + newRel;
            sendCommand('rename_file', { old_path: oldPath, new_path: newPath });
            showNotification('Move requested', 'info');
            closeFileContextMenu();
            setTimeout(reloadCurrentDirectory, 800);
        }

        function contextDelete() {
            if (!contextMenuPath || !contextMenuName) return;
            const confirmed = confirm('Delete ' + contextMenuName + (contextMenuIsDir ? ' and all its contents?' : '?'));
            if (!confirmed) {
                closeFileContextMenu();
                return;
            }
            sendCommand('delete_path', { path: contextMenuPath });
            showNotification('Delete requested', 'warning');
            closeFileContextMenu();
            setTimeout(reloadCurrentDirectory, 800);
        }

        document.addEventListener('click', (e) => {
            const menu = document.getElementById('file-context-menu');
            if (!menu) return;
            if (menu.style.display === 'block' && !menu.contains(e.target)) {
                closeFileContextMenu();
            }
        });

        window.navigateTo = (depth) => {
            if (depth === -1) {
                currentPath = '';
            } else {
                const pathParts = currentPath.split('/').filter(p => p);
                currentPath = pathParts.slice(0, depth + 1).join('/');
            }
            renderBreadcrumb();
            renderFiles();
        };

        window.openFolder = (folderName) => {
            currentPath = currentPath ? currentPath + '/' + folderName : folderName;
            if (!currentFileTree[currentPath] || !currentFileTree[currentPath].loaded) {
                loadDirectory(currentPath);
            } else {
                renderBreadcrumb();
                renderFiles();
            }
        };

        function reloadCurrentDirectory() {
            if (currentPath) {
                loadDirectory(currentPath);
            } else {
                renderBreadcrumb();
                renderFiles();
            }
        }

        function createNewFile() {
            const baseName = prompt('New file name (e.g. notes.txt or my_extension.py)');
            if (!baseName) return;
            const relPath = currentPath ? currentPath + '/' + baseName : baseName;
            const fullPath = relPath.startsWith('./') ? relPath : './' + relPath;
            sendCommand('write_file', { path: fullPath, content: '' });
            showNotification('File created', 'success');
            setTimeout(reloadCurrentDirectory, 800);
        }

        function createNewFolder() {
            const baseName = prompt('New folder name');
            if (!baseName) return;
            const relPath = currentPath ? currentPath + '/' + baseName : baseName;
            const fullPath = relPath.startsWith('./') ? relPath : './' + relPath;
            sendCommand('create_dir', { path: fullPath });
            showNotification('Folder creation requested', 'success');
            setTimeout(reloadCurrentDirectory, 800);
        }

        function initExplorer() {
            const fileBrowser = document.getElementById('file-browser-content');
            if (!fileBrowser) {
                console.error('[EDITOR] ERROR: file-browser-content container not found');
                return;
            }

            const resizer = fileBrowser.querySelector('#resize') || document.getElementById('resize');
            const pane = fileBrowser.querySelector('#pane') || document.getElementById('pane');
            const unit = fileBrowser.querySelector('.explorer-unit') || document.querySelector('#tab-files .explorer-unit');

            if (!resizer || !pane || !unit) {
                console.error('[EDITOR] ERROR: Missing explorer elements in File Browser tab');
                return;
            }

            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                document.body.classList.add('dragging');

                const startX = e.clientX;
                const startWidth = pane.offsetWidth || 320;

                function doDrag(e) {
                    e.preventDefault();
                    const delta = e.clientX - startX;
                    const proposed = startWidth + delta;
                    const minWidth = 220;  // let user go quite narrow
                    const maxWidth = Math.max(320, unit.offsetWidth - 320); // leave room for editor
                    const newWidth = Math.min(Math.max(proposed, minWidth), maxWidth);
                    pane.style.width = newWidth + 'px';
                }

                function stopDrag() {
                    document.body.classList.remove('dragging');
                    document.removeEventListener('mousemove', doDrag);
                    document.removeEventListener('mouseup', stopDrag);
                }

                document.addEventListener('mousemove', doDrag);
                document.addEventListener('mouseup', stopDrag);
            });
        }

        function initFileToolbar() {
            const toggle = document.getElementById('file-toolbar-toggle');
            const menu = document.getElementById('file-toolbar-menu');
            if (!toggle || !menu || toggle._initialized) return;
            toggle._initialized = true;

            toggle.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = menu.classList.contains('open');
                menu.classList.toggle('open', !isOpen);
                toggle.setAttribute('aria-expanded', String(!isOpen));
            });

            document.addEventListener('click', (e) => {
                if (!menu.classList.contains('open')) return;
                if (e.target === toggle || menu.contains(e.target)) return;
                menu.classList.remove('open');
                toggle.setAttribute('aria-expanded', 'false');
            });
        }

        window.setView = (mode, btn) => {
            const grid = document.getElementById('list');
            if (!grid) return;
            const group = btn && btn.parentElement;
            if (group) {
                group.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            grid.className = `file-grid ${mode}-mode`;
            const menu = document.getElementById('file-toolbar-menu');
            const toggle = document.getElementById('file-toolbar-toggle');
            if (menu && toggle) {
                menu.classList.remove('open');
                toggle.setAttribute('aria-expanded', 'false');
            }
        };

        window.refreshFileBrowser = () => {
            showNotification('Refreshing file browser...', 'info');
            reloadCurrentDirectory();
        };

        window.openFileByName = (element, fileName) => {
            console.log(`[EDITOR] openFileByName called for: ${fileName}`);
            
            const files = getFiles(currentPath);
            const file = files.find(f => f.name === fileName && (f.type === 'file' || f.type !== 'dir' && f.type !== 'folder'));
            
            if (!file) {
                console.error(`[EDITOR] ERROR: File not found: ${fileName}`);
                showNotification('Error opening file: not found', 'error');
                return;
            }

            console.log(`[EDITOR] Opening file: ${file.name}`);

            const fileBrowser = document.getElementById('file-browser-content');
            const unit = (fileBrowser && fileBrowser.querySelector('.explorer-unit')) || document.querySelector('#tab-files .explorer-unit');
            const nameEl = document.getElementById('fileName');
            const text = document.getElementById('fileContent');
            const editorPane = (fileBrowser && fileBrowser.querySelector('.editor-pane')) || document.querySelector('#tab-files .editor-pane');
            const filePane = (fileBrowser && fileBrowser.querySelector('.file-pane')) || document.querySelector('#tab-files .file-pane');

            if (!unit || !nameEl || !text || !editorPane || !filePane) {
                console.error('[EDITOR] ERROR: Missing editor elements!');
                showNotification('Editor not initialized', 'error');
                return;
            }
            
            unit.querySelectorAll('.file-row').forEach(r => r.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }

            nameEl.innerText = file.name;
            const placeholder = `// Loading ${file.name}...\\n\\n// Please wait while content loads...`;
            text.value = addLineNumbers(placeholder);
            
            unit.classList.add('editor-open');

            function waitForWidth(attempt = 0) {
                if (unit.offsetWidth > 0) {
                    if (!filePane.style.width) {
                        filePane.style.width = '420px';
                    }
                    filePane.style.flexShrink = '0';
                    editorPane.style.display = 'flex';
                    editorPane.style.flex = '1';
                } else if (attempt < 20) {
                    setTimeout(() => waitForWidth(attempt + 1), 50);
                }
            }
            waitForWidth();
            
            setTimeout(() => {
                editorPane.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);

            const filePath = currentPath ? currentPath + '/' + file.name : file.name;
            loadFile(filePath);
        };
        
        function addLineNumbers(content) {
            const lines = content.split('\\n');
            const maxDigits = String(lines.length).length;
            return lines.map((line, i) => {
                const lineNum = String(i + 1).padStart(maxDigits, ' ');
                return `${lineNum} | ${line}`;
            }).join('\\n');
        }
        
        function stripLineNumbers(content) {
            return content.split('\\n').map(line => {
                const pipeIndex = line.indexOf(' | ');
                return pipeIndex !== -1 ? line.substring(pipeIndex + 3) : line;
            }).join('\\n');
        }

        window.closeEditor = () => {
            const fileBrowser = document.getElementById('file-browser-content');
            const unit = (fileBrowser && fileBrowser.querySelector('.explorer-unit')) || document.querySelector('#tab-files .explorer-unit');
            const pane = document.getElementById('pane');
            const editorPane = (fileBrowser && fileBrowser.querySelector('.editor-pane')) || document.querySelector('#tab-files .editor-pane');
            const filePane = (fileBrowser && fileBrowser.querySelector('.file-pane')) || document.querySelector('#tab-files .file-pane');
            
            unit.classList.remove('editor-open');
            
            if (pane) pane.style.width = "";
            
            if (filePane) {
                filePane.style.width = '';
                filePane.style.flexShrink = '';
            }
            
            if (editorPane) {
                editorPane.style.display = '';
                editorPane.style.flex = '';
            }
            
            unit.querySelectorAll('.file-row').forEach(r => r.classList.remove('active'));
        };

        window.jumpEditorScroll = () => {
            const text = document.getElementById('fileContent');
            if (!text) return;

            const threshold = 16;
            const atBottom = text.scrollTop + text.clientHeight >= text.scrollHeight - threshold;

            if (atBottom) {
                text.scrollTop = 0;
            } else {
                text.scrollTop = text.scrollHeight;
            }
        };

        window.save = () => {
            const text = document.getElementById('fileContent');
            const fileName = document.getElementById('fileName').innerText;
            const path = currentPath ? currentPath + '/' + fileName : fileName;
            const fullPath = path.startsWith('./') ? path : './' + path;
            const contentWithoutLineNumbers = stripLineNumbers(text.value);
            sendCommand('write_file', { path: fullPath, content: contentWithoutLineNumbers });
            showNotification('File saved successfully', 'success');
            closeEditor();
        };

        function promptRenameCurrentFile() {
            const fileNameEl = document.getElementById('fileName');
            if (!fileNameEl) return;
            const currentName = fileNameEl.innerText;
            const currentRel = currentPath ? currentPath + '/' + currentName : currentName;
            const newName = prompt('New file name', currentName);
            if (!newName || newName === currentName) return;
            const newRel = currentPath ? currentPath + '/' + newName : newName;
            const oldPath = currentRel.startsWith('./') ? currentRel : './' + currentRel;
            const newPath = newRel.startsWith('./') ? newRel : './' + newRel;
            sendCommand('rename_file', { old_path: oldPath, new_path: newPath });
            showNotification('Rename requested', 'info');
            closeEditor();
            setTimeout(reloadCurrentDirectory, 800);
        }

        function goToPath(path) {
            currentPath = path;
            if (path === '') {
                // Show root directories
                renderFiles();
            } else {
                // Load and show the directory
                loadDirectory(path);
            }
            renderBreadcrumb();
        }

        function loadDirectory(path) {
            const list = document.getElementById('list');
            if (list) {
                list.innerHTML = '<div style="padding: 40px; text-align: center; color: #8b949e;"><div style="font-size: 18px; margin-bottom: 8px;">Loading directory...</div><div style="font-size: 13px;">Please wait</div></div>';
            }
            
            const fullPath = path.startsWith('./') ? path : './' + path;
            const requestId = sendFileCommand('list_dir', { path: fullPath });
            
            let retries = 0;
            const maxRetries = 15;
            const poll = () => {
                retries++;
                fetch('monitor_data_fileops.json?t=' + Date.now())
                    .then(r => r.ok ? r.text() : null)
                    .then(text => {
                        if (!text) {
                            if (retries < maxRetries) setTimeout(poll, 1000);
                            return;
                        }
                        try {
                            const data = JSON.parse(text);
                            if (data && data.type === 'list_dir' && 
                                data.path === fullPath && 
                                data.request_id === requestId) {
                                currentFileTree[path] = { files: data.files, loaded: true };
                                currentPath = path;
                                renderFiles();
                                renderBreadcrumb();
                                showNotification('Directory loaded successfully', 'success');
                            } else if (retries < maxRetries) {
                                setTimeout(poll, 1000);
                            }
                        } catch (e) {
                            if (retries < maxRetries) setTimeout(poll, 1000);
                        }
                    })
                    .catch(err => {
                        if (retries < maxRetries) setTimeout(poll, 1000);
                        else {
                            if (list) list.innerHTML = '<div style="padding: 40px; text-align: center; color: #ef4444;">Failed to load directory</div>';
                            showNotification('Failed to load directory', 'error');
                        }
                    });
            };
            setTimeout(poll, 500);
        }

        function loadFile(path) {
            console.log(`[LOADFILE] Starting to load: ${path}`);
            showNotification('Loading file...', 'info');
            const fullPath = path.startsWith('./') ? path : './' + path;
            console.log(`[LOADFILE] Full path: ${fullPath}`);
            const requestId = sendFileCommand('read_file', { path: fullPath });
            console.log(`[LOADFILE] Request ID: ${requestId}`);
            
            let retries = 0;
            const maxRetries = 15;
            const poll = () => {
                retries++;
                console.log(`[LOADFILE] Poll attempt ${retries}/${maxRetries}`);
                fetch('monitor_data_fileops.json?t=' + Date.now())
                    .then(r => {
                        console.log(`[LOADFILE] Fetch response:`, r.ok, r.status);
                        return r.ok ? r.text() : null;
                    })
                    .then(text => {
                        if (!text) {
                            console.log(`[LOADFILE] No text response, retrying...`);
                            if (retries < maxRetries) setTimeout(poll, 1000);
                            else console.error('[LOADFILE] Max retries reached, giving up');
                            return;
                        }
                        try {
                            const data = JSON.parse(text);
                            console.log(`[LOADFILE] Parsed data:`, {
                                type: data.type,
                                path: data.path,
                                requestId: data.request_id,
                                contentLength: data.content?.length || 0
                            });
                            
                            if (data && data.type === 'read_file' && 
                                data.path === fullPath && 
                                data.request_id === requestId) {
                                console.log(`[LOADFILE] SUCCESS! Loading content into editor...`);
                                const textArea = document.getElementById('fileContent');
                                textArea.value = addLineNumbers(data.content);
                                textArea.scrollTop = 0;
                                console.log(`[LOADFILE] Content loaded, ${data.content.length} bytes`);
                                showNotification('File loaded successfully', 'success');
                            } else {
                                console.log(`[LOADFILE] Data mismatch, waiting for correct response...`);
                                if (retries < maxRetries) setTimeout(poll, 1000);
                            }
                        } catch (e) {
                            console.error(`[LOADFILE] Parse error:`, e);
                            if (retries < maxRetries) setTimeout(poll, 1000);
                        }
                    })
                    .catch(err => {
                        console.error(`[LOADFILE] Fetch error:`, err);
                        if (retries < maxRetries) {
                            setTimeout(poll, 1000);
                        } else {
                            console.error('[LOADFILE] Max retries reached after errors');
                            showNotification('Failed to load file - check console', 'error');
                        }
                    });
            };
            setTimeout(poll, 500);
        }

        function showFileModal(path, content) {
            const fileBrowser = document.getElementById('file-browser-content');
            const unit = (fileBrowser && fileBrowser.querySelector('.explorer-unit')) || document.querySelector('#tab-files .explorer-unit');
            const name = document.getElementById('fileName');
            const text = document.getElementById('fileContent');

            const fileName = path.split('/').pop();

            name.innerText = fileName;
            text.value = content;
            if (unit) {
                unit.classList.add('editor-open');
            }
        }


        let selectedChatGuildId = null;
        let selectedChatChannelId = null;
        let chatMessageHistory = [];

        function appendChatLog(entry) {
            chatMessageHistory.push(entry);
            const log = document.getElementById('chat-message-log');
            if (!log) return;
            log.innerHTML = chatMessageHistory.map(e => `
                <div style="margin-bottom:6px; font-size:13px;">
                    <span style="color:#64748b;">[${new Date(e.timestamp).toLocaleTimeString()}]</span>
                    <span style="color:#38bdf8; font-weight:600;">${e.guild || ''} #${e.channel || ''}</span>:
                    <span style="color:#e5e7eb;">${e.content}</span>
                </div>
            `).join('');
            log.scrollTop = log.scrollHeight;
        }

        function renderChatConsole(botInfo) {
            const guilds = botInfo.guilds_detail || [];
            const guildContainer = document.getElementById('chat-guilds');
            const channelContainer = document.getElementById('chat-channels');
            const subtitle = document.getElementById('chat-channel-subtitle');
            if (!guildContainer || !channelContainer) return;

            if (!guilds.length) {
                guildContainer.innerHTML = '<div class="empty-state">Bot is not in any servers or guild data is unavailable.</div>';
                channelContainer.innerHTML = '<div class="empty-state">No channels to show.</div>';
                if (subtitle) subtitle.textContent = 'No channel selected';
                return;
            }

            guildContainer.innerHTML = guilds.map(g => `
                <div class="file-row" onclick="selectChatGuild('${g.id}')" data-guild-id="${g.id}">
                    <div class="file-name">${g.name}</div>
                    <div class="file-meta">${g.member_count || 0} members</div>
                </div>
            `).join('');

            if (!selectedChatGuildId && guilds.length) {
                selectedChatGuildId = guilds[0].id;
            }
            selectChatGuild(selectedChatGuildId, false);
        }

        function renderGuilds(guildsDetail) {
            const container = document.getElementById('guilds-list');
            if (!container) return;
            const rows = Array.isArray(guildsDetail) ? guildsDetail : [];
            
            currentGuilds = rows.map(g => ({
                id: g.id,
                name: g.name
            }));
            
            if (!rows.length) {
                container.innerHTML = '<div class="empty-state">Bot is not in any servers or guild data is unavailable.</div>';
                return;
            }
            container.classList.add('guilds-grid');
            container.innerHTML = rows.map(g => {
                const members = g.member_count || 0;
                const ownerId = g.owner_id || '';
                const ownerName = g.owner || '';
                const ownerLabel = ownerName || ownerId || 'Unknown';
                const joined = g.joined_at ? new Date(g.joined_at).toLocaleString() : 'Unknown';
                let actionsHtml = '<span style="font-size:12px;color:var(--text-secondary);">No permission</span>';
                if (typeof LM_PERMS !== 'undefined' && (LM_PERMS.action_leave_guild || LM_PERMS.control_guilds)) {
                    const safeName = (g.name || '').replace(/"/g, '&quot;');
                    actionsHtml = `<button class="button button-danger button-compact" onclick="confirmLeaveGuild('${g.id}', '${safeName}')">Leave</button>`;
                }
                const safeNameDisplay = g.name || 'Unknown server';
                return `
                    <div class="guild-card">
                        <div class="guild-card-header">
                            <div class="guild-card-name">${safeNameDisplay}</div>
                            <div class="guild-card-members">${members.toLocaleString()} members</div>
                        </div>
                        <div class="guild-card-meta">
                            <div class="guild-card-meta-row">
                                <div class="guild-meta-label">Server ID</div>
                                <div class="guild-meta-value mono">${g.id || ''}</div>
                            </div>
                            <div class="guild-card-meta-row">
                                <div class="guild-meta-label">Owner</div>
                                <div class="guild-meta-value">${ownerLabel}</div>
                            </div>
                            <div class="guild-card-meta-row">
                                <div class="guild-meta-label">Joined</div>
                                <div class="guild-meta-value">${joined}</div>
                            </div>
                        </div>
                        <div class="guild-card-actions">
                            ${actionsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.confirmLeaveGuild = function (guildId, guildName) {
            if (typeof LM_PERMS !== 'undefined' && !LM_PERMS.control_guilds) {
                showNotification('You do not have permission to make the bot leave servers.', 'error');
                return;
            }
            const name = guildName || guildId;
            if (!confirm(`Make the bot leave the server "${name}"?`)) {
                return;
            }
            sendCommand('leave_guild', { guild_id: guildId });
        };

        window.selectChatGuild = (guildId, clearLog = true) => {
            selectedChatGuildId = guildId;
            const guilds = (currentData?.bot?.guilds_detail) || [];
            const g = guilds.find(x => x.id == guildId);
            const channelContainer = document.getElementById('chat-channels');
            const subtitle = document.getElementById('chat-channel-subtitle');
            if (!g || !channelContainer) return;

            document.querySelectorAll('#chat-guilds .file-row').forEach(row => {
                if (String(row.getAttribute('data-guild-id')) === String(guildId)) {
                    row.classList.add('active');
                } else {
                    row.classList.remove('active');
                }
            });

            const channels = g.text_channels || [];
            if (!channels.length) {
                channelContainer.innerHTML = '<div class="empty-state">No text channels in this server.</div>';
                if (subtitle) subtitle.textContent = `${g.name} â€” no text channels`;
                return;
            }

            channelContainer.innerHTML = channels.map(ch => `
                <div class="file-row" onclick="selectChatChannel('${g.id}', '${ch.id}')" data-channel-id="${ch.id}">
                    <div class="file-name">#${ch.name}</div>
                </div>
            `).join('');

            if (subtitle) subtitle.textContent = 'Select a channel to start chatting as the bot';
            if (clearLog) {
                chatMessageHistory = [];
                const log = document.getElementById('chat-message-log');
                if (log) log.innerHTML = '';
            }
        };

        window.selectChatChannel = (guildId, channelId) => {
            selectedChatGuildId = guildId;
            selectedChatChannelId = channelId;
            const guilds = (currentData?.bot?.guilds_detail) || [];
            const g = guilds.find(x => x.id == guildId);
            const ch = g ? (g.text_channels || []).find(c => c.id == channelId) : null;
            const subtitle = document.getElementById('chat-channel-subtitle');
            if (subtitle && ch && g) {
                subtitle.textContent = `${g.name} â€” #${ch.name}`;
            }
            document.querySelectorAll('#chat-channels .file-row').forEach(row => {
                if (String(row.getAttribute('data-channel-id')) === String(channelId)) {
                    row.classList.add('active');
                } else {
                    row.classList.remove('active');
                }
            });
        };

        window.sendChatMessage = () => {
            if (!selectedChatChannelId) {
                showNotification('Select a channel first.', 'error');
                return;
            }
            const input = document.getElementById('chat-message-input');
            if (!input) return;
            const content = input.value.trim();
            if (!content) return;

            sendCommand('send_chat_message', {
                guild_id: selectedChatGuildId,
                channel_id: selectedChatChannelId,
                content
            });

            const guilds = (currentData?.bot?.guilds_detail) || [];
            const g = guilds.find(x => x.id == selectedChatGuildId);
            const ch = g ? (g.text_channels || []).find(c => c.id == selectedChatChannelId) : null;
            appendChatLog({
                timestamp: new Date().toISOString(),
                guild: g ? g.name : '',
                channel: ch ? ch.name : '',
                content
            });

            input.value = '';
        };

        window.requestChatHistory = () => {
            if (!window.LM_PERMS?.action_request_chat_data) {
                showNotification('You do not have permission to request chat data. Requires action_request_chat_data permission.', 'error');
                return;
            }
            if (!selectedChatChannelId) {
                showNotification('Select a channel first.', 'error');
                return;
            }
            sendCommand('request_chat_history', {
                guild_id: selectedChatGuildId,
                channel_id: selectedChatChannelId
            });
            showNotification('Requested chat data (BETA) for this channel.', 'info');
        };

        window.togglePluginEnforcement = (mode, enabled) => {
            const parsedEnabled = String(enabled) === 'true';
            sendCommand('plugin_registry_set_enforcement', { mode, enabled: parsedEnabled });
            showNotification(`Plugin enforcement updated: ${mode} = ${parsedEnabled ? 'On' : 'Off'}`, 'info');
            setTimeout(loadData, 1500);
        };

        window.toggleSlashLimiterDebug = () => {
            const current = currentData?.slash_limiter?.debug_mode ? true : false;
            const next = !current;
            sendCommand('slash_limiter_set_debug', { enabled: next });
            showNotification(`Slash limiter debug ${next ? 'enabled' : 'disabled'}`, 'info');
            setTimeout(loadData, 1500);
        };

        window.toggleAutoReload = () => {
            const current = currentData?.core_settings?.auto_reload ? true : false;
            const next = !current;
            sendCommand('set_auto_reload', { enabled: next });
            showNotification(`Auto reload ${next ? 'enabled' : 'disabled'}`, 'info');
            setTimeout(loadData, 1500);
        };

        window.toggleExtensionsAutoLoad = () => {
            const current = currentData?.core_settings?.extensions_auto_load ? true : false;
            const next = !current;
            sendCommand('set_extensions_auto_load', { enabled: next });
            showNotification(`Extensions auto-load on startup ${next ? 'enabled' : 'disabled'}`, 'info');
            setTimeout(loadData, 1500);
        };

        let localVerboseState = false;
        let localDebugState = false;
        
        window.toggleVerboseLogging = () => {
            localVerboseState = !localVerboseState;
            sendCommand('set_verbose_logging', { enabled: localVerboseState });
            showNotification(`Verbose logging ${localVerboseState ? 'enabled' : 'disabled'}`, 'info');
            
            const btn = document.getElementById('toggle-verbose-btn');
            if (btn) {
                btn.textContent = `Verbose Logging: ${localVerboseState ? 'ON' : 'OFF'}`;
                btn.className = localVerboseState ? 'button button-success' : 'button button-secondary';
            }
        };

        window.toggleDebugPackages = () => {
            localDebugState = !localDebugState;
            sendCommand('toggle_debug_packages', { enabled: localDebugState });
            showNotification(`Debug packages ${localDebugState ? 'enabled' : 'disabled'}`, 'info');
            
            const btn = document.getElementById('toggle-debug-packages-btn');
            if (btn) {
                btn.textContent = `Debug Packages: ${localDebugState ? 'ON' : 'OFF'}`;
                btn.className = localDebugState ? 'button button-success' : 'button button-secondary';
            }
        };

        function updateDebugLoggingButtons() {
            const verboseBtn = document.getElementById('toggle-verbose-btn');
            const debugBtn = document.getElementById('toggle-debug-packages-btn');
            
            if (verboseBtn && currentData?.monitor_settings) {
                const verboseOn = currentData.monitor_settings.verbose_logging || false;
                localVerboseState = verboseOn;
                verboseBtn.textContent = `Verbose Logging: ${verboseOn ? 'ON' : 'OFF'}`;
                verboseBtn.className = verboseOn ? 'button button-success' : 'button button-secondary';
                verboseBtn.title = verboseOn 
                    ? 'Currently ON - Hides repetitive success messages from console logs to reduce noise'
                    : 'Currently OFF - Shows all log messages including success notifications';
            }
            
            if (debugBtn && currentData?.monitor_settings) {
                const debugOn = currentData.monitor_settings.debug_packages || false;
                localDebugState = debugOn;
                debugBtn.textContent = `Debug Packages: ${debugOn ? 'ON' : 'OFF'}`;
                debugBtn.className = debugOn ? 'button button-success' : 'button button-secondary';
                debugBtn.title = debugOn
                    ? 'Currently ON - Shows detailed package installation logs (pip install, npm install output)'
                    : 'Currently OFF - Hides package installation details to keep logs cleaner';
            }
        }

        function renderEvents(events) {
            const container = document.getElementById('events-list');
            const countEl = document.getElementById('events-count');
            if (countEl) countEl.textContent = events.length + ' Events';
            
            if (events.length === 0) {
                container.innerHTML = '<div class="events-empty"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="1.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><div class="events-empty-title">No events recorded</div><div class="events-empty-text">Events will appear here as they occur</div></div>';
                return;
            }

            container.innerHTML = events.slice().reverse().slice(0, 50).map((event, index) => {
                const eventColors = {
                    'message': '#3b82f6',
                    'guild_join': '#10b981',
                    'guild_remove': '#ef4444',
                    'member_join': '#22d3ee',
                    'member_remove': '#f97316',
                    'command': '#8b5cf6',
                    'error': '#ef4444',
                    'ready': '#10b981'
                };
                const color = eventColors[event.type.toLowerCase()] || '#6366f1';
                
                let detailsHtml = '';
                if (event.details && Object.keys(event.details).length > 0) {
                    detailsHtml = '<div class="event-details">' +
                        Object.entries(event.details).map(([key, value]) => 
                            '<div class="event-detail-row"><span class="event-detail-key">' + key + '</span><span class="event-detail-value">' + JSON.stringify(value).substring(0, 80) + '</span></div>'
                        ).join('') +
                    '</div>';
                }
                
                return '<div class="event-item">' +
                    '<div class="event-line" style="background: ' + color + ';"></div>' +
                    '<div class="event-dot" style="background: ' + color + '; box-shadow: 0 0 10px ' + color + '50;"></div>' +
                    '<div class="event-content">' +
                        '<div class="event-header">' +
                            '<span class="event-type" style="background: ' + color + '20; color: ' + color + '; border-color: ' + color + '40;">' + event.type + '</span>' +
                            '<span class="event-time">' + formatTime(event.timestamp) + '</span>' +
                        '</div>' +
                        detailsHtml +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function toggleHeroInfo() {
            const panel = document.getElementById('hero-info-panel');
            if (!panel) return;
            panel.classList.toggle('visible');
        }

        function renderSystemDetails(data) {
            const container = document.getElementById('system-details');
            
            // Helper for status colors
            const getStatusColor = (status) => {
                if (status === 'healthy' || status === 'safe' || status === true) return { bg: 'rgba(16, 185, 129, 0.15)', border: 'rgba(16, 185, 129, 0.3)', text: '#34d399', label: status === true ? 'On' : status };
                if (status === 'degraded' || status === 'warning') return { bg: 'rgba(251, 191, 36, 0.15)', border: 'rgba(251, 191, 36, 0.3)', text: '#fbbf24', label: status };
                if (status === false) return { bg: 'rgba(148, 163, 184, 0.15)', border: 'rgba(148, 163, 184, 0.3)', text: '#94a3b8', label: 'Off' };
                return { bg: 'rgba(239, 68, 68, 0.15)', border: 'rgba(239, 68, 68, 0.3)', text: '#f87171', label: status };
            };
            
            // Modern card builder
            const buildCard = (icon, title, color, content, actions = '') => `
                <div class="sys-card" style="--card-color: ${color};">
                    <div class="sys-card-header">
                        <div class="sys-card-icon">${icon}</div>
                        <div class="sys-card-title">${title}</div>
                    </div>
                    <div class="sys-card-body">${content}</div>
                    ${actions ? '<div class="sys-card-actions">' + actions + '</div>' : ''}
                </div>
            `;
            
            const buildProperty = (label, value, valueColor = '#e5e7eb') => `
                <div class="sys-prop">
                    <span class="sys-prop-label">${label}</span>
                    <span class="sys-prop-value" style="color: ${valueColor};">${value}</span>
                </div>
            `;
            
            const buildBadge = (status) => {
                const s = getStatusColor(status);
                return '<span class="sys-badge" style="background:' + s.bg + ';border-color:' + s.border + ';color:' + s.text + ';">' + s.label + '</span>';
            };
            
            const buildBtn = (text, onclick, variant = 'secondary') => 
                '<button class="sys-btn sys-btn-' + variant + '" onclick="' + onclick + '">' + text + '</button>';
            
            let cards = '';
            
            // Bot Information Card
            cards += buildCard(
                '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>',
                'Bot Information',
                '#8b5cf6',
                buildProperty('User', data.bot.user, '#c4b5fd') +
                buildProperty('Cogs Loaded', data.bot.cogs_loaded) +
                buildProperty('Extensions', data.bot.extensions_loaded) +
                buildProperty('User Extensions', data.bot.user_extensions) +
                buildProperty('Framework Cogs', data.bot.framework_cogs)
            );
            
            // System Resources Card
            cards += buildCard(
                '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="14" x2="23" y2="14"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="14" x2="4" y2="14"/></svg>',
                'System Resources',
                '#3b82f6',
                buildProperty('CPU User Time', Math.round(data.system.cpu_user_time || 0) + 's') +
                buildProperty('Memory %', (data.system.memory_percent || 0).toFixed(2) + '%') +
                buildProperty('Threads', data.system.threads) +
                buildProperty('Open Files', data.system.open_files) +
                buildProperty('Connections', data.system.connections)
            );
            
            // Framework Health Card
            if (data.health) {
                const healthStatus = getStatusColor(data.health.status || 'unknown');
                cards += buildCard(
                    '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>',
                    'Framework Health',
                    healthStatus.text,
                    buildProperty('Status', buildBadge(data.health.status || 'unknown')) +
                    buildProperty('Error Rate', (data.health.error_rate ?? 0).toFixed(2) + '%') +
                    buildProperty('Event Loop Lag', (data.health.event_loop_lag_ms || 0).toFixed(2) + ' ms') +
                    buildProperty('Write Failures', data.health.consecutive_write_failures || 0)
                );
            }
            
            // Slash Command Limiter Card
            if (data.slash_limiter) {
                const slashStatus = getStatusColor(data.slash_limiter.status);
                const pct = data.slash_limiter.percentage || 0;
                const progressColor = pct > 80 ? '#ef4444' : pct > 60 ? '#fbbf24' : '#10b981';
                cards += buildCard(
                    '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 3a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3H6a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3h12a3 3 0 0 0 3-3 3 3 0 0 0-3-3z"/></svg>',
                    'Slash Command Limiter',
                    slashStatus.text,
                    buildProperty('Status', buildBadge(data.slash_limiter.status)) +
                    buildProperty('Usage', data.slash_limiter.current + ' / ' + data.slash_limiter.limit) +
                    '<div class="sys-progress"><div class="sys-progress-bar" style="width:' + pct + '%;background:' + progressColor + ';"></div></div>' +
                    buildProperty('Blocked', data.slash_limiter.blocked) +
                    buildProperty('Converted', data.slash_limiter.converted)
                );
            }
            
            // Event Hooks Metrics Card
            if (data.event_hooks && data.event_hooks.metrics) {
                cards += buildCard(
                    '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>',
                    'Event Hooks Metrics',
                    '#f97316',
                    buildProperty('Emissions', data.event_hooks.metrics.total_emissions || 0) +
                    buildProperty('Executions', data.event_hooks.metrics.total_executions || 0) +
                    buildProperty('Failures', data.event_hooks.metrics.total_failures || 0, data.event_hooks.metrics.total_failures > 0 ? '#f87171' : '#e5e7eb') +
                    buildProperty('Queue Size', data.event_hooks.queue_size || 0)
                );
            }
            
            // Core Settings Card
            if (data.core_settings && Object.keys(data.core_settings).length > 0) {
                cards += buildCard(
                    '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
                    'Core Settings',
                    '#6366f1',
                    buildProperty('Auto Reload', buildBadge(data.core_settings.auto_reload)) +
                    buildProperty('Auto Load (Startup)', buildBadge(data.core_settings.extensions_auto_load)),
                    buildBtn('Toggle Reload', 'toggleAutoReload()') + buildBtn('Toggle Auto Load', 'toggleExtensionsAutoLoad()')
                );
            }
            
            // Monitor Settings Card
            if (data.monitor_settings) {
                const ms = data.monitor_settings;
                const intervalInfo = ms.update_interval ? `${ms.update_interval}s` : 'N/A';
                const collectionInfo = ms.collection_duration_ms ? `${ms.collection_duration_ms}ms` : 'N/A';
                const bufferInfo = ms.recommended_buffer_ms ? `${ms.recommended_buffer_ms}ms` : 'N/A';
                
                cards += buildCard(
                    '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>',
                    'Monitor Settings',
                    '#06b6d4',
                    buildProperty('Update Interval', intervalInfo) +
                    buildProperty('Collection Time', collectionInfo) +
                    buildProperty('Recommended Buffer', bufferInfo) +
                    buildProperty('Verbose Logging', buildBadge(ms.verbose_logging)) +
                    buildProperty('Debug Packages', buildBadge(ms.debug_packages)) +
                    '<div class="sys-hint">Buffer accounts for network latency â€¢ Collection time = data gathering duration</div>',
                    buildBtn('Toggle Verbose', 'toggleVerboseLogging()') + buildBtn('Toggle Debug', 'toggleDebugPackages()')
                );
            }
            
            // Atomic FS Card (spans full width)
            let atomicCard = '';
            if (data.atomic_fs) {
                const locks = data.atomic_fs.locks || [];
                const lockSummary = data.atomic_fs.lock_summary || {};
                const hitRate = data.atomic_fs.hit_rate || 0;
                const cacheSize = data.atomic_fs.cache_size || 0;
                const maxCache = data.atomic_fs.max_cache_size || 1000;
                const activeLocks = locks.filter(l => l.locked).length || lockSummary.active || data.atomic_fs.active_locks || 0;
                
                let locksContent = '';
                if (locks.length > 0) {
                    locksContent = '<div class="sys-locks-table">' +
                        '<div class="sys-locks-header"><span>Path</span><span>Status</span><span>Last Op</span><span>Last Used</span><span>Actions</span></div>' +
                        locks.map(lock => {
                            const isLocked = lock.locked;
                            return '<div class="sys-locks-row">' +
                                '<div class="sys-lock-path" title="' + lock.path + '">' + lock.path + '</div>' +
                                '<div><span class="sys-lock-chip ' + (isLocked ? 'locked' : 'idle') + '">' + (isLocked ? 'Locked' : 'Idle') + '</span></div>' +
                                '<div>' + (lock.last_operation || 'n/a') + '</div>' +
                                '<div class="sys-lock-time">' + (lock.last_used ? formatTime(lock.last_used) : 'n/a') + '</div>' +
                                '<div class="sys-lock-actions">' +
                                    '<button class="sys-btn-sm af-invalidate-lock" data-path="' + lock.path + '">Invalidate</button>' +
                                    '<button class="sys-btn-sm sys-btn-danger af-release-lock" data-path="' + lock.path + '">Force</button>' +
                                '</div>' +
                            '</div>';
                        }).join('') +
                    '</div>';
                } else if (activeLocks > 0) {
                    locksContent = '<div class="sys-empty-locks"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><div>Lock count available but details not provided</div><div class="sys-empty-sub">' + activeLocks + ' active lock(s) reported</div></div>';
                } else {
                    locksContent = '<div class="sys-empty-locks"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg><div>No active file locks</div></div>';
                }
                
                atomicCard = '<div class="sys-card sys-card-wide" style="--card-color: #ec4899;">' +
                    '<div class="sys-card-header">' +
                        '<div class="sys-card-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div>' +
                        '<div class="sys-card-title">Active File Locks</div>' +
                        '<div class="sys-card-stats">' +
                            '<span class="sys-mini-stat"><strong>' + hitRate + '%</strong> hit rate</span>' +
                            '<span class="sys-mini-stat"><strong>' + cacheSize + '/' + maxCache + '</strong> cache</span>' +
                            '<span class="sys-mini-stat"><strong>' + activeLocks + '</strong> active</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="sys-card-body sys-locks-body">' + locksContent + '</div>' +
                '</div>';
            }
            
            container.innerHTML = '<div class="sys-grid">' + cards + '</div>' + atomicCard;
            
            // Attach lock control handlers
            container.querySelectorAll('.af-invalidate-lock').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const path = btn.getAttribute('data-path');
                    if (path) sendCommand('af_invalidate_cache_entry', { path });
                });
            });
            container.querySelectorAll('.af-release-lock').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const path = btn.getAttribute('data-path');
                    if (path) sendCommand('af_force_release_lock', { path });
                });
            });
        }

        let retryCount = 0;
        const maxRetries = 10;
        let retryTimeout = null;
        let expandedCards = new Set();
        let searchState = {
            commands: ''
        };
        let isCommandPending = false;
        
        function openSectionHelp(section) {
            const map = {
                dashboard: {
                    title: 'Dashboard Overview',
                    body: 'High-level health, alerts, and quick actions. Start here to see if anything needs attention.',
                },
                commands: {
                    title: 'Commands Overview',
                    body: 'Shows every registered command with usage, errors, and how to invoke it. Sort and filter to find hotspots.',
                },
                plugins: {
                    title: 'Plugins & Extensions',
                    body: 'Each plugin corresponds to an extension. This view surfaces dependency issues, conflicts, and load times so you can keep your stack healthy.',
                },
                hooks: {
                    title: 'Event Hooks System',
                    body: 'Advanced event pipeline. Use this to see which hooks are running, how often, and where failures happen.',
                },
                filesystem: {
                    title: 'File System Overview',
                    body: 'Aggregate stats for data, cogs, extensions, and botlogs. Helps you spot growth and disk-heavy areas.',
                },
                files: {
                    title: 'File Browser',
                    body: 'Safe, live view into your bot files. Browse logs, configs, and cogs. Writes go through the bot so atomic FS rules still apply.',
                },
                chat: {
                    title: 'Chat Console',
                    body: 'Experimental console to talk as the bot and inspect recent messages. Use for quick diagnostics, not for full moderation.',
                },
                events: {
                    title: 'Recent Events',
                    body: 'Stream of high-level framework events (joins, errors, hook actions). Good for â€œwhat just happened?â€ questions.',
                },
                system: {
                    title: 'System Details',
                    body: 'Low-level metrics like event-loop lag, atomic FS locks, and slash command limiter state.',
                },
                roles: {
                    title: 'Roles & Access',
                    body: 'Owner-only panel to see which Discord IDs can access the dashboard and what role (OWNER / CUSTOM) they have.',
                },
                security: {
                    title: 'Security & Logs',
                    body: 'Owner-only audit view that shows logins, configuration changes, and other sensitive events. Backed by a SQLite audit_log table.',
                },
                guilds: {
                    title: 'Guilds / Servers',
                    body: 'Lists the servers the bot is in. With the right role, you can make the bot leave a guild from here.',
                },
                database: {
                    title: 'Database viewer',
                    body: 'Read-only viewer for the local dashboard.sqlite database (config, roles, audits).',
                },
                invite: {
                    title: 'Bot Invite Helper',
                    body: 'Generate OAuth2 invite URLs for your bot. Configure application ID, scopes (bot, applications.commands), and permissions. For advanced settings, use the Discord Developer Portal.',
                },
                marketplace: {
                    title: 'Extension/Plugin Marketplace',
                    body: 'BETA feature - Browse and download extensions directly from the ZygnalBot marketplace. Downloaded extensions are saved directly to ./extensions/ folder and can be automatically loaded. Requires ZygnalID activation for downloads.',
                },
                invite: {
                    title: 'Bot Invite Helper',
                    body: 'Generate Discord OAuth2 invite links for your bot. Customize the client ID, scopes, and permissions to create the perfect invite URL for adding your bot to servers.',
                },
            };
            const info = map[section] || { title: 'Section Help', body: 'This section provides additional monitoring information.' };
            openModal(info.title, `<p style="font-size:13px;color:var(--text-secondary);">${info.body}</p>`);
        }

        // Notification system with stacking support
        const activeNotifications = [];
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'lm-toast-notification';
            
            // Calculate vertical position based on existing notifications
            let topOffset = 20;
            activeNotifications.forEach(n => {
                if (n && n.offsetHeight) {
                    topOffset += n.offsetHeight + 12;
                }
            });
            
            notification.style.cssText = `
                position: fixed;
                top: ${topOffset}px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'success' ? 'linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.95))' : type === 'error' ? 'linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(185, 28, 28, 0.95))' : 'linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95))'};
                color: white;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.1) inset;
                z-index: 10000;
                animation: toastSlideIn 0.3s ease;
                font-weight: 600;
                font-size: 14px;
                max-width: 400px;
                backdrop-filter: blur(8px);
                border: 1px solid rgba(255,255,255,0.15);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Track this notification
            activeNotifications.push(notification);
            
            // Function to reposition remaining notifications
            function repositionNotifications() {
                let offset = 20;
                activeNotifications.forEach(n => {
                    if (n && n.parentNode) {
                        n.style.top = offset + 'px';
                        offset += n.offsetHeight + 12;
                    }
                });
            }
            
            setTimeout(() => {
                notification.style.animation = 'toastSlideOut 0.3s ease forwards';
                setTimeout(() => {
                    // Remove from tracking array
                    const idx = activeNotifications.indexOf(notification);
                    if (idx > -1) activeNotifications.splice(idx, 1);
                    notification.remove();
                    // Reposition remaining notifications
                    repositionNotifications();
                }, 300);
            }, 3000);
        }
        
        const style = document.createElement('style');
        style.textContent = `
            @keyframes toastSlideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes toastSlideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
            .lm-toast-notification {
                transition: top 0.3s ease;
            }
        `;
        document.head.appendChild(style);

        // === Roles & Access (owner-only UI over owner_roles.php) ===
        let rolesTabInitialized = false;

        function loadRolesTab() {
            if (rolesTabInitialized) return;
            const container = document.getElementById('roles-content');
            if (!container) return;

            container.innerHTML = '<div class="loading">Loading roles from server...</div>';

            fetch('owner_roles.php?format=json', { credentials: 'include' })
                .then(async r => {
                    let data = null;
                    const contentType = r.headers.get('content-type');
                    try {
                        if (contentType && contentType.includes('application/json')) {
                            data = await r.json();
                        } else {
                            const text = await r.text();
                            console.error('Roles API returned non-JSON response:', text.substring(0, 500));
                            throw new Error('Server returned invalid response');
                        }
                    } catch (parseErr) {
                        console.error('Failed to parse roles response:', parseErr);
                        throw new Error('Failed to parse server response');
                    }
                    if (!r.ok) {
                        const msg = interpretHttpError(r.status, data, 'roles');
                        showNotification(msg, 'error');
                        throw new Error(msg);
                    }
                    return data || {};
                })
                .then(data => {
                    renderRolesTab(container, data);
                    rolesTabInitialized = true;
                })
                .catch(err => {
                    console.error('Roles load error:', err);
                    if (err.message === 'Failed to fetch') {
                        container.innerHTML = '<div class="empty-state">Network error: Could not connect to roles API. Please refresh the page.</div>';
                    } else {
                        container.innerHTML = '<div class="empty-state">Unable to load roles: ' + (err.message || 'Unknown error') + '</div>';
                    }
                });
        }

        function renderRolesTab(container, data) {
            const users = data.users || [];
            const roles = data.roles || [];
            const ownerId = data.owner_discord_id || null;

            const VIEW_PERM_DEFS = [
                { key: 'view_dashboard', label: 'Dashboard' },
                { key: 'view_commands', label: 'Commands' },
                { key: 'view_plugins', label: 'Plugins & Extensions' },
                { key: 'view_hooks', label: 'Event Hooks' },
                { key: 'view_filesystem', label: 'File System Overview' },
                { key: 'view_files', label: 'File Browser' },
                { key: 'view_chat', label: 'Chat Console' },
                { key: 'view_tickets', label: 'Discord Tickets' },
                { key: 'view_events', label: 'Events' },
                { key: 'view_system', label: 'System Details' },
                { key: 'view_security', label: 'Security & Logs (tab only - requires action_view_logs for content)' },
                { key: 'view_guilds', label: 'Guilds / Servers' },
                { key: 'view_database', label: 'Database Viewer' },
                { key: 'view_marketplace', label: 'Extension Marketplace' },
                { key: 'view_bot_invite', label: 'Bot Invite Helper' },
                { key: 'view_roles', label: 'Roles & Access' },
                /* DASHBOARD_PLUGINS_VIEW_PERMS_PLACEHOLDER */
            ];

            const CONTROL_PERM_DEFS = [
                // Dashboard Actions
                { key: 'action_clear_cache', label: 'Clear Cache' },
                { key: 'action_toggle_logging', label: 'Toggle Verbose Logging' },
                { key: 'action_toggle_debug_packages', label: 'Toggle Debug Packages' },
                { key: 'action_backup_dashboard', label: 'Backup Dashboard' },
                { key: 'action_backup_bot', label: 'Backup Bot Directory' },
                
                // Plugin Actions
                { key: 'action_reload_extension', label: 'Reload Extension' },
                { key: 'action_load_extension', label: 'Load Extension' },
                { key: 'action_unload_extension', label: 'Unload Extension' },
                { key: 'action_set_auto_reload', label: 'Set Auto Reload' },
                { key: 'action_set_auto_load', label: 'Set Auto Load Extensions' },
                { key: 'action_set_enforcement', label: 'Set Plugin Enforcement' },
                
                // Hook Actions
                { key: 'action_enable_hook', label: 'Enable Event Hook' },
                { key: 'action_disable_hook', label: 'Disable Event Hook' },
                { key: 'action_reset_circuit', label: 'Reset Circuit Breaker' },
                { key: 'action_create_hook', label: 'Create Event Hook' },
                { key: 'action_delete_hook', label: 'Delete Event Hook' },
                { key: 'action_export_hooks', label: 'Export Hooks JSON' },
                
                // File Actions
                { key: 'action_upload_file', label: 'Upload File' },
                { key: 'action_rename_file', label: 'Rename File' },
                { key: 'action_delete_file', label: 'Delete File/Folder' },
                { key: 'action_create_folder', label: 'Create Folder' },
                { key: 'action_edit_file', label: 'Edit File' },
                { key: 'action_save_file', label: 'Save File' },
                
                // System Actions
                { key: 'action_shutdown_bot', label: 'Shutdown Bot (DANGEROUS)' },
                { key: 'action_generate_diagnostics', label: 'Generate Diagnostics' },
                { key: 'action_invalidate_cache', label: 'Invalidate Cache Entry' },
                { key: 'action_force_release_lock', label: 'Force Release Lock (DANGEROUS)' },
                
                // Chat Actions
                { key: 'action_send_message', label: 'Send Chat Message' },
                { key: 'action_request_chat_data', label: 'Request Chat History Data' },
                
                // Ticket Actions
                { key: 'action_view_ticket', label: 'View Ticket Transcript' },
                { key: 'action_download_ticket', label: 'Download Ticket Transcript' },
                { key: 'action_delete_ticket', label: 'Delete Ticket' },
                
                // Guild Actions
                { key: 'action_leave_guild', label: 'Leave Guild (DANGEROUS)' },
                
                // Bot Invite Actions
                { key: 'action_generate_invite', label: 'Generate Bot Invite' },
                { key: 'action_open_invite', label: 'Open Bot Invite' },
                { key: 'action_copy_invite', label: 'Copy Bot Invite' },
                
                // Marketplace Actions
                { key: 'action_fetch_marketplace', label: 'Fetch Marketplace Extensions' },
                { key: 'action_download_extension', label: 'Download Extension' },
                { key: 'action_load_marketplace_extension', label: 'Load Marketplace Extension' },
                { key: 'action_refresh_zygnalid', label: 'Refresh Zygnalid Cache' },
                { key: 'action_refresh_marketplace', label: 'Refresh Marketplace Data' },
                
                // Role Management Actions
                { key: 'action_save_role', label: 'Save Role Changes' },
                { key: 'action_delete_role', label: 'Delete Role (DANGEROUS)' },
                { key: 'action_create_role', label: 'Create Role' },
                
                // User Management Actions
                { key: 'action_add_user', label: 'Add User to Whitelist' },
                { key: 'action_remove_user', label: 'Remove User from Whitelist' },
                { key: 'action_change_user_role', label: 'Change User Role' },
                
                // Log Actions
                { key: 'action_view_logs', label: 'View Audit Logs' },
                { key: 'action_export_logs', label: 'Export Audit Logs' },
                
                // Database Actions
                { key: 'action_execute_query', label: 'Execute Database Query (DANGEROUS)' },
                { key: 'action_db_create', label: 'Create Database Records' },
                { key: 'action_db_read', label: 'Read Database Records' },
                { key: 'action_db_update', label: 'Update Database Records' },
                { key: 'action_db_delete', label: 'Delete Database Records' },
                /* DASHBOARD_PLUGINS_ACTION_PERMS_PLACEHOLDER */
            ];

            const OTHER_PERM_DEFS = [];

            const rolesOptions = roles.map(r => r.name).filter(Boolean);

            const rolesHtml = users.map(u => {
                const isOwner = u.role === 'OWNER';
                const disableRoleChange = isOwner;
                const disableDelete = isOwner;
                const allRoleNames = Array.from(new Set([...rolesOptions, u.role].filter(Boolean)));
                const roleOptionsHtml = allRoleNames.map(name => `<option value="${name}" ${u.role === name ? 'selected' : ''}>${name}</option>`).join('');
                const roleSelect = `
                    <select data-user-id="${u.id}" class="roles-form-select role-select" ${disableRoleChange ? 'disabled' : ''}>
                        ${roleOptionsHtml}
                    </select>`;
                return `
                    <tr>
                        <td><span class="roles-user-id">${u.id}</span></td>
                        <td><span class="roles-user-discord">${u.discord_user_id}</span></td>
                        <td><span class="roles-user-name">${u.display_name}</span></td>
                        <td>${roleSelect}</td>
                        <td>
                            <div class="roles-table-actions">
                                <button class="roles-btn-save" data-action="save-role" data-user-id="${u.id}" ${disableRoleChange ? 'disabled' : ''}>Save</button>
                                <button class="roles-btn-remove" data-action="delete-user" data-user-id="${u.id}" ${disableDelete ? 'disabled' : ''}>Remove</button>
                            </div>
                        </td>
                    </tr>`;
            }).join('');

            container.innerHTML = `
                <div class="roles-grid">
                    <!-- Users & Access Section -->
                    <div class="roles-section">
                        <div class="roles-section-header">
                            <div class="roles-section-icon users">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            </div>
                            <div>
                                <div class="roles-section-title">Users &amp; Access</div>
                                <div class="roles-section-subtitle">Manage who can access the dashboard</div>
                            </div>
                        </div>
                        <div class="roles-section-body">
                            <!-- Add User Form -->
                            <div class="roles-add-form">
                                <div class="roles-form-group">
                                    <label class="roles-form-label">Discord ID</label>
                                    <input id="roles-add-discord" class="roles-form-input" type="text" placeholder="e.g. 123456789012345678"/>
                                </div>
                                <div class="roles-form-group">
                                    <label class="roles-form-label">Display Name</label>
                                    <input id="roles-add-name" class="roles-form-input" type="text" placeholder="Optional"/>
                                </div>
                                <div class="roles-form-group" style="min-width:140px;">
                                    <label class="roles-form-label">Role</label>
                                    <select id="roles-add-role" class="roles-form-select">
                                        ${rolesOptions.map(name => `<option value="${name}">${name}</option>`).join('')}
                                    </select>
                                </div>
                                <button class="roles-add-btn" id="roles-add-submit">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                    Add User
                                </button>
                            </div>
                            <p class="roles-form-hint">OWNER role is assigned on first claim and cannot be added manually.</p>
                            
                            <!-- Users Table -->
                            <div class="roles-table-wrap">
                                <table class="roles-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Discord ID</th>
                                            <th>Name</th>
                                            <th>Role</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${rolesHtml || '<tr><td colspan="5" class="roles-table-empty">No users registered yet. Use the form above to add one.</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Role Profiles Section -->
                    <div class="roles-section">
                        <div class="roles-section-header">
                            <div class="roles-section-icon profiles">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                            </div>
                            <div>
                                <div class="roles-section-title">Role Profiles</div>
                                <div class="roles-section-subtitle">Create and customize permission sets</div>
                            </div>
                        </div>
                        <div class="roles-section-body">
                            <div id="roles-profiles"></div>
                        </div>
                    </div>
                </div>
            `;

            const addBtn = document.getElementById('roles-add-submit');
            if (addBtn) {
                addBtn.addEventListener('click', () => {
                    if (!window.LM_PERMS?.action_add_user) {
                        showNotification('You do not have permission to add users. Requires action_add_user permission.', 'error');
                        return;
                    }
                    const did = (document.getElementById('roles-add-discord') || {}).value?.trim();
                    const name = (document.getElementById('roles-add-name') || {}).value?.trim();
                    const roleSel = document.getElementById('roles-add-role');
                    const role = roleSel ? roleSel.value : 'CUSTOM';
                    if (!did) {
                        showNotification('Please provide a Discord user ID.', 'error');
                        return;
                    }
                    rolesApiRequest({ action: 'add', discord_user_id: did, display_name: name || did, role });
                });
            }

            container.querySelectorAll('button[data-action="save-role"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (!window.LM_PERMS?.action_change_user_role) {
                        showNotification('You do not have permission to change user roles. Requires action_change_user_role permission.', 'error');
                        return;
                    }
                    const userId = btn.getAttribute('data-user-id');
                    const sel = container.querySelector(`select.role-select[data-user-id="${userId}"]`);
                    if (!sel) return;
                    const role = sel.value;
                    rolesApiRequest({ action: 'update_role', user_id: parseInt(userId, 10), role });
                });
            });

            container.querySelectorAll('button[data-action="delete-user"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (!window.LM_PERMS?.action_remove_user) {
                        showNotification('You do not have permission to remove users. Requires action_remove_user permission.', 'error');
                        return;
                    }
                    const userId = btn.getAttribute('data-user-id');
                    if (!confirm('Remove this user from dashboard access?')) return;
                    rolesApiRequest({ action: 'delete', user_id: parseInt(userId, 10) });
                });
            });

            // ---- Role profiles UI ----
            const profilesContainer = document.getElementById('roles-profiles');
            if (!profilesContainer) return;

            const builtin = roles.filter(r => r.system);
            const custom = roles.filter(r => !r.system);

            let html = '';
            if (builtin.length) {
                html += `
                    <div class="roles-builtin-card">
                        <div class="roles-builtin-title">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                            Built-in Roles
                        </div>
                        <div class="roles-builtin-list">
                            ${builtin.map(r => `<div class="roles-builtin-item"><strong>${r.name}</strong> â€” ${r.description || 'No description'}</div>`).join('')}
                        </div>
                        <p class="roles-builtin-note">Built-in roles define base permissions. Custom roles extend them.</p>
                    </div>
                `;
            }

            html += `
                <div class="roles-create-form">
                    <div class="roles-form-group">
                        <label class="roles-create-label">Role Name</label>
                        <input id="role-new-name" class="roles-form-input" type="text" placeholder="e.g. LOGS_ONLY"/>
                    </div>
                    <div class="roles-form-group" style="min-width:160px;">
                        <label class="roles-create-label">Base Tier</label>
                        <select id="role-new-base" class="roles-form-select">
                            <option value="CUSTOM">CUSTOM (customizable)</option>
                            <option value="OWNER">OWNER (full access)</option>
                        </select>
                    </div>
                    <button class="roles-create-btn" id="role-new-create">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Create Role
                    </button>
                </div>
            `;

            custom.forEach(role => {
                const perms = role.permissions || {};
                const enabledActions = CONTROL_PERM_DEFS.filter(def => perms[def.key]).map(def => def.label);
                const enabledTabs = VIEW_PERM_DEFS.filter(def => perms[def.key]).map(def => def.label);
                const otherCaps = OTHER_PERM_DEFS.filter(def => perms[def.key]).map(def => def.label);
                const summaryParts = [];
                if (enabledTabs.length) summaryParts.push(enabledTabs.length + ' tabs');
                if (enabledActions.length) summaryParts.push(enabledActions.length + ' actions');
                if (otherCaps.length) summaryParts.push(otherCaps.length + ' other');
                const summaryText = summaryParts.length
                    ? summaryParts.join(' â€¢ ')
                    : 'No permissions enabled';

                html += `
                    <div class="roles-profile-card" data-role-id="${role.id}">
                        <div class="roles-profile-header">
                            <div class="roles-profile-info">
                                <div class="roles-profile-name">
                                    ${role.name}
                                    <span class="roles-profile-edited role-edited-badge">Edited</span>
                                </div>
                                <div class="roles-profile-base">Base: ${role.base_role}</div>
                                <div class="roles-profile-summary">${summaryText}</div>
                            </div>
                            <div class="roles-profile-actions">
                                <button class="roles-btn-edit" data-role-action="toggle" data-role-id="${role.id}">Edit</button>
                                <button class="roles-btn-delete" data-role-action="delete" data-role-id="${role.id}">Delete</button>
                            </div>
                        </div>
                        <div class="roles-profile-body">
                            <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:16px;">
                                <div class="roles-form-group" style="min-width:160px;flex:0;">
                                    <label class="roles-form-label">Base Tier</label>
                                    <select class="roles-form-select" data-role-field="base_role" data-role-id="${role.id}">
                                        <option value="CUSTOM" ${role.base_role === 'CUSTOM' ? 'selected' : ''}>CUSTOM</option>
                                        <option value="OWNER" ${role.base_role === 'OWNER' ? 'selected' : ''}>OWNER</option>
                                    </select>
                                </div>
                                <div class="roles-form-group" style="flex:1;">
                                    <label class="roles-form-label">Description</label>
                                    <input class="roles-form-input" data-role-field="description" data-role-id="${role.id}" placeholder="Role description..." value="${role.description || ''}"/>
                                </div>
                            </div>
                            
                            <div class="roles-perm-section">
                                <div class="roles-perm-title">Tab Access</div>
                                <div class="roles-perm-grid">
                                    ${VIEW_PERM_DEFS.map(def => `
                                        <label class="roles-perm-item">
                                            <input type="checkbox" data-role-perm="${def.key}" data-role-id="${role.id}" ${perms[def.key] ? 'checked' : ''}/>
                                            <span>${def.label}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="roles-perm-section">
                                <div class="roles-perm-title">Actions</div>
                                <div class="roles-perm-grid">
                                    ${CONTROL_PERM_DEFS.map(def => `
                                        <label class="roles-perm-item">
                                            <input type="checkbox" data-role-perm="${def.key}" data-role-id="${role.id}" ${perms[def.key] ? 'checked' : ''}/>
                                            <span>${def.label}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="roles-profile-save">
                                <button class="roles-btn-primary" data-role-action="save" data-role-id="${role.id}">Save Changes</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            profilesContainer.innerHTML = html;

            function markRoleEdited(roleId) {
                const card = profilesContainer.querySelector(`.roles-profile-card[data-role-id="${roleId}"]`);
                if (!card) return;
                const badge = card.querySelector('.roles-profile-edited');
                if (!badge) return;
                badge.style.display = 'inline-flex';
            }

            // Collapse/expand custom role details
            profilesContainer.querySelectorAll('[data-role-action="toggle"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = parseInt(btn.getAttribute('data-role-id'), 10);
                    if (!id) return;
                    const card = profilesContainer.querySelector(`.roles-profile-card[data-role-id="${id}"]`);
                    if (!card) return;
                    const body = card.querySelector('.roles-profile-body');
                    if (!body) return;
                    const isOpen = body.classList.contains('active');
                    body.classList.toggle('active');
                    btn.textContent = isOpen ? 'Edit' : 'Close';
                });
            });

            // Mark roles as edited when fields change
            profilesContainer.querySelectorAll('[data-role-field="base_role"]').forEach(sel => {
                const id = parseInt(sel.getAttribute('data-role-id'), 10);
                sel.addEventListener('change', () => markRoleEdited(id));
            });
            profilesContainer.querySelectorAll('[data-role-field="description"]').forEach(area => {
                const id = parseInt(area.getAttribute('data-role-id'), 10);
                area.addEventListener('input', () => markRoleEdited(id));
            });
            profilesContainer.querySelectorAll('[data-role-perm]').forEach(cb => {
                const id = parseInt(cb.getAttribute('data-role-id'), 10);
                cb.addEventListener('change', () => markRoleEdited(id));
            });

            const createBtn = document.getElementById('role-new-create');
            if (createBtn) {
                createBtn.addEventListener('click', () => {
                    // CRITICAL: Check permission before creating role
                    if (!window.LM_PERMS?.action_create_role) {
                        showNotification('You do not have permission to create roles. Requires action_create_role permission.', 'error');
                        return;
                    }
                    
                    const nameEl = document.getElementById('role-new-name');
                    const baseEl = document.getElementById('role-new-base');
                    const name = nameEl.value.trim();
                    const base = baseEl.value;
                    if (!name) {
                        showNotification('Role name is required', 'error');
                        return;
                    }
                    rolesApiRequest({ action: 'role_create', name, base_role: base });
                });
            }

            profilesContainer.querySelectorAll('[data-role-action="delete"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    // CRITICAL: Check permission before deleting role
                    if (!window.LM_PERMS?.action_delete_role) {
                        showNotification('You do not have permission to delete roles. Requires action_delete_role permission.', 'error');
                        return;
                    }
                    
                    const id = parseInt(btn.getAttribute('data-role-id'), 10);
                    if (!id) return;
                    if (!confirm('Delete this role profile? It must not be assigned to any users.')) return;
                    rolesApiRequest({ action: 'role_delete', id });
                });
            });

            profilesContainer.querySelectorAll('[data-role-action="save"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    // CRITICAL: Check permission before saving role
                    if (!window.LM_PERMS?.action_save_role) {
                        showNotification('You do not have permission to save role changes. Requires action_save_role permission.', 'error');
                        return;
                    }
                    
                    const id = parseInt(btn.getAttribute('data-role-id'), 10);
                    if (!id) return;
                    const card = profilesContainer.querySelector(`.roles-profile-card[data-role-id="${id}"]`);
                    if (!card) return;
                    const baseSel = card.querySelector('[data-role-field="base_role"]');
                    const descEl = card.querySelector('[data-role-field="description"]');
                    const permEls = card.querySelectorAll('[data-role-perm]');
                    const base_role = baseSel ? baseSel.value : 'CUSTOM';
                    const description = descEl ? descEl.value : '';
                    const perms = {};
                    permEls.forEach(el => {
                        const key = el.getAttribute('data-role-perm');
                        perms[key] = el.checked;
                    });
                    rolesApiRequest({ action: 'role_update', id, base_role, description, permissions: perms });
                });
            });
        }

        function rolesApiRequest(payload) {
            fetch('owner_roles.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(payload)
            })
                .then(async r => {
                    let data = null;
                    const contentType = r.headers.get('content-type');
                    try {
                        if (contentType && contentType.includes('application/json')) {
                            data = await r.json();
                        } else {
                            const text = await r.text();
                            console.error('Roles API returned non-JSON response:', text.substring(0, 500));
                            throw new Error('Server returned invalid response. Check server logs.');
                        }
                    } catch (parseErr) {
                        console.error('Failed to parse roles API response:', parseErr);
                        throw new Error('Failed to parse server response');
                    }
                    if (!r.ok) {
                        const msg = interpretHttpError(r.status, data, 'roles');
                        throw new Error(msg);
                    }
                    return data || {};
                })
                .then(data => {
                    if (!data.success) {
                        showNotification(data.error || 'Roles API error', 'error');
                        return;
                    }
                    showNotification(data.message || 'Updated roles', 'success');
                    rolesTabInitialized = false;
                    loadRolesTab();
                })
                .catch(err => {
                    console.error('Roles API error:', err);
                    if (err.message === 'Failed to fetch') {
                        showNotification('Network error: Could not connect to roles API. Please refresh the page and try again.', 'error');
                    } else {
                        showNotification(err.message || 'Failed to update roles.', 'error');
                    }
                });
        }

        let dbCurrentTable = null;
        let dbCurrentPage = 1;
        let dbPageSize = 50;
        let dbTotalRecords = 0;
        let dbTableColumns = [];
        let dbSelectedRows = new Set();
        let dbSortColumn = null;
        let dbSortDirection = 'asc';
        let dbFilters = {};
        
        function loadDatabaseTables() {
            console.log('[DATABASE] loadDatabaseTables() called');
            if (typeof window.LM_PERMS !== 'undefined') {
                console.log('[DATABASE] LM_PERMS.action_db_read:', window.LM_PERMS.action_db_read);
            } else {
                console.error('[DATABASE] window.LM_PERMS is undefined!');
            }
            
            const listEl = document.getElementById('db-tables-list');
            if (!listEl) return;
            
            listEl.innerHTML = '<div class="loading" style="padding:20px;text-align:center;color:#94a3b8;">Loading tables...</div>';
            
            fetch('owner_db.php?action=tables', { credentials: 'include' })
                .then(async r => {
                    let data = null;
                    try {
                        data = await r.json();
                    } catch (_) {}
                    if (!r.ok) {
                        const msg = interpretHttpError(r.status, data, 'database');
                        showNotification(msg, 'error');
                        throw new Error(msg);
                    }
                    return data || {};
                })
                .then(data => {
                    const tables = data.tables || [];
                    if (!tables.length) {
                        listEl.innerHTML = '<div style="padding:20px;text-align:center;color:#94a3b8;font-size:13px;">No tables found</div>';
                        return;
                    }
                    
                    const hasRead = hasPermission('action_db_read');
                    const hasWrite = hasPermission('action_db_create') || hasPermission('action_db_update') || hasPermission('action_db_delete');
                    
                    listEl.innerHTML = tables.map(t => {
                        const isActive = dbCurrentTable === t.name;
                        return `
                            <div class="db-table-item ${isActive ? 'active' : ''}" data-table="${t.name}" onclick="selectDatabaseTable('${t.name}')" style="
                                padding: 12px 16px;
                                margin-bottom: 4px;
                                border-radius: 8px;
                                cursor: pointer;
                                background: ${isActive ? 'rgba(168, 85, 247, 0.2)' : 'rgba(15, 23, 42, 0.4)'};
                                border: 1px solid ${isActive ? 'rgba(168, 85, 247, 0.4)' : 'rgba(148, 163, 184, 0.2)'};
                                transition: all 0.2s ease;
                            " onmouseover="if(!this.classList.contains('active')) this.style.background='rgba(30, 41, 59, 0.6)'" onmouseout="if(!this.classList.contains('active')) this.style.background='rgba(15, 23, 42, 0.4)'">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div style="flex:1;min-width:0;">
                                        <div style="font-size:14px;font-weight:600;color:${isActive ? '#a855f7' : '#e2e8f0'};white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${t.name}">
                                            ${t.name}
                                        </div>
                                        ${typeof t.count === 'number' ? `
                                        <div style="font-size:11px;color:#94a3b8;margin-top:2px;">
                                            ${t.count.toLocaleString()} ${t.count === 1 ? 'row' : 'rows'}
                                        </div>
                                        ` : ''}
                                    </div>
                                    ${hasWrite ? `
                                    <div style="margin-left:8px;">
                                        <span style="width:6px;height:6px;border-radius:50%;background:#10b981;display:inline-block;" title="Editable"></span>
                                    </div>
                                    ` : hasRead ? `
                                    <div style="margin-left:8px;">
                                        <span style="width:6px;height:6px;border-radius:50%;background:#94a3b8;display:inline-block;" title="Read-only"></span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                })
                .catch(err => {
                    console.error('Database tables load error:', err);
                    listEl.innerHTML = '<div style="padding:20px;text-align:center;color:#ef4444;font-size:13px;">Failed to load tables</div>';
                });
        }
        
        window.filterDatabaseTables = function() {
            const searchInput = document.getElementById('db-search-tables');
            const filter = searchInput ? searchInput.value.toLowerCase() : '';
            const items = document.querySelectorAll('.db-table-item');
            
            items.forEach(item => {
                const tableName = item.getAttribute('data-table') || '';
                if (tableName.toLowerCase().includes(filter)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        };
        
        window.selectDatabaseTable = function(tableName) {
            // DEBUG: Show permission status
            console.log('[DEBUG] Checking action_db_read permission');
            console.log('[DEBUG] window.LM_PERMS exists:', typeof window.LM_PERMS !== 'undefined');
            if (typeof window.LM_PERMS !== 'undefined') {
                console.log('[DEBUG] window.LM_PERMS.action_db_read:', window.LM_PERMS.action_db_read);
            } else {
                console.error('[DEBUG] window.LM_PERMS is undefined!');
            }
            console.log('[DEBUG] hasPermission result:', hasPermission('action_db_read'));
            
            if (!hasPermission('action_db_read')) {
                showNotification('You do not have permission to read database records. Requires action_db_read permission.', 'error');
                console.error('[ERROR] Permission denied. Full LM_PERMS:', window.LM_PERMS);
                return;
            }
            
            dbCurrentTable = tableName;
            dbCurrentPage = 1;
            dbSelectedRows.clear();
            dbFilters = {};
            dbSortColumn = null;
            dbSortDirection = 'asc';
            
            document.querySelectorAll('.db-table-item').forEach(item => {
                if (item.getAttribute('data-table') === tableName) {
                    item.classList.add('active');
                    item.style.background = 'rgba(168, 85, 247, 0.2)';
                    item.style.borderColor = 'rgba(168, 85, 247, 0.4)';
                } else {
                    item.classList.remove('active');
                    item.style.background = 'rgba(15, 23, 42, 0.4)';
                    item.style.borderColor = 'rgba(148, 163, 184, 0.2)';
                }
            });
            
            loadDatabaseData();
        };
        
        function loadDatabaseData() {
            if (!dbCurrentTable) return;
            
            const gridEl = document.getElementById('db-data-grid');
            const headerEl = document.getElementById('db-content-header');
            const paginationEl = document.getElementById('db-pagination');
            const createBtn = document.getElementById('db-create-btn');
            const exportBtn = document.getElementById('db-export-btn');
            
            if (headerEl) headerEl.style.display = 'block';
            if (paginationEl) paginationEl.style.display = 'flex';
            
            if (createBtn) {
                createBtn.style.display = hasPermission('action_db_create') ? 'inline-flex' : 'none';
            }
            if (exportBtn) {
                exportBtn.style.display = 'inline-flex';
            }
            
            gridEl.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;"><div class="loading">Loading data...</div></div>';
            
            const offset = (dbCurrentPage - 1) * dbPageSize;
            const params = new URLSearchParams({
                action: 'rows',
                table: dbCurrentTable,
                limit: dbPageSize.toString(),
                offset: offset.toString()
            });
            
            fetch('owner_db.php?' + params.toString(), { credentials: 'include' })
                .then(async r => {
                    let data = null;
                    try {
                        data = await r.json();
                    } catch (_) {}
                    if (!r.ok) {
                        const msg = interpretHttpError(r.status, data, 'database');
                        showNotification(msg, 'error');
                        throw new Error(msg);
                    }
                    return data || {};
                })
                .then(data => {
                    const rows = data.rows || [];
                    const columns = data.columns || [];
                    dbTableColumns = columns;
                    
                    const tableNameEl = document.getElementById('db-current-table-name');
                    const tableInfoEl = document.getElementById('db-current-table-info');
                    
                    if (tableNameEl) tableNameEl.textContent = dbCurrentTable;
                    if (tableInfoEl) {
                        const hasCreate = hasPermission('action_db_create');
                        const hasUpdate = hasPermission('action_db_update');
                        const hasDelete = hasPermission('action_db_delete');
                        const perms = [];
                        if (hasCreate) perms.push('Create');
                        if (hasUpdate) perms.push('Update');
                        if (hasDelete) perms.push('Delete');
                        const permsText = perms.length ? perms.join(' Â· ') : 'Read-only';
                        tableInfoEl.textContent = `${rows.length} records loaded Â· ${permsText}`;
                    }
                    
                    if (!rows.length) {
                        gridEl.innerHTML = `
                            <div style="display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:16px;">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.5"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                                <div style="color:#94a3b8;font-size:14px;">No records in this table</div>
                                ${hasPermission('action_db_create') ? `
                                <button class="button button-primary" onclick="openCreateRecordForm()">
                                    Create First Record
                                </button>
                                ` : ''}
                            </div>
                        `;
                        updatePaginationInfo(0, 0, 0);
                        return;
                    }
                    
                    renderDataGrid(rows, columns);
                    updatePaginationInfo(offset + 1, offset + rows.length, offset + rows.length);
                })
                .catch(err => {
                    console.error('Database data load error:', err);
                    gridEl.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#ef4444;font-size:14px;">Failed to load data</div>';
                });
        }
        
        function renderDataGrid(rows, columns) {
            const gridEl = document.getElementById('db-data-grid');
            if (!gridEl || !rows.length) return;
            
            const cols = Object.keys(rows[0]);
            const hasUpdate = hasPermission('action_db_update');
            const hasDelete = hasPermission('action_db_delete');
            const hasActions = hasUpdate || hasDelete;
            
            // FIX: Container erlaubt jetzt horizontales Scrollen und hat eine feste Struktur
            let html = `
                <div style="overflow-x:auto; overflow-y:auto; max-height:650px; display:block; position:relative; border-radius:12px; border:1px solid rgba(148, 163, 184, 0.1); background:rgba(15, 23, 42, 0.4);">
                    <table style="min-width:max-content; border-collapse:separate; border-spacing:0; font-size:13px; table-layout:auto;">
                        <thead style="position:sticky; top:0; z-index:10; background:linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 59, 0.98)); backdrop-filter:blur(10px);">
                            <tr>
            `;
            
            if (hasActions) {
                html += `
                    <th style="padding:14px 16px; text-align:center; font-weight:600; color:#a855f7; border-bottom:2px solid rgba(168, 85, 247, 0.3); width:40px; white-space:nowrap;">
                        <input type="checkbox" id="db-select-all" onchange="toggleSelectAll(this.checked)" style="cursor:pointer; width:16px; height:16px;">
                    </th>
                `;
            }
            
            cols.forEach((col, idx) => {
                const colInfo = columns.find(c => c.name === col);
                const isPk = colInfo && colInfo.pk === 1;
                // FIX: white-space:nowrap hinzugefÃ¼gt, damit Header nicht umbrechen
                html += `
                    <th onclick="sortByColumn('${col}')" style="
                        padding: 14px 16px;
                        text-align: left;
                        font-weight: 600;
                        color: ${isPk ? '#facc15' : '#a855f7'};
                        border-bottom: 2px solid ${isPk ? 'rgba(250, 204, 21, 0.3)' : 'rgba(168, 85, 247, 0.3)'};
                        white-space: nowrap;
                        text-transform: uppercase;
                        font-size: 11px;
                        letter-spacing: 0.5px;
                        cursor: pointer;
                        user-select: none;
                        position: relative;
                    ">
                        <div style="display:flex; align-items:center; gap:6px;">
                            ${isPk ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#facc15;"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>' : ''}
                            ${col}
                            ${dbSortColumn === col ? (dbSortDirection === 'asc' ? ' â†‘' : ' â†“') : ''}
                        </div>
                    </th>
                `;
            });
            
            if (hasActions) {
                html += `
                    <th style="padding:14px 16px; text-align:center; font-weight:600; color:#a855f7; border-bottom:2px solid rgba(168, 85, 247, 0.3); min-width:140px; white-space:nowrap;">
                        Actions
                    </th>
                `;
            }
            
            html += `
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            rows.forEach((row, rowIdx) => {
                const isEven = rowIdx % 2 === 0;
                const rowId = JSON.stringify(row).replace(/"/g, '&quot;');
                const isSelected = dbSelectedRows.has(rowIdx);
                
                html += `<tr data-row-idx="${rowIdx}" style="
                    background: ${isSelected ? 'rgba(168, 85, 247, 0.2)' : (isEven ? 'rgba(15, 23, 42, 0.3)' : 'rgba(30, 41, 59, 0.3)')};
                    transition: all 0.2s ease;
                " onmouseover="this.style.background='rgba(168, 85, 247, 0.15)'" 
                   onmouseout="this.style.background='${isSelected ? 'rgba(168, 85, 247, 0.2)' : (isEven ? 'rgba(15, 23, 42, 0.3)' : 'rgba(30, 41, 59, 0.3)')}'" 
                   ondblclick="openRecordDetailModal(${rowId})">`;
                
                if (hasActions) {
                    html += `
                        <td style="padding:14px 16px; border-bottom:1px solid rgba(148, 163, 184, 0.1); text-align:center; white-space:nowrap;">
                            <input type="checkbox" class="row-select" data-row-idx="${rowIdx}" ${isSelected ? 'checked' : ''} onchange="toggleRowSelect(${rowIdx}, this.checked)" style="cursor:pointer; width:16px; height:16px;">
                        </td>
                    `;
                }
                
                cols.forEach((col, colIdx) => {
                    const v = row[col];
                    let text = '';
                    // FIX: Max-Width entfernt, damit Spalten so breit wie nÃ¶tig sind
                    let cellStyle = 'padding:14px 16px; border-bottom:1px solid rgba(148, 163, 184, 0.1); color:#e2e8f0; white-space:nowrap;';                   
                    
                    if (v === null || v === undefined) {
                        text = '<span style="color:#64748b; font-style:italic; font-size:11px;">NULL</span>';
                    } else if (typeof v === 'boolean') {
                        text = v ? '<span style="color:#10b981; font-weight:600; display:inline-flex; align-items:center; gap:4px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>TRUE</span>' : '<span style="color:#ef4444; font-weight:600; display:inline-flex; align-items:center; gap:4px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>FALSE</span>';
                    } else if (typeof v === 'number') {
                        text = `<span style="color:#60a5fa; font-weight:500;">${v}</span>`;
                    } else {
                        const str = String(v);
                        const escaped = str.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        text = `<span style="color:#cbd5e1;" title="${escaped}">${escaped}</span>`;
                    }
                    
                    html += `<td style="${cellStyle}">${text}</td>`;
                });
                
                if (hasActions) {
                    html += `<td style="padding:14px 16px; border-bottom:1px solid rgba(148, 163, 184, 0.1); text-align:center; white-space:nowrap;">`;
                    html += '<div style="display:flex; gap:6px; justify-content:center;">';
                    
                    if (hasUpdate) {
                        html += `<button class="button button-secondary button-compact" style="padding:6px 10px; font-size:11px; min-width:60px; display:inline-flex; align-items:center; gap:4px;" onclick="event.stopPropagation(); openUpdateRecordForm(${rowId})" title="Edit record"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit</button>`;
                    }
                    
                    if (hasDelete) {
                        html += `<button class="button button-danger button-compact" style="padding:6px 10px; font-size:11px; display:inline-flex; align-items:center; gap:4px;" onclick="event.stopPropagation(); confirmDeleteRecord(${rowId})" title="Delete record"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>`;
                    }
                    
                    html += '</div></td>';
                }
                
                html += '</tr>';
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            gridEl.innerHTML = html;
        }
        
        function updatePaginationInfo(start, end, total) {
            const infoEl = document.getElementById('db-pagination-info');
            const prevBtn = document.getElementById('db-prev-page');
            const nextBtn = document.getElementById('db-next-page');
            
            if (infoEl) {
                if (total === 0) {
                    infoEl.textContent = 'No records';
                } else {
                    infoEl.textContent = `Showing ${start}-${end} of ${total} records`;
                }
            }
            
            if (prevBtn) prevBtn.disabled = dbCurrentPage <= 1;
            if (nextBtn) nextBtn.disabled = end >= total;
        }
        
        window.loadDatabasePage = function(direction) {
            if (direction === 'next') {
                dbCurrentPage++;
            } else if (direction === 'prev' && dbCurrentPage > 1) {
                dbCurrentPage--;
            }
            loadDatabaseData();
        };
        
        window.sortByColumn = function(column) {
            if (dbSortColumn === column) {
                dbSortDirection = dbSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                dbSortColumn = column;
                dbSortDirection = 'asc';
            }
            loadDatabaseData();
        };
        
        window.toggleSelectAll = function(checked) {
            const checkboxes = document.querySelectorAll('.row-select');
            checkboxes.forEach(cb => {
                const rowIdx = parseInt(cb.getAttribute('data-row-idx'), 10);
                cb.checked = checked;
                toggleRowSelect(rowIdx, checked);
            });
        };
        
        window.toggleRowSelect = function(rowIdx, checked) {
            if (checked) {
                dbSelectedRows.add(rowIdx);
            } else {
                dbSelectedRows.delete(rowIdx);
            }
            
            const selectedCountEl = document.getElementById('db-selected-count');
            const selectedCountText = document.getElementById('db-selected-count-text');
            
            if (selectedCountEl && selectedCountText) {
                if (dbSelectedRows.size > 0) {
                    selectedCountEl.style.display = 'block';
                    selectedCountText.textContent = `${dbSelectedRows.size} selected`;
                } else {
                    selectedCountEl.style.display = 'none';
                }
            }
        };
        
        window.refreshDatabaseView = function() {
            if (dbCurrentTable) {
                loadDatabaseData();
                showNotification('Database view refreshed', 'success');
            } else {
                loadDatabaseTables();
                showNotification('Table list refreshed', 'success');
            }
        };
        
        window.exportTableData = function() {
            if (!dbCurrentTable) {
                showNotification('No table selected', 'warning');
                return;
            }
            
            if (!hasPermission('action_db_read')) {
                showNotification('You do not have permission to export data. Requires action_db_read permission.', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;';
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background:linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 59, 0.98));border-radius:12px;padding:32px;max-width:500px;width:90%;border:1px solid rgba(168, 85, 247, 0.3);';
            
            modalContent.innerHTML = `
                <div style="margin-bottom:24px;">
                    <h3 style="font-size:20px;font-weight:700;color:#a855f7;margin-bottom:8px;">Export Table Data</h3>
                    <p style="font-size:13px;color:#94a3b8;">Export <strong>${dbCurrentTable}</strong> to your preferred format</p>
                </div>
                <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:24px;">
                    <button class="export-format-btn" data-format="csv" style="padding:16px;background:rgba(168, 85, 247, 0.1);border:2px solid rgba(168, 85, 247, 0.3);border-radius:8px;color:#e2e8f0;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;text-align:left;">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
                            <div>
                                <div style="font-size:16px;margin-bottom:4px;">CSV Format</div>
                                <div style="font-size:11px;color:#94a3b8;">Comma-separated values (Excel compatible)</div>
                            </div>
                        </div>
                    </button>
                    <button class="export-format-btn" data-format="json" style="padding:16px;background:rgba(168, 85, 247, 0.1);border:2px solid rgba(168, 85, 247, 0.3);border-radius:8px;color:#e2e8f0;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;text-align:left;">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                            <div>
                                <div style="font-size:16px;margin-bottom:4px;">JSON Format</div>
                                <div style="font-size:11px;color:#94a3b8;">JavaScript Object Notation (Developer friendly)</div>
                            </div>
                        </div>
                    </button>
                </div>
                <div style="display:flex;gap:12px;justify-content:flex-end;">
                    <button class="export-cancel-btn" style="padding:10px 20px;background:rgba(148, 163, 184, 0.1);border:1px solid rgba(148, 163, 184, 0.3);border-radius:8px;color:#e2e8f0;font-size:14px;font-weight:600;cursor:pointer;">Cancel</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            const formatBtns = modalContent.querySelectorAll('.export-format-btn');
            formatBtns.forEach(btn => {
                btn.addEventListener('mouseenter', () => {
                    btn.style.background = 'rgba(168, 85, 247, 0.2)';
                    btn.style.borderColor = 'rgba(168, 85, 247, 0.5)';
                });
                btn.addEventListener('mouseleave', () => {
                    btn.style.background = 'rgba(168, 85, 247, 0.1)';
                    btn.style.borderColor = 'rgba(168, 85, 247, 0.3)';
                });
                btn.addEventListener('click', () => {
                    const format = btn.getAttribute('data-format');
                    document.body.removeChild(modal);
                    performExport(format);
                });
            });
            
            modalContent.querySelector('.export-cancel-btn').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        };
        
        function performExport(format) {
            showNotification(`Exporting ${dbCurrentTable} as ${format.toUpperCase()}...`, 'info');
            
            fetch(`owner_db.php?action=rows&table=${dbCurrentTable}&limit=10000&offset=0`, { 
                credentials: 'include' 
            })
            .then(async r => {
                if (!r.ok) {
                    throw new Error('Failed to fetch data for export');
                }
                return r.json();
            })
            .then(data => {
                const rows = data.rows || [];
                if (!rows.length) {
                    showNotification('No data to export', 'warning');
                    return;
                }
                
                let content = '';
                let filename = '';
                let mimeType = '';
                
                if (format === 'csv') {
                    const headers = Object.keys(rows[0]);
                    const csvRows = [headers.join(',')];
                    
                    rows.forEach(row => {
                        const values = headers.map(header => {
                            const val = row[header];
                            if (val === null || val === undefined) return '';
                            const str = String(val).replace(/"/g, '""');
                            // Use \\n to prevent Python from creating a literal newline in the JS file
                            return str.includes(',') || str.includes('"') || str.includes('\\n') ? `"${str}"` : str;
                        });
                        csvRows.push(values.join(','));
                    });
                    
                    // Use \\n here as well
                    content = csvRows.join('\\n');
                    filename = `${dbCurrentTable}_${new Date().toISOString().slice(0,10)}.csv`;
                    mimeType = 'text/csv;charset=utf-8;';
                    
                } else if (format === 'json') {
                    content = JSON.stringify(rows, null, 2);
                    filename = `${dbCurrentTable}_${new Date().toISOString().slice(0,10)}.json`;
                    mimeType = 'application/json;charset=utf-8;';
                }
                
                const blob = new Blob([content], { type: mimeType });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                
                showNotification(`Exported ${rows.length} records to ${filename}`, 'success');
            })
            .catch(err => {
                console.error('Export error:', err);
                showNotification('Failed to export data', 'error');
            });
        }
        
        window.openCreateRecordForm = function() {
            if (!hasPermission('action_db_create')) {
                showNotification('You do not have permission to create database records. Requires action_db_create permission.', 'error');
                return;
            }
            
            if (!dbCurrentTable || !dbTableColumns.length) {
                showNotification('No table selected or columns not loaded', 'warning');
                return;
            }
            
            showCreateRecordModal(dbCurrentTable, dbTableColumns);
        };
        
        window.openUpdateRecordForm = function(rowData) {
            if (!hasPermission('action_db_update')) {
                showNotification('You do not have permission to update database records. Requires action_db_update permission.', 'error');
                return;
            }
            
            if (!dbCurrentTable || !dbTableColumns.length) {
                showNotification('No table selected or columns not loaded', 'warning');
                return;
            }
            
            showUpdateRecordModal(dbCurrentTable, dbTableColumns, rowData);
        };
        
        window.confirmDeleteRecord = function(rowData) {
            if (!hasPermission('action_db_delete')) {
                showNotification('You do not have permission to delete database records. Requires action_db_delete permission.', 'error');
                return;
            }
            
            const keys = Object.keys(rowData);
            const previewData = keys.slice(0, 3).map(k => `${k}: ${rowData[k]}`).join(', ');
            const preview = keys.length > 3 ? previewData + '...' : previewData;
            
            if (!confirm(`âš ï¸ DELETE RECORD\n\nTable: ${dbCurrentTable}\nRecord: ${preview}\n\nThis action cannot be undone. Are you sure?`)) {
                return;
            }
            
            deleteRecord(rowData);
        };
        
        function deleteRecord(rowData) {
            fetch('owner_db.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ action: 'delete', table: dbCurrentTable, where: rowData })
            })
            .then(async r => {
                let payload = null;
                try {
                    payload = await r.json();
                } catch (_) {}
                if (!r.ok) {
                    const msg = interpretHttpError(r.status, payload, 'database');
                    throw new Error(msg);
                }
                return payload;
            })
            .then(result => {
                if (result.success) {
                    showNotification(`Record deleted successfully (${result.affected_rows} row affected)`, 'success');
                    loadDatabaseData();
                } else {
                    showNotification(result.error || 'Failed to delete record', 'error');
                }
            })
            .catch(err => {
                console.error('Delete record error:', err);
                showNotification(err.message || 'Failed to delete record', 'error');
            });
        }
        
        window.openRecordDetailModal = function(rowData) {
            const modalHtml = `
                <div id="db-detail-modal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    backdrop-filter: blur(4px);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                " onclick="if(event.target === this) closeDbDetailModal()">
                    <div style="
                        background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 59, 0.98));
                        border: 1px solid rgba(148, 163, 184, 0.2);
                        border-radius: 16px;
                        padding: 24px;
                        max-width: 700px;
                        width: 100%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 18px; font-weight: 600; color: #a855f7; margin: 0;">
                                Record Details
                            </h3>
                            <button onclick="closeDbDetailModal()" style="
                                background: none;
                                border: none;
                                color: #94a3b8;
                                font-size: 24px;
                                cursor: pointer;
                                padding: 0;
                                width: 30px;
                                height: 30px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">Ã—</button>
                        </div>
                        <div style="display: grid; gap: 16px;">
                            ${Object.keys(rowData).map(key => {
                                const value = rowData[key];
                                const colInfo = dbTableColumns.find(c => c.name === key);
                                const isPk = colInfo && colInfo.pk === 1;
                                
                                let displayValue = '';
                                if (value === null || value === undefined) {
                                    displayValue = '<span style="color:#64748b;font-style:italic;">NULL</span>';
                                } else if (typeof value === 'boolean') {
                                    displayValue = value ? '<span style="color:#10b981;">âœ“ TRUE</span>' : '<span style="color:#ef4444;">âœ— FALSE</span>';
                                } else if (typeof value === 'number') {
                                    displayValue = `<span style="color:#60a5fa;">${value}</span>`;
                                } else {
                                    displayValue = String(value).replace(/</g, '&lt;').replace(/>/g, '&gt;');
                                }
                                
                                return `
                                    <div style="background: rgba(15, 23, 42, 0.6); padding: 16px; border-radius: 8px; border: 1px solid rgba(148, 163, 184, 0.2);">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div style="font-size: 13px; font-weight: 600; color: #e2e8f0;">
                                                ${key}
                                            </div>
                                            <div style="display: flex; gap: 6px; align-items: center;">
                                                ${isPk ? '<span style="font-size:11px;color:#facc15;">ğŸ”‘ PK</span>' : ''}
                                                ${colInfo ? `<span style="font-size:11px;color:#94a3b8;">${colInfo.type}</span>` : ''}
                                            </div>
                                        </div>
                                        <div style="font-size: 14px; color: #cbd5e1; word-break: break-word;">
                                            ${displayValue}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 24px;">
                            ${hasPermission('action_db_update') ? `
                            <button class="button button-primary" style="flex: 1;" onclick="closeDbDetailModal(); openUpdateRecordForm(${JSON.stringify(rowData).replace(/"/g, '&quot;')})">
                                Edit Record
                            </button>
                            ` : ''}
                            <button class="button button-secondary" onclick="closeDbDetailModal()">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        };
        
        window.closeDbDetailModal = function() {
            const modal = document.getElementById('db-detail-modal');
            if (modal) modal.remove();
        };
        
        window.showCreateRecordModal = function(tableName, columns) {
            if (!hasPermission('action_db_create')) {
                showNotification('You do not have permission to create database records. Requires action_db_create permission.', 'error');
                return;
            }
            
            let fieldsHtml = '';
            columns.forEach(col => {
                if (col.pk === 1 && col.type.toUpperCase().includes('INTEGER')) {
                    return;
                }
                const required = col.notnull === 1 ? 'required' : '';
                fieldsHtml += `
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #e2e8f0; margin-bottom: 6px;">
                            ${col.name} ${col.notnull === 1 ? '<span style="color: #ef4444;">*</span>' : ''}
                            <span style="font-size: 11px; font-weight: 400; color: #94a3b8;">(${col.type})</span>
                        </label>
                        <input type="text" id="create-field-${col.name}" ${required} 
                            style="width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 8px; color: #e2e8f0; font-size: 13px;"
                            placeholder="${col.dflt_value ? 'Default: ' + col.dflt_value : 'Enter value...'}">
                    </div>
                `;
            });
            
            const modalHtml = `
                <div id="db-crud-modal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    backdrop-filter: blur(4px);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                " onclick="if(event.target === this) closeDbCrudModal()">
                    <div style="
                        background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 59, 0.98));
                        border: 1px solid rgba(148, 163, 184, 0.2);
                        border-radius: 16px;
                        padding: 24px;
                        max-width: 600px;
                        width: 100%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 18px; font-weight: 600; color: #a855f7; margin: 0;">
                                Create New Record in ${tableName}
                            </h3>
                            <button onclick="closeDbCrudModal()" style="
                                background: none;
                                border: none;
                                color: #94a3b8;
                                font-size: 24px;
                                cursor: pointer;
                                padding: 0;
                                width: 30px;
                                height: 30px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">Ã—</button>
                        </div>
                        <form id="create-record-form" onsubmit="submitCreateRecord(event, '${tableName}')">
                            ${fieldsHtml}
                            <div style="display: flex; gap: 12px; margin-top: 24px;">
                                <button type="submit" class="button button-primary" style="flex: 1;">
                                    Create Record
                                </button>
                                <button type="button" class="button button-secondary" onclick="closeDbCrudModal()">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        };
        
        window.showUpdateRecordModal = function(tableName, columns, rowData) {
            if (!hasPermission('action_db_update')) {
                showNotification('You do not have permission to update database records. Requires action_db_update permission.', 'error');
                return;
            }
            
            let fieldsHtml = '';
            let pkFields = [];
            
            columns.forEach(col => {
                const value = rowData[col.name] !== undefined ? rowData[col.name] : '';
                const isPk = col.pk === 1;
                
                if (isPk) {
                    pkFields.push(col.name);
                }
                
                fieldsHtml += `
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 13px; font-weight: 600; color: #e2e8f0; margin-bottom: 6px;">
                            ${col.name} ${isPk ? '<span style="color: #facc15;">ğŸ”‘ Primary Key</span>' : ''}
                            <span style="font-size: 11px; font-weight: 400; color: #94a3b8;">(${col.type})</span>
                        </label>
                        <input type="text" id="update-field-${col.name}" value="${value}"
                            ${isPk ? 'readonly' : ''}
                            style="width: 100%; padding: 10px; background: ${isPk ? 'rgba(15, 23, 42, 0.9)' : 'rgba(15, 23, 42, 0.6)'}; border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 8px; color: #e2e8f0; font-size: 13px;"
                            placeholder="Enter new value...">
                    </div>
                `;
            });
            
            const modalHtml = `
                <div id="db-crud-modal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    backdrop-filter: blur(4px);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                " onclick="if(event.target === this) closeDbCrudModal()">
                    <div style="
                        background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 59, 0.98));
                        border: 1px solid rgba(148, 163, 184, 0.2);
                        border-radius: 16px;
                        padding: 24px;
                        max-width: 600px;
                        width: 100%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 18px; font-weight: 600; color: #a855f7; margin: 0;">
                                Update Record in ${tableName}
                            </h3>
                            <button onclick="closeDbCrudModal()" style="
                                background: none;
                                border: none;
                                color: #94a3b8;
                                font-size: 24px;
                                cursor: pointer;
                                padding: 0;
                                width: 30px;
                                height: 30px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">Ã—</button>
                        </div>
                        <form id="update-record-form" onsubmit="submitUpdateRecord(event, '${tableName}', ${JSON.stringify(pkFields).replace(/"/g, '&quot;')})">
                            ${fieldsHtml}
                            <div style="display: flex; gap: 12px; margin-top: 24px;">
                                <button type="submit" class="button button-primary" style="flex: 1;">
                                    Update Record
                                </button>
                                <button type="button" class="button button-secondary" onclick="closeDbCrudModal()">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        };
        
        window.closeDbCrudModal = function() {
            const modal = document.getElementById('db-crud-modal');
            if (modal) {
                modal.remove();
            }
        };
        
        window.submitCreateRecord = function(event, tableName) {
            event.preventDefault();
            
            if (!hasPermission('action_db_create')) {
                showNotification('You do not have permission to create database records. Requires action_db_create permission.', 'error');
                return;
            }
            
            const form = event.target;
            const data = {};
            
            Array.from(form.elements).forEach(element => {
                if (element.id && element.id.startsWith('create-field-')) {
                    const fieldName = element.id.replace('create-field-', '');
                    const value = element.value.trim();
                    if (value !== '') {
                        data[fieldName] = value;
                    }
                }
            });
            
            fetch('owner_db.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ action: 'create', table: tableName, data: data })
            })
            .then(async r => {
                let payload = null;
                try {
                    payload = await r.json();
                } catch (_) {}
                if (!r.ok) {
                    const msg = interpretHttpError(r.status, payload, 'database');
                    throw new Error(msg);
                }
                return payload;
            })
            .then(result => {
                if (result.success) {
                    showNotification('Record created successfully!', 'success');
                    closeDbCrudModal();
                    loadDatabaseData();
                } else {
                    showNotification(result.error || 'Failed to create record', 'error');
                }
            })
            .catch(err => {
                console.error('Create record error:', err);
                showNotification(err.message || 'Failed to create record', 'error');
            });
        };
        
        window.submitUpdateRecord = function(event, tableName, pkFields) {
            event.preventDefault();
            
            if (!hasPermission('action_db_update')) {
                showNotification('You do not have permission to update database records. Requires action_db_update permission.', 'error');
                return;
            }
            
            const form = event.target;
            const data = {};
            const where = {};
            
            Array.from(form.elements).forEach(element => {
                if (element.id && element.id.startsWith('update-field-')) {
                    const fieldName = element.id.replace('update-field-', '');
                    const value = element.value.trim();
                    
                    if (pkFields.includes(fieldName)) {
                        where[fieldName] = value;
                    } else if (value !== '') {
                        data[fieldName] = value;
                    }
                }
            });
            
            if (Object.keys(where).length === 0) {
                showNotification('Cannot update: no primary key found', 'error');
                return;
            }
            
            if (Object.keys(data).length === 0) {
                showNotification('No fields to update', 'warning');
                return;
            }
            
            fetch('owner_db.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ action: 'update', table: tableName, data: data, where: where })
            })
            .then(async r => {
                let payload = null;
                try {
                    payload = await r.json();
                } catch (_) {}
                if (!r.ok) {
                    const msg = interpretHttpError(r.status, payload, 'database');
                    throw new Error(msg);
                }
                return payload;
            })
            .then(result => {
                if (result.success) {
                    showNotification(`Record updated successfully! (${result.affected_rows} row(s) affected)`, 'success');
                    closeDbCrudModal();
                    loadDatabaseData();
                } else {
                    showNotification(result.error || 'Failed to update record', 'error');
                }
            })
            .catch(err => {
                console.error('Update record error:', err);
                showNotification(err.message || 'Failed to update record', 'error');
            });
        };
        

        function renderCurrentUserPill() {
            try {
                if (typeof LM_CURRENT_USER === 'undefined') return;
                const u = LM_CURRENT_USER || {};
                if (!u.discord_user_id) return;
                const pill = document.getElementById('lm-user-pill');
                if (!pill) return;
                const initial = (u.display_name || 'U').charAt(0).toUpperCase();
                const avatarHtml = u.avatar_url
                    ? `<span class="lm-user-pill-avatar"><img src="${u.avatar_url}" alt="${u.display_name || ''}"></span>`
                    : `<span class="lm-user-pill-avatar">${initial}</span>`;
                pill.innerHTML = `
                    <div class="lm-user-pill-inner">
                        ${avatarHtml}
                        <div class="lm-user-pill-text">
                            <div class="lm-user-pill-name">${u.display_name || 'Unknown user'}</div>
                            <div class="lm-user-pill-role">${(u.role || '').toUpperCase()}</div>
                        </div>
                        <button class="lm-user-logout-button" onclick="window.location='logout.php'">Logout</button>
                    </div>
                `;
            } catch (e) {}
        }

        renderCurrentUserPill();

        function renderStatusChip(status) {
            const safeStatus = status || 'healthy';
            const label = safeStatus.charAt(0).toUpperCase() + safeStatus.slice(1);
            let color = '#22c55e';
            if (safeStatus === 'critical') {
                color = '#ef4444';
            } else if (safeStatus === 'degraded') {
                color = '#f59e0b';
            }
            return `
                <span class="status-chip status-chip-${safeStatus}">
                    <svg class="status-chip-icon" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
                        <circle cx="8" cy="8" r="6.75" fill="none" stroke="${color}" stroke-width="1.5" />
                        <path d="M4.5 8.2L7 10.7L11.5 5.5" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <span class="status-chip-label">${label}</span>
                </span>
            `;
        }

        function setStatusBadge(status) {
            const badge = document.getElementById('status-badge');
            if (!badge) return;
            const safeStatus = status || 'healthy';
            badge.className = 'status-badge status-' + safeStatus;
            badge.innerHTML = `
                <span class="status-badge-caption">Bot Status</span>
                ${renderStatusChip(safeStatus)}
            `;
        }

        function prettyPrintJson(raw) {
            if (!raw) return 'No diagnostics data available.';
            try {
                const parsed = JSON.parse(raw);
                return JSON.stringify(parsed, null, 2);
            } catch (e) {
                return raw;
            }
        }

        function openDiagnosticsModal() {
            const body = `
                <div style="font-size:13px;color:var(--text-secondary);margin-bottom:8px;">
                    Framework diagnostics from <code>data/framework_diagnostics.json</code>.
                </div>
                <pre id="diag-json-view" class="code-block-json">Regenerating diagnostics...</pre>
            `;
            openModal('Framework Diagnostics JSON', body);
            
            // Always regenerate on click to show current info
            console.log('[DIAGNOSTICS] Triggering fresh diagnostics generation...');
            sendCommand('generate_framework_diagnostics', {});
            
            // Wait for generation, then fetch
            setTimeout(() => {
                fetchDiagnosticsJson();
            }, 2000);
        }

        function fetchDiagnosticsJson() {
            const path = './data/framework_diagnostics.json';
            const view = document.getElementById('diag-json-view');
            if (!view) return;

            function attemptRead(allowGenerate) {
                const requestId = sendFileCommand('read_file', { path });
                let retries = 0;
                const maxRetries = 10;

                const poll = () => {
                    retries++;
                    fetch('monitor_data_fileops.json?t=' + Date.now())
                        .then(r => r.ok ? r.text() : null)
                        .then(text => {
                            if (!text) {
                                if (retries < maxRetries) {
                                    return setTimeout(poll, 900);
                                }
                                if (allowGenerate) {
                                    triggerDiagnosticsGeneration();
                                } else {
                                    view.textContent = 'Unable to load diagnostics data from the bot.';
                                }
                                return;
                            }
                            let data;
                            try {
                                data = JSON.parse(text);
                            } catch {
                                if (retries < maxRetries) {
                                    return setTimeout(poll, 900);
                                }
                                if (allowGenerate) {
                                    triggerDiagnosticsGeneration();
                                } else {
                                    view.textContent = 'Diagnostics response from bot could not be parsed.';
                                }
                                return;
                            }

                            if (data && data.type === 'read_file' && data.path === path && data.request_id === requestId) {
                                const raw = data.content || '';
                                view.textContent = prettyPrintJson(raw);
                            } else if (retries < maxRetries) {
                                setTimeout(poll, 900);
                            } else if (allowGenerate) {
                                triggerDiagnosticsGeneration();
                            } else {
                                view.textContent = 'Diagnostics data not available.';
                            }
                        })
                        .catch(() => {
                            if (retries < maxRetries) {
                                setTimeout(poll, 900);
                            } else if (allowGenerate) {
                                triggerDiagnosticsGeneration();
                            } else {
                                view.textContent = 'Network error while loading diagnostics.';
                            }
                        });
                };

                setTimeout(poll, 600);
            }

            function triggerDiagnosticsGeneration() {
                view.textContent = 'No existing diagnostics found. Generating a fresh report...';
                sendCommand('generate_framework_diagnostics', {});
                setTimeout(() => attemptRead(false), 2000);
            }

            attemptRead(true);
        }

        function updateOverview(data, previous) {
            const health = data.health || {};
            const system = data.system || {};
            const bot = data.bot || {};
            const framework = data.framework || {};

            const healthText = document.getElementById('overview-health-text');
            if (healthText) {
                const status = health.status || 'healthy';
                healthText.innerHTML = renderStatusChip(status);
            }

            const uptimeGuilds = document.getElementById('overview-uptime-guilds');
            if (uptimeGuilds) {
                uptimeGuilds.textContent = `Uptime: ${bot.uptime_formatted || '0s'} â€¢ ${bot.guilds || 0} guilds`;
            }

            const activityEl = document.getElementById('overview-activity');
            if (activityEl) {
                const msgs = previous && previous.metrics ? previous.metrics.messages_seen || 0 : 0;
                const nowMsgs = data.metrics ? data.metrics.messages_seen || 0 : msgs;
                const delta = nowMsgs - msgs;
                const trend = delta > 0 ? `â†‘ ${delta} msgs since last refresh` : 'No change since last refresh';
                activityEl.textContent = `CPU ${system.cpu_percent?.toFixed(1) || '0'}% â€¢ RAM ${(system.memory_percent || 0).toFixed(0)}% â€¢ ${trend}`;
            }

            const frameworkEl = document.getElementById('overview-framework');
            if (frameworkEl) {
                const v = (data.framework && data.framework.version) ? data.framework.version : (framework.version || 'unknown');
                const py = framework.python_runtime || 'unknown';
                const rec = framework.recommended_python || '';
                const ok = rec && py === rec;
                frameworkEl.innerHTML = `
                    <div style="font-size: 13px; line-height: 1.6;">
                        <div style="margin-bottom: 4px;">
                            <strong style="color: #a855f7;">Framework:</strong> ${v}
                        </div>
                        <div>
                            <strong style="color: #a855f7;">Python:</strong> ${py}
                            ${rec && !ok ? `<span style="color: #f59e0b; font-size: 11px; margin-left: 8px;">âš  Recommended: ${rec}</span>` : ''}
                            ${rec && ok ? `<span style="color: #10b981; font-size: 11px; margin-left: 8px;">âœ“ Recommended</span>` : ''}
                        </div>
                    </div>
                `;
            }

            const alertsContainer = document.getElementById('overview-alert-list');
            const bannerContainer = document.getElementById('alerts-bar');
            if (!alertsContainer || !bannerContainer) return;

            const alerts = [];
            const memPct = system.memory_percent || 0;
            if (memPct >= 85) {
                alerts.push({
                    type: 'warning',
                    text: `Memory at ${memPct.toFixed(0)}% - consider restarting or investigating memory usage.`,
                });
            } else if (memPct >= 70) {
                alerts.push({
                    type: 'info',
                    text: `Memory at ${memPct.toFixed(0)}% (high but acceptable).`,
                });
            }

            const errorRate = health.error_rate || 0;
            if (errorRate >= 10) {
                alerts.push({ type: 'warning', text: `Command errors increasing (error rate ${errorRate.toFixed(2)}%).` });
            }

            if (previous && previous.bot && typeof previous.bot.guilds === 'number') {
                const diff = (bot.guilds || 0) - (previous.bot.guilds || 0);
                if (diff > 0) {
                    alerts.push({ type: 'info', text: `Bot added to ${diff} new server(s) since the last refresh.` });
                }
            }

            if (alerts.length === 0) {
                alertsContainer.innerHTML = '<div class="empty-state">No active alerts. Your bot looks good.</div>';
                bannerContainer.innerHTML = '';
                return;
            }

            alertsContainer.innerHTML = alerts.map(a => `
                <div class="card" style="cursor: default;">
                    <div class="card-header">
                        <div class="card-title">${a.type === 'warning' ? 'âš ï¸ Alert' : 'â„¹ï¸ Info'}</div>
                    </div>
                    <div class="card-body" style="display:block;">
                        <div style="font-size:13px;color:var(--text-secondary);">${a.text}</div>
                    </div>
                </div>
            `).join('');

            const topAlert = alerts[0];
            const color = topAlert.type === 'warning' ? 'rgba(245,158,11,0.18)' : 'rgba(59,130,246,0.18)';
            bannerContainer.innerHTML = `
                <div style="margin-bottom:14px;padding:10px 14px;border-radius:10px;background:${color};border:1px solid rgba(148,163,184,0.4);font-size:13px;">
                    ${topAlert.text}
                </div>
            `;
        }

        function openMainConfig() {
            switchTab('files');
            quickOpenFile('./config.json', 'config.json');
        }

        function openLiveMonitorConfig() {
            switchTab('files');
            quickOpenFile('./data/live_monitor_config.json', 'live_monitor_config.json');
        }

        function quickOpenFile(path, displayName) {
            const fileBrowser = document.getElementById('file-browser-content');
            const unit = (fileBrowser && fileBrowser.querySelector('.explorer-unit')) || document.querySelector('#tab-files .explorer-unit');
            const name = document.getElementById('fileName');
            const text = document.getElementById('fileContent');
            if (!unit || !name || !text) return;

            name.innerText = displayName || path.split('/').pop();
            text.value = addLineNumbers('// Loading ' + name.innerText + '...');
            unit.classList.add('editor-open');
            const filePane = (fileBrowser && fileBrowser.querySelector('.file-pane')) || document.querySelector('#tab-files .file-pane');
            const editorPane = (fileBrowser && fileBrowser.querySelector('.editor-pane')) || document.querySelector('#tab-files .editor-pane');
            if (filePane) {
                if (!filePane.style.width) filePane.style.width = '420px';
                filePane.style.flexShrink = '0';
            }
            if (editorPane) {
                editorPane.style.display = 'flex';
                editorPane.style.flex = '1';
            }
            loadFile(path);
        }

        function maybeShowTour() {
            try {
                const seen = window.localStorage.getItem('lm_tour_seen');
                if (!seen) {
                    const overlay = document.getElementById('lm-tour-overlay');
                    if (overlay) {
                        overlay.style.display = 'flex';
                        overlay.classList.add('lm-open');
                    }
                }
            } catch (_) {}
        }

        function completeTour() {
            try { window.localStorage.setItem('lm_tour_seen', '1'); } catch (_) {}
            const overlay = document.getElementById('lm-tour-overlay');
            if (overlay) {
                overlay.classList.remove('lm-open');
                overlay.style.display = 'none';
            }
        }

        (function () {
            const tourTrigger = document.getElementById('tour-trigger');
            if (tourTrigger) {
                tourTrigger.addEventListener('click', () => {
                    const overlay = document.getElementById('lm-tour-overlay');
                    if (overlay) {
                        overlay.style.display = 'flex';
                        overlay.classList.add('lm-open');
                    }
                });
            }
        })();

        let isFirstLoad = true;
        async function loadData() {
            const searchInput = document.getElementById('cmd-search');
            if (searchInput) {
                searchState.commands = searchInput.value;
            }
            
            document.querySelectorAll('.card').forEach(card => {
                const body = card.querySelector('.card-body');
                if (body && body.style.display === 'block') {
                    expandedCards.add(card.id);
                }
            });
            
            try {
                if (isFirstLoad) {
                    document.getElementById('loading').innerHTML = 
                        '<p>Initializing dashboard...</p>' +
                        '<p style="color: var(--text-secondary); margin-top: 8px;">Waiting for bot to send data</p>';
                    await new Promise(resolve => setTimeout(resolve, 2500));
                    isFirstLoad = false;
                }
                
                const packages = ['core', 'commands', 'plugins', 'hooks', 'extensions', 'system_details', 'events', 'filesystem', 'hook_creator'];
                const loadPromises = packages.map((pkg, index) => 
                    new Promise(resolve => {
                        setTimeout(() => {
                            fetch(`monitor_data_${pkg}.json?t=` + Date.now())
                                .then(r => r.ok ? r.json() : null)
                                .catch(() => null)
                                .then(resolve);
                        }, index * 100);
                    })
                );

                const results = await Promise.all(loadPromises);

                const data = {
                    "timestamp": results[0]?.timestamp || new Date().toISOString(),
                    "bot": results[0]?.bot || {},
                    "system": results[0]?.system || {},
                    "health": results[0]?.health || {},
                    "chat_history": results[0]?.chat_history || null,
                    "commands": results[1] || {},
                    "plugins": results[2] || {},
                    "event_hooks": results[3] || {},
                    "available_extensions": results[4]?.available_extensions || [],
                    "slash_limiter": results[5]?.slash_limiter || {},
                    "atomic_fs": results[5]?.atomic_fs || {},
                    "core_settings": results[5]?.core_settings || {},
                    "framework": results[5]?.framework || {},
                    "events": results[6]?.events || [],
                    "file_system": results[7] || {},
                    "hook_creator": results[8] || {}
                };
                
                if (!results[0]) {
                    if (retryCount < maxRetries) {
                        retryCount++;
                        const waitTime = Math.min(1000 * retryCount, 5000);
                        document.getElementById('loading').innerHTML = 
                            '<p>Waiting for bot to send data...</p>' +
                            '<p style="color: var(--text-secondary); margin-top: 8px;">Retry ' + retryCount + '/' + maxRetries + '</p>' +
                            '<p style="color: var(--text-secondary); font-size: 12px;">Make sure you ran: /livemonitor enable</p>';
                        
                        if (retryTimeout) clearTimeout(retryTimeout);
                        retryTimeout = setTimeout(loadData, waitTime);
                        return;
                    } else {
                        document.getElementById('loading').innerHTML = 
                            '<div style="color: var(--danger); padding: 20px;">' +
                            '<h3>âš ï¸ Unable to Load Data</h3>' +
                            '<p style="margin-top: 12px;">Possible issues:</p>' +
                            '<ul style="text-align: left; margin: 12px auto; max-width: 400px;">' +
                            '<li>Bot hasnt sent data yet (run /livemonitor enable)</li>' +
                            '<li>receive.php not working or not uploaded</li>' +
                            '<li>Monitor data files not being created</li>' +
                            '</ul>' +
                            '<button class="button button-primary" style="margin-top: 16px;" onclick="retryCount=0; loadData()">Try Again</button>' +
                            '</div>';
                        return;
                    }
                }
                
                retryCount = 0;
                const previousData = currentData;
                currentData = data;
                currentGuilds = data.bot?.guilds_detail || [];
                
                updateDebugLoggingButtons();
                
                // Extract platform info
                if (data.system && data.system.platform) {
                    platformOS = data.system.platform;
                    console.log('[SYSTEM] Platform detected:', platformOS);
                }
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';

                const memPct = data.system.memory_percent || 0;
                const memBand = memPct >= 85 ? 'Critical' : memPct >= 70 ? 'High' : 'Normal';
                const memMb = (data.system.memory_mb || 0).toFixed(2);
                document.getElementById('cpu-value').textContent = (data.system.cpu_percent || 0).toFixed(1);
                document.getElementById('cpu-value').title = 'Process CPU usage as a percentage of one core.';
                document.getElementById('memory-value').textContent = `${memMb} MB`;
                document.getElementById('memory-value').title = `Resident memory usage for the bot process; ${memPct.toFixed(0)}% of total (${memBand}).`;
                const guildEl = document.getElementById('guilds-value');
                if (guildEl) guildEl.textContent = data.bot.guilds || 0;
                const userEl = document.getElementById('users-value');
                if (userEl) userEl.textContent = data.bot.users || 0;
                const uptimeEl = document.getElementById('uptime-value');
                if (uptimeEl) uptimeEl.textContent = data.bot.uptime_formatted || '0s';
                document.getElementById('latency-value').textContent = (data.bot.latency || 0).toFixed(2);
                
                const status = data.health && data.health.status ? data.health.status : 'healthy';
                setStatusBadge(status);
                
                if (data.commands && data.commands.commands) {
                    renderCommands(data.commands.commands);
                }
                
                if (data.plugins) {
                    renderPlugins(data.plugins);
                }
                
                if (data.event_hooks && data.event_hooks.hooks) {
                    renderHooks(data.event_hooks);
                }
                
        if (data.bot && data.bot.guilds_detail) {
                    renderChatConsole(data.bot);
                    renderGuilds(data.bot.guilds_detail);
                }

                updateOverview(data, previousData);

                if (data.hook_creator) {
                    updateHookCreator(data.hook_creator);
                }

                if (data.chat_history && data.chat_history.messages) {
                    const hist = data.chat_history;
                    chatMessageHistory = [];
                    const guildName = hist.guild_name || '';
                    const channelName = hist.channel_name || '';
                    (hist.messages || []).forEach(m => {
                        appendChatLog({
                            timestamp: m.timestamp,
                            guild: guildName,
                            channel: channelName,
                            content: m.content
                        });
                    });
                }
                
                if (data.file_system) {
                    renderFileSystem(data.file_system);
                    if (data.file_system.fileops) {
                        updateFileTree(data.file_system.fileops);
                    }
                    if (!fileBrowserInitialized) {
                        renderFileBrowser(data.file_system, data.file_system.fileops);
                    }
                }
                
                if (data.events) {
                    renderEvents(data.events);
                }
                
                renderSystemDetails(data);
                
                setTimeout(() => {
                    if (searchState.commands && document.getElementById('cmd-search')) {
                        document.getElementById('cmd-search').value = searchState.commands;
                        const event = new Event('input');
                        document.getElementById('cmd-search').dispatchEvent(event);
                    }
                    
                    expandedCards.forEach(cardId => {
                        const card = document.getElementById(cardId);
                        if (card) {
                            const body = card.querySelector('.card-body');
                            if (body) body.style.display = 'block';
                        }
                    });
                }, 50);
                
                document.getElementById('last-update').textContent = new Date().toLocaleString();
            } catch (err) {
                console.error('Load error:', err);
                showNotification('âš ï¸ Data loading error. Retrying...', 'error');
            }
        }

        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') closeModal();
        });

        // Note: loadData() is called AFTER the wrapper is set up below
        maybeShowTour();
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONNECTION STATUS INDICATOR - Tracks bot connectivity
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let connectionStatus = 'connecting';
        let lastSuccessfulFetch = null;
        let consecutiveFailures = 0;
        let botDisabled = false;
        let lastSeenTimestamp = null;
        let lastNewDataTime = Date.now();
        
        function updateConnectionStatus(status, message) {
            connectionStatus = status;
            const indicator = document.getElementById('connection-status');
            if (!indicator) return;
            
            // Remove all state classes
            indicator.classList.remove('connected', 'connecting', 'disconnected', 'disabled');
            indicator.classList.add(status);
            
            const dot = indicator.querySelector('.connection-dot');
            const text = indicator.querySelector('.connection-text');
            
            const statusLabels = {
                connected: 'Connected',
                connecting: 'Connecting',
                disconnected: 'Disconnected',
                disabled: 'Disabled'
            };
            
            if (text) text.textContent = statusLabels[status] || status;
            indicator.title = message || statusLabels[status];
        }
        
        // Check for disabled status from bot
        async function checkBotStatus() {
            try {
                const response = await fetch('monitor_data_status.json?t=' + Date.now());
                if (response.ok) {
                    const statusData = await response.json();
                    if (statusData.enabled === false || statusData.status === 'disabled') {
                        botDisabled = true;
                        updateConnectionStatus('disabled', statusData.message || 'Live Monitor is disabled on the bot');
                        return true;
                    } else {
                        botDisabled = false;
                    }
                }
            } catch (e) {
                // Status file doesn't exist or couldn't be read - that's fine
            }
            return false;
        }
        
        // Check connection status based on time since last NEW data
        function checkConnectionHealth() {
            if (botDisabled) return;
            
            const expectedInterval = (currentData?.monitor_settings?.update_interval || 5) * 1000;
            const timeSinceNewData = Date.now() - lastNewDataTime;
            
            // Thresholds: interval + 10s = connecting, interval + 40s = disconnected
            const connectingThreshold = expectedInterval + 10000;
            const disconnectedThreshold = expectedInterval + 40000;
            
            if (timeSinceNewData > disconnectedThreshold) {
                updateConnectionStatus('disconnected', `No new data for ${Math.round(timeSinceNewData/1000)}s`);
            } else if (timeSinceNewData > connectingThreshold) {
                updateConnectionStatus('connecting', `Waiting for data (${Math.round(timeSinceNewData/1000)}s)...`);
            } else {
                updateConnectionStatus('connected', 'Live');
            }
        }
        
        // Initial status check
        checkBotStatus();
        
        // Check bot status periodically (every 30 seconds)
        setInterval(checkBotStatus, 30000);
        
        // Check connection health every 2 seconds
        setInterval(checkConnectionHealth, 2000);
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SMART POLLING SYSTEM with buffer, freshness detection, and adaptive timing
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let dataRefreshInterval = null;
        let pollingStats = {
            lastFetchDuration: 0,
            avgFetchDuration: 500,
            fetchCount: 0,
            staleCount: 0,
            lastDataTimestamp: null,
            bufferMs: 300,
        };
        
        function getDataAge() {
            if (!pollingStats.lastDataTimestamp) return null;
            const dataTime = new Date(pollingStats.lastDataTimestamp).getTime();
            return Date.now() - dataTime;
        }
        
        function updateStaleIndicator(isStale, ageMs) {
            // Don't show stale indicator if bot is disabled
            if (botDisabled) return;
            
            let indicator = document.getElementById('lm-stale-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'lm-stale-indicator';
                indicator.style.cssText = 'position:fixed;top:10px;right:10px;padding:6px 12px;border-radius:6px;font-size:12px;font-weight:600;z-index:9999;transition:all 0.3s ease;display:none;';
                document.body.appendChild(indicator);
            }
            
            if (isStale && ageMs) {
                const ageSec = Math.round(ageMs / 1000);
                indicator.textContent = `âš ï¸ Data ${ageSec}s old`;
                indicator.style.background = ageSec > 30 ? '#dc2626' : '#f59e0b';
                indicator.style.color = '#fff';
                indicator.style.display = 'block';
                
                // Update connection status to disconnected if very stale
                if (ageSec > 30 && !botDisabled) {
                    updateConnectionStatus('disconnected', `No data received for ${ageSec} seconds`);
                }
            } else {
                indicator.style.display = 'none';
            }
        }
        
        function calculateOptimalInterval(botInterval, bufferMs, avgFetchDuration) {
            // Bot interval in ms + small buffer to avoid race conditions
            // Buffer should be minimal - just enough to not hit mid-write
            const baseInterval = (botInterval || 5) * 1000;
            // Use 200-500ms buffer max, or recommended buffer from bot (clamped)
            const clampedBuffer = Math.max(200, Math.min(bufferMs || 300, 500));
            return baseInterval + clampedBuffer;
        }
        
        function startDataRefresh(intervalSeconds, bufferMs) {
            if (dataRefreshInterval) clearInterval(dataRefreshInterval);
            const optimalMs = calculateOptimalInterval(intervalSeconds, bufferMs, pollingStats.avgFetchDuration);
            dataRefreshInterval = setInterval(loadData, optimalMs);
            console.log('[LiveMonitor] Polling: interval=' + intervalSeconds + 's, buffer=' + Math.round(bufferMs || 300) + 'ms, effective=' + optimalMs + 'ms');
        }
        
        // Wrap loadData to track timing, freshness, and connection status
        // IMPORTANT: This must happen BEFORE startDataRefresh so the interval uses the wrapped version
        const originalLoadData = loadData;
        loadData = async function() {
            const fetchStart = Date.now();
            
            try {
                await originalLoadData();
                const fetchDuration = Date.now() - fetchStart;
                
                // Update stats
                pollingStats.fetchCount++;
                pollingStats.lastFetchDuration = fetchDuration;
                pollingStats.avgFetchDuration = pollingStats.avgFetchDuration * 0.7 + fetchDuration * 0.3; // Exponential moving average
                
                // Check if we got NEW data (timestamp changed)
                if (currentData?.timestamp) {
                    const currentTimestamp = currentData.timestamp;
                    
                    // Check if timestamp is different from last seen (new data!)
                    if (currentTimestamp !== lastSeenTimestamp) {
                        lastSeenTimestamp = currentTimestamp;
                        lastNewDataTime = Date.now();
                        consecutiveFailures = 0;
                        
                        // Immediately update to connected when we get fresh data
                        if (!botDisabled) {
                            updateConnectionStatus('connected', 'Live');
                        }
                        console.log('[LiveMonitor] New data received, timestamp:', currentTimestamp);
                    }
                    
                    pollingStats.lastDataTimestamp = currentTimestamp;
                    lastSuccessfulFetch = Date.now();
                    
                    // Stale indicator: only show if no new data for a long time
                    const timeSinceNewData = Date.now() - lastNewDataTime;
                    const expectedInterval = (currentData?.monitor_settings?.update_interval || 5) * 1000;
                    const isStale = timeSinceNewData > expectedInterval * 5;
                    updateStaleIndicator(isStale, timeSinceNewData);
                    if (isStale) pollingStats.staleCount++;
                }
            } catch (err) {
                consecutiveFailures++;
                console.warn('[LiveMonitor] Fetch failed:', err.message, `(${consecutiveFailures} failures)`);
            }
            
            // Adapt polling based on bot config
            if (currentData?.monitor_settings) {
                const ms = currentData.monitor_settings;
                const botInterval = ms.update_interval || 5;
                const recommendedBuffer = ms.recommended_buffer_ms || 300;
                
                // Only update if config changed
                if (window._lastBotInterval !== botInterval || window._lastBuffer !== recommendedBuffer) {
                    window._lastBotInterval = botInterval;
                    window._lastBuffer = recommendedBuffer;
                    pollingStats.bufferMs = recommendedBuffer;
                    startDataRefresh(botInterval, recommendedBuffer);
                }
            }
        };
        
        // Now start polling with the WRAPPED loadData
        // Call loadData() once immediately, then start the interval
        loadData();
        startDataRefresh(5, 300);
        
        // CRITICAL: Apply permission visibility to ALL tabs on page load
        // This ensures buttons are properly disabled IMMEDIATELY, not just when tab is first visited
        setTimeout(() => {
            const allTabs = ['dashboard', 'commands', 'plugins', 'hooks', 'hook-creator', 'filesystem', 'files', 
                           'chat', 'tickets', 'events', 'system', 'invite', 'roles', 'security', 
                           'guilds', 'database', 'marketplace', 'logs', 'credits'];
            allTabs.forEach(tab => {
                applyPermissionVisibility(tab);
            });
            console.log('[PERMISSIONS] Applied permission checks to all tabs on page load');
        }, 500); // Small delay to ensure DOM is fully ready

        // When switching tabs, lazily initialize heavy owner-only panels
        const originalSwitchTab = switchTab;
        window.switchTab = function (tabName) {
            if (!isTabAllowedByPerms(tabName)) {
                showNotification('You do not have permission to view this section.', 'error');
                return;
            }
            originalSwitchTab(tabName);
            if (tabName === 'roles') {
                loadRolesTab();
            } else if (tabName === 'database') {
                loadDatabaseTables();
            }
        };

        let ticketsData = [];
        let filteredTickets = [];
        let currentTicketsPage = 1;
        const ticketsPerPage = 10;
        let ticketsAutoRefreshInterval = null;

        async function loadTickets() {
            try {
                document.getElementById('tickets-loading').style.display = 'block';
                document.getElementById('tickets-table-container').style.display = 'none';
                document.getElementById('tickets-empty-state').style.display = 'none';
                document.getElementById('tickets-pagination').style.display = 'none';

                const response = await fetch('./get_tickets.php');
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Fetch error:', response.status, errorText);
                    throw new Error(`Failed to load tickets (${response.status}): ${errorText.substring(0, 100)}`);
                }

                const data = await response.json();
                console.log('Tickets API Response:', data);
                console.log('Number of guilds:', data.guilds ? data.guilds.length : 0);
                console.log('Raw guilds data:', JSON.stringify(data.guilds, null, 2));
                ticketsData = [];
                
                const guildSelect = document.getElementById('tickets-guild-filter');
                const categorySelect = document.getElementById('tickets-category-filter');
                
                const currentGuild = guildSelect.value;
                const currentCategory = categorySelect.value;
                
                guildSelect.innerHTML = '<option value="">All Guilds</option>';
                categorySelect.innerHTML = '<option value="">All Categories</option>';
                
                const categories = new Set();

                data.guilds.forEach(guild => {
                    guildSelect.innerHTML += `<option value="${guild.guild_id}" ${currentGuild == guild.guild_id ? 'selected' : ''}>Guild ${guild.guild_id}</option>`;
                    
                    guild.tickets.forEach(ticket => {
                        ticket.guild_id = guild.guild_id;
                        ticketsData.push(ticket);
                        categories.add(ticket.category);
                    });
                });

                categories.forEach(cat => {
                    categorySelect.innerHTML += `<option value="${cat}" ${currentCategory == cat ? 'selected' : ''}>${cat}</option>`;
                });

                console.log('ticketsData populated with', ticketsData.length, 'tickets');
                console.log('ticketsData:', ticketsData);

                if (ticketsData.length === 0) {
                    document.getElementById('tickets-loading').style.display = 'none';
                    document.getElementById('tickets-empty-state').style.display = 'block';
                    document.getElementById('tickets-count').textContent = '0 tickets';
                    return;
                }

                filterAndDisplayTickets();
            } catch (error) {
                console.error('Error loading tickets:', error);
                document.getElementById('tickets-loading').innerHTML = '<div style="color:#ef4444;">Error loading tickets: ' + error.message + '</div>';
            }
        }

        function filterAndDisplayTickets() {
            const guildFilter = document.getElementById('tickets-guild-filter').value;
            const categoryFilter = document.getElementById('tickets-category-filter').value;
            const searchTerm = document.getElementById('tickets-search').value.toLowerCase();
            const sortBy = document.getElementById('tickets-sort').value;

            filteredTickets = ticketsData.filter(ticket => {
                if (guildFilter && ticket.guild_id != guildFilter) return false;
                if (categoryFilter && ticket.category !== categoryFilter) return false;
                if (searchTerm) {
                    const searchFields = [
                        String(ticket.ticket_number),
                        String(ticket.creator_id),
                        ticket.subject || '',
                        ticket.description || ''
                    ].join(' ').toLowerCase();
                    if (!searchFields.includes(searchTerm)) return false;
                }
                return true;
            });

            filteredTickets.sort((a, b) => {
                switch (sortBy) {
                    case 'closed_desc':
                        return new Date(b.closed_at) - new Date(a.closed_at);
                    case 'closed_asc':
                        return new Date(a.closed_at) - new Date(b.closed_at);
                    case 'created_desc':
                        return new Date(b.created_at) - new Date(a.created_at);
                    case 'created_asc':
                        return new Date(a.created_at) - new Date(b.created_at);
                    case 'number_desc':
                        return b.ticket_number - a.ticket_number;
                    case 'number_asc':
                        return a.ticket_number - b.ticket_number;
                    default:
                        return 0;
                }
            });

            console.log('After filtering and sorting:', filteredTickets.length, 'tickets');
            console.log('Calling displayTicketsPage()...');

            currentTicketsPage = 1;
            displayTicketsPage();
        }

        function displayTicketsPage() {
            const tbody = document.getElementById('tickets-tbody');
            tbody.innerHTML = '';

            console.log('displayTicketsPage called');
            console.log('filteredTickets.length:', filteredTickets.length);
            console.log('currentTicketsPage:', currentTicketsPage);

            const start = (currentTicketsPage - 1) * ticketsPerPage;
            const end = start + ticketsPerPage;
            const pageTickets = filteredTickets.slice(start, end);

            console.log('pageTickets.length:', pageTickets.length);
            console.log('pageTickets:', pageTickets);

            const hasViewTickets = typeof LM_PERMS !== 'undefined' && (LM_PERMS.action_view_ticket || LM_PERMS.view_tickets);
            const hasDownloadTickets = typeof LM_PERMS !== 'undefined' && (LM_PERMS.action_download_ticket || LM_PERMS.view_tickets);
            const hasDeleteTickets = typeof LM_PERMS !== 'undefined' && (LM_PERMS.action_delete_ticket);

            pageTickets.forEach(ticket => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid rgba(148,163,184,0.1)';
                row.style.cursor = 'pointer';
                row.style.transition = 'background 0.2s';
                row.onmouseover = () => row.style.background = 'rgba(124,58,237,0.1)';
                row.onmouseout = () => row.style.background = 'transparent';
                
                const createdDate = new Date(ticket.created_at).toLocaleString();
                const closedDate = ticket.closed_at ? new Date(ticket.closed_at).toLocaleString() : 'N/A';

                row.innerHTML = `
                    <td style="padding:12px 16px;color:#e5e7eb;font-weight:600;">#${ticket.ticket_number}</td>
                    <td style="padding:12px 16px;color:#94a3b8;">${ticket.category}</td>
                    <td style="padding:12px 16px;color:#94a3b8;">${ticket.creator_id}</td>
                    <td style="padding:12px 16px;"><span style="padding:4px 10px;background:${ticket.status === 'Closed' ? 'rgba(239,68,68,0.2)' : 'rgba(34,197,94,0.2)'};color:${ticket.status === 'Closed' ? '#ef4444' : '#22c55e'};border-radius:6px;font-size:12px;font-weight:600;">${ticket.status}</span></td>
                    <td style="padding:12px 16px;color:#94a3b8;font-size:13px;">${createdDate}</td>
                    <td style="padding:12px 16px;color:#94a3b8;font-size:13px;">${closedDate}</td>
                    <td style="padding:12px 16px;" onclick="event.stopPropagation();">
                        <div style="display:flex;gap:8px;">
                            ${hasViewTickets ? `<button class="button button-primary button-compact ticket-open-btn" onclick="openTicketTranscript('${ticket.ticket_id}', '${ticket.guild_id}')" style="padding:6px 12px;font-size:12px;">Open</button>` : ''}
                            ${hasDownloadTickets ? `<button class="button button-secondary button-compact ticket-download-btn" onclick="downloadTicketTranscript('${ticket.ticket_id}', '${ticket.guild_id}', ${ticket.ticket_number})" style="padding:6px 12px;font-size:12px;">Download</button>` : ''}
                            ${hasDeleteTickets ? `<button class="button button-danger button-compact ticket-delete-btn" onclick="deleteTicketTranscript('${ticket.ticket_id}', '${ticket.guild_id}')" style="padding:6px 12px;font-size:12px;background:rgba(239,68,68,0.2);color:#ef4444;">Delete</button>` : ''}
                        </div>
                `;

                row.onclick = () => toggleTicketDetails(ticket, row);
                tbody.appendChild(row);
            });

            document.getElementById('tickets-loading').style.display = 'none';
            document.getElementById('tickets-table-container').style.display = filteredTickets.length > 0 ? 'block' : 'none';
            document.getElementById('tickets-empty-state').style.display = filteredTickets.length > 0 ? 'none' : 'block';
            
            console.log('Table container display:', document.getElementById('tickets-table-container').style.display);
            console.log('Empty state display:', document.getElementById('tickets-empty-state').style.display);
            console.log('Rows added to tbody:', tbody.children.length);
            
            // DEBUG: Check actual computed styles and dimensions
            const tableContainer = document.getElementById('tickets-table-container');
            const computedStyle = window.getComputedStyle(tableContainer);
            console.log('COMPUTED STYLES:', {
                display: computedStyle.display,
                visibility: computedStyle.visibility,
                opacity: computedStyle.opacity,
                height: computedStyle.height,
                maxHeight: computedStyle.maxHeight,
                overflow: computedStyle.overflow,
                position: computedStyle.position,
                top: computedStyle.top,
                left: computedStyle.left
            });
            console.log('BOUNDING RECT:', tableContainer.getBoundingClientRect());
            console.log('PARENT ELEMENT:', tableContainer.parentElement);
            console.log('PARENT COMPUTED:', {
                display: window.getComputedStyle(tableContainer.parentElement).display,
                height: window.getComputedStyle(tableContainer.parentElement).height,
                overflow: window.getComputedStyle(tableContainer.parentElement).overflow
            });
            
            const totalPages = Math.ceil(filteredTickets.length / ticketsPerPage);
            document.getElementById('tickets-pagination').style.display = filteredTickets.length > ticketsPerPage ? 'flex' : 'none';
            document.getElementById('tickets-page-info').textContent = `Page ${currentTicketsPage} of ${totalPages}`;
            document.getElementById('tickets-prev-btn').disabled = currentTicketsPage === 1;
            document.getElementById('tickets-next-btn').disabled = currentTicketsPage === totalPages;
            
            document.getElementById('tickets-count').textContent = `${filteredTickets.length} ticket${filteredTickets.length !== 1 ? 's' : ''}`;
        }

        function toggleTicketDetails(ticket, row) {
            const existingDetails = row.nextElementSibling;
            if (existingDetails && existingDetails.classList.contains('ticket-details-row')) {
                existingDetails.remove();
                return;
            }

            const detailsRow = document.createElement('tr');
            detailsRow.classList.add('ticket-details-row');
            detailsRow.style.background = 'rgba(15,23,42,0.5)';
            detailsRow.style.borderBottom = '1px solid rgba(148,163,184,0.2)';
            
            detailsRow.innerHTML = `
                <td colspan="7" style="padding:20px 16px;">
                    <div style="display:grid;gap:12px;">
                        <div>
                            <div style="color:#7c3aed;font-weight:600;font-size:13px;margin-bottom:4px;">SUBJECT</div>
                            <div style="color:#e5e7eb;">${ticket.subject || 'No subject'}</div>
                        </div>
                        <div>
                            <div style="color:#7c3aed;font-weight:600;font-size:13px;margin-bottom:4px;">DESCRIPTION</div>
                            <div style="color:#e5e7eb;">${ticket.description || 'No description'}</div>
                        </div>
                        ${ticket.tags && ticket.tags.length > 0 ? `
                        <div>
                            <div style="color:#7c3aed;font-weight:600;font-size:13px;margin-bottom:4px;">TAGS</div>
                            <div style="display:flex;gap:6px;flex-wrap:wrap;">
                                ${ticket.tags.map(tag => `<span style="padding:4px 10px;background:rgba(124,58,237,0.2);color:#a855f7;border-radius:6px;font-size:12px;">${tag}</span>`).join('')}
                            </div>
                        </div>
                        ` : ''}
                        ${ticket.close_reason ? `
                        <div>
                            <div style="color:#7c3aed;font-weight:600;font-size:13px;margin-bottom:4px;">CLOSE REASON</div>
                            <div style="color:#e5e7eb;">${ticket.close_reason}</div>
                        </div>
                        ` : ''}
                        ${ticket.closed_by_name ? `
                        <div>
                            <div style="color:#7c3aed;font-weight:600;font-size:13px;margin-bottom:4px;">CLOSED BY</div>
                            <div style="color:#e5e7eb;">${ticket.closed_by_name}</div>
                        </div>
                        ` : ''}
                    </div>
                </td>
            `;
            
            row.after(detailsRow);
        }

        function ticketsPreviousPage() {
            if (currentTicketsPage > 1) {
                currentTicketsPage--;
                displayTicketsPage();
            }
        }

        function ticketsNextPage() {
            const totalPages = Math.ceil(filteredTickets.length / ticketsPerPage);
            if (currentTicketsPage < totalPages) {
                currentTicketsPage++;
                displayTicketsPage();
            }
        }

        function openTicketTranscript(ticketId, guildId) {
            window.open(`transcript_view.php?ticket_id=${ticketId}&guild_id=${guildId}`, '_blank');
        }

        function downloadTicketTranscript(ticketId, guildId, ticketNumber) {
            window.location.href = `download_transcript.php?ticket_id=${ticketId}&guild_id=${guildId}&ticket_number=${ticketNumber}`;
        }

        async function deleteTicketTranscript(ticketId, guildId) {
            if (!confirm('Are you sure you want to delete this ticket transcript? This action cannot be undone.')) {
                return;
            }

            showNotification('Deleting ticket transcript...', 'info');

            try {
                const response = await fetch('./delete_ticket.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticket_id: ticketId, guild_id: guildId })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showNotification('Ticket transcript deleted successfully', 'success');
                    
                    // Immediately remove from ticketsData array
                    ticketsData = ticketsData.filter(t => !(t.ticket_id === ticketId && t.guild_id === guildId));
                    
                    // Immediately remove from UI for instant feedback
                    const ticketRow = document.querySelector(`[data-ticket-id="${ticketId}"]`);
                    if (ticketRow) {
                        ticketRow.style.opacity = '0';
                        ticketRow.style.transition = 'opacity 0.3s';
                        setTimeout(() => ticketRow.remove(), 300);
                    }
                    
                    // Refresh the filtered display immediately
                    filterAndDisplayTickets();
                    
                    // Refresh from server after short delay
                    setTimeout(() => loadTickets(), 1000);
                } else {
                    showNotification('Error deleting transcript: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showNotification('Error deleting transcript: ' + error.message, 'error');
            }
        }

        function setupTicketsAutoRefresh() {
            const autoRefreshSelect = document.getElementById('tickets-autorefresh');
            if (!autoRefreshSelect) return;

            autoRefreshSelect.addEventListener('change', () => {
                if (ticketsAutoRefreshInterval) {
                    clearInterval(ticketsAutoRefreshInterval);
                    ticketsAutoRefreshInterval = null;
                }

                const interval = parseInt(autoRefreshSelect.value);
                if (interval > 0) {
                    ticketsAutoRefreshInterval = setInterval(() => {
                        loadTickets();
                    }, interval);
                }
            });
        }

        document.getElementById('tickets-guild-filter')?.addEventListener('change', filterAndDisplayTickets);
        document.getElementById('tickets-category-filter')?.addEventListener('change', filterAndDisplayTickets);
        document.getElementById('tickets-search')?.addEventListener('input', filterAndDisplayTickets);
        document.getElementById('tickets-sort')?.addEventListener('change', filterAndDisplayTickets);

        setupTicketsAutoRefresh();
    
        let logsRefreshInterval = null;
        
        function setLogsAutoRefresh(seconds) {
            if (logsRefreshInterval) {
                clearInterval(logsRefreshInterval);
                logsRefreshInterval = null;
            }
            const sec = parseInt(seconds);
            if (sec > 0) {
                logsRefreshInterval = setInterval(() => {
                    refreshSecurityLogs();
                }, sec * 1000);
            }
        }
        
        
        function toggleDebugPackages(enabled) {
            sendCommand('toggle_debug_packages', { enabled: enabled });
            showNotification(enabled ? 'Debug packages enabled' : 'Debug packages disabled', 'info');
        }
        
        function refreshSecurityLogs() {
            if (typeof currentTab !== 'undefined' && currentTab !== 'security') {
                return;
            }
            const iframe = document.querySelector('#tab-security iframe');
            if (iframe) {
                iframe.src = iframe.src;
            }
        }
        

        function openPrivacyModal() {
            fetch('privacy_api.php')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const toggle = document.getElementById('modal-log-ip-toggle-pill');
                        if (data.log_ip) {
                            toggle.classList.add('on');
                        } else {
                            toggle.classList.remove('on');
                        }
                    }
                });
            document.getElementById('privacy-modal').classList.add('active');
        }

        function closePrivacyModal() {
            document.getElementById('privacy-modal').classList.remove('active');
        }

        function savePrivacySettings() {
            const toggle = document.getElementById('modal-log-ip-toggle-pill');
            const log_ip = toggle.classList.contains('on');
            
            fetch('privacy_api.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ log_ip: log_ip })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showNotification('Privacy settings saved!', 'success');
                    // Refresh permissions to get updated session values
                    refreshPermissions();
                } else {
                    showNotification('Error saving settings: ' + data.error, 'error');
                }
                closePrivacyModal();
            });
        }

        /* DASHBOARD_PLUGINS_JS_PLACEHOLDER */

</script>
</body>
</html>'''.replace('{{TOKEN}}', token).replace('{{PREFIX}}', self._get_default_prefix())

    def _generate_index_php(self, token: str, default_prefix: str, setup_token: str) -> str:
        """Wrap the static dashboard HTML in a small PHP bootstrap.

        The underlying HTML/JS is still generated by `_generate_index_html`, but
        index.php adds a lightweight guard that ensures the dashboard is either
        in one-time setup mode or requires a logged-in Discord user.
        
        Also injects Dashboard Plugin System content.
        """

        if not self._plugins_discovered:
            self._dashboard_plugins = self._discover_dashboard_plugins()
            self._plugins_discovered = True
        
        plugins = self._dashboard_plugins
        
        base_html = self._generate_index_html(token)
        

        if plugins:

            sidebar_html = self._generate_plugin_sidebar_html(plugins)
            base_html = base_html.replace('<!-- DASHBOARD_PLUGINS_SIDEBAR_PLACEHOLDER -->', sidebar_html)
            

            drawer_html = self._generate_plugin_sidebar_html(plugins)
            drawer_html = drawer_html.replace('lm-sidebar-item', 'lm-drawer-item')
            drawer_html = drawer_html.replace('lm-sidebar-group-label', 'lm-drawer-group-label')
            drawer_html = drawer_html.replace('id="lm-plugin-section"', 'id="lm-drawer-plugin-section"')
            drawer_html = drawer_html.replace('id="lm-plugin-dropdown"', 'id="lm-drawer-plugin-dropdown"')
            drawer_html = drawer_html.replace('id="lm-plugin-visible-count"', 'id="lm-drawer-plugin-visible-count"')
            drawer_html = drawer_html.replace('togglePluginDropdown()', 'toggleDrawerPluginDropdown()')
            base_html = base_html.replace('<!-- DASHBOARD_PLUGINS_DRAWER_PLACEHOLDER -->', drawer_html)
            

            tabs_html = self._generate_plugin_tabs_html(plugins)
            base_html = base_html.replace('<!-- DASHBOARD_PLUGINS_TABS_PLACEHOLDER -->', tabs_html)
            

            css_html = self._generate_plugin_dropdown_css()
            base_html = base_html.replace('/* DASHBOARD_PLUGINS_CSS_PLACEHOLDER */', css_html)
            

            js_html = self._generate_plugin_dropdown_js() + self._generate_plugin_tab_mapping_js(plugins)
            base_html = base_html.replace('/* DASHBOARD_PLUGINS_JS_PLACEHOLDER */', js_html)
            

            all_perms = self._get_all_plugin_permissions(plugins)
            

            view_perms_js = ""
            for perm in all_perms['view']:
                view_perms_js += f"{{ key: '{perm['key']}', label: '{perm['label']}' }},\n                "
            base_html = base_html.replace('/* DASHBOARD_PLUGINS_VIEW_PERMS_PLACEHOLDER */', view_perms_js.rstrip().rstrip(','))
            

            action_perms_js = ""
            for perm in all_perms['actions']:
                label = perm['label'].replace("'", "\\'")
                action_perms_js += f"{{ key: '{perm['key']}', label: '{label}' }},\n                "
            base_html = base_html.replace('/* DASHBOARD_PLUGINS_ACTION_PERMS_PLACEHOLDER */', action_perms_js.rstrip().rstrip(','))
            

            tab_map_js = ""
            for plugin in plugins:
                plugin_id = plugin['id']
                view_perm = plugin.get('permissions', {}).get('view', f'view_{plugin_id}')
                tab_map_js += f"'{plugin_id}': '{view_perm}',\n                "
            base_html = base_html.replace('/* DASHBOARD_PLUGINS_TAB_MAP_PLACEHOLDER */', tab_map_js.rstrip().rstrip(','))
            base_html = base_html.replace('/* DASHBOARD_PLUGINS_TAB_PERM_MAP_PLACEHOLDER */', tab_map_js.rstrip().rstrip(','))
        else:

            base_html = base_html.replace('<!-- DASHBOARD_PLUGINS_SIDEBAR_PLACEHOLDER -->', '')
            base_html = base_html.replace('<!-- DASHBOARD_PLUGINS_DRAWER_PLACEHOLDER -->', '')
            base_html = base_html.replace('<!-- DASHBOARD_PLUGINS_TABS_PLACEHOLDER -->', '')
            base_html = base_html.replace('/* DASHBOARD_PLUGINS_CSS_PLACEHOLDER */', '')
            base_html = base_html.replace('/* DASHBOARD_PLUGINS_JS_PLACEHOLDER */', '')
            base_html = base_html.replace('/* DASHBOARD_PLUGINS_VIEW_PERMS_PLACEHOLDER */', '')
            base_html = base_html.replace('/* DASHBOARD_PLUGINS_ACTION_PERMS_PLACEHOLDER */', '')
            base_html = base_html.replace('/* DASHBOARD_PLUGINS_TAB_MAP_PLACEHOLDER */', '')
            base_html = base_html.replace('/* DASHBOARD_PLUGINS_TAB_PERM_MAP_PLACEHOLDER */', '')
        
        php_guard = """<?php
require_once __DIR__ . '/lm_db.php';
require_once __DIR__ . '/lm_auth.php';

lm_start_session_if_needed();
lm_ensure_schema();
lm_guard_index();
?>
"""
        return php_guard + base_html

    def _generate_lm_bootstrap_php(self, secret_token: str, setup_token: str) -> str:
        """Small bootstrap file that carries tokens into the PHP world.

        LM_SECRET_TOKEN is used for bootstrapping the initial DB config; the
        actual botâ†”web communication still relies on SECRET_TOKEN inside the
        bridge scripts.
        """
        return f'''<?php
// Prevent direct access to this file
if (basename($_SERVER['PHP_SELF']) == basename(__FILE__)) {{
    http_response_code(403);
    ?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>403 - Access Denied</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap');

    * {{
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }}

    body {{
      font-family: 'Space Grotesk', sans-serif;
      background: #0a0a0f;
      color: #fff;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      position: relative;
    }}

    .background {{
      position: absolute;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }}

    .orb {{
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.6;
      animation: float 20s infinite ease-in-out;
    }}

    .orb1 {{
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, #ff006e, #8338ec);
      top: -200px;
      left: -100px;
      animation-delay: 0s;
    }}

    .orb2 {{
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, #3a86ff, #06ffa5);
      bottom: -150px;
      right: -100px;
      animation-delay: -10s;
    }}

    .orb3 {{
      width: 350px;
      height: 350px;
      background: radial-gradient(circle, #fb5607, #ffbe0b);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation-delay: -5s;
    }}

    @keyframes float {{
      0%, 100% {{
        transform: translate(0, 0) scale(1);
      }}
      33% {{
        transform: translate(100px, -50px) scale(1.1);
      }}
      66% {{
        transform: translate(-50px, 100px) scale(0.9);
      }}
    }}

    .container {{
      position: relative;
      z-index: 10;
      text-align: center;
      max-width: 600px;
      padding: 40px;
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border-radius: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: slideIn 0.8s ease-out;
    }}

    @keyframes slideIn {{
      from {{
        opacity: 0;
        transform: translateY(30px);
      }}
      to {{
        opacity: 1;
        transform: translateY(0);
      }}
    }}

    .lock-icon {{
      width: 120px;
      height: 120px;
      margin: 0 auto 30px;
      position: relative;
      animation: bounce 2s infinite;
    }}

    @keyframes bounce {{
      0%, 100% {{
        transform: translateY(0);
      }}
      50% {{
        transform: translateY(-10px);
      }}
    }}

    .lock-body {{
      width: 80px;
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
    }}

    .lock-shackle {{
      width: 50px;
      height: 50px;
      border: 8px solid #667eea;
      border-bottom: none;
      border-radius: 50px 50px 0 0;
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
    }}

    .keyhole {{
      width: 8px;
      height: 20px;
      background: rgba(10, 10, 15, 0.8);
      border-radius: 50% 50% 0 0;
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
    }}

    .keyhole::after {{
      content: '';
      width: 16px;
      height: 16px;
      background: rgba(10, 10, 15, 0.8);
      border-radius: 50%;
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
    }}

    h1 {{
      font-size: 120px;
      font-weight: 700;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      animation: glow 2s ease-in-out infinite;
    }}

    @keyframes glow {{
      0%, 100% {{
        filter: brightness(1);
      }}
      50% {{
        filter: brightness(1.2);
      }}
    }}

    h2 {{
      font-size: 32px;
      font-weight: 600;
      margin: 20px 0 15px;
      color: #fff;
    }}

    p {{
      font-size: 18px;
      color: rgba(255, 255, 255, 0.7);
      line-height: 1.6;
      margin-bottom: 30px;
    }}

    .buttons {{
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }}

    .btn {{
      padding: 14px 32px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.3s ease;
      font-family: 'Space Grotesk', sans-serif;
    }}

    .btn-primary {{
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }}

    .btn-primary:hover {{
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
    }}

    .error-footer {{
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      font-size: 14px;
      color: rgba(255, 255, 255, 0.65);
    }}

    @media (max-width: 768px) {{
      .container {{
        padding: 30px 20px;
        margin: 20px;
      }}

      h1 {{
        font-size: 80px;
      }}

      h2 {{
        font-size: 24px;
      }}

      p {{
        font-size: 16px;
      }}

      .lock-icon {{
        width: 100px;
        height: 100px;
      }}

      .lock-body {{
        width: 70px;
        height: 50px;
      }}

      .lock-shackle {{
        width: 40px;
        height: 40px;
      }}
    }}
  </style>
</head>
<body>
  <div class="background">
    <div class="orb orb1"></div>
    <div class="orb orb2"></div>
    <div class="orb orb3"></div>
  </div>

  <div class="container">
    <div class="lock-icon">
      <div class="lock-shackle"></div>
      <div class="lock-body">
        <div class="keyhole"></div>
      </div>
    </div>
    
    <h1>403</h1>
    <h2>Library File Access Denied</h2>
    <p>This is a backend library file and cannot be accessed directly. Please use the dashboard homepage.</p>
    
    <div class="buttons">
      <a href="index.php" class="btn btn-primary">â† Back to Dashboard</a>
    </div>
    
    <div class="error-footer">
      Zoryx Discord Bot Framework Â· Live Monitor Dashboard
    </div>
  </div>
</body>
</html>
    <?php
    exit;
}}

// Auto-generated by Zoryx Live Monitor. Do not edit manually unless you
// know what you're doing.

if (!defined('LM_SECRET_TOKEN')) {{
    define('LM_SECRET_TOKEN', '{secret_token}');
}}

if (!defined('LM_SETUP_TOKEN')) {{
    define('LM_SETUP_TOKEN', '{setup_token}');
}}
?>
'''

    def _generate_lm_db_php(self) -> str:
        """Database helper (SQLite by default, file-based, zero-config)."""
        return '''<?php
// Prevent direct access to this file
if (basename($_SERVER['PHP_SELF']) == basename(__FILE__)) {
    http_response_code(403);
    ?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>403 - Access Denied</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: #0a0a0f;
      color: #fff;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      position: relative;
    }

    .background {
      position: absolute;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.6;
      animation: float 20s infinite ease-in-out;
    }

    .orb1 {
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, #ff006e, #8338ec);
      top: -200px;
      left: -100px;
      animation-delay: 0s;
    }

    .orb2 {
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, #3a86ff, #06ffa5);
      bottom: -150px;
      right: -100px;
      animation-delay: -10s;
    }

    .orb3 {
      width: 350px;
      height: 350px;
      background: radial-gradient(circle, #fb5607, #ffbe0b);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation-delay: -5s;
    }

    @keyframes float {
      0%, 100% {
        transform: translate(0, 0) scale(1);
      }
      33% {
        transform: translate(100px, -50px) scale(1.1);
      }
      66% {
        transform: translate(-50px, 100px) scale(0.9);
      }
    }

    .container {
      position: relative;
      z-index: 10;
      text-align: center;
      max-width: 600px;
      padding: 40px;
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border-radius: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: slideIn 0.8s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .lock-icon {
      width: 120px;
      height: 120px;
      margin: 0 auto 30px;
      position: relative;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    .lock-body {
      width: 80px;
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
    }

    .lock-shackle {
      width: 50px;
      height: 50px;
      border: 8px solid #667eea;
      border-bottom: none;
      border-radius: 50px 50px 0 0;
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
    }

    .keyhole {
      width: 8px;
      height: 20px;
      background: rgba(10, 10, 15, 0.8);
      border-radius: 50% 50% 0 0;
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
    }

    .keyhole::after {
      content: '';
      width: 16px;
      height: 16px;
      background: rgba(10, 10, 15, 0.8);
      border-radius: 50%;
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
    }

    h1 {
      font-size: 120px;
      font-weight: 700;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      animation: glow 2s ease-in-out infinite;
    }

    @keyframes glow {
      0%, 100% {
        filter: brightness(1);
      }
      50% {
        filter: brightness(1.2);
      }
    }

    h2 {
      font-size: 32px;
      font-weight: 600;
      margin: 20px 0 15px;
      color: #fff;
    }

    p {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.7);
      line-height: 1.6;
      margin-bottom: 30px;
    }

    .buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 14px 32px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.3s ease;
      font-family: 'Space Grotesk', sans-serif;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
    }

    .error-footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      font-size: 14px;
      color: rgba(255, 255, 255, 0.65);
    }

    @media (max-width: 768px) {
      .container {
        padding: 30px 20px;
        margin: 20px;
      }

      h1 {
        font-size: 80px;
      }

      h2 {
        font-size: 24px;
      }

      p {
        font-size: 16px;
      }

      .lock-icon {
        width: 100px;
        height: 100px;
      }

      .lock-body {
        width: 70px;
        height: 50px;
      }

      .lock-shackle {
        width: 40px;
        height: 40px;
      }
    }
  </style>
</head>
<body>
  <div class="background">
    <div class="orb orb1"></div>
    <div class="orb orb2"></div>
    <div class="orb orb3"></div>
  </div>

  <div class="container">
    <div class="lock-icon">
      <div class="lock-shackle"></div>
      <div class="lock-body">
        <div class="keyhole"></div>
      </div>
    </div>
    
    <h1>403</h1>
    <h2>Library File Access Denied</h2>
    <p>This is a backend library file and cannot be accessed directly. Please use the dashboard homepage.</p>
    
    <div class="buttons">
      <a href="index.php" class="btn btn-primary">â† Back to Dashboard</a>
    </div>
    
    <div class="error-footer">
      Zoryx Discord Bot Framework Â· Live Monitor Dashboard
    </div>
  </div>
</body>
</html>
    <?php
    exit;
}

// Lightweight DB helper for the Live Monitor dashboard (SQLite by default).
require_once __DIR__ . '/lm_bootstrap.php';

function lm_db() {
    static $pdo = null;
    if ($pdo !== null) {
        return $pdo;
    }

    $dbDir = __DIR__ . '/data';
    if (!is_dir($dbDir)) {
        mkdir($dbDir, 0775, true);
    }

    $dsn = 'sqlite:' . $dbDir . '/dashboard.sqlite';

    $pdo = new PDO($dsn, null, null, [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
    ]);

    return $pdo;
}

function lm_ensure_schema() {
    $pdo = lm_db();

    // Global config (single row)
    $pdo->exec("\r
        CREATE TABLE IF NOT EXISTS dashboard_config (\r
            id INTEGER PRIMARY KEY AUTOINCREMENT,\r
            owner_discord_id VARCHAR(32) NULL,\r
            setup_completed INTEGER NOT NULL DEFAULT 0,\r
            setup_token VARCHAR(64) NULL,\r
            discord_client_id VARCHAR(64) NULL,\r
            discord_client_secret VARCHAR(128) NULL,\r
            oauth_redirect_url VARCHAR(255) NULL,\r
            created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\r
            updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP\r
        );\r
    ");

    // Allowed dashboard users
    $pdo->exec("\r
        CREATE TABLE IF NOT EXISTS dashboard_users (\r
            id INTEGER PRIMARY KEY AUTOINCREMENT,\r
            discord_user_id VARCHAR(32) UNIQUE NOT NULL,\r
            display_name VARCHAR(128) NOT NULL,\r
            avatar_url VARCHAR(255) NULL,\r
            role VARCHAR(16) NOT NULL,\r
            log_ip INTEGER NOT NULL DEFAULT 1,\r
            created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\r
            updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP\r
        );\r
    ");

    // Best-effort migration: add log_ip if an older table exists without it
    try {
        $pdo->exec("ALTER TABLE dashboard_users ADD COLUMN log_ip INTEGER NOT NULL DEFAULT 1");
    } catch (Throwable $e) {
        // Ignore if column already exists
    }

    // Audit logs
    $pdo->exec("\r
        CREATE TABLE IF NOT EXISTS audit_logs (\r
            id INTEGER PRIMARY KEY AUTOINCREMENT,\r
            timestamp DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\r
            actor_user_id INTEGER NULL,\r
            actor_discord_id VARCHAR(32) NULL,\r
            action VARCHAR(64) NOT NULL,\r
            target_type VARCHAR(64) NULL,\r
            target_id VARCHAR(128) NULL,\r
            ip_address VARCHAR(45) NULL,\r
            user_agent VARCHAR(255) NULL,\r
            meta_json TEXT NULL\r
        );\r
    ");

    $pdo->exec("CREATE INDEX IF NOT EXISTS idx_audit_logs_timestamp ON audit_logs (timestamp);");
    $pdo->exec("CREATE INDEX IF NOT EXISTS idx_audit_logs_actor ON audit_logs (actor_user_id);");
    $pdo->exec("CREATE INDEX IF NOT EXISTS idx_audit_logs_action ON audit_logs (action);");

    // Optional custom roles table (role profiles / aliases)
    $pdo->exec("\r
        CREATE TABLE IF NOT EXISTS dashboard_roles (\r
            id INTEGER PRIMARY KEY AUTOINCREMENT,\r
            name VARCHAR(64) UNIQUE NOT NULL,\r
            base_role VARCHAR(16) NOT NULL,\r
            description VARCHAR(255) NULL,\r
            permissions_json TEXT NULL,\r
            created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\r
            updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP\r
        );\r
    ");

    // Best-effort migration: add permissions_json if an older table exists without it
    try {
        $pdo->exec("ALTER TABLE dashboard_roles ADD COLUMN permissions_json TEXT NULL");
    } catch (Throwable $e) {
        // Ignore if column already exists
    }
    
    // CRITICAL: Delete any OWNER role from dashboard_roles table
    // OWNER should only exist as code-defined tier, never in database
    try {
        $pdo->exec("DELETE FROM dashboard_roles WHERE UPPER(name) = 'OWNER'");
    } catch (Throwable $e) {
        // Ignore if table doesn't exist yet or other errors
    }

    // Seed single config row if missing
    $stmt = $pdo->query("SELECT COUNT(*) AS c FROM dashboard_config");
    $row = $stmt->fetch();
    $count = isset($row['c']) ? (int)$row['c'] : 0;
    if ($count === 0) {
        $setupToken = defined('LM_SETUP_TOKEN') ? LM_SETUP_TOKEN : null;
        $insert = $pdo->prepare("\r
            INSERT INTO dashboard_config (owner_discord_id, setup_completed, setup_token)\r
            VALUES (NULL, 0, :token)\r
        ");
        $insert->execute([':token' => $setupToken]);
    }
}
?>
'''

    def _generate_lm_auth_php(self, plugins: List[Dict] = None) -> str:
        """Authentication helpers: sessions, roles, audit logging, guards."""
        base_php = '''<?php
// Prevent direct access to this file
if (basename($_SERVER['PHP_SELF']) == basename(__FILE__)) {
    http_response_code(403);
    ?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>403 - Access Denied</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: #0a0a0f;
      color: #fff;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      position: relative;
    }

    .background {
      position: absolute;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.6;
      animation: float 20s infinite ease-in-out;
    }

    .orb1 {
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, #ff006e, #8338ec);
      top: -200px;
      left: -100px;
      animation-delay: 0s;
    }

    .orb2 {
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, #3a86ff, #06ffa5);
      bottom: -150px;
      right: -100px;
      animation-delay: -10s;
    }

    .orb3 {
      width: 350px;
      height: 350px;
      background: radial-gradient(circle, #fb5607, #ffbe0b);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation-delay: -5s;
    }

    @keyframes float {
      0%, 100% {
        transform: translate(0, 0) scale(1);
      }
      33% {
        transform: translate(100px, -50px) scale(1.1);
      }
      66% {
        transform: translate(-50px, 100px) scale(0.9);
      }
    }

    .container {
      position: relative;
      z-index: 10;
      text-align: center;
      max-width: 600px;
      padding: 40px;
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border-radius: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: slideIn 0.8s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .lock-icon {
      width: 120px;
      height: 120px;
      margin: 0 auto 30px;
      position: relative;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    .lock-body {
      width: 80px;
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
    }

    .lock-shackle {
      width: 50px;
      height: 50px;
      border: 8px solid #667eea;
      border-bottom: none;
      border-radius: 50px 50px 0 0;
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
    }

    .keyhole {
      width: 8px;
      height: 20px;
      background: rgba(10, 10, 15, 0.8);
      border-radius: 50% 50% 0 0;
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
    }

    .keyhole::after {
      content: '';
      width: 16px;
      height: 16px;
      background: rgba(10, 10, 15, 0.8);
      border-radius: 50%;
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
    }

    h1 {
      font-size: 120px;
      font-weight: 700;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      animation: glow 2s ease-in-out infinite;
    }

    @keyframes glow {
      0%, 100% {
        filter: brightness(1);
      }
      50% {
        filter: brightness(1.2);
      }
    }

    h2 {
      font-size: 32px;
      font-weight: 600;
      margin: 20px 0 15px;
      color: #fff;
    }

    p {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.7);
      line-height: 1.6;
      margin-bottom: 30px;
    }

    .buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 14px 32px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.3s ease;
      font-family: 'Space Grotesk', sans-serif;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
    }

    .error-footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      font-size: 14px;
      color: rgba(255, 255, 255, 0.65);
    }

    @media (max-width: 768px) {
      .container {
        padding: 30px 20px;
        margin: 20px;
      }

      h1 {
        font-size: 80px;
      }

      h2 {
        font-size: 24px;
      }

      p {
        font-size: 16px;
      }

      .lock-icon {
        width: 100px;
        height: 100px;
      }

      .lock-body {
        width: 70px;
        height: 50px;
      }

      .lock-shackle {
        width: 40px;
        height: 40px;
      }
    }
  </style>
</head>
<body>
  <div class="background">
    <div class="orb orb1"></div>
    <div class="orb orb2"></div>
    <div class="orb orb3"></div>
  </div>

  <div class="container">
    <div class="lock-icon">
      <div class="lock-shackle"></div>
      <div class="lock-body">
        <div class="keyhole"></div>
      </div>
    </div>
    
    <h1>403</h1>
    <h2>Library File Access Denied</h2>
    <p>This is a backend library file and cannot be accessed directly. Please use the dashboard homepage.</p>
    
    <div class="buttons">
      <a href="index.php" class="btn btn-primary">â† Back to Dashboard</a>
    </div>
    
    <div class="error-footer">
      Zoryx Discord Bot Framework Â· Live Monitor Dashboard
    </div>
  </div>
</body>
</html>
    <?php
    exit;
}

require_once __DIR__ . '/lm_db.php';

function lm_start_session_if_needed(): void {
    if (session_status() !== PHP_SESSION_ACTIVE) {
        // Simple, safe default session configuration
        session_start([
            'cookie_httponly' => true,
            'cookie_secure' => (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off'),
            'cookie_samesite' => 'Lax',
        ]);
    }
}

function lm_get_config(): array {
    lm_ensure_schema();
    $pdo = lm_db();
    $stmt = $pdo->query('SELECT * FROM dashboard_config LIMIT 1');
    $row = $stmt->fetch();
    return $row ?: [];
}

function lm_save_config(array $config): void {
    $pdo = lm_db();
    $current = lm_get_config();
    if (!$current) {
        return;
    }

    $fields = [
        'owner_discord_id',
        'setup_completed',
        'setup_token',
        'discord_client_id',
        'discord_client_secret',
        'oauth_redirect_url',
    ];
    $sets = [];
    $params = [];
    foreach ($fields as $field) {
        if (array_key_exists($field, $config)) {
            $sets[] = "$field = :$field";
            $params[":$field"] = $config[$field];
        }
    }
    if (!$sets) {
        return;
    }
    $sql = 'UPDATE dashboard_config SET ' . implode(', ', $sets) . ' WHERE id = :id';
    $params[':id'] = $current['id'];
    $stmt = $pdo->prepare($sql);
    $stmt->execute($params);
}

function lm_current_user(): ?array {
    lm_start_session_if_needed();
    if (empty($_SESSION['lm_user_id'])) {
        return null;
    }
    $pdo = lm_db();
    $stmt = $pdo->prepare('SELECT * FROM dashboard_users WHERE id = :id LIMIT 1');
    $stmt->execute([':id' => $_SESSION['lm_user_id']]);
    $user = $stmt->fetch();
    return $user ?: null;
}

function lm_is_logged_in(): bool {
    return lm_current_user() !== null;
}

function lm_log_audit(string $action, ?string $targetType = null, ?string $targetId = null, array $meta = []): void {
    try {
        lm_start_session_if_needed();
        lm_ensure_schema();
        $pdo = lm_db();
        $user = lm_current_user();

        $stmt = $pdo->prepare('INSERT INTO audit_logs (
            actor_user_id, actor_discord_id, action, target_type, target_id, ip_address, user_agent, meta_json
        ) VALUES (:uid, :did, :action, :tt, :tid, :ip, :ua, :meta)');

        $ip = ($_SESSION['log_ip'] ?? false) ? ($_SERVER['REMOTE_ADDR'] ?? null) : null;
        $ua = $_SERVER['HTTP_USER_AGENT'] ?? null;

        $stmt->execute([
            ':uid' => $user['id'] ?? null,
            ':did' => $user['discord_user_id'] ?? null,
            ':action' => $action,
            ':tt' => $targetType,
            ':tid' => $targetId,
            ':ip' => $ip,
            ':ua' => $ua,
            ':meta' => $meta ? json_encode($meta, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE) : null,
        ]);
    } catch (Throwable $e) {
        // Never break the dashboard because of logging issues.
    }
}

function lm_guard_index(): void {
    lm_start_session_if_needed();
    lm_ensure_schema();
    $config = lm_get_config();

    // Not yet claimed: redirect to setup wizard if we have a setup token
    if (empty($config['setup_completed'])) {
        $token = $config['setup_token'] ?? (defined('LM_SETUP_TOKEN') ? LM_SETUP_TOKEN : null);
        if (!$token) {
            http_response_code(503);
            echo '<h1>Dashboard setup required</h1><p>Please re-run /livemonitor quickstart to generate a new setup link.</p>';
            exit;
        }

        $scheme = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') ? 'https' : 'http';
        $host = $_SERVER['HTTP_HOST'] ?? 'localhost';
        $basePath = rtrim(dirname($_SERVER['SCRIPT_NAME'] ?? ''), '/');
        $setupUrl = sprintf('%s://%s%s/setup.php?setup_token=%s', $scheme, $host, $basePath, urlencode($token));
        header('Location: ' . $setupUrl);
        exit;
    }

    // Already claimed: require a logged-in dashboard user
    $user = lm_current_user();
    if (!$user) {
        header('Location: login.php');
        exit;
    }
}

function lm_require_owner(): void {
    $user = lm_current_user();
    if (!$user) {
        lm_render_error_page(401, 'Authentication Required', 'You must be logged in to access this page.', 'lock');
    }
    if (($user['role'] ?? '') !== 'OWNER') {
        lm_render_error_page(403, 'Owner Access Required', 'This page is restricted to dashboard owners only. Contact the owner for access.', 'forbidden');
    }
}

/**
 * Resolve an arbitrary role name (including custom roles) to a base tier
 * of OWNER / CUSTOM for permission checks.
 */
function lm_resolve_role_tier(string $roleName): string {
    $upper = strtoupper($roleName);
    // Only two tiers: OWNER and CUSTOM
    if ($upper === 'OWNER') {
        return 'OWNER';
    }
    // Check database for base_role
    try {
        $pdo = lm_db();
        $stmt = $pdo->prepare('SELECT base_role FROM dashboard_roles WHERE UPPER(name) = UPPER(:name) LIMIT 1');
        $stmt->execute([':name' => $roleName]);
        $row = $stmt->fetch();
        if ($row && !empty($row['base_role'])) {
            $base = strtoupper($row['base_role']);
            if ($base === 'OWNER') {
                return 'OWNER';
            }
        }
    } catch (Throwable $e) {
        // Ignore DB errors; fall back to CUSTOM tier.
    }
    // Everything except OWNER is CUSTOM
    return 'CUSTOM';
}


function lm_default_permissions_for_tier(string $tier): array {
    switch ($tier) {
        case 'OWNER':
            // OWNER has EVERYTHING - all view and action permissions
            return [
                // VIEW PERMISSIONS - One per tab
                'view_dashboard' => true,       // Dashboard tab
                'view_commands' => true,        // Commands tab
                'view_plugins' => true,         // Plugins tab
                'view_hooks' => true,           // Event Hooks tab
                'view_files' => true,           // File Browser tab
                'view_filesystem' => true,      // Filesystem tab
                'view_chat' => true,            // Chat Console tab
                'view_tickets' => true,         // Discord Tickets tab
                'view_events' => true,          // Events tab
                'view_system' => true,          // System Details tab
                'view_guilds' => true,          // Guilds / Servers tab
                'view_database' => true,        // Database Viewer tab
                'view_marketplace' => true,     // Extension Marketplace tab
                'view_security' => true,        // Security & Logs tab
                'view_roles' => true,           // Roles & Access tab
                'view_bot_invite' => true,      // Bot Invite Helper tab
                
                // ACTION PERMISSIONS - Dashboard Actions (5)
                'action_clear_cache' => true,
                'action_toggle_logging' => true,
                'action_toggle_debug_packages' => true,
                'action_backup_dashboard' => true,
                'action_backup_bot' => true,
                
                // ACTION PERMISSIONS - Plugin Actions (6)
                'action_reload_extension' => true,
                'action_load_extension' => true,
                'action_unload_extension' => true,
                'action_set_auto_reload' => true,
                'action_set_auto_load' => true,
                'action_set_enforcement' => true,
                
                // ACTION PERMISSIONS - Hook Actions (6)
                'action_enable_hook' => true,
                'action_disable_hook' => true,
                'action_reset_circuit' => true,
                'action_create_hook' => true,
                'action_delete_hook' => true,
                'action_export_hooks' => true,
                
                // ACTION PERMISSIONS - File Actions (6)
                'action_upload_file' => true,
                'action_rename_file' => true,
                'action_delete_file' => true,
                'action_create_folder' => true,
                'action_edit_file' => true,
                'action_save_file' => true,
                
                // ACTION PERMISSIONS - System Actions (4)
                'action_shutdown_bot' => true,
                'action_generate_diagnostics' => true,
                'action_invalidate_cache' => true,
                'action_force_release_lock' => true,
                
                // ACTION PERMISSIONS - Chat Actions (1)
                'action_send_message' => true,
                'action_request_chat_data' => true,
                
                // ACTION PERMISSIONS - Ticket Actions (3)
                'action_view_ticket' => true,
                'action_download_ticket' => true,
                'action_delete_ticket' => true,
                
                // ACTION PERMISSIONS - Guild Actions (1)
                'action_leave_guild' => true,
                
                // ACTION PERMISSIONS - Bot Invite Actions (3)
                'action_generate_invite' => true,
                'action_open_invite' => true,
                'action_copy_invite' => true,
                
                // ACTION PERMISSIONS - Marketplace Actions (5)
                'action_fetch_marketplace' => true,
                'action_download_extension' => true,
                'action_load_marketplace_extension' => true,
                'action_refresh_zygnalid' => true,
                'action_refresh_marketplace' => true,
                
                // ACTION PERMISSIONS - Role Management Actions (3)
                'action_save_role' => true,
                'action_delete_role' => true,
                'action_create_role' => true,
                
                // ACTION PERMISSIONS - User Management Actions (3)
                'action_add_user' => true,
                'action_remove_user' => true,
                'action_change_user_role' => true,
                
                // ACTION PERMISSIONS - Log Actions (2)
                'action_view_logs' => true,
                'action_export_logs' => true,
                
                // ACTION PERMISSIONS - Database Actions (5)
                'action_execute_query' => true,
                'action_db_create' => true,
                'action_db_read' => true,
                'action_db_update' => true,
                'action_db_delete' => true,
                
                // DASHBOARD PLUGIN PERMISSIONS (dynamically added)
                /* DASHBOARD_PLUGINS_OWNER_PERMISSIONS_PLACEHOLDER */
            ];

        case 'CUSTOM':
        default:
            // CUSTOM tier: View most things, do nothing by default
            return [
                // VIEW PERMISSIONS - Most tabs visible
                'view_dashboard' => true,       // Dashboard tab
                'view_commands' => true,        // Commands tab
                'view_plugins' => true,         // Plugins tab
                'view_hooks' => true,           // Event Hooks tab
                'view_files' => true,           // File Browser tab
                'view_filesystem' => true,      // Filesystem tab
                'view_chat' => true,            // Chat Console tab
                'view_tickets' => true,         // Discord Tickets tab
                'view_events' => true,          // Events tab
                'view_system' => true,          // System Details tab
                'view_guilds' => true,          // Guilds / Servers tab
                'view_database' => false,       // Database Viewer - SENSITIVE
                'view_marketplace' => true,     // Extension Marketplace tab
                'view_security' => false,       // Security & Logs - SENSITIVE
                'view_roles' => false,          // Roles & Access - SENSITIVE
                'view_bot_invite' => true,      // Bot Invite Helper tab
                
                // ALL ACTION PERMISSIONS - FALSE by default (customize per role)
                'action_clear_cache' => false,
                'action_toggle_logging' => false,
                'action_toggle_debug_packages' => false,
                'action_backup_dashboard' => false,
                'action_backup_bot' => false,
                'action_reload_extension' => false,
                'action_load_extension' => false,
                'action_unload_extension' => false,
                'action_set_auto_reload' => false,
                'action_set_auto_load' => false,
                'action_set_enforcement' => false,
                'action_enable_hook' => false,
                'action_disable_hook' => false,
                'action_reset_circuit' => false,
                'action_create_hook' => false,
                'action_delete_hook' => false,
                'action_export_hooks' => false,
                'action_upload_file' => false,
                'action_rename_file' => false,
                'action_delete_file' => false,
                'action_create_folder' => false,
                'action_edit_file' => false,
                'action_save_file' => false,
                'action_shutdown_bot' => false,
                'action_generate_diagnostics' => false,
                'action_invalidate_cache' => false,
                'action_force_release_lock' => false,
                'action_send_message' => false,
                'action_request_chat_data' => false,
                'action_view_ticket' => false,
                'action_download_ticket' => false,
                'action_delete_ticket' => false,
                'action_leave_guild' => false,
                'action_generate_invite' => false,
                'action_open_invite' => false,
                'action_copy_invite' => false,
                'action_fetch_marketplace' => false,
                'action_download_extension' => false,
                'action_load_marketplace_extension' => false,
                'action_refresh_zygnalid' => false,
                'action_refresh_marketplace' => false,
                'action_save_role' => false,
                'action_delete_role' => false,
                'action_create_role' => false,
                'action_add_user' => false,
                'action_remove_user' => false,
                'action_change_user_role' => false,
                'action_view_logs' => false,
                'action_export_logs' => false,
                'action_execute_query' => false,
                'action_db_create' => false,
                'action_db_read' => false,
                'action_db_update' => false,
                'action_db_delete' => false,
            ];
    }
}

/**
 * Compute the effective permissions for a role name + tier, merging
 * dashboard_roles.permissions_json (if any) over the tier defaults.
 */
function lm_role_permissions(string $roleName, string $tier): array {
    $perms = lm_default_permissions_for_tier($tier);
    
    // CRITICAL: For OWNER role, ALWAYS return tier defaults, never check database
    // This ensures OWNER always has ALL permissions including new ones
    $upper = strtoupper($roleName);
    if ($upper === 'OWNER') {
        // AUTOMATIC FIX: Delete any OWNER entry from database right now
        // This runs every time OWNER logs in, ensuring the fix happens automatically
        try {
            $pdo = lm_db();
            $pdo->exec("DELETE FROM dashboard_roles WHERE UPPER(name) = 'OWNER'");
        } catch (Throwable $e) {
            // Ignore errors, permissions will still work from code
        }
        return $perms;
    }
    
    // For CUSTOM base roles, just return tier defaults
    if ($upper === 'CUSTOM') {
        return $perms;
    }
    
    // For custom role names (not OWNER or CUSTOM), merge database permissions
    try {
        $pdo = lm_db();
        $stmt = $pdo->prepare('SELECT permissions_json FROM dashboard_roles WHERE UPPER(name) = UPPER(:name) LIMIT 1');
        $stmt->execute([':name' => $roleName]);
        $row = $stmt->fetch();
        if ($row && !empty($row['permissions_json'])) {
            $decoded = json_decode($row['permissions_json'], true);
            if (is_array($decoded)) {
                foreach ($decoded as $k => $v) {
                    $perms[$k] = (bool)$v;
                }
            }
        }
    } catch (Throwable $e) {
        // Ignore DB errors
    }
    return $perms;
}

function lm_render_error_page(int $code, string $title, string $message, string $iconType = 'default'): void {
    http_response_code($code);
    
    // Choose icon HTML based on type
    $iconHTML = '';
    if ($iconType === 'lock') {
        $iconHTML = '<div class="lock-icon"><div class="lock-shackle"></div><div class="lock-body"><div class="keyhole"></div></div></div>';
    } elseif ($iconType === 'forbidden') {
        $iconHTML = '<div class="forbidden-icon"><div class="forbidden-circle"></div><div class="forbidden-slash"></div></div>';
    } elseif ($iconType === 'error') {
        $iconHTML = '<div class="error-icon"><div class="error-bar"></div><div class="error-dot"></div></div>';
    } elseif ($iconType === 'ticket') {
        $iconHTML = '<div class="ticket-icon"><div class="ticket-body"><div class="ticket-cutout-left"></div><div class="ticket-cutout-right"></div><div class="ticket-line"></div></div></div>';
    } elseif ($iconType === 'loading') {
        $iconHTML = '<div class="loading-icon"><div class="spinner"></div></div>';
    } else {
        $iconHTML = '<div class="error-icon"><div class="error-bar"></div><div class="error-dot"></div></div>';
    }
    
    ?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><?php echo $code; ?> - <?php echo htmlspecialchars($title); ?></title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: #0a0a0f;
      color: #fff;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      position: relative;
    }

    .branding {
      position: absolute;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 18px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }

    .branding-logo {
      width: 32px;
      height: 32px;
      filter: drop-shadow(0 2px 8px rgba(102, 126, 234, 0.6));
    }

    .background {
      position: absolute;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.6;
      animation: float 20s infinite ease-in-out;
    }

    .orb1 {
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, #ff006e, #8338ec);
      top: -200px;
      left: -100px;
      animation-delay: 0s;
    }

    .orb2 {
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, #3a86ff, #06ffa5);
      bottom: -150px;
      right: -100px;
      animation-delay: -10s;
    }

    .orb3 {
      width: 350px;
      height: 350px;
      background: radial-gradient(circle, #fb5607, #ffbe0b);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation-delay: -5s;
    }

    @keyframes float {
      0%, 100% {
        transform: translate(0, 0) scale(1);
      }
      33% {
        transform: translate(100px, -50px) scale(1.1);
      }
      66% {
        transform: translate(-50px, 100px) scale(0.9);
      }
    }

    .container {
      position: relative;
      z-index: 10;
      text-align: center;
      max-width: 600px;
      padding: 40px;
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border-radius: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: slideIn 0.8s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .lock-icon, .forbidden-icon, .error-icon, .ticket-icon, .loading-icon {
      width: 120px;
      height: 120px;
      margin: 0 auto 30px;
      position: relative;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    .lock-body {
      width: 80px;
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
    }

    .lock-shackle {
      width: 50px;
      height: 50px;
      border: 8px solid #667eea;
      border-bottom: none;
      border-radius: 50px 50px 0 0;
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
    }

    .keyhole {
      width: 8px;
      height: 20px;
      background: rgba(10, 10, 15, 0.8);
      border-radius: 50% 50% 0 0;
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
    }

    .keyhole::after {
      content: '';
      width: 16px;
      height: 16px;
      background: rgba(10, 10, 15, 0.8);
      border-radius: 50%;
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
    }

    .forbidden-circle {
      width: 100px;
      height: 100px;
      border: 8px solid #667eea;
      border-radius: 50%;
      position: absolute;
      top: 10px;
      left: 10px;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
    }

    .forbidden-slash {
      width: 120px;
      height: 8px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      position: absolute;
      top: 56px;
      left: 0;
      transform: rotate(-45deg);
      border-radius: 4px;
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
    }

    .error-bar {
      width: 12px;
      height: 70px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 6px;
      position: absolute;
      top: 15px;
      left: 54px;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
    }

    .error-dot {
      width: 16px;
      height: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      position: absolute;
      bottom: 15px;
      left: 52px;
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
    }

    .ticket-body {
      width: 100px;
      height: 70px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      position: absolute;
      top: 25px;
      left: 10px;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
    }

    .ticket-cutout-left, .ticket-cutout-right {
      width: 24px;
      height: 24px;
      background: #0a0a0f;
      border-radius: 50%;
      position: absolute;
      top: 23px;
    }

    .ticket-cutout-left {
      left: -12px;
    }

    .ticket-cutout-right {
      right: -12px;
    }

    .ticket-line {
      width: 3px;
      height: 50px;
      background: rgba(10, 10, 15, 0.3);
      position: absolute;
      left: 48px;
      top: 10px;
    }

    .spinner {
      width: 90px;
      height: 90px;
      border: 8px solid rgba(102, 126, 234, 0.2);
      border-top: 8px solid #667eea;
      border-radius: 50%;
      position: absolute;
      top: 15px;
      left: 15px;
      animation: spin 1s linear infinite;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    h1 {
      font-size: 120px;
      font-weight: 700;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      animation: glow 2s ease-in-out infinite;
    }

    @keyframes glow {
      0%, 100% {
        filter: brightness(1);
      }
      50% {
        filter: brightness(1.2);
      }
    }

    h2 {
      font-size: 32px;
      font-weight: 600;
      margin: 20px 0 15px;
      color: #fff;
    }

    p {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.7);
      line-height: 1.6;
      margin-bottom: 30px;
    }

    .buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 14px 32px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.3s ease;
      font-family: 'Space Grotesk', sans-serif;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }

    @media (max-width: 768px) {
      .branding {
        top: 20px;
        font-size: 16px;
      }

      .branding-logo {
        width: 28px;
        height: 28px;
      }

      .container {
        padding: 30px 20px;
        margin: 20px;
      }

      h1 {
        font-size: 80px;
      }

      h2 {
        font-size: 24px;
      }

      p {
        font-size: 16px;
      }

      .lock-icon, .forbidden-icon, .error-icon, .ticket-icon, .loading-icon {
        width: 100px;
        height: 100px;
      }

      .lock-body {
        width: 70px;
        height: 50px;
      }

      .lock-shackle {
        width: 40px;
        height: 40px;
      }
    }
  </style>
</head>
<body>
  <div class="branding">
    <svg class="branding-logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" fill="url(#grad)" stroke="url(#grad2)" stroke-width="1"/>
      <defs>
        <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
        </linearGradient>
        <linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#f093fb;stop-opacity:1" />
        </linearGradient>
      </defs>
    </svg>
    <span>Zoryx Discord Bot Framework</span>
  </div>

  <div class="background">
    <div class="orb orb1"></div>
    <div class="orb orb2"></div>
    <div class="orb orb3"></div>
  </div>

  <div class="container">
    <?php echo $iconHTML; ?>
    
    <h1><?php echo $code; ?></h1>
    <h2><?php echo htmlspecialchars($title); ?></h2>
    <p><?php echo htmlspecialchars($message); ?></p>
    
    <div class="buttons">
      <a href="index.php" class="btn btn-primary">â† Back to Dashboard</a>
      <?php if ($code === 403 || $code === 401): ?>
        <a href="login.php" class="btn btn-secondary">Login</a>
      <?php endif; ?>
    </div>
  </div>
</body>
</html>
<?php
    exit;
}

?>
'''
        if plugins:
            plugin_perms_php = self._generate_plugin_owner_permissions_php(plugins)
            base_php = base_php.replace('/* DASHBOARD_PLUGINS_OWNER_PERMISSIONS_PLACEHOLDER */', plugin_perms_php)
        else:
            base_php = base_php.replace('/* DASHBOARD_PLUGINS_OWNER_PERMISSIONS_PLACEHOLDER */', '')
        
        return base_php

    def _generate_setup_php(self) -> str:
        """One-time setup wizard page (Discord OAuth config + claim link)."""
        return '''<?php
require_once __DIR__ . '/lm_auth.php';

lm_start_session_if_needed();
lm_ensure_schema();
$pdo = lm_db();
$config = lm_get_config();

if (!empty($config['setup_completed'])) {
    header('Location: index.php');
    exit;
}

$requiredToken = $config['setup_token'] ?? (defined('LM_SETUP_TOKEN') ? LM_SETUP_TOKEN : null);
$providedToken = $_GET['setup_token'] ?? '';
if (!$requiredToken || !$providedToken || !hash_equals($requiredToken, $providedToken)) {
    http_response_code(403);
    echo '<h1>Invalid setup link</h1><p>Please re-run /livemonitor quickstart to generate a fresh setup URL.</p>';
    exit;
}

$message = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $clientId = trim($_POST['discord_client_id'] ?? '');
    $clientSecret = trim($_POST['discord_client_secret'] ?? '');

    if ($clientId && $clientSecret) {
        $config['discord_client_id'] = $clientId;
        $config['discord_client_secret'] = $clientSecret;

        // Compute and persist the redirect URL for convenience
        $scheme = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') ? 'https' : 'http';
        $host = $_SERVER['HTTP_HOST'] ?? 'localhost';
        $basePath = rtrim(dirname($_SERVER['SCRIPT_NAME'] ?? ''), '/');
        $redirectUrl = sprintf('%s://%s%s/oauth_callback.php', $scheme, $host, $basePath);
        $config['oauth_redirect_url'] = $redirectUrl;

        lm_save_config($config);
        lm_log_audit('OAUTH_CONFIG_UPDATED', 'SETTING', 'discord_oauth', []);
        $message = 'Saved! You can now click "Connect with Discord" below to claim the dashboard.';
    } else {
        $message = 'Please fill both Client ID and Client Secret.';
    }

    $config = lm_get_config();
}

$scheme = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') ? 'https' : 'http';
$host = $_SERVER['HTTP_HOST'] ?? 'localhost';
$basePath = rtrim(dirname($_SERVER['SCRIPT_NAME'] ?? ''), '/');
$redirectUrl = $config['oauth_redirect_url'] ?? sprintf('%s://%s%s/oauth_callback.php', $scheme, $host, $basePath);

?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Monitor â€“ Setup</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #020617;
            color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 16px;
        }
        .card {
            max-width: 720px;
            width: 100%;
            background: #020617;
            border-radius: 16px;
            padding: 24px 24px 20px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            box-shadow: 0 24px 80px rgba(15, 23, 42, 0.9);
        }
        h1 {
            margin-top: 0;
            margin-bottom: 4px;
            font-size: 22px;
        }
        p {
            margin: 4px 0;
            color: #9ca3af;
            font-size: 14px;
        }
        label {
            display: block;
            margin-top: 12px;
            margin-bottom: 4px;
            font-size: 13px;
        }
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            background: #020617;
            color: #e5e7eb;
            font-size: 13px;
        }
        input[type="text"]:focus, input[type="password"]:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 1px;
        }
        .hint {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }
        .redirect-box {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid rgba(55, 65, 81, 0.9);
            background: #020617;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
            font-size: 12px;
            margin-top: 4px;
            word-break: break-all;
        }
        .actions {
            margin-top: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        button {
            border-radius: 8px;
            border: none;
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-secondary {
            background: #111827;
            color: #e5e7eb;
            border: 1px solid rgba(75, 85, 99, 0.8);
        }
        .message {
            margin-top: 10px;
            font-size: 13px;
            color: #f97316;
        }
        .steps {
            margin-top: 12px;
            padding-left: 18px;
            font-size: 13px;
            color: #9ca3af;
        }
        .steps li {
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
<div class="card">
    <h1>Live Monitor â€“ One-time Setup</h1>
    <p>This page is only for the bot owner. Configure Discord OAuth once, then claim the dashboard.</p>

    <h3 style="margin-top:16px;margin-bottom:4px;font-size:14px;">1. Configure Discord Application</h3>
    <ol class="steps">
        <li>Open the <strong>Discord Developer Portal</strong> and select your bot's application.</li>
        <li>Go to <strong>OAuth2 â†’ General</strong> and add this Redirect URL:</li>
    </ol>
    <div class="redirect-box"><?php echo htmlspecialchars($redirectUrl, ENT_QUOTES, 'UTF-8'); ?></div>
    <p class="hint">Make sure this exact URL is listed under OAuth2 Redirects, then save changes.</p>

    <form method="post" style="margin-top:12px;">
        <h3 style="margin:8px 0;font-size:14px;">2. Enter Discord OAuth Credentials</h3>
        <label for="discord_client_id">Client ID</label>
        <input type="text" id="discord_client_id" name="discord_client_id" value="<?php echo htmlspecialchars($config['discord_client_id'] ?? '', ENT_QUOTES, 'UTF-8'); ?>" required>

        <label for="discord_client_secret">Client Secret</label>
        <input type="password" id="discord_client_secret" name="discord_client_secret" value="<?php echo htmlspecialchars($config['discord_client_secret'] ?? '', ENT_QUOTES, 'UTF-8'); ?>" required>

        <div class="actions">
            <button type="submit" class="btn-secondary">Save OAuth Settings</button>
            <a href="login.php" class="btn-primary" style="text-decoration:none;display:inline-flex;align-items:center;gap:6px;">
                <span>Connect with Discord</span>
            </a>
        </div>
    </form>

    <?php if (!empty($message)): ?>
        <div class="message"><?php echo htmlspecialchars($message, ENT_QUOTES, 'UTF-8'); ?></div>
    <?php endif; ?>

    <p style="margin-top:16px;font-size:12px;color:#6b7280;">
        After you log in with Discord successfully, the dashboard will switch into safe mode and require login for every visit.
    </p>
</div>
</body>
</html>
'''

    def _generate_login_php(self) -> str:
        """Branded login page with Discord OAuth entry point."""
        return '''<?php
require_once __DIR__ . '/lm_auth.php';

lm_start_session_if_needed();
lm_ensure_schema();
$config = lm_get_config();

// If already logged in, go straight to dashboard
if (lm_current_user()) {
    header('Location: index.php');
    exit;
}

$clientId = $config['discord_client_id'] ?? '';
$clientSecret = $config['discord_client_secret'] ?? '';
$oauthConfigured = $clientId && $clientSecret;

$scheme = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') ? 'https' : 'http';
$host = $_SERVER['HTTP_HOST'] ?? 'localhost';
$basePath = rtrim(dirname($_SERVER['SCRIPT_NAME'] ?? ''), '/');
$redirectUrl = $config['oauth_redirect_url'] ?? sprintf('%s://%s%s/oauth_callback.php', $scheme, $host, $basePath);

// If the owner hit the "Login with Discord" button, start the OAuth flow
if (isset($_GET['action']) && $_GET['action'] === 'start_oauth') {
    if (!$oauthConfigured) {
        echo '<h1>OAuth not configured</h1><p>Please complete the setup form first.</p>';
        exit;
    }

    $state = bin2hex(random_bytes(16));
    $_SESSION['lm_oauth_state'] = $state;
    $_SESSION['log_ip_preference'] = $_GET['log_ip'] ?? '1';

    $params = [
        'client_id' => $clientId,
        'redirect_uri' => $redirectUrl,
        'response_type' => 'code',
        'scope' => 'identify',
        'state' => $state,
        'prompt' => 'consent',
    ];

    $query = http_build_query($params);
    $authUrl = 'https://discord.com/api/oauth2/authorize?' . $query;

    header('Location: ' . $authUrl);
    exit;
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Monitor â€“ Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Space Grotesk', system-ui, -apple-system, sans-serif;
            background: #020617;
            color: #e5e7eb;
            overflow: hidden;
            position: relative;
        }
        
        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
        }
        
        .bg-gradient {
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(124, 58, 237, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(168, 85, 247, 0.08) 0%, transparent 70%);
        }
        
        /* Floating Orbs */
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            animation: float 20s infinite ease-in-out;
        }
        
        .orb-1 {
            width: 600px;
            height: 600px;
            background: rgba(124, 58, 237, 0.3);
            top: -200px;
            left: -200px;
            animation-delay: 0s;
        }
        
        .orb-2 {
            width: 500px;
            height: 500px;
            background: rgba(59, 130, 246, 0.25);
            bottom: -150px;
            right: -150px;
            animation-delay: -5s;
            animation-duration: 25s;
        }
        
        .orb-3 {
            width: 400px;
            height: 400px;
            background: rgba(236, 72, 153, 0.2);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation-delay: -10s;
            animation-duration: 30s;
        }
        
        .orb-4 {
            width: 300px;
            height: 300px;
            background: rgba(34, 211, 238, 0.2);
            top: 20%;
            right: 10%;
            animation-delay: -7s;
            animation-duration: 22s;
        }
        
        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            25% {
                transform: translate(50px, -50px) scale(1.1);
            }
            50% {
                transform: translate(-30px, 30px) scale(0.95);
            }
            75% {
                transform: translate(40px, 40px) scale(1.05);
            }
        }
        
        /* Grid Pattern */
        .grid-pattern {
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            background-image: 
                linear-gradient(rgba(148, 163, 184, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(148, 163, 184, 0.03) 1px, transparent 1px);
            background-size: 60px 60px;
            animation: gridMove 30s linear infinite;
        }
        
        @keyframes gridMove {
            0% {
                transform: translate(0, 0) rotate(0deg);
            }
            100% {
                transform: translate(60px, 60px) rotate(1deg);
            }
        }
        
        /* Floating Particles */
        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(168, 85, 247, 0.6);
            border-radius: 50%;
            animation: particleFloat 15s infinite ease-in-out;
        }
        
        .particle:nth-child(1) { left: 10%; top: 20%; animation-delay: 0s; }
        .particle:nth-child(2) { left: 20%; top: 80%; animation-delay: -2s; }
        .particle:nth-child(3) { left: 30%; top: 40%; animation-delay: -4s; }
        .particle:nth-child(4) { left: 40%; top: 60%; animation-delay: -6s; }
        .particle:nth-child(5) { left: 50%; top: 30%; animation-delay: -8s; }
        .particle:nth-child(6) { left: 60%; top: 70%; animation-delay: -10s; }
        .particle:nth-child(7) { left: 70%; top: 50%; animation-delay: -12s; }
        .particle:nth-child(8) { left: 80%; top: 20%; animation-delay: -14s; }
        .particle:nth-child(9) { left: 90%; top: 90%; animation-delay: -1s; }
        .particle:nth-child(10) { left: 15%; top: 55%; animation-delay: -3s; }
        .particle:nth-child(11) { left: 85%; top: 45%; animation-delay: -5s; }
        .particle:nth-child(12) { left: 45%; top: 85%; animation-delay: -7s; }
        
        @keyframes particleFloat {
            0%, 100% {
                transform: translateY(0) scale(1);
                opacity: 0.6;
            }
            50% {
                transform: translateY(-100px) scale(1.5);
                opacity: 1;
            }
        }
        
        /* Scan Lines */
        .scanlines {
            position: absolute;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.03) 2px,
                rgba(0, 0, 0, 0.03) 4px
            );
            pointer-events: none;
        }
        
        /* Login Card */
        .login-shell {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 920px;
            margin: 16px;
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            overflow: hidden;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            box-shadow: 
                0 0 0 1px rgba(255, 255, 255, 0.05) inset,
                0 25px 50px -12px rgba(0, 0, 0, 0.5),
                0 0 100px rgba(124, 58, 237, 0.1);
            display: grid;
            grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.1fr);
            animation: cardAppear 0.8s ease-out;
        }
        
        @keyframes cardAppear {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .login-visual {
            position: relative;
            background: 
                radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.15), transparent 60%),
                radial-gradient(circle at 100% 100%, rgba(250, 204, 21, 0.15), transparent 60%);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 24px;
        }
        
        .login-visual-inner {
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, 0.3);
            background: rgba(2, 6, 23, 0.8);
            animation: visualSlide 0.8s ease-out 0.2s both;
        }
        
        @keyframes visualSlide {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .login-banner {
            width: 100%;
            height: 160px;
            object-fit: cover;
            display: block;
        }
        
        .login-visual-footer {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .login-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .login-brand img {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .login-brand-title {
            font-size: 14px;
            font-weight: 600;
            background: linear-gradient(135deg, #e5e7eb, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .login-brand-subtitle {
            font-size: 11px;
            color: #94a3b8;
        }
        
        .login-pill {
            font-size: 10px;
            padding: 5px 12px;
            border-radius: 999px;
            border: 1px solid rgba(124, 58, 237, 0.5);
            background: rgba(124, 58, 237, 0.1);
            color: #c4b5fd;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .login-main {
            padding: 28px 28px 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            animation: contentFade 0.8s ease-out 0.3s both;
        }
        
        @keyframes contentFade {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .login-title {
            font-size: 26px;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .login-subtitle {
            font-size: 13px;
            color: #94a3b8;
            margin-top: 6px;
            line-height: 1.6;
        }
        
        .login-list {
            margin: 12px 0 0;
            padding-left: 0;
            list-style: none;
            font-size: 13px;
            color: #94a3b8;
        }
        
        .login-list li {
            padding: 8px 0 8px 24px;
            position: relative;
            border-left: 2px solid rgba(124, 58, 237, 0.3);
            margin-left: 8px;
        }
        
        .login-list li::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            border-radius: 50%;
        }
        
        .login-list li strong {
            color: #e5e7eb;
        }
        
        .login-section-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #64748b;
            margin-top: 8px;
            margin-bottom: 6px;
            font-weight: 600;
        }
        
        .login-callout {
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            background: rgba(59, 130, 246, 0.05);
            font-size: 12px;
            color: #cbd5e1;
            line-height: 1.6;
        }
        
        .login-callout code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            color: #93c5fd;
        }
        
        .privacy-toggle {
            appearance: none;
            width: 40px;
            height: 22px;
            background: rgba(148, 163, 184, 0.3);
            border-radius: 999px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .privacy-toggle::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            top: 3px;
            left: 3px;
            transition: all 0.2s ease-in-out;
        }
        .privacy-toggle:checked {
            background: #5865F2;
        }
        .privacy-toggle:checked::before {
            transform: translateX(18px);
        }
        .login-button-row {
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .btn-discord {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #5865F2, #7c3aed);
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            box-shadow: 
                0 4px 15px rgba(88, 101, 242, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-discord::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .btn-discord:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 25px rgba(88, 101, 242, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.15) inset;
        }
        
        .btn-discord:hover::before {
            left: 100%;
        }
        
        .btn-discord svg {
            width: 20px;
            height: 20px;
        }
        
        .btn-secondary {
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            background: rgba(15, 23, 42, 0.5);
            color: #94a3b8;
            padding: 10px 18px;
            font-size: 12px;
            cursor: not-allowed;
        }
        
        .login-footer {
            margin-top: auto;
            font-size: 11px;
            color: #475569;
            padding-top: 12px;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .login-footer a {
            color: #818cf8;
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .login-footer a:hover {
            color: #a5b4fc;
        }
        
        @media (max-width: 860px) {
            .login-shell {
                grid-template-columns: minmax(0, 1fr);
                max-width: 440px;
            }
            .login-visual {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="bg-animation">
        <div class="bg-gradient"></div>
        <div class="grid-pattern"></div>
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
        <div class="orb orb-4"></div>
        <div class="particles">
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
        </div>
        <div class="scanlines"></div>
    </div>
    
    <div class="login-shell">
        <div class="login-visual">
            <div class="login-visual-inner">
                <img src="assets/banner.png" alt="Zoryx Framework" class="login-banner">
                <div class="login-visual-footer">
                    <div class="login-brand">
                        <img src="assets/zoryx-framework.png" alt="Zoryx Icon">
                        <div>
                            <div class="login-brand-title">Zoryx Discord Bot Framework</div>
                            <div class="login-brand-subtitle">Live Monitor Dashboard</div>
                        </div>
                    </div>
                    <div class="login-pill">Self-hosted</div>
                </div>
            </div>
        </div>
        <div class="login-main">
            <div>
                <div class="login-title">Login with Discord</div>
                <div class="login-subtitle">
                    Authenticate with your Discord account to access the Live Monitor dashboard.
                </div>
                <ul class="login-list">
                    <li><strong>Whitelist-based access</strong>: Only users added to the dashboard can log in.</li>
                    <li><strong>Role-based permissions</strong>: Your assigned role determines what you can view and control.</li>
                    <li><strong>First login</strong>: The first person to log in becomes the dashboard owner with full access.</li>
                </ul>
            </div>

            <div>
                <div class="login-section-label">Authentication</div>
                <div class="login-callout">
                    This dashboard uses Discord OAuth2 with the <code>identify</code> scope only. Your Discord ID and name are stored
                    in the local <code>dashboard.sqlite</code> database for access control and audit logging.
                </div>
                <div>
                <div class="login-section-label">Privacy Notice</div>
                <div class="login-callout" style="font-size: 11px; line-height: 1.5;">
                    After you login, your IP address may be logged in our database. The owner of this framework, TheHolyOneZ, does NOT have access to it or can see it. It will be logged in the database of the user who owns this bot right now! So be aware that when you login, the owner would be able to see your IP address inside the audit logs. If you want this to NOT happen, please toggle this switch off.
                </div>
                <div style="margin-top: 12px; display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <label for="log-ip-toggle" style="font-size: 13px; color: #cbd5e1; cursor: pointer; margin: 0;">Allow IP Address Logging</label>
                    <input type="checkbox" id="log-ip-toggle" class="privacy-toggle" checked>
                </div>
            </div>

            <div class="login-button-row">
                <div class="login-button-row">
                    <?php if ($oauthConfigured): ?>
                        <a href="?action=start_oauth" class="btn-discord">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
                            <span>Login with Discord</span>
                        </a>
                    <?php else: ?>
                        <button class="btn-secondary" disabled>OAuth not configured â€“ run /livemonitor quickstart</button>
                    <?php endif; ?>
                </div>
            </div>

            <div class="login-footer">
                Zoryx Discord Bot Framework Â· Live Monitor. Configure OAuth once via the one-time setup URL, then return here to log in.
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const toggle = document.getElementById('log-ip-toggle');
            const link = document.querySelector('a.btn-discord');
            if (toggle && link) {
                const updateLink = () => {
                    const url = new URL(link.href, window.location.origin);
                    url.searchParams.set('log_ip', toggle.checked ? '1' : '0');
                    link.href = url.toString();
                };
                toggle.addEventListener('change', updateLink);
                // Set initial state
                updateLink();
            }
        });
    </script>
</body>
</html>
'''

    def _generate_oauth_callback_php(self) -> str:
        """Handle Discord OAuth2 callback, claim dashboard, and create sessions."""
        return '''<?php
require_once __DIR__ . '/lm_auth.php';

lm_start_session_if_needed();
lm_ensure_schema();
$pdo = lm_db();
$config = lm_get_config();

if (!isset($_GET['state']) || !isset($_SESSION['lm_oauth_state']) || !hash_equals($_SESSION['lm_oauth_state'], $_GET['state'])) {
    http_response_code(400);
    echo '<h1>Invalid OAuth state</h1><p>Please try logging in again.</p>';
    exit;
}
unset($_SESSION['lm_oauth_state']);

if (isset($_GET['error'])) {
    lm_log_audit('LOGIN_FAILED', 'OAUTH', null, ['error' => $_GET['error']]);
    echo '<h1>Discord Login Failed</h1><p>' . htmlspecialchars($_GET['error'], ENT_QUOTES, 'UTF-8') . '</p>';
    exit;
}

$code = $_GET['code'] ?? null;
if (!$code) {
    http_response_code(400);
    echo '<h1>Missing code</h1><p>Discord did not return an authorization code.</p>';
    exit;
}

$clientId = $config['discord_client_id'] ?? '';
$clientSecret = $config['discord_client_secret'] ?? '';
if (!$clientId || !$clientSecret) {
    echo '<h1>OAuth not configured</h1><p>Please complete the setup form first.</p>';
    exit;
}

$scheme = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') ? 'https' : 'http';
$host = $_SERVER['HTTP_HOST'] ?? 'localhost';
$basePath = rtrim(dirname($_SERVER['SCRIPT_NAME'] ?? ''), '/');
$redirectUrl = $config['oauth_redirect_url'] ?? sprintf('%s://%s%s/oauth_callback.php', $scheme, $host, $basePath);

$tokenResponse = null;

// Exchange code for access token
$ch = curl_init('https://discord.com/api/oauth2/token');
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_HTTPHEADER, [
    'Content-Type: application/x-www-form-urlencoded',
]);
curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query([
    'client_id' => $clientId,
    'client_secret' => $clientSecret,
    'grant_type' => 'authorization_code',
    'code' => $code,
    'redirect_uri' => $redirectUrl,
]));

$result = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

if ($result === false) {
    lm_log_audit('LOGIN_FAILED', 'OAUTH', null, ['error' => 'curl_error']);
    echo '<h1>OAuth Error</h1><p>Failed to contact Discord.</p>';
    exit;
}

$tokenResponse = json_decode($result, true);
if (!is_array($tokenResponse) || empty($tokenResponse['access_token'])) {
    lm_log_audit('LOGIN_FAILED', 'OAUTH', null, ['error' => 'no_access_token', 'http_code' => $httpCode, 'response' => $result]);
    echo '<h1>OAuth Error</h1><p>Discord did not return an access token. HTTP Code: ' . $httpCode . '</p><pre>' . htmlspecialchars($result) . '</pre>';
    exit;
}

$accessToken = $tokenResponse['access_token'];

// Fetch Discord user profile
$ch = curl_init('https://discord.com/api/users/@me');
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_HTTPHEADER, [
    'Authorization: Bearer ' . $accessToken,
]);
$userResult = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

if ($userResult === false) {
    lm_log_audit('LOGIN_FAILED', 'PROFILE', null, ['error' => 'profile_fetch_failed']);
    echo '<h1>OAuth Error</h1><p>Failed to fetch user profile from Discord.</p>';
    exit;
}

$user = json_decode($userResult, true);
if (!is_array($user) || empty($user['id'])) {
    lm_log_audit('LOGIN_FAILED', 'PROFILE', null, ['error' => 'invalid_profile', 'http_code' => $httpCode, 'response' => $userResult]);
    echo '<h1>OAuth Error</h1><p>Discord did not return a valid user. HTTP Code: ' . $httpCode . '</p><pre>' . htmlspecialchars($userResult) . '</pre>';
    exit;
}

$discordId = $user['id'];
$displayName = $user['global_name'] ?? ($user['username'] ?? 'unknown');
$avatarUrl = null;
if (!empty($user['avatar'])) {
    $avatarUrl = sprintf('https://cdn.discordapp.com/avatars/%s/%s.png', $discordId, $user['avatar']);
}

$pdo->beginTransaction();
try {
    $config = lm_get_config();

    // First claim: no owner yet
    if (empty($config['setup_completed']) || empty($config['owner_discord_id'])) {
        $config['owner_discord_id'] = $discordId;
        $config['setup_completed'] = 1;
        $config['setup_token'] = null;
        lm_save_config($config);

        $log_ip = ($_SESSION['log_ip_preference'] ?? '1') === '1' ? 1 : 0;
        unset($_SESSION['log_ip_preference']);

        $stmt = $pdo->prepare('INSERT INTO dashboard_users (discord_user_id, display_name, avatar_url, role, log_ip) VALUES (:did, :name, :avatar, :role, :log_ip)');
        $stmt->execute([
            ':did' => $discordId,
            ':name' => $displayName,
            ':avatar' => $avatarUrl,
            ':role' => 'OWNER',
            ':log_ip' => $log_ip,
        ]);

        $userId = (int)$pdo->lastInsertId();
        $_SESSION['lm_user_id'] = $userId;
        $_SESSION['log_ip'] = (bool)$log_ip;
        lm_log_audit('DASHBOARD_CLAIMED', 'USER', $discordId, []);
        lm_log_audit('LOGIN_SUCCESS', 'USER', $discordId, ['role' => 'OWNER']);
    } else {
        // Existing dashboard: only allow registered users
        $stmt = $pdo->prepare('SELECT * FROM dashboard_users WHERE discord_user_id = :did LIMIT 1');
        $stmt->execute([':did' => $discordId]);
        $existing = $stmt->fetch();
        if (!$existing) {
            $pdo->commit();
            lm_log_audit('LOGIN_DENIED', 'USER', $discordId, []);
            http_response_code(403);
            
            // Beautiful Access Denied page
            $safeDisplayName = htmlspecialchars($displayName, ENT_QUOTES, 'UTF-8');
            $safeAvatarUrl = $avatarUrl ? htmlspecialchars($avatarUrl, ENT_QUOTES, 'UTF-8') : '';
            $defaultAvatar = 'data:image/svg+xml;base64,' . base64_encode('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="#374151" width="100" height="100"/><text x="50" y="60" font-size="40" text-anchor="middle" fill="#9ca3af">?</text></svg>');
            $avatarSrc = $safeAvatarUrl ?: $defaultAvatar;
            
            echo <<<HTML
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Access Denied â€“ Live Monitor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Space Grotesk', system-ui, -apple-system, sans-serif;
            background: #020617;
            color: #e5e7eb;
            overflow: hidden;
            position: relative;
        }
        
        /* Animated Background - Red/Orange Theme for Denied */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
        }
        
        .bg-gradient {
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(239, 68, 68, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(249, 115, 22, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(220, 38, 38, 0.06) 0%, transparent 70%);
        }
        
        /* Floating Orbs - Warning Colors */
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            animation: float 20s infinite ease-in-out;
        }
        
        .orb-1 {
            width: 500px;
            height: 500px;
            background: rgba(239, 68, 68, 0.25);
            top: -150px;
            left: -150px;
            animation-delay: 0s;
        }
        
        .orb-2 {
            width: 400px;
            height: 400px;
            background: rgba(249, 115, 22, 0.2);
            bottom: -100px;
            right: -100px;
            animation-delay: -5s;
            animation-duration: 25s;
        }
        
        .orb-3 {
            width: 350px;
            height: 350px;
            background: rgba(251, 146, 60, 0.15);
            top: 60%;
            left: 20%;
            animation-delay: -10s;
            animation-duration: 30s;
        }
        
        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            25% {
                transform: translate(40px, -40px) scale(1.1);
            }
            50% {
                transform: translate(-30px, 30px) scale(0.95);
            }
            75% {
                transform: translate(35px, 35px) scale(1.05);
            }
        }
        
        /* Glitch Grid */
        .grid-pattern {
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            background-image: 
                linear-gradient(rgba(239, 68, 68, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(239, 68, 68, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridPulse 4s ease-in-out infinite;
        }
        
        @keyframes gridPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        /* Warning Particles */
        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: rgba(239, 68, 68, 0.5);
            border-radius: 50%;
            animation: particleFall 10s infinite linear;
        }
        
        .particle:nth-child(1) { left: 5%; animation-delay: 0s; }
        .particle:nth-child(2) { left: 15%; animation-delay: -1s; }
        .particle:nth-child(3) { left: 25%; animation-delay: -2s; }
        .particle:nth-child(4) { left: 35%; animation-delay: -3s; }
        .particle:nth-child(5) { left: 45%; animation-delay: -4s; }
        .particle:nth-child(6) { left: 55%; animation-delay: -5s; }
        .particle:nth-child(7) { left: 65%; animation-delay: -6s; }
        .particle:nth-child(8) { left: 75%; animation-delay: -7s; }
        .particle:nth-child(9) { left: 85%; animation-delay: -8s; }
        .particle:nth-child(10) { left: 95%; animation-delay: -9s; }
        
        @keyframes particleFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            90% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
        
        /* Scan Lines */
        .scanlines {
            position: absolute;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.03) 2px,
                rgba(0, 0, 0, 0.03) 4px
            );
            pointer-events: none;
            animation: scanlineMove 8s linear infinite;
        }
        
        @keyframes scanlineMove {
            0% { transform: translateY(0); }
            100% { transform: translateY(4px); }
        }
        
        /* Main Card */
        .denied-card {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 480px;
            margin: 16px;
            border-radius: 24px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            overflow: hidden;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            box-shadow: 
                0 0 0 1px rgba(255, 255, 255, 0.03) inset,
                0 25px 50px -12px rgba(0, 0, 0, 0.5),
                0 0 80px rgba(239, 68, 68, 0.15);
            animation: cardShake 0.6s ease-out, cardAppear 0.8s ease-out;
        }
        
        @keyframes cardShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        @keyframes cardAppear {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Warning Header Strip */
        .denied-header {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(249, 115, 22, 0.15));
            padding: 20px 24px;
            border-bottom: 1px solid rgba(239, 68, 68, 0.2);
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .denied-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #dc2626, #ea580c);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(220, 38, 38, 0.4);
            animation: iconPulse 2s ease-in-out infinite;
        }
        
        @keyframes iconPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 8px 20px rgba(220, 38, 38, 0.4);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 12px 30px rgba(220, 38, 38, 0.6);
            }
        }
        
        .denied-icon svg {
            width: 28px;
            height: 28px;
            color: white;
        }
        
        .denied-header-text h1 {
            font-size: 22px;
            font-weight: 700;
            color: #fca5a5;
            margin-bottom: 4px;
        }
        
        .denied-header-text p {
            font-size: 13px;
            color: #94a3b8;
        }
        
        /* User Info Section */
        .denied-user {
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .denied-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 3px solid rgba(239, 68, 68, 0.5);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
            animation: avatarGlow 3s ease-in-out infinite;
        }
        
        @keyframes avatarGlow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
            }
            50% { 
                box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
            }
        }
        
        .denied-user-info h2 {
            font-size: 18px;
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 4px;
        }
        
        .denied-user-info p {
            font-size: 12px;
            color: #64748b;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        /* Message Section */
        .denied-message {
            padding: 24px;
        }
        
        .denied-message h3 {
            font-size: 15px;
            font-weight: 600;
            color: #f87171;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .denied-message p {
            font-size: 14px;
            color: #94a3b8;
            line-height: 1.7;
            margin-bottom: 16px;
        }
        
        .denied-steps {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        
        .denied-steps h4 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #64748b;
            margin-bottom: 12px;
            font-weight: 600;
        }
        
        .denied-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.08);
        }
        
        .denied-step:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .denied-step-num {
            width: 24px;
            height: 24px;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: #60a5fa;
            flex-shrink: 0;
        }
        
        .denied-step-text {
            font-size: 13px;
            color: #cbd5e1;
            line-height: 1.5;
        }
        
        .denied-step-text code {
            background: rgba(124, 58, 237, 0.2);
            color: #c4b5fd;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }
        
        /* Footer Actions */
        .denied-footer {
            padding: 20px 24px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(148, 163, 184, 0.1);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: rgba(148, 163, 184, 0.1);
            color: #94a3b8;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(148, 163, 184, 0.2);
            color: #e5e7eb;
        }
        
        .btn svg {
            width: 16px;
            height: 16px;
        }
        
        /* Decorative Corner Elements */
        .corner {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 2px solid rgba(239, 68, 68, 0.2);
            pointer-events: none;
        }
        
        .corner-tl { top: 20px; left: 20px; border-right: none; border-bottom: none; border-radius: 12px 0 0 0; }
        .corner-tr { top: 20px; right: 20px; border-left: none; border-bottom: none; border-radius: 0 12px 0 0; }
        .corner-bl { bottom: 20px; left: 20px; border-right: none; border-top: none; border-radius: 0 0 0 12px; }
        .corner-br { bottom: 20px; right: 20px; border-left: none; border-top: none; border-radius: 0 0 12px 0; }
        
        @media (max-width: 520px) {
            .denied-card {
                margin: 12px;
                border-radius: 20px;
            }
            .denied-header {
                padding: 16px 20px;
            }
            .denied-user, .denied-message, .denied-footer {
                padding: 20px;
            }
            .denied-avatar {
                width: 52px;
                height: 52px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-animation">
        <div class="bg-gradient"></div>
        <div class="grid-pattern"></div>
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
        <div class="particles">
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
        </div>
        <div class="scanlines"></div>
        <div class="corner corner-tl"></div>
        <div class="corner corner-tr"></div>
        <div class="corner corner-bl"></div>
        <div class="corner corner-br"></div>
    </div>
    
    <div class="denied-card">
        <div class="denied-header">
            <div class="denied-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
                </svg>
            </div>
            <div class="denied-header-text">
                <h1>Access Denied</h1>
                <p>Your account is not on the whitelist</p>
            </div>
        </div>
        
        <div class="denied-user">
            <img src="{$avatarSrc}" alt="Avatar" class="denied-avatar">
            <div class="denied-user-info">
                <h2>{$safeDisplayName}</h2>
                <p>ID: {$discordId}</p>
            </div>
        </div>
        
        <div class="denied-message">
            <h3>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                Why am I seeing this?
            </h3>
            <p>
                Your Discord account has not been added to the dashboard whitelist yet. 
                Only users on the whitelist can access the Live Monitor dashboard.
            </p>
            
            <div class="denied-steps">
                <h4>How to get access</h4>
                <div class="denied-step">
                    <div class="denied-step-num">1</div>
                    <div class="denied-step-text">Contact someone with dashboard access and share your Discord ID shown above</div>
                </div>
                <div class="denied-step">
                    <div class="denied-step-num">2</div>
                    <div class="denied-step-text">Ask them to add you via <code>Roles & Access</code> (requires the <code>Add User</code> permission)</div>
                </div>
                <div class="denied-step">
                    <div class="denied-step-num">3</div>
                    <div class="denied-step-text">Once added, return here and log in again</div>
                </div>
            </div>
        </div>
        
        <div class="denied-footer">
            <a href="login.php" class="btn btn-primary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                Try Again
            </a>
            <button onclick="navigator.clipboard.writeText('{$discordId}');this.innerHTML='<svg width=16 height=16 viewBox=&quot;0 0 24 24&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;2&quot;><polyline points=&quot;20 6 9 17 4 12&quot;/></svg> Copied!';" class="btn btn-secondary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                Copy My ID
            </button>
        </div>
    </div>
</body>
</html>
HTML;
            exit;
        }

        // Update display name/avatar on every login for freshness
        $upd = $pdo->prepare('UPDATE dashboard_users SET display_name = :name, avatar_url = :avatar WHERE id = :id');
        $upd->execute([
            ':name' => $displayName,
            ':avatar' => $avatarUrl,
            ':id' => $existing['id'],
        ]);

        // If a preference was passed from the login form, update it in the DB
        if (isset($_SESSION['log_ip_preference'])) {
            $log_ip = ($_SESSION['log_ip_preference'] ?? '1') === '1' ? 1 : 0;
            $upd = $pdo->prepare('UPDATE dashboard_users SET log_ip = :log_ip, updated_at = CURRENT_TIMESTAMP WHERE id = :id');
            $upd->execute([':log_ip' => $log_ip, ':id' => $existing['id']]);
            $_SESSION['log_ip'] = (bool)$log_ip;
            unset($_SESSION['log_ip_preference']);
        } else {
            $_SESSION['log_ip'] = (bool)($existing['log_ip'] ?? true);
        }

        $_SESSION['lm_user_id'] = $existing['id'];
        lm_log_audit('LOGIN_SUCCESS', 'USER', $discordId, ['role' => $existing['role'] ?? 'UNKNOWN']);
    }

    $pdo->commit();
} catch (Throwable $e) {
    $pdo->rollBack();
    lm_log_audit('LOGIN_FAILED', 'INTERNAL', null, ['error' => $e->getMessage()]);
    http_response_code(500);
    echo '<h1>Internal error</h1><p>Login failed unexpectedly.</p>';
    exit;
}

header('Location: index.php');
exit;
?>
'''

    def _generate_logout_php(self) -> str:
        """Simple logout endpoint that destroys the dashboard session and redirects to login."""
        return '''<?php
require_once __DIR__ . '/lm_auth.php';

lm_start_session_if_needed();
lm_ensure_schema();
$user = lm_current_user();
if ($user) {
    lm_log_audit('LOGOUT', 'USER', $user['discord_user_id'] ?? null, []);
}

// Clear session
$_SESSION = [];
if (ini_get('session.use_cookies')) {
    $params = session_get_cookie_params();
    setcookie(session_name(), '', time() - 42000,
        $params['path'], $params['domain'],
        $params['secure'], $params['httponly']
    );
}
session_destroy();

header('Location: login.php');
exit;
?>
'''

    def _generate_htaccess(self) -> str:
        """Generate .htaccess file to protect sensitive files from direct access.
        
        This blocks direct access to:
        - The /data/ directory (contains SQLite database with OAuth secrets)
        - All SQLite/database files anywhere
        - PHP include files that shouldn't be accessed directly
        - Hidden files (.env, .git, etc.)
        
        NOTE: monitor_data_*.json files in the root are ALLOWED - they're needed
        by the dashboard JavaScript and don't contain sensitive secrets.
        The sensitive data (OAuth secrets, user accounts) is in /data/dashboard.sqlite.
        """
        return '''# ============================================
# Live Monitor Security - .htaccess
# Protects sensitive files from direct access
# Generated by Zoryx Discord Bot Framework
# ============================================

# Enable rewrite engine
<IfModule mod_rewrite.c>
    RewriteEngine On
</IfModule>

# ============================================
# PROTECT DATA DIRECTORY (CRITICAL)
# Contains: dashboard.sqlite, config files
# ============================================

# Block all access to /data/ directory
<IfModule mod_rewrite.c>
    RewriteRule ^data/ - [F,L]
    RewriteRule ^data$ - [F,L]
</IfModule>

# ============================================
# BLOCK SENSITIVE FILE TYPES
# ============================================

# Block all SQLite and database files (anywhere)
<FilesMatch "\\.(sqlite|sqlite3|db|sql)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order Allow,Deny
        Deny from all
    </IfModule>
</FilesMatch>

# Block PHP include/library files that shouldn't be accessed directly
<FilesMatch "^(lm_auth|lm_db|lm_bootstrap)\\.php$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order Allow,Deny
        Deny from all
    </IfModule>
</FilesMatch>

# Block .htaccess itself and other hidden/sensitive files
<FilesMatch "^\\.(htaccess|htpasswd|git|env|DS_Store)">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order Allow,Deny
        Deny from all
    </IfModule>
</FilesMatch>

# Block log files
<FilesMatch "\\.(log|logs)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order Allow,Deny
        Deny from all
    </IfModule>
</FilesMatch>

# Block backup files
<FilesMatch "\\.(bak|backup|old|orig|tmp)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order Allow,Deny
        Deny from all
    </IfModule>
</FilesMatch>

# ============================================
# ADDITIONAL SECURITY HEADERS
# ============================================

<IfModule mod_headers.c>
    # Prevent MIME type sniffing
    Header set X-Content-Type-Options "nosniff"
    
    # Clickjacking protection
    Header set X-Frame-Options "SAMEORIGIN"
    
    # XSS protection
    Header set X-XSS-Protection "1; mode=block"
    
    # Referrer policy
    Header set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# ============================================
# PREVENT DIRECTORY LISTING
# ============================================

Options -Indexes

# ============================================
# ERROR DOCUMENTS
# ============================================

ErrorDocument 403 "Access Denied - This file cannot be accessed directly."
ErrorDocument 404 "Not Found"

# ============================================
# NOTE: monitor_data_*.json files are ALLOWED
# They contain bot status data needed by the
# dashboard UI and don't have OAuth secrets.
# Sensitive data is protected in /data/ dir.
# ============================================
'''

    def _generate_data_htaccess(self) -> str:
        """Generate .htaccess for the data directory to completely block access.
        
        The data directory contains:
        - dashboard.sqlite (OAuth secrets, users, audit logs)
        - live_monitor_config.json
        - Other sensitive configuration files
        """
        return '''# ============================================
# Live Monitor Data Directory Protection
# DENY ALL DIRECT ACCESS
# Generated by Zoryx Discord Bot Framework
# ============================================

# Deny everything in this directory
<IfModule mod_authz_core.c>
    Require all denied
</IfModule>
<IfModule !mod_authz_core.c>
    Order Allow,Deny
    Deny from all
</IfModule>

# Extra protection: disable all handlers
<FilesMatch ".*">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order Allow,Deny
        Deny from all
    </IfModule>
</FilesMatch>

# Prevent any script execution
Options -ExecCGI -Indexes
RemoveHandler .php .php3 .php4 .php5 .phtml .pl .py .cgi

# Disable directory listing
Options -Indexes
'''

    def _generate_backup_dashboard_php(self) -> str:
        """Endpoint to download a zip backup of the dashboard PHP files and data directory."""
        return '''<?php
require_once __DIR__ . '/lm_auth.php';

lm_start_session_if_needed();
lm_ensure_schema();

$user = lm_current_user();
if (!$user) {
    http_response_code(403);
    echo 'Not logged in';
    exit;
}

$roleName = $user['role'] ?? 'CUSTOM';
$roleTier = lm_resolve_role_tier($roleName);
$perms = lm_role_permissions($roleName, $roleTier);

// Check new action permission with fallback to old control permission
if (empty($perms['action_backup_dashboard']) && empty($perms['control_backup'])) {
    http_response_code(403);
    echo 'You do not have permission to create dashboard backups.';
    exit;
}

if (!class_exists('ZipArchive')) {
    http_response_code(500);
    echo 'ZipArchive extension is required to create backups.';
    exit;
}

$root = __DIR__;
$zip = new ZipArchive();
$filename = 'dashboard_backup_' . date('Ymd_His') . '.zip';
$tmpPath = sys_get_temp_dir() . DIRECTORY_SEPARATOR . $filename;

if ($zip->open($tmpPath, ZipArchive::CREATE | ZipArchive::OVERWRITE) !== true) {
    http_response_code(500);
    echo 'Unable to create backup.';
    exit;
}

$rii = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($root));

foreach ($rii as $file) {
    if ($file->isDir()) {
        continue;
    }
    $path = $file->getPathname();
    $relative = substr($path, strlen($root) + 1);

    // Skip existing backup archives to avoid recursion
    if (preg_match('/\\.zip$/i', $relative)) {
        continue;
    }

    $zip->addFile($path, $relative);
}

$zip->close();

lm_log_audit('DASHBOARD_BACKUP_CREATED', 'BACKUP', $filename, []);

header('Content-Type: application/zip');
header('Content-Disposition: attachment; filename="' . $filename . '"');
header('Content-Length: ' . filesize($tmpPath));

readfile($tmpPath);
@unlink($tmpPath);
exit;
?>
'''

    def _generate_owner_audit_php(self) -> str:
        """Owner-only audit log viewer with basic search + filters."""
        return '''<?php
require_once __DIR__ . '/lm_auth.php';

lm_start_session_if_needed();
lm_ensure_schema();

// Check permissions for viewing audit logs
$user = lm_current_user();
if (!$user) {
    lm_render_error_page(401, 'Authentication Required', 'You must be logged in to view audit logs.', 'lock');
}

$roleName = $user['role'] ?? 'CUSTOM';
$roleTier = lm_resolve_role_tier($roleName);
$rolePerms = lm_role_permissions($roleName, $roleTier);

// CRITICAL: Viewing audit logs requires view_security AND action_view_logs permissions
if (empty($rolePerms['view_security']) || empty($rolePerms['action_view_logs'])) {
    lm_render_error_page(403, 'Access Denied', 'You do not have permission to view audit logs. Requires view_security and action_view_logs permissions.', 'forbidden');
}

$pdo = lm_db();

$q = trim($_GET['q'] ?? '');
$actionFilter = trim($_GET['action'] ?? '');
$page = max(1, (int)($_GET['page'] ?? 1));
$limit = 50;
$offset = ($page - 1) * $limit;

$where = [];
$params = [];

if ($q !== '') {
    $where[] = '(actor_discord_id LIKE :q OR target_id LIKE :q OR meta_json LIKE :q)';
    $params[':q'] = '%' . $q . '%';
}

if ($actionFilter !== '') {
    $where[] = 'action = :action';
    $params[':action'] = $actionFilter;
}

$sqlWhere = $where ? ('WHERE ' . implode(' AND ', $where)) : '';

// CSV export (used by the Security & Logs "Export Logs" button)
if (isset($_GET['export']) && $_GET['export'] === 'csv') {
    // CRITICAL: Exporting logs requires action_export_logs permission
    if (empty($rolePerms['action_export_logs'])) {
        http_response_code(403);
        echo 'You do not have permission to export audit logs. Requires action_export_logs permission.';
        exit;
    }
    
    header('Content-Type: text/csv; charset=UTF-8');
    header('Content-Disposition: attachment; filename="audit_logs_' . date('Ymd_His') . '.csv"');

    $exportSql = 'SELECT timestamp, action, actor_discord_id, target_type, target_id, meta_json FROM audit_logs ' . $sqlWhere . ' ORDER BY timestamp DESC';
    $exportStmt = $pdo->prepare($exportSql);
    $exportStmt->execute($params);

    $out = fopen('php://output', 'w');
    if ($out !== false) {
        fputcsv($out, ['timestamp', 'action', 'actor_discord_id', 'target_type', 'target_id', 'meta_json']);
        while ($row = $exportStmt->fetch(PDO::FETCH_ASSOC)) {
            fputcsv($out, [
                $row['timestamp'] ?? '',
                $row['action'] ?? '',
                $row['actor_discord_id'] ?? '',
                $row['target_type'] ?? '',
                $row['target_id'] ?? '',
                $row['meta_json'] ?? '',
            ]);
        }
        fclose($out);
    }
    exit;
}

$totalSql = 'SELECT COUNT(*) AS c FROM audit_logs ' . $sqlWhere;
$stmt = $pdo->prepare($totalSql);
$stmt->execute($params);
$total = (int)($stmt->fetch()['c'] ?? 0);

$listSql = 'SELECT * FROM audit_logs ' . $sqlWhere . ' ORDER BY timestamp DESC LIMIT :limit OFFSET :offset';
$stmt = $pdo->prepare($listSql);
foreach ($params as $k => $v) {
    $stmt->bindValue($k, $v, PDO::PARAM_STR);
}
$stmt->bindValue(':limit', $limit, PDO::PARAM_INT);
$stmt->bindValue(':offset', $offset, PDO::PARAM_INT);
$stmt->execute();
$rows = $stmt->fetchAll();

$pages = max(1, (int)ceil($total / $limit));
$currentPage = min($page, $pages);

function h($s) {
    return htmlspecialchars((string)$s, ENT_QUOTES, 'UTF-8');
}

?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Owner Audit Log</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #020617;
            color: #e5e7eb;
            margin: 0;
            padding: 12px;
        }
        h1 {
            margin: 0 0 8px 0;
            font-size: 18px;
        }
        form {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        input[type="text"] {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            background: rgba(15, 23, 42, 0.8);
            color: #e5e7eb;
            font-size: 12px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        select {
            padding: 8px 32px 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            background-color: rgba(15, 23, 42, 0.8);
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            color: #e5e7eb;
            font-size: 12px;
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
        }
        select:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        select option {
            background: #0f172a;
            color: #e5e7eb;
            padding: 8px;
        }
        button {
            padding: 6px 10px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        th, td {
            padding: 6px 8px;
            border-bottom: 1px solid rgba(31, 41, 55, 0.9);
            text-align: left;
        }
        th {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #9ca3af;
        }
        tr:nth-child(even) td {
            background: #020617;
        }
        tr:nth-child(odd) td {
            background: #030712;
        }
        .meta {
            max-width: 260px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
        }
        .pager {
            margin-top: 8px;
            font-size: 11px;
            color: #9ca3af;
        }
        .pager a {
            color: #93c5fd;
            text-decoration: none;
            margin-right: 6px;
        }
    </style>
</head>
<body>
    <h1>Audit Log (Owner)</h1>
    <form method="get">
        <input type="text" name="q" placeholder="Search user, target, meta" value="<?php echo h($q); ?>">
        <select name="action">
            <option value="">All actions</option>
            <option value="LOGIN_SUCCESS" <?php echo $actionFilter === 'LOGIN_SUCCESS' ? 'selected' : ''; ?>>LOGIN_SUCCESS</option>
            <option value="LOGIN_FAILED" <?php echo $actionFilter === 'LOGIN_FAILED' ? 'selected' : ''; ?>>LOGIN_FAILED</option>
            <option value="LOGIN_DENIED" <?php echo $actionFilter === 'LOGIN_DENIED' ? 'selected' : ''; ?>>LOGIN_DENIED</option>
            <option value="DASHBOARD_CLAIMED" <?php echo $actionFilter === 'DASHBOARD_CLAIMED' ? 'selected' : ''; ?>>DASHBOARD_CLAIMED</option>
            <option value="OAUTH_CONFIG_UPDATED" <?php echo $actionFilter === 'OAUTH_CONFIG_UPDATED' ? 'selected' : ''; ?>>OAUTH_CONFIG_UPDATED</option>
        </select>
        <button type="submit" class="btn-primary">Filter</button>
    </form>

    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Action</th>
                <th>Actor</th>
                <th>Target</th>
                <th>Meta</th>
            </tr>
        </thead>
        <tbody>
        <?php if (!$rows): ?>
            <tr><td colspan="5">No entries</td></tr>
        <?php else: ?>
            <?php foreach ($rows as $row): ?>
                <tr>
                    <td><?php echo h($row['timestamp']); ?></td>
                    <td><?php echo h($row['action']); ?></td>
                    <td><?php echo h($row['actor_discord_id'] ?? ''); ?></td>
                    <td><?php echo h($row['target_type'] . ':' . $row['target_id']); ?></td>
                    <td class="meta"><?php echo h($row['meta_json'] ?? ''); ?></td>
                </tr>
            <?php endforeach; ?>
        <?php endif; ?>
        </tbody>
    </table>

    <div class="pager">
        Page <?php echo $currentPage; ?> of <?php echo $pages; ?> (<?php echo $total; ?> entries)
        <?php if ($currentPage > 1): ?>
            <a href="?<?php echo http_build_query(['q' => $q, 'action' => $actionFilter, 'page' => $currentPage - 1]); ?>">Prev</a>
        <?php endif; ?>
        <?php if ($currentPage < $pages): ?>
            <a href="?<?php echo http_build_query(['q' => $q, 'action' => $actionFilter, 'page' => $currentPage + 1]); ?>">Next</a>
        <?php endif; ?>
    </div>
</body>
</html>
'''

    def _generate_owner_roles_php(self) -> str:
        """Owner-only JSON API for managing dashboard_users roles."""
        return '''<?php
require_once __DIR__ . '/lm_auth.php';

lm_start_session_if_needed();
lm_ensure_schema();

// Check permissions for viewing roles
$user = lm_current_user();
if (!$user) {
    http_response_code(401);
    header('Content-Type: application/json');
    echo json_encode(['error' => 'Not logged in']);
    exit;
}

$roleName = $user['role'] ?? 'CUSTOM';
$roleTier = lm_resolve_role_tier($roleName);
$rolePerms = lm_role_permissions($roleName, $roleTier);

// CRITICAL: Viewing roles requires view_roles permission
if (empty($rolePerms['view_roles'])) {
    http_response_code(403);
    header('Content-Type: application/json');
    echo json_encode(['error' => 'You do not have permission to view roles. Requires view_roles permission.']);
    exit;
}

$pdo = lm_db();
$config = lm_get_config();

header('Content-Type: application/json');

// Load custom role profiles (aliases)
$customRoles = [];
try {
    $stmtRoles = $pdo->query('SELECT id, name, base_role, description, permissions_json, created_at FROM dashboard_roles ORDER BY name ASC');
    $rowsRoles = $stmtRoles->fetchAll();
    foreach ($rowsRoles as $r) {
        $perms = [];
        if (!empty($r['permissions_json'])) {
            $tmp = json_decode($r['permissions_json'], true);
            if (is_array($tmp)) {
                $perms = $tmp;
            }
        }
        $customRoles[] = [
            'id' => (int)($r['id'] ?? 0),
            'name' => $r['name'],
            'base_role' => strtoupper($r['base_role'] ?? 'CUSTOM'),
            'description' => $r['description'] ?? '',
            'permissions' => $perms,
            'system' => false,
        ];
    }
} catch (Throwable $e) {
    $customRoles = [];
}

$builtinRoles = [
    [
        'name' => 'OWNER',
        'base_role' => 'OWNER',
        'description' => 'Dashboard owner (full access)',
        'system' => true,
    ],
];

$allRoles = array_merge($builtinRoles, $customRoles);

if ($_SERVER['REQUEST_METHOD'] === 'GET') {
    if (($_GET['format'] ?? '') === 'json') {
        $stmt = $pdo->query('SELECT id, discord_user_id, display_name, avatar_url, role, created_at FROM dashboard_users ORDER BY role DESC, created_at ASC');
        $rows = $stmt->fetchAll();
        echo json_encode([
            'success' => true,
            'owner_discord_id' => $config['owner_discord_id'] ?? null,
            'users' => $rows,
            'roles' => $allRoles,
        ]);
        exit;
    }
    echo json_encode(['success' => false, 'error' => 'Use ?format=json for this endpoint']);
    exit;
}

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    http_response_code(405);
    echo json_encode(['success' => false, 'error' => 'Method not allowed']);
    exit;
}

$raw = file_get_contents('php://input');
$data = json_decode($raw, true);
if (!is_array($data)) {
    http_response_code(400);
    echo json_encode(['success' => false, 'error' => 'Invalid JSON body']);
    exit;
}

$action = $data['action'] ?? '';

// CRITICAL: Check action permissions before allowing any modifications
// User management permissions
$requiresAddUser = in_array($action, ['add'], true);
$requiresRemoveUser = in_array($action, ['delete'], true);
$requiresChangeUserRole = in_array($action, ['update_role'], true);

// Role profile permissions
$requiresCreateRole = in_array($action, ['create_role', 'role_create'], true);
$requiresSaveRole = in_array($action, ['save_role', 'role_update'], true);
$requiresDeleteRole = in_array($action, ['remove', 'delete_role', 'role_delete'], true);

// User management permission checks
if ($requiresAddUser && empty($rolePerms['action_add_user'])) {
    http_response_code(403);
    echo json_encode(['success' => false, 'error' => 'No permission to add users. Requires action_add_user permission.']);
    exit;
}

if ($requiresRemoveUser && empty($rolePerms['action_remove_user'])) {
    http_response_code(403);
    echo json_encode(['success' => false, 'error' => 'No permission to remove users. Requires action_remove_user permission.']);
    exit;
}

if ($requiresChangeUserRole && empty($rolePerms['action_change_user_role'])) {
    http_response_code(403);
    echo json_encode(['success' => false, 'error' => 'No permission to change user roles. Requires action_change_user_role permission.']);
    exit;
}

// Role profile permission checks
if ($requiresCreateRole && empty($rolePerms['action_create_role'])) {
    http_response_code(403);
    echo json_encode(['success' => false, 'error' => 'No permission to create roles. Requires action_create_role permission.']);
    exit;
}

if ($requiresSaveRole && empty($rolePerms['action_save_role'])) {
    http_response_code(403);
    echo json_encode(['success' => false, 'error' => 'No permission to save role changes. Requires action_save_role permission.']);
    exit;
}

if ($requiresDeleteRole && empty($rolePerms['action_delete_role'])) {
    http_response_code(403);
    echo json_encode(['success' => false, 'error' => 'No permission to delete roles. Requires action_delete_role permission.']);
    exit;
}

try {
    if ($action === 'add') {
        $did = trim($data['discord_user_id'] ?? '');
        $name = trim($data['display_name'] ?? '');
        $role = strtoupper(trim($data['role'] ?? 'CUSTOM'));
        if (!$did) {
            throw new RuntimeException('Discord user ID is required');
        }
        if ($role === 'OWNER') {
            throw new RuntimeException('OWNER role is reserved for the original claimant');
        }
        // Allow CUSTOM and any custom role name defined in dashboard_roles
        if (!in_array($role, ['CUSTOM', 'CUSTOM'], true)) {
            $check = $pdo->prepare('SELECT COUNT(*) AS c FROM dashboard_roles WHERE UPPER(name) = :name');
            $check->execute([':name' => $role]);
            $row = $check->fetch();
            $exists = isset($row['c']) ? (int)$row['c'] > 0 : false;
            if (!$exists) {
                throw new RuntimeException('Unknown role: ' . $role . '. Create a role profile first.');
            }
        }

        $stmt = $pdo->prepare('INSERT OR IGNORE INTO dashboard_users (discord_user_id, display_name, avatar_url, role) VALUES (:did, :name, NULL, :role)');
        $stmt->execute([
            ':did' => $did,
            ':name' => $name ?: $did,
            ':role' => $role,
        ]);
        lm_log_audit('ROLE_ADDED', 'USER', $did, ['role' => $role]);
        echo json_encode(['success' => true, 'message' => 'User added']);
        exit;
    }

    if ($action === 'update_role') {
        $userId = (int)($data['user_id'] ?? 0);
        $role = strtoupper(trim($data['role'] ?? ''));
        if (!$userId) {
            throw new RuntimeException('Invalid user or role');
        }
        if ($role === 'OWNER') {
            throw new RuntimeException('OWNER role is reserved for the original claimant');
        }
        // Allow CUSTOM and any custom dashboard_roles.name
        if (!in_array($role, ['CUSTOM', 'CUSTOM'], true)) {
            $check = $pdo->prepare('SELECT COUNT(*) AS c FROM dashboard_roles WHERE UPPER(name) = :name');
            $check->execute([':name' => $role]);
            $row = $check->fetch();
            $exists = isset($row['c']) ? (int)$row['c'] > 0 : false;
            if (!$exists) {
                throw new RuntimeException('Unknown role: ' . $role . '. Create a role profile first.');
            }
        }
        $stmt = $pdo->prepare('SELECT * FROM dashboard_users WHERE id = :id LIMIT 1');
        $stmt->execute([':id' => $userId]);
        $u = $stmt->fetch();
        if (!$u) {
            throw new RuntimeException('User not found');
        }
        if ($u['role'] === 'OWNER' && $role !== 'OWNER') {
            throw new RuntimeException('Cannot demote OWNER via web UI');
        }

        $stmt = $pdo->prepare('UPDATE dashboard_users SET role = :role WHERE id = :id');
        $stmt->execute([':role' => $role, ':id' => $userId]);
        lm_log_audit('ROLE_UPDATED', 'USER', $u['discord_user_id'], ['old' => $u['role'], 'new' => $role]);
        echo json_encode(['success' => true, 'message' => 'Role updated']);
        exit;
    }

    if ($action === 'delete') {
        $userId = (int)($data['user_id'] ?? 0);
        if (!$userId) {
            throw new RuntimeException('Invalid user');
        }
        $stmt = $pdo->prepare('SELECT * FROM dashboard_users WHERE id = :id LIMIT 1');
        $stmt->execute([':id' => $userId]);
        $u = $stmt->fetch();
        if (!$u) {
            throw new RuntimeException('User not found');
        }
        if ($u['role'] === 'OWNER') {
            throw new RuntimeException('Cannot remove OWNER');
        }

        $del = $pdo->prepare('DELETE FROM dashboard_users WHERE id = :id');
        $del->execute([':id' => $userId]);
        lm_log_audit('ROLE_REMOVED', 'USER', $u['discord_user_id'], ['role' => $u['role']]);
        echo json_encode(['success' => true, 'message' => 'User removed']);
        exit;
    }

    // Create a new custom role profile
    if ($action === 'role_create') {
        $name = strtoupper(trim($data['name'] ?? ''));
        $base = strtoupper(trim($data['base_role'] ?? 'CUSTOM'));
        $desc = trim($data['description'] ?? '');
        $perms = $data['permissions'] ?? null;
        if (!$name) {
            throw new RuntimeException('Role name is required');
        }
        if (in_array($name, ['OWNER', 'CUSTOM', 'CUSTOM'], true)) {
            throw new RuntimeException('This name is reserved for built-in roles');
        }
        if (!in_array($base, ['OWNER', 'CUSTOM', 'CUSTOM'], true)) {
            throw new RuntimeException('Invalid base role');
        }
        $stmt = $pdo->prepare('SELECT COUNT(*) AS c FROM dashboard_roles WHERE UPPER(name) = :name');
        $stmt->execute([':name' => $name]);
        $row = $stmt->fetch();
        if (isset($row['c']) && (int)$row['c'] > 0) {
            throw new RuntimeException('A role with this name already exists');
        }
        $jsonPerms = is_array($perms) ? json_encode($perms) : null;
        $ins = $pdo->prepare('INSERT INTO dashboard_roles (name, base_role, description, permissions_json) VALUES (:name, :base, :description, :perms)');
        $ins->execute([
            ':name' => $name,
            ':base' => $base,
            ':description' => $desc,
            ':perms' => $jsonPerms,
        ]);
        lm_log_audit('ROLE_PROFILE_CREATED', 'ROLE', $name, ['base_role' => $base]);
        echo json_encode(['success' => true, 'message' => 'Role created']);
        exit;
    }

    // Update an existing custom role profile (base tier / description)
    if ($action === 'role_update') {
        $id = (int)($data['id'] ?? 0);
        $base = strtoupper(trim($data['base_role'] ?? 'CUSTOM'));
        $desc = trim($data['description'] ?? '');
        $perms = $data['permissions'] ?? null;
        if (!$id) {
            throw new RuntimeException('Invalid role');
        }
        if (!in_array($base, ['OWNER', 'CUSTOM', 'CUSTOM'], true)) {
            throw new RuntimeException('Invalid base role');
        }
        $stmt = $pdo->prepare('SELECT * FROM dashboard_roles WHERE id = :id LIMIT 1');
        $stmt->execute([':id' => $id]);
        $role = $stmt->fetch();
        if (!$role) {
            throw new RuntimeException('Role not found');
        }
        $jsonPerms = is_array($perms) ? json_encode($perms) : null;
        $upd = $pdo->prepare('UPDATE dashboard_roles SET base_role = :base, description = :description, permissions_json = :perms WHERE id = :id');
        $upd->execute([
            ':base' => $base,
            ':description' => $desc,
            ':perms' => $jsonPerms,
            ':id' => $id,
        ]);
        lm_log_audit('ROLE_PROFILE_UPDATED', 'ROLE', $role['name'], ['base_role' => $base]);
        echo json_encode(['success' => true, 'message' => 'Role updated']);
        exit;
    }

    // Delete a custom role profile (must not be in use)
    if ($action === 'role_delete') {
        $id = (int)($data['id'] ?? 0);
        if (!$id) {
            throw new RuntimeException('Invalid role');
        }
        $stmt = $pdo->prepare('SELECT * FROM dashboard_roles WHERE id = :id LIMIT 1');
        $stmt->execute([':id' => $id]);
        $role = $stmt->fetch();
        if (!$role) {
            throw new RuntimeException('Role not found');
        }
        $name = strtoupper($role['name']);
        if (in_array($name, ['OWNER', 'CUSTOM', 'CUSTOM'], true)) {
            throw new RuntimeException('Cannot delete built-in roles');
        }
        $checkUsers = $pdo->prepare('SELECT COUNT(*) AS c FROM dashboard_users WHERE UPPER(role) = :name');
        $checkUsers->execute([':name' => $name]);
        $row = $checkUsers->fetch();
        if (isset($row['c']) && (int)$row['c'] > 0) {
            throw new RuntimeException('Cannot delete a role that is still assigned to users');
        }
        $del = $pdo->prepare('DELETE FROM dashboard_roles WHERE id = :id');
        $del->execute([':id' => $id]);
        lm_log_audit('ROLE_PROFILE_DELETED', 'ROLE', $name, []);
        echo json_encode(['success' => true, 'message' => 'Role deleted']);
        exit;
    }

    throw new RuntimeException('Unknown action');
} catch (Throwable $e) {
    http_response_code(400);
    echo json_encode(['success' => false, 'error' => $e->getMessage()]);
    exit;
}
?>
'''

    def _generate_owner_db_php(self) -> str:
        """RBAC-aware JSON API for inspecting and managing the local dashboard SQLite database."""
        return '''<?php
require_once __DIR__ . '/lm_auth.php';

lm_start_session_if_needed();
lm_ensure_schema();

header('Content-Type: application/json');

$user = lm_current_user();
if (!$user) {
    http_response_code(401);
    echo json_encode(['success' => false, 'error' => 'Not logged in']);
    exit;
}

$roleName = $user['role'] ?? 'CUSTOM';
$roleTier = lm_resolve_role_tier($roleName);
$rolePerms = lm_role_permissions($roleName, $roleTier);

if (empty($rolePerms['view_database'])) {
    http_response_code(403);
    echo json_encode(['success' => false, 'error' => 'You do not have permission to view the dashboard database.']);
    exit;
}

$pdo = lm_db();
$action = $_GET['action'] ?? $_POST['action'] ?? 'tables';

try {
    if ($action === 'tables') {
        $tables = [];
        $stmt = $pdo->query("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name ASC");
        while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
            $name = $row['name'] ?? null;
            if (!$name) {
                continue;
            }
            $count = null;
            try {
                $cntStmt = $pdo->query("SELECT COUNT(*) AS c FROM " . $pdo->quote($name));
                $cntRow = $cntStmt->fetch(PDO::FETCH_ASSOC);
                if ($cntRow && isset($cntRow['c'])) {
                    $count = (int)$cntRow['c'];
                }
            } catch (Throwable $e) {
                $count = null;
            }
            $tables[] = [
                'name' => $name,
                'count' => $count,
            ];
        }
        echo json_encode(['success' => true, 'tables' => $tables]);
        exit;
    }

    if ($action === 'rows') {
        if (empty($rolePerms['action_db_read'])) {
            http_response_code(403);
            echo json_encode(['success' => false, 'error' => 'You do not have permission to read database rows. Requires action_db_read permission.']);
            exit;
        }
        
        $table = $_GET['table'] ?? '';
        if (!$table || !preg_match('/^[A-Za-z0-9_]+$/', $table)) {
            http_response_code(400);
            echo json_encode(['success' => false, 'error' => 'Invalid table name']);
            exit;
        }
        $limit = isset($_GET['limit']) ? (int)$_GET['limit'] : 100;
        $offset = isset($_GET['offset']) ? (int)$_GET['offset'] : 0;
        if ($limit < 1) $limit = 1;
        if ($limit > 1000) $limit = 1000;
        if ($offset < 0) $offset = 0;

        $sql = sprintf('SELECT * FROM "%s" LIMIT :limit OFFSET :offset', $table);
        $stmt = $pdo->prepare($sql);
        $stmt->bindValue(':limit', $limit, PDO::PARAM_INT);
        $stmt->bindValue(':offset', $offset, PDO::PARAM_INT);
        $stmt->execute();
        $rows = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        $colStmt = $pdo->query(sprintf('PRAGMA table_info("%s")', $table));
        $columns = $colStmt->fetchAll(PDO::FETCH_ASSOC);

        echo json_encode([
            'success' => true,
            'table' => $table,
            'limit' => $limit,
            'offset' => $offset,
            'rows' => $rows,
            'columns' => $columns,
        ]);
        exit;
    }
    
    if ($action === 'create') {
        if (empty($rolePerms['action_db_create'])) {
            http_response_code(403);
            echo json_encode(['success' => false, 'error' => 'You do not have permission to create database records. Requires action_db_create permission.']);
            exit;
        }
        
        $input = json_decode(file_get_contents('php://input'), true);
        $table = $input['table'] ?? '';
        $data = $input['data'] ?? [];
        
        if (!$table || !preg_match('/^[A-Za-z0-9_]+$/', $table)) {
            http_response_code(400);
            echo json_encode(['success' => false, 'error' => 'Invalid table name']);
            exit;
        }
        
        if (empty($data) || !is_array($data)) {
            http_response_code(400);
            echo json_encode(['success' => false, 'error' => 'No data provided']);
            exit;
        }
        
        $columns = array_keys($data);
        $placeholders = array_map(function($col) { return ':' . $col; }, $columns);
        
        $sql = sprintf(
            'INSERT INTO "%s" (%s) VALUES (%s)',
            $table,
            implode(', ', array_map(function($c) { return '"' . $c . '"'; }, $columns)),
            implode(', ', $placeholders)
        );
        
        $stmt = $pdo->prepare($sql);
        foreach ($data as $col => $val) {
            $stmt->bindValue(':' . $col, $val);
        }
        $stmt->execute();
        
        echo json_encode([
            'success' => true,
            'message' => 'Record created successfully',
            'id' => $pdo->lastInsertId()
        ]);
        exit;
    }
    
    if ($action === 'update') {
        if (empty($rolePerms['action_db_update'])) {
            http_response_code(403);
            echo json_encode(['success' => false, 'error' => 'You do not have permission to update database records. Requires action_db_update permission.']);
            exit;
        }
        
        $input = json_decode(file_get_contents('php://input'), true);
        $table = $input['table'] ?? '';
        $data = $input['data'] ?? [];
        $where = $input['where'] ?? [];
        
        if (!$table || !preg_match('/^[A-Za-z0-9_]+$/', $table)) {
            http_response_code(400);
            echo json_encode(['success' => false, 'error' => 'Invalid table name']);
            exit;
        }
        
        if (empty($data) || !is_array($data)) {
            http_response_code(400);
            echo json_encode(['success' => false, 'error' => 'No data provided']);
            exit;
        }
        
        if (empty($where) || !is_array($where)) {
            http_response_code(400);
            echo json_encode(['success' => false, 'error' => 'No WHERE conditions provided']);
            exit;
        }
        
        $setClauses = [];
        foreach (array_keys($data) as $col) {
            $setClauses[] = sprintf('"%s" = :set_%s', $col, $col);
        }
        
        $whereClauses = [];
        foreach (array_keys($where) as $col) {
            $whereClauses[] = sprintf('"%s" = :where_%s', $col, $col);
        }
        
        $sql = sprintf(
            'UPDATE "%s" SET %s WHERE %s',
            $table,
            implode(', ', $setClauses),
            implode(' AND ', $whereClauses)
        );
        
        $stmt = $pdo->prepare($sql);
        foreach ($data as $col => $val) {
            $stmt->bindValue(':set_' . $col, $val);
        }
        foreach ($where as $col => $val) {
            $stmt->bindValue(':where_' . $col, $val);
        }
        $stmt->execute();
        
        echo json_encode([
            'success' => true,
            'message' => 'Record updated successfully',
            'affected_rows' => $stmt->rowCount()
        ]);
        exit;
    }
    
    if ($action === 'delete') {
        if (empty($rolePerms['action_db_delete'])) {
            http_response_code(403);
            echo json_encode(['success' => false, 'error' => 'You do not have permission to delete database records. Requires action_db_delete permission.']);
            exit;
        }
        
        $input = json_decode(file_get_contents('php://input'), true);
        $table = $input['table'] ?? '';
        $where = $input['where'] ?? [];
        
        if (!$table || !preg_match('/^[A-Za-z0-9_]+$/', $table)) {
            http_response_code(400);
            echo json_encode(['success' => false, 'error' => 'Invalid table name']);
            exit;
        }
        
        if (empty($where) || !is_array($where)) {
            http_response_code(400);
            echo json_encode(['success' => false, 'error' => 'No WHERE conditions provided - refusing to delete entire table']);
            exit;
        }
        
        $whereClauses = [];
        foreach (array_keys($where) as $col) {
            $whereClauses[] = sprintf('"%s" = :%s', $col, $col);
        }
        
        $sql = sprintf(
            'DELETE FROM "%s" WHERE %s',
            $table,
            implode(' AND ', $whereClauses)
        );
        
        $stmt = $pdo->prepare($sql);
        foreach ($where as $col => $val) {
            $stmt->bindValue(':' . $col, $val);
        }
        $stmt->execute();
        
        echo json_encode([
            'success' => true,
            'message' => 'Record deleted successfully',
            'affected_rows' => $stmt->rowCount()
        ]);
        exit;
    }

    http_response_code(400);
    echo json_encode(['success' => false, 'error' => 'Unknown action']);
    exit;
} catch (Throwable $e) {
    http_response_code(500);
    echo json_encode(['success' => false, 'error' => 'Database error: ' . $e->getMessage()]);
    exit;
}
?>
'''

    def _generate_receive_php(self, token: str) -> str:
        return '''<?php
    ini_set('memory_limit', '256M');
    ini_set('post_max_size', '50M');
    ini_set('upload_max_filesize', '50M');

    define('SECRET_TOKEN', '{{TOKEN}}');

    header('Content-Type: application/json');
    header('X-Content-Type-Options: nosniff');
    header('X-Frame-Options: DENY');

    // Security: This endpoint is for bot-to-server communication only
    // Block common browser User-Agents to prevent unauthorized access
    $userAgent = $_SERVER['HTTP_USER_AGENT'] ?? '';
    if (preg_match('/(Mozilla|Chrome|Safari|Edge|Opera)/i', $userAgent)) {{
        http_response_code(403);
        die(json_encode(['error' => 'Access denied']));
    }}

    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {{
        http_response_code(405);
        die(json_encode(['error' => 'Only POST requests allowed']));
    }}

    $token = $_GET['token'] ?? null;
    if (!$token || $token !== SECRET_TOKEN) {{
        http_response_code(403);
        die(json_encode(['error' => 'Invalid token']));
    }}

    $package = $_GET['package'] ?? 'unknown';
    $validPackages = ['core', 'commands', 'plugins', 'hooks', 'extensions', 'system_details', 'events', 'filesystem', 'fileops', 'assets', 'tickets', 'hook_creator', 'status', 'plugin_response', 'plugin_requests_clear'];

    if (!in_array($package, $validPackages)) {{
        http_response_code(400);
        die(json_encode(['error' => 'Invalid package name']));
    }}

    $jsonPayload = file_get_contents('php://input');
    if (empty($jsonPayload)) {{
        http_response_code(400);
        die(json_encode(['error' => 'No data received']));
    }}

    $decoded = json_decode($jsonPayload);
    if (json_last_error() !== JSON_ERROR_NONE) {{
        http_response_code(400);
        die(json_encode(['error' => 'Invalid JSON: ' . json_last_error_msg()]));
    }}

    // Special handling for branding assets: write base64-encoded files
    // into an /assets directory next to this script so the dashboard can
    // use them automatically.
    if ($package === 'assets') {{
        if (!is_array($decoded)) {{
            http_response_code(400);
            die(json_encode(['error' => 'Assets payload must be a JSON array']));
        }}

        $assetsDir = __DIR__ . DIRECTORY_SEPARATOR . 'assets';
        if (!is_dir($assetsDir)) {{
            mkdir($assetsDir, 0755, true);
        }}

        $written = 0;
        foreach ($decoded as $asset) {{
            $filename = $asset->filename ?? null;
            $content  = $asset->content ?? null;
            if (!$filename || !$content) {{
                continue;
            }}
            $safeName = basename($filename);
            $target   = $assetsDir . DIRECTORY_SEPARATOR . $safeName;
            $binary   = base64_decode($content, true);
            if ($binary === false) {{
                continue;
            }}
            if (file_put_contents($target, $binary, LOCK_EX) !== false) {{
                chmod($target, 0644);
                $written++;
            }}
        }}

        http_response_code(200);
        echo json_encode(['success' => true, 'message' => 'Assets uploaded', 'count' => $written]);
        exit;
    }}

    // Handle plugin API responses from the bot
    if ($package === 'plugin_response') {{
        $requestId = $decoded->request_id ?? null;
        $response = $decoded->response ?? null;
        
        if (!$requestId) {{
            http_response_code(400);
            die(json_encode(['error' => 'Missing request_id']));
        }}
        
        $responseFile = __DIR__ . "/monitor_data_plugin_response_$requestId.json";
        if (file_put_contents($responseFile, json_encode($response), LOCK_EX) === false) {{
            http_response_code(500);
            die(json_encode(['error' => 'Could not write response']));
        }}
        chmod($responseFile, 0644);
        
        http_response_code(200);
        echo json_encode(['success' => true, 'message' => 'Plugin response saved']);
        exit;
    }}
    
    // Handle clearing processed plugin requests
    if ($package === 'plugin_requests_clear') {{
        $processedIds = $decoded->ids ?? [];
        $queueFile = __DIR__ . '/monitor_data_plugin_requests.json';
        
        if (file_exists($queueFile)) {{
            $requests = json_decode(file_get_contents($queueFile), true) ?: [];
            $requests = array_filter($requests, function($r) use ($processedIds) {{
                return !in_array($r['id'] ?? '', $processedIds);
            }});
            file_put_contents($queueFile, json_encode(array_values($requests), JSON_PRETTY_PRINT), LOCK_EX);
        }}
        
        http_response_code(200);
        echo json_encode(['success' => true, 'message' => 'Processed requests cleared']);
        exit;
    }}

    $outputFile = "monitor_data_$package.json";

    if (file_put_contents($outputFile, $jsonPayload, LOCK_EX) === false) {{
        http_response_code(500);
        die(json_encode(['error' => 'Could not write data']));
    }}

    chmod($outputFile, 0644);

    http_response_code(200);
    echo json_encode(['success' => true, 'message' => 'Package received', 'package' => $package, 'size' => strlen($jsonPayload)]);
    ?>'''.replace('{{TOKEN}}', token)
    
    def _generate_get_commands_php(self, token: str) -> str:
        return '''<?php
define('SECRET_TOKEN', '{{TOKEN}}');
$commandFile = 'pending_commands.json';

header('Content-Type: application/json');
header('X-Content-Type-Options: nosniff');
header('X-Frame-Options: DENY');

// Security: This endpoint is for bot-to-server communication only
// Block common browser User-Agents to prevent unauthorized access
$userAgent = $_SERVER['HTTP_USER_AGENT'] ?? '';
if (preg_match('/(Mozilla|Chrome|Safari|Edge|Opera)/i', $userAgent)) {{
    http_response_code(403);
    die(json_encode(['error' => 'Access denied']));
}}

if ($_SERVER['REQUEST_METHOD'] !== 'GET') {{
    http_response_code(405);
    die(json_encode(['error' => 'Only GET requests allowed']));
}}

$token = $_GET['token'] ?? null;
if (!$token || $token !== SECRET_TOKEN) {{
    http_response_code(403);
    die(json_encode(['error' => 'Invalid token']));
}}

if (!file_exists($commandFile)) {{
    echo json_encode([]);
    exit;
}}

$commands = json_decode(file_get_contents($commandFile), true) ?? [];

if (file_put_contents($commandFile, json_encode([]), LOCK_EX) === false) {{
    http_response_code(500);
    die(json_encode(['error' => 'Could not clear commands']));
}}

echo json_encode($commands);
?>'''.replace('{{TOKEN}}', token)
    
    def _generate_send_command_php(self, token: str) -> str:
        return '''<?php
require_once __DIR__ . '/lm_auth.php';

lm_start_session_if_needed();
lm_ensure_schema();
$user = lm_current_user();
if (!$user) {
    http_response_code(403);
    header('Content-Type: application/json');
    echo json_encode(['error' => 'Not logged in']);
    exit;
}

$roleName = $user['role'] ?? 'CUSTOM';
$roleTier = lm_resolve_role_tier($roleName);
$rolePerms = lm_role_permissions($roleName, $roleTier);

$commandFile = 'pending_commands.json';

header('Content-Type: application/json');

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    http_response_code(405);
    echo json_encode(['error' => 'Only POST requests allowed']);
    exit;
}

$payload = file_get_contents('php://input');
if (empty($payload)) {
    http_response_code(400);
    echo json_encode(['error' => 'No command received']);
    exit;
}

$data = json_decode($payload, true);
if (json_last_error() !== JSON_ERROR_NONE) {
    http_response_code(400);
    echo json_encode(['error' => 'Invalid JSON']);
    exit;
}

$command = $data['command'] ?? '';
$params  = $data['params'] ?? [];

// Role-based allow lists
function lm_command_allowed_for_permissions(string $command, array $perms): bool {
    switch ($command) {
        // Dashboard Actions
        case 'clear_cache':
            return !empty($perms['action_clear_cache']);
        case 'toggle_verbose_logging':
        case 'set_verbose_logging':
            return !empty($perms['action_toggle_logging']);
        case 'toggle_debug_packages':
            return !empty($perms['action_toggle_debug_packages']);
        case 'backup_bot_directory':
            return !empty($perms['action_backup_bot']);
        
        // Plugin Actions
        case 'reload_extension':
            return !empty($perms['action_reload_extension']);
        case 'load_extension':
            return !empty($perms['action_load_extension']);
        case 'unload_extension':
            return !empty($perms['action_unload_extension']);
        case 'set_auto_reload':
            return !empty($perms['action_set_auto_reload']);
        case 'set_extensions_auto_load':
            return !empty($perms['action_set_auto_load']);
        case 'plugin_registry_set_enforcement':
            return !empty($perms['action_set_enforcement']);
        
        // Hook Actions
        case 'enable_hook':
            return !empty($perms['action_enable_hook']);
        case 'disable_hook':
            return !empty($perms['action_disable_hook']);
        case 'reset_circuit':
            return !empty($perms['action_reset_circuit']);
        case 'create_custom_hook':
            return !empty($perms['action_create_hook']);
        case 'delete_custom_hook':
            return !empty($perms['action_delete_hook']);
        case 'toggle_custom_hook':
            return !empty($perms['action_enable_hook']) || !empty($perms['action_disable_hook']);
        
        // File Actions
        case 'write_file':
            return !empty($perms['action_save_file']) || !empty($perms['action_upload_file']);
        case 'rename_file':
            return !empty($perms['action_rename_file']);
        case 'delete_path':
            return !empty($perms['action_delete_file']);
        case 'create_dir':
            return !empty($perms['action_create_folder']);
        case 'read_file':
        case 'list_dir':
            return !empty($perms['view_files']);
        
        // System Actions
        case 'shutdown_bot':
            return !empty($perms['action_shutdown_bot']);
        case 'generate_framework_diagnostics':
            return !empty($perms['action_generate_diagnostics']);
        case 'af_invalidate_cache_entry':
            return !empty($perms['action_invalidate_cache']);
        case 'af_force_release_lock':
            return !empty($perms['action_force_release_lock']);
        
        // Chat Actions
        case 'send_chat_message':
            return !empty($perms['action_send_message']);
        case 'request_chat_history':
            return !empty($perms['action_request_chat_data']) || !empty($perms['view_chat']);
        
        // Guild Actions
        case 'leave_guild':
            return !empty($perms['action_leave_guild']);
        
        // Marketplace Actions
        case 'fetch_marketplace_extensions':
            return !empty($perms['action_fetch_marketplace']);
        case 'download_marketplace_extension':
            return !empty($perms['action_download_extension']);
        case 'load_downloaded_extension':
            return !empty($perms['action_load_marketplace_extension']);
        
        default:
            return true;
    }
}

// SIMPLIFIED: 100% permission-based system - no tier restrictions!
// OWNER has all permissions by default
// CUSTOM has permissions based on what you enable
$allowed = lm_command_allowed_for_permissions($command, $rolePerms);

if (!$allowed) {
    lm_log_audit('COMMAND_DENIED', 'DASHBOARD', $command, [
        'role_name' => $roleName,
        'role_tier' => $roleTier,
        'user_id'   => $user['discord_user_id'] ?? null,
    ]);
    http_response_code(403);
    echo json_encode(['error' => 'Not allowed for your role']);
    exit;
}

// Queue command for the bot to consume
$commands = [];
if (file_exists($commandFile)) {
    $existing = @file_get_contents($commandFile);
    if ($existing === false) {
        http_response_code(500);
        echo json_encode(['error' => 'Could not read command file', 'file' => $commandFile]);
        exit;
    }
    $commands = json_decode($existing, true) ?? [];
} else {
    if (!is_writable(dirname($commandFile))) {
        http_response_code(500);
        echo json_encode(['error' => 'Directory not writable', 'dir' => dirname($commandFile)]);
        exit;
    }
}

$commands[] = [
    'command'   => $command,
    'params'    => $params,
    'timestamp' => time(),
];

$jsonData = json_encode($commands, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE);
if ($jsonData === false) {
    http_response_code(500);
    echo json_encode(['error' => 'JSON encoding failed', 'json_error' => json_last_error_msg()]);
    exit;
}

if (@file_put_contents($commandFile, $jsonData, LOCK_EX) === false) {
    $errorMsg = error_get_last();
    http_response_code(500);
    echo json_encode([
        'error' => 'Could not save command',
        'file' => $commandFile,
        'writable' => is_writable(dirname($commandFile)),
        'exists' => file_exists($commandFile),
        'dir_exists' => is_dir(dirname($commandFile)),
        'php_error' => $errorMsg ? $errorMsg['message'] : 'Unknown error'
    ]);
    exit;
}

@chmod($commandFile, 0666);

lm_log_audit('COMMAND_QUEUED', 'DASHBOARD', $command, [
    'role_name' => $roleName,
    'role_tier' => $roleTier,
    'user_id'   => $user['discord_user_id'] ?? null,
]);

echo json_encode(['success' => true, 'message' => 'Command queued']);
?>'''.replace('{{TOKEN}}', token)


    def _generate_get_user_permissions_php(self) -> str:
        """Generate PHP endpoint for refreshing user permissions"""
        return '''<?php
require_once __DIR__ . '/lm_auth.php';

lm_start_session_if_needed();
lm_ensure_schema();

header('Content-Type: application/json');
header('Cache-Control: no-cache, no-store, must-revalidate');
header('Pragma: no-cache');
header('Expires: 0');

$user = lm_current_user();
if (!$user) {
    http_response_code(403);
    echo json_encode(['error' => 'Not logged in']);
    exit;
}

// Get current permissions
$roleName = $user['role'] ?? 'CUSTOM';
$roleTier = lm_resolve_role_tier($roleName);
$perms = lm_role_permissions($roleName, $roleTier);

// Return fresh permissions
echo json_encode([
    'success' => true,
    'permissions' => $perms,
    'role' => $roleName,
    'tier' => $roleTier
]);
?>'''
    
    def _generate_get_tickets_php(self) -> str:
        return '''<?php
require_once __DIR__ . '/lm_auth.php';

lm_start_session_if_needed();
lm_ensure_schema();
$user = lm_current_user();
if (!$user) {
    http_response_code(401);
    header('Content-Type: application/json');
    echo json_encode(['error' => 'Authentication required', 'code' => 401]);
    exit;
}

$roleName = $user['role'] ?? 'CUSTOM';
$roleTier = lm_resolve_role_tier($roleName);
$rolePerms = lm_role_permissions($roleName, $roleTier);

if (empty($rolePerms['view_tickets']) && empty($rolePerms['control_tickets'])) {
    http_response_code(403);
    header('Content-Type: application/json');
    echo json_encode(['error' => 'Access denied: No permission to view tickets', 'code' => 403]);
    exit;
}

header('Content-Type: application/json');

$ticketsDataFile = __DIR__ . '/monitor_data_tickets.json';

if (!file_exists($ticketsDataFile)) {
    echo json_encode([
        'guilds' => [],
        'debug' => [
            'dataFile' => $ticketsDataFile,
            'exists' => false,
            'message' => 'Tickets data not synced yet. Bot sends ticket data every 2 seconds.'
        ]
    ]);
    exit;
}

$ticketsJson = file_get_contents($ticketsDataFile);
$ticketsData = json_decode($ticketsJson, true);

if (!$ticketsData) {
    echo json_encode([
        'guilds' => [],
        'debug' => [
            'dataFile' => $ticketsDataFile,
            'exists' => true,
            'message' => 'Failed to parse tickets data'
        ]
    ]);
    exit;
}

echo json_encode($ticketsData);
?>'''

    def _generate_get_transcript_php(self) -> str:
        return '''<?php
require_once __DIR__ . '/lm_auth.php';

lm_start_session_if_needed();
lm_ensure_schema();
$user = lm_current_user();
if (!$user) {
    lm_render_error_page(401, 'Authentication Required', 'You must be logged in to view ticket transcripts.', 'lock');
}

$roleName = $user['role'] ?? 'CUSTOM';
$roleTier = lm_resolve_role_tier($roleName);
$rolePerms = lm_role_permissions($roleName, $roleTier);

// CRITICAL: Viewing transcript requires action_view_ticket permission ONLY
if (empty($rolePerms['action_view_ticket'])) {
    lm_render_error_page(403, 'Access Denied', 'You do not have permission to view ticket transcripts. Requires action_view_ticket permission.', 'forbidden');
}

$ticketId = $_GET['ticket_id'] ?? '';
$guildId = $_GET['guild_id'] ?? '';

if (!$ticketId || !$guildId) {
    lm_render_error_page(400, 'Invalid Request', 'Missing required parameters: ticket_id or guild_id.', 'error');
}

$ticketsDataFile = __DIR__ . '/monitor_data_tickets.json';

if (!file_exists($ticketsDataFile)) {
    lm_render_error_page(404, 'Data Not Found', 'Tickets data not synced yet. Please wait a few seconds for the bot to sync.', 'loading');
}

$ticketsJson = file_get_contents($ticketsDataFile);
$ticketsData = json_decode($ticketsJson, true);

if (!$ticketsData) {
    lm_render_error_page(500, 'Server Error', 'Failed to parse tickets data. Please contact an administrator.', 'error');
}

$htmlContent = null;
foreach ($ticketsData['guilds'] as $guild) {
    if ($guild['guild_id'] == $guildId) {
        foreach ($guild['tickets'] as $ticket) {
            if ($ticket['ticket_id'] == $ticketId) {
                $htmlContent = $ticket['html_content'] ?? null;
                break 2;
            }
        }
    }
}

if (!$htmlContent) {
    lm_render_error_page(404, 'Ticket Not Found', 'The requested ticket transcript could not be found. It may have been deleted.', 'ticket');
}

header('Content-Type: text/html; charset=utf-8');
echo $htmlContent;
?>'''

    def _generate_download_transcript_php(self) -> str:
        return '''<?php
ob_start();
require_once __DIR__ . '/lm_auth.php';

lm_start_session_if_needed();
lm_ensure_schema();
$user = lm_current_user();
if (!$user) {
    ob_end_clean();
    lm_render_error_page(401, 'Authentication Required', 'You must be logged in to download ticket transcripts.', 'lock');
}

$roleName = $user['role'] ?? 'CUSTOM';
$roleTier = lm_resolve_role_tier($roleName);
$rolePerms = lm_role_permissions($roleName, $roleTier);

// CRITICAL: Downloading transcript requires action_download_ticket permission ONLY
if (empty($rolePerms['action_download_ticket'])) {
    ob_end_clean();
    lm_render_error_page(403, 'Access Denied', 'You do not have permission to download ticket transcripts. Requires action_download_ticket permission.', 'forbidden');
}

$ticketId = $_GET['ticket_id'] ?? '';
$guildId = $_GET['guild_id'] ?? '';
$ticketNumber = $_GET['ticket_number'] ?? 'ticket';

if (!$ticketId || !$guildId) {
    ob_end_clean();
    lm_render_error_page(400, 'Invalid Request', 'Missing required parameters: ticket_id or guild_id.', 'error');
}

$ticketsDataFile = __DIR__ . '/monitor_data_tickets.json';

if (!file_exists($ticketsDataFile)) {
    ob_end_clean();
    lm_render_error_page(404, 'Data Not Found', 'Tickets data not synced yet. Please wait a few seconds for the bot to sync.', 'loading');
}

$ticketsJson = file_get_contents($ticketsDataFile);
$ticketsData = json_decode($ticketsJson, true);

if (!$ticketsData) {
    ob_end_clean();
    lm_render_error_page(500, 'Server Error', 'Failed to parse tickets data. Please contact an administrator.', 'error');
}

$htmlContent = null;
foreach ($ticketsData['guilds'] as $guild) {
    if ($guild['guild_id'] == $guildId) {
        foreach ($guild['tickets'] as $ticket) {
            if ($ticket['ticket_id'] == $ticketId) {
                $htmlContent = $ticket['html_content'] ?? null;
                break 2;
            }
        }
    }
}

if (!$htmlContent) {
    ob_end_clean();
    lm_render_error_page(404, 'Ticket Not Found', 'The requested ticket transcript could not be found. It may have been deleted.', 'ticket');
}

ob_end_clean();

$filename = "transcript-ticket-$ticketNumber.html";
header('Content-Type: text/html; charset=utf-8');
header('Content-Disposition: attachment; filename="' . $filename . '"');
header('Content-Length: ' . strlen($htmlContent));
header('Cache-Control: no-cache, must-revalidate');
header('Expires: 0');
echo $htmlContent;
exit;
?>'''

    def _generate_delete_ticket_php(self) -> str:
        return '''<?php
require_once __DIR__ . '/lm_auth.php';

lm_start_session_if_needed();
lm_ensure_schema();
$user = lm_current_user();
if (!$user) {
    http_response_code(403);
    header('Content-Type: application/json');
    echo json_encode(['error' => 'Not logged in']);
    exit;
}

$roleName = $user['role'] ?? 'CUSTOM';
$roleTier = lm_resolve_role_tier($roleName);
$rolePerms = lm_role_permissions($roleName, $roleTier);

// CRITICAL: Deleting ticket requires action_delete_ticket permission ONLY
if (empty($rolePerms['action_delete_ticket'])) {
    http_response_code(403);
    header('Content-Type: application/json');
    echo json_encode(['error' => 'No permission to delete transcripts. Requires action_delete_ticket permission.']);
    exit;
}

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    http_response_code(405);
    header('Content-Type: application/json');
    echo json_encode(['error' => 'Only POST requests allowed']);
    exit;
}

$input = json_decode(file_get_contents('php://input'), true);
$ticketId = $input['ticket_id'] ?? '';
$guildId = $input['guild_id'] ?? '';

if (!$ticketId || !$guildId) {
    http_response_code(400);
    header('Content-Type: application/json');
    echo json_encode(['error' => 'Missing ticket_id or guild_id']);
    exit;
}

$queueFile = __DIR__ . '/monitor_data_ticket_deletions.json';
$deletions = [];

if (file_exists($queueFile)) {
    $json = file_get_contents($queueFile);
    $deletions = json_decode($json, true) ?: [];
}

$deletions[] = [
    'ticket_id' => $ticketId,
    'guild_id' => $guildId,
    'requested_at' => date('c'),
    'requested_by' => $user['username'] ?? 'unknown'
];

file_put_contents($queueFile, json_encode($deletions, JSON_PRETTY_PRINT));

header('Content-Type: application/json');
echo json_encode([
    'success' => true,
    'message' => 'Deletion queued. Bot will process it shortly.'
]);
?>'''

    def _generate_privacy_api_php(self) -> str:
        """Generate PHP endpoint for updating privacy settings."""
        return '''<?php
require_once __DIR__ . '/lm_auth.php';

lm_start_session_if_needed();
lm_ensure_schema();
$user = lm_current_user();
if (!$user) {
    http_response_code(403);
    header('Content-Type: application/json');
    echo json_encode(['error' => 'Not logged in']);
    exit;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $input = json_decode(file_get_contents('php://input'), true);
    $log_ip = isset($input['log_ip']) ? (bool)$input['log_ip'] : false;

    try {
        $pdo = lm_db();
        $stmt = $pdo->prepare('UPDATE dashboard_users SET log_ip = :log_ip WHERE id = :id');
        $stmt->execute([':log_ip' => $log_ip ? 1 : 0, ':id' => $user['id']]);
        
        $_SESSION['log_ip'] = $log_ip;
        
        lm_log_audit('PRIVACY_UPDATE', 'USER', $user['discord_user_id'], ['log_ip' => $log_ip]);

        header('Content-Type: application/json');
        echo json_encode(['success' => true, 'message' => 'Privacy settings updated.']);
    } catch (Throwable $e) {
        http_response_code(500);
        header('Content-Type: application/json');
        echo json_encode(['error' => 'Database error: ' . $e->getMessage()]);
    }
    exit;
}

if ($_SERVER['REQUEST_METHOD'] === 'GET') {
    header('Content-Type: application/json');
    echo json_encode([
        'success' => true,
        'log_ip' => isset($_SESSION['log_ip']) ? (bool)$_SESSION['log_ip'] : true
    ]);
    exit;
}

http_response_code(405);
header('Content-Type: application/json');
echo json_encode(['error' => 'Method not allowed']);
?>'''

    def _generate_transcript_view_php(self) -> str:
        return '''<?php
require_once __DIR__ . '/lm_auth.php';

lm_start_session_if_needed();
lm_ensure_schema();
$user = lm_current_user();
if (!$user) {
    lm_render_error_page(401, 'Authentication Required', 'You must be logged in to view ticket transcripts.', 'lock');
}

$roleName = $user['role'] ?? 'CUSTOM';
$roleTier = lm_resolve_role_tier($roleName);
$rolePerms = lm_role_permissions($roleName, $roleTier);

// CRITICAL: Viewing transcript requires action_view_ticket permission ONLY
if (empty($rolePerms['action_view_ticket'])) {
    lm_render_error_page(403, 'Access Denied', 'You do not have permission to view ticket transcripts. Requires action_view_ticket permission.', 'forbidden');
}

$ticketId = $_GET['ticket_id'] ?? '';
$guildId = $_GET['guild_id'] ?? '';

if (!$ticketId || !$guildId) {
    lm_render_error_page(400, 'Invalid Request', 'Missing required parameters: ticket_id or guild_id.', 'error');
}

?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Transcript</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #020617;
            color: #e5e7eb;
            overflow: hidden;
        }
        .header-bar {
            background: #0f172a;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 56px;
        }
        .back-button {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .back-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
        }
        .transcript-title {
            font-size: 16px;
            font-weight: 600;
            color: #e5e7eb;
        }
        .transcript-container {
            position: absolute;
            top: 56px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: auto;
            background: white;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
        .framework-badge {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 6px 16px;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-left: auto;
        }
        .framework-badge-text {
            font-size: 13px;
            font-weight: 700;
            color: #ffffff;
            line-height: 1.2;
            white-space: nowrap;
        }
        .framework-badge-subtitle {
            font-size: 9px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1;
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <a href="index.php#tickets" class="back-button">
            <span>â†</span> Back to Dashboard
        </a>
        <div class="transcript-title">Ticket Transcript</div>
        <div class="framework-badge">
            <div class="framework-badge-text">Zoryx Discord Bot Framework</div>
            <div class="framework-badge-subtitle">Ticket Wrapper</div>
        </div>
    </div>
    <div class="transcript-container">
        <iframe src="get_transcript.php?ticket_id=<?php echo htmlspecialchars($ticketId); ?>&guild_id=<?php echo htmlspecialchars($guildId); ?>"></iframe>
    </div>
</body>
</html>
'''


async def setup(bot):
    await bot.add_cog(LiveMonitor(bot))
    logger.info("Live Monitor cog loaded successfully")
